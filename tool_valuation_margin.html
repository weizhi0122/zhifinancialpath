<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>巴菲特式合理價值試算（含安全邊際）｜智 Financial Path</title>
<meta name="description" content="用巴菲特的 Owner Earnings 思路：輸入股東盈餘、成長、折現率與安全邊際，估算合理價值區間與買進區。">

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#333; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --ok:#16a34a; --okbg:#f1fff5; --warn:#d92c2c; --warnbg:#fff4f4;
    --shadow:0 10px 22px rgba(16,24,40,.06); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.85}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:12px 20px;position:sticky;top:0;z-index:10}
  .topbar .inner{max-width:1020px;margin:auto;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
  .topbar a{color:var(--primary);text-decoration:none;font-size:14px}
  .topbar a:hover{text-decoration:underline}
  .container{max-width:1020px;margin:auto;padding:26px 20px 90px}
  h1,h2,h3{color:var(--primary);margin:0 0 10px}
  .sub{color:#4b5563;margin:0 0 18px}
  .grid{display:grid;grid-template-columns:420px 1fr;gap:14px;align-items:start}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid #edf0f6;padding:16px}
  label{display:flex;justify-content:space-between;gap:10px;align-items:flex-end;font-size:13px;color:#475569;margin:10px 0 6px}
  label .tag{font-size:12px;color:#64748b;background:#f7f9ff;border:1px solid #dfeaff;border-radius:999px;padding:2px 8px}
  input,select{width:100%;padding:10px 12px;border:1px solid #d9e2f2;border-radius:12px;background:#fff;font-size:14px}
  input:focus,select:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{border:0;border-radius:12px;padding:10px 14px;background:var(--primary);color:#fff;cursor:pointer;font-size:14px}
  button.secondary{background:#fff;color:var(--primary);border:1px solid #cfe0ff}
  button:hover{opacity:.92}
  .small{font-size:13px;color:var(--muted)}
  .hr{border:none;border-top:1px solid #eef1f6;margin:12px 0}
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .kpi .box{background:#f7f9ff;border:1px solid #dfeaff;border-radius:14px;padding:12px}
  .kpi .box b{color:var(--primary)}
  .note{background:#fff;border-left:4px solid var(--primary);border-radius:14px;padding:12px 14px;box-shadow:0 6px 16px rgba(0,0,0,.04)}
  .msg{border-radius:14px;padding:12px 14px;margin-top:12px}
  .msg.ok{background:var(--okbg);border-left:4px solid var(--ok)}
  .msg.warn{background:var(--warnbg);border-left:4px solid var(--warn)}
  details.help{background:#fff;border:1px solid #edf0f6;border-radius:14px;padding:10px 12px;margin-top:10px}
  details.help summary{cursor:pointer;color:#111827;font-weight:700}
  details.help ul{margin:8px 0 0 18px}
  details.help li{margin:6px 0}
  .hint{font-size:12px;color:#64748b;margin-top:6px;line-height:1.55}
  canvas{width:100%;max-width:100%;height:260px;background:#fff;border-radius:14px;border:1px solid var(--line)}
  .footer-links{text-align:center;margin-top:26px}
  .footer-links a{margin:0 10px;color:var(--primary);text-decoration:none}
  .footer-links a:hover{text-decoration:underline}
</style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <a href="javascript:history.back()">← 回上頁</a>
      <div>
        <a href="./index.html" style="margin-right:12px;">回主頁</a>
        <a href="./library.html">知識庫</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>巴菲特式合理價值試算（含安全邊際）</h1>
    <p class="sub">
      這不是「神準算股價」，而是把公司當成「未來能吐出多少現金」的機器來估值：<br>
      <b>合理價值區間</b>（保守/基準/樂觀）＋ <b>安全邊際買進區</b>（避免犯大錯）。
    </p>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2 style="margin-top:0">輸入</h2>

        <label>估值方法 <span class="tag">建議用 Owner Earnings</span></label>
        <select id="mode">
          <option value="oe" selected>巴菲特模式：Owner Earnings（股東盈餘）折現</option>
          <option value="eps">新手模式：用 EPS 近似（較粗略）</option>
        </select>

        <div id="oeBlock">
          <label>Owner Earnings（每股）<span class="tag">現金流 + 維持性資本支出</span></label>
          <input id="oeps" type="number" step="0.01" value="9.00" />
          <div class="hint">
            你可以先用「每股」版本（最直覺）。如果你只有公司總額也可：先算 OE 總額，再除以流通在外股數。
          </div>

          <details class="help">
            <summary>我不知道 Owner Earnings 怎麼算、去哪找？（照這裡做）</summary>
            <ul>
              <li><b>第 1 步：找 CFO（營運現金流）</b>：現金流量表 → 「營業活動之淨現金流入（出）」。</li>
              <li><b>第 2 步：扣掉維持性資本支出（Maintenance CapEx）</b>：
                <ul>
                  <li>現金流量表常有「購置不動產、廠房及設備」＝ CapEx（但它包含擴張 + 維持）。</li>
                  <li><b>保守做法（新手可用）</b>：Maintenance CapEx 先用「CapEx 的 60%~80%」估（產業不同）。</li>
                  <li><b>更嚴謹做法</b>：看年報/法說：「擴產投資」與「汰換更新」拆分；汰換更新≈維持性。</li>
                </ul>
              </li>
              <li><b>第 3 步：Owner Earnings（公司總額）≈ CFO − Maintenance CapEx</b>。</li>
              <li><b>第 4 步：轉成每股</b>：除以「加權平均流通在外股數」（EPS 計算用那個）。</li>
              <li class="small"><b>為什麼不用淨利？</b>淨利可能受會計估計影響；CFO 才更接近「真現金」。</li>
            </ul>
          </details>
        </div>

        <div id="epsBlock" style="display:none;">
          <label>目前 EPS（近四季或近一年）<span class="tag">較粗略</span></label>
          <input id="eps" type="number" step="0.01" value="10.00" />
          <div class="hint">
            EPS 哪裡找：財報/年報「每股盈餘」。若公司盈餘品質不佳（CFO/淨利 &lt; 1），請改用 Owner Earnings。
          </div>
        </div>

        <div class="row2">
          <div>
            <label>預期年成長率 g（%）<span class="tag">保守更重要</span></label>
            <input id="g" type="number" step="0.1" value="10" />
            <div class="hint">
              來源：看「近 5~10 年」OE（或 EPS）成長、產業天花板、競爭強度。循環股建議用「景氣中間值」。
            </div>
          </div>
          <div>
            <label>折現率 r / 要求報酬（%）<span class="tag">你的風險門檻</span></label>
            <input id="r" type="number" step="0.1" value="10" />
            <div class="hint">
              直覺：你希望每年賺多少才值得承擔風險。風險越大、r 應該越高（估值會更保守）。
            </div>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>估值期間 N（年）<span class="tag">常用 5~10</span></label>
            <input id="years" type="number" step="1" value="10" />
            <div class="hint">巴菲特偏好「可預測」的公司：若你只能看懂 3 年，就不要硬拉到 10 年。</div>
          </div>
          <div>
            <label>安全邊際 MOS（%）<span class="tag">避免犯錯</span></label>
            <input id="mos" type="number" step="1" value="30" />
            <div class="hint">建議 25%~40%。不確定性越大（循環、槓桿、匯率），MOS 越要高。</div>
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 6px">終值（Terminal Value）設定</h3>
        <label>終值計算方式 <span class="tag">兩種都保守</span></label>
        <select id="tvMode">
          <option value="gordon" selected>Gordon 模型（更嚴謹）：TV = OE(N+1) / (r − gT)</option>
          <option value="peAuto">用折現率推導倍數（簡化保守）：PE ≈ 1 / (r − gT)</option>
          <option value="peManual">手動輸入終值倍數（不建議新手）</option>
        </select>

        <div class="row2">
          <div>
            <label>長期成長 gT（%）<span class="tag">通常 0~3</span></label>
            <input id="gT" type="number" step="0.1" value="2.0" />
            <div class="hint">gT 是「公司成熟後」的長期成長，通常不應高於長期名目 GDP（保守 0~3%）。</div>
          </div>
          <div id="peManualWrap" style="display:none;">
            <label>終值倍數（手動）<span class="tag">小心高估</span></label>
            <input id="peManual" type="number" step="0.1" value="15" />
            <div class="hint">只有當你非常確定產業定價權與穩定性，才考慮手動倍數。</div>
          </div>
        </div>

        <div class="btnrow">
          <button type="button" onclick="calc()">開始試算</button>
          <button type="button" class="secondary" onclick="resetAll()">重設</button>
        </div>

        <div id="msg" class="msg" style="display:none"></div>

        <p class="small" style="margin-top:10px;">
          <b>巴菲特核心：</b>你不是在預測股價，你在估算「公司未來能帶回來的現金」值多少。<br>
          因此 <b>成長假設要保守</b>、<b>折現率要反映風險</b>、<b>安全邊際用來抵抗看錯</b>。
        </p>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2 style="margin-top:0">結果</h2>

        <div class="kpi">
          <div class="box">
            <b>合理價值區間（保守→樂觀）</b>
            <div id="rangeText" style="margin-top:6px;">—</div>
            <div class="small">三情境（g×0.6 / g / g×1.4）避免單點幻想。</div>
          </div>
          <div class="box">
            <b>安全邊際買進區</b>
            <div id="mosText" style="margin-top:6px;">—</div>
            <div class="small">MOS 的本質：讓你就算看錯也不容易重傷。</div>
          </div>
          <div class="box">
            <b>終值假設（採用）</b>
            <div id="tvText" style="margin-top:6px;">—</div>
            <div class="small">gT 必須小於 r；否則模型會失真。</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <canvas id="chart" width="940" height="260"></canvas>
        </div>

        <div class="note" style="margin-top:12px;">
          <b>估值前，請自問三題（更像巴菲特）：</b><br>
          ① 這家公司 10 年後還能靠同樣護城河賺錢嗎？（定價權/轉換成本/網路效應）<br>
          ② Owner Earnings 是否「穩定」且「可重複」？還是靠景氣/一次性？<br>
          ③ 即使你高估了成長 30%，用 MOS 後你還是買在「不會致命」的位置嗎？
        </div>
      </div>
    </div>

    <div class="footer-links">
      <a href="./chapter_investing.html">← 回投資決策系統</a>
      <a href="./tools.html">回工具</a>
      <a href="./index.html">回主頁</a>
    </div>
  </div>

<script>
  const modeSel = document.getElementById('mode');
  const oeBlock = document.getElementById('oeBlock');
  const epsBlock = document.getElementById('epsBlock');

  const tvMode = document.getElementById('tvMode');
  const peManualWrap = document.getElementById('peManualWrap');

  modeSel.addEventListener('change', ()=>{
    const m = modeSel.value;
    oeBlock.style.display = (m==='oe') ? 'block' : 'none';
    epsBlock.style.display = (m==='eps') ? 'block' : 'none';
    calc();
  });

  tvMode.addEventListener('change', ()=>{
    peManualWrap.style.display = (tvMode.value === 'peManual') ? 'block' : 'none';
    calc();
  });

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function fmt(n){ return isFinite(n) ? n.toFixed(2) : '—'; }

  function scenarioGrowth(gBase){
    return [
      clamp(gBase*0.6, -5, 25),
      clamp(gBase, -5, 25),
      clamp(gBase*1.4, -5, 25)
    ];
  }

  // 折現現金流：PV = Σ [OE_t / (1+r)^t] + TV / (1+r)^N
  function pvDCF(oe0, gPct, rPct, N, gTPct, tvMode, peManual){
    const g = gPct/100;
    const r = rPct/100;
    const gT = gTPct/100;

    // 基本防呆
    if(N<1 || r<=0) return {pv:NaN, tv:NaN, tvInfo:"折現率需 > 0"};
    if(tvMode==="gordon" && (gT >= r)) return {pv:NaN, tv:NaN, tvInfo:"gT 必須 < r（否則 Gordon 失效）"};

    let pv = 0;
    for(let t=1; t<=N; t++){
      const oe_t = oe0 * Math.pow(1+g, t);
      pv += oe_t / Math.pow(1+r, t);
    }

    // Terminal Value（在第 N 年末）
    const oe_N = oe0 * Math.pow(1+g, N);
    let TV = NaN;
    let tvInfo = "";

    if(tvMode==="gordon"){
      const oe_N1 = oe_N * (1+gT);
      TV = oe_N1 / (r - gT);
      tvInfo = `Gordon：TV = OE(N+1)/(r−gT)，gT=${gTPct.toFixed(1)}%`;
    } else if(tvMode==="peAuto"){
      // 用折現率推導保守倍數：multiple ≈ 1/(r-gT)（同 Gordon 的結構，但用「倍數」呈現）
      const denom = Math.max(0.01, r - gT);
      const multiple = clamp(1/denom, 6, 25);
      TV = oe_N * multiple;
      tvInfo = `倍數推導：Multiple≈1/(r−gT)→${multiple.toFixed(1)}x（保守上限 25x）`;
    } else {
      const multiple = clamp(peManual, 5, 40);
      TV = oe_N * multiple;
      tvInfo = `手動倍數：${multiple.toFixed(1)}x（請確認護城河與穩定性）`;
    }

    pv += TV / Math.pow(1+r, N);
    return {pv, tv:TV, tvInfo};
  }

  function validateInputs(oe0, g, r, N, mos, gT){
    const warns=[];
    if(oe0<=0) warns.push("輸入的每股 Owner Earnings / EPS ≤ 0：估值會失真（可能是景氣低谷或一次性損益）。");
    if(r < 6) warns.push("折現率偏低：通常低估風險（除非你確定非常穩定、且你要求報酬真的低）。");
    if(g > 20) warns.push("成長率偏高：請確認不是小基期或循環高峰。建議用 5~10 年平均或保守降一級。");
    if(N > 12) warns.push("估值年數偏長：超過你能理解的可預測範圍，容易變成自我安慰。");
    if(mos < 20) warns.push("安全邊際偏低：如果你不是很有把握，建議 25~40%。");
    if(gT > 4) warns.push("長期成長 gT 偏高：成熟公司長期多落在 0~3%。");
    return warns;
  }

  function calc(){
    const mode = modeSel.value;

    const oe0 = (mode==="oe")
      ? Number(document.getElementById('oeps').value || 0)
      : Number(document.getElementById('eps').value || 0);

    const gBase = Number(document.getElementById('g').value || 0);
    const r = Number(document.getElementById('r').value || 0);
    const N = Math.max(1, parseInt(document.getElementById('years').value || 10, 10));
    const mos = clamp(Number(document.getElementById('mos').value || 30), 0, 80);

    const gT = Number(document.getElementById('gT').value || 2.0);
    const tvM = tvMode.value;
    const peManual = Number(document.getElementById('peManual').value || 15);

    // 顯示提醒
    const msg = document.getElementById('msg');
    const warns = validateInputs(oe0, gBase, r, N, mos, gT);
    msg.style.display = "block";
    if(warns.length){
      msg.className="msg warn";
      msg.innerHTML = `<b>請先確認假設（越保守越像巴菲特）：</b><ul>${warns.map(w=>`<li>${w}</li>`).join("")}</ul>`;
    }else{
      msg.className="msg ok";
      msg.innerHTML = `<b>假設看起來合理。</b>請重點檢查：Owner Earnings 是否穩定、護城河是否可持續。`;
    }

    // 三情境
    const gs = scenarioGrowth(gBase);
    const out = gs.map(g=>{
      const res = pvDCF(oe0, g, r, N, gT, tvM, peManual);
      return {g, pv:res.pv, tvInfo:res.tvInfo};
    });

    // 若 Gordon 失效等 → 會 NaN
    const valid = out.filter(x=>isFinite(x.pv));
    if(valid.length !== 3){
      document.getElementById('rangeText').innerHTML = `—（請確認：gT 必須 < r，且折現率 > 0）`;
      document.getElementById('mosText').innerHTML = `—`;
      document.getElementById('tvText').innerHTML = `—`;
      const c = document.getElementById('chart');
      c.getContext('2d').clearRect(0,0,c.width,c.height);
      return;
    }

    const vals = valid.map(x=>x.pv).sort((a,b)=>a-b);
    const low = vals[0], mid = vals[1], high = vals[2];

    const buyLow = low * (1 - mos/100);
    const buyMid = mid * (1 - mos/100);

    document.getElementById('rangeText').innerHTML =
      `保守 ${fmt(low)} ｜基準 ${fmt(mid)} ｜樂觀 ${fmt(high)}`;

    document.getElementById('mosText').innerHTML =
      `MOS ${mos.toFixed(0)}%：買進參考區 ≈ ${fmt(buyLow)} ～ ${fmt(buyMid)}`;

    document.getElementById('tvText').innerHTML =
      `${valid[1].tvInfo}`;

    drawBar(low, mid, high, buyLow, buyMid, mode);
  }

  function drawBar(low, mid, high, buyLow, buyMid, mode){
    const c = document.getElementById('chart');
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);

    const pad = 40;
    const w = c.width - pad*2;
    const y = 140;

    const minX = Math.max(0, buyLow*0.85);
    const maxX = high*1.15;

    function x(v){
      return pad + ( (v - minX) / (maxX - minX) ) * w;
    }

    // baseline
    ctx.strokeStyle = '#d7deea';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(pad+w, y);
    ctx.stroke();

    // fair range
    ctx.fillStyle = '#eef4ff';
    ctx.fillRect(x(low), y-30, Math.max(2, x(high)-x(low)), 60);

    // mid line
    ctx.strokeStyle = '#0b3d91';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x(mid), y-35);
    ctx.lineTo(x(mid), y+35);
    ctx.stroke();

    // MOS buy zone
    ctx.fillStyle = '#eaf7ef';
    ctx.fillRect(x(buyLow), y-18, Math.max(2, x(buyMid)-x(buyLow)), 36);
    ctx.strokeStyle = '#b7e2c6';
    ctx.lineWidth = 2;
    ctx.strokeRect(x(buyLow), y-18, Math.max(2, x(buyMid)-x(buyLow)), 36);

    // labels
    ctx.fillStyle = '#333';
    ctx.font = '14px Arial';
    ctx.fillText('合理價值區間（DCF）', x(low), y-40);
    ctx.fillText('安全邊際買進區', x(buyLow), y+55);

    // ticks
    function tick(v, label){
      ctx.strokeStyle = '#c9d3e5';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x(v), y);
      ctx.lineTo(x(v), y+10);
      ctx.stroke();
      ctx.fillStyle = '#555';
      ctx.font = '12px Arial';
      ctx.fillText(label, x(v)-12, y+26);
    }
    tick(low, fmt(low));
    tick(mid, fmt(mid));
    tick(high, fmt(high));

    ctx.fillStyle = '#666';
    ctx.font = '13px Arial';
    const base = (mode==="oe") ? "Owner Earnings" : "EPS（近似）";
    ctx.fillText(`提示：以 ${base} 做折現；用區間思維，而非單點價格。`, pad, 30);
  }

  function resetAll(){
    document.getElementById('mode').value = 'oe';
    oeBlock.style.display = 'block';
    epsBlock.style.display = 'none';

    document.getElementById('oeps').value = 9.00;
    document.getElementById('eps').value = 10.00;
    document.getElementById('g').value = 10;
    document.getElementById('r').value = 10;
    document.getElementById('years').value = 10;
    document.getElementById('mos').value = 30;

    document.getElementById('tvMode').value = 'gordon';
    document.getElementById('gT').value = 2.0;
    document.getElementById('peManual').value = 15;
    peManualWrap.style.display = 'none';

    document.getElementById('rangeText').innerHTML = '—';
    document.getElementById('mosText').innerHTML = '—';
    document.getElementById('tvText').innerHTML = '—';
    document.getElementById('msg').style.display = 'none';

    const c = document.getElementById('chart');
    c.getContext('2d').clearRect(0,0,c.width,c.height);
    calc();
  }

  calc();
</script>
</body>
</html>
