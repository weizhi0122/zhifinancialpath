<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é€€ä¼‘ç¾é‡‘æµæ¨¡æ“¬å·¥å…·ï½œæ™º Financial Path</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="é€€ä¼‘ç¾é‡‘æµæ¨¡æ“¬ï¼šä¸‰æ®µæœŸå‡è¨­ã€è³‡æœ¬æˆé•·èˆ‡ç¾é‡‘æ®–åˆ©æ‹†è§£ã€é€šè†¨/å¯¦è³ªè³¼è²·åŠ›ã€å£“åŠ›æ¸¬è©¦ã€é€€ä¼‘åˆæœŸåºåˆ—é¢¨éšªã€åœ–è¡¨èˆ‡å¹´åº¦æ˜ç´°ã€‚" />

  <!-- Chart.js CDNï¼ˆç´”å‰ç«¯ï¼ŒGitHub Pages å¯ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f6f8fb;color:#333;line-height:1.8}
    .topbar{background:#fff;border-bottom:1px solid #e6e8ee;padding:12px 20px;position:sticky;top:0;z-index:999}
    .topbar .inner{max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .topbar a{color:#0b3d91;text-decoration:none;font-size:14px}
    .container{max-width:1100px;margin:auto;padding:22px 20px 70px}
    h1,h2,h3{color:#0b3d91;margin:0 0 10px}
    .muted{color:#666;font-size:14px}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){ .row{grid-template-columns:1fr} }

    label{display:block;font-size:13px;color:#444;margin:10px 0 6px}
    input,select{width:100%;padding:10px 10px;border:1px solid #d7deea;border-radius:10px;font-size:14px;background:#fff}
    input:focus,select:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-block;background:#0b3d91;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;border:0;cursor:pointer;font-size:14px}
    .btn:hover{opacity:.92}
    .btn.ghost{background:#fff;color:#0b3d91;border:1px solid #cfe0ff}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    @media (max-width: 900px){ .kpi{grid-template-columns:1fr 1fr} }
    @media (max-width: 520px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{background:#f3f7ff;border:1px solid #dfeaff;border-radius:12px;padding:12px}
    .kpi .box .t{font-size:12px;color:#4a5b7a}
    .kpi .box .v{font-size:18px;font-weight:800;color:#0b3d91;margin-top:4px}

    .charts{display:grid;grid-template-columns:1fr;gap:14px}
    canvas{background:#fff;border-radius:14px}
    .tablewrap{overflow:auto;border-radius:14px;border:1px solid #e6e8ee}
    table{border-collapse:collapse;width:100%;min-width:980px;background:#fff}
    th,td{padding:10px 10px;border-bottom:1px solid #eef1f6;text-align:right;font-size:13px;white-space:nowrap}
    th{text-align:right;background:#f7f9fd;color:#0b3d91;position:sticky;top:0}
    td:first-child, th:first-child{text-align:left}
    .warn{background:#fff4f4;border-left:4px solid #d92c2c;padding:12px;border-radius:12px;margin-top:12px}
    .ok{background:#f1fff5;border-left:4px solid #15a34a;padding:12px;border-radius:12px;margin-top:12px}
    .small{font-size:13px;color:#666}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:#0b3d91;border:1px solid #dbe7ff}
    footer{margin-top:18px;color:#777;font-size:12px}

    .mini{font-size:12px;color:#7a8699;line-height:1.4;margin-top:6px}
    .hr{border:none;border-top:1px solid #eef1f6;margin:14px 0}

    details{border:1px solid #e6e8ee;border-radius:12px;background:#fff;margin-top:12px}
    summary{cursor:pointer;padding:12px 12px;font-weight:800;color:#0f172a}
    details .inner{padding:0 12px 12px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #dbe2f0;color:#334155;background:#f8fafc;font-size:12px;margin-left:6px}

    .conclusion{margin-top:12px;border:1px solid #dfeaff;background:#f7f9ff;border-radius:12px;padding:12px}
    .conclusion b{color:#0b3d91}
    .ul{margin:8px 0 0 18px;color:#334155}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <a href="./tools.html">â† å›å·¥å…·</a>
      <div>
        <a href="./index.html" style="margin-right:14px;">ğŸ  å›ä¸»é </a>
        <a href="./library.html#retire">ğŸ“š çŸ¥è­˜åº«</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¾é‡‘æµæ¨¡æ“¬å·¥å…· <span class="pill">ä¸‰æ®µæœŸ</span> <span class="pill">æé ˜ç­–ç•¥</span> <span class="pill">åç›®/å¯¦è³ª</span></h1>
    <p class="muted">
      æŠŠé€šè†¨ã€è³‡ç”¢æˆé•·ï¼ˆè³‡æœ¬åˆ©å¾—ï¼‰ã€ç¾é‡‘æ®–åˆ©ï¼ˆè‚¡åˆ©/å‚µæ¯/ç§Ÿé‡‘/é…æ¯ï¼‰ã€é€€ä¼‘æ”¯å‡ºã€å¹´é‡‘æ”¶å…¥èˆ‡å¿…è¦æé ˜æ•´åˆæˆå¹´åº¦ç¾é‡‘æµï¼›
      ä¸¦åŠ å…¥ã€Œé€€ä¼‘åˆæœŸåºåˆ—é¢¨éšªã€èˆ‡ã€Œå£“åŠ›æ¸¬è©¦ã€ã€‚
    </p>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <h2 style="font-size:18px;margin-bottom:6px;">è¼¸å…¥</h2>
        <p class="small" style="margin:0 0 8px;">
          å–®ä½ï¼šé‡‘é¡ä»¥ã€Œè¬å…ƒã€ï¼›æœˆé‡‘é¡æœƒè‡ªå‹•æ›ç®—æˆå¹´åº¦ã€‚
        </p>

        <div class="row">
          <div>
            <label>ç›®å‰å¹´é½¡</label>
            <input id="ageNow" type="number" value="35" min="18" max="80">
          </div>
          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <input id="ageRet" type="number" value="60" min="30" max="85">
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ¨¡æ“¬åˆ°å¹¾æ­²ï¼ˆå£½å‘½å‡è¨­ï¼‰</label>
            <input id="ageEnd" type="number" value="90" min="60" max="110">
          </div>
          <div>
            <label>ç›®å‰å¯æŠ•è³‡è³‡ç”¢ï¼ˆè¬å…ƒï¼‰</label>
            <input id="assetNow" type="number" value="800" min="0" step="1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆå¯æŠ•å…¥ï¼ˆè¬å…ƒï¼‰</label>
            <input id="monthlySave" type="number" value="3" min="0" step="0.1">
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™æ”¯å‡ºï¼ˆè¬å…ƒï¼Œä»¥ã€Œä»Šå¤©ã€è³¼è²·åŠ›ï¼‰</label>
            <input id="monthlySpendReal" type="number" value="6" min="0" step="0.1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ”¯å‡ºèª¿æ•´æ–¹å¼</label>
            <select id="spendIndexMode">
              <option value="cpi" selected>æ¯å¹´éš¨é€šè†¨ï¼ˆCPIï¼‰èª¿æ•´</option>
              <option value="partial">éƒ¨åˆ†èª¿æ•´ï¼ˆåªèª¿æ•´ 70%ï¼‰</option>
              <option value="flat">ä¸èª¿æ•´ï¼ˆåç›®å›ºå®šï¼‰</option>
            </select>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œä¸€æ¬¡æ€§å¤§æ”¯å‡ºï¼ˆè¬å…ƒï¼‰</label>
            <input id="oneOffCost" type="number" value="0" min="0" step="1">
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">ä¸‰æ®µæœŸå‡è¨­ï¼ˆé€šè†¨ / è³‡æœ¬æˆé•· / ç¾é‡‘æ®–åˆ©ï¼‰</h3>
        <div class="mini">
          ç”¨ä¸‰æ®µæœŸæé«˜çœŸå¯¦åº¦ï¼šç´¯ç©æœŸï¼ˆç¾åœ¨â†’é€€ä¼‘ï¼‰ã€é€€ä¼‘å‰æœŸï¼ˆé€€ä¼‘å¾Œå‰Nå¹´ï¼‰ã€é€€ä¼‘å¾ŒæœŸï¼ˆå…¶å¾Œï¼‰ã€‚
          <b>è³‡æœ¬æˆé•·ä¸å«æ®–åˆ©</b>ï¼Œæ®–åˆ©ä½œç‚ºç¾é‡‘æµæˆ–å†æŠ•å…¥ï¼Œé¿å… double countã€‚
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰æœŸï¼ˆé€€ä¼‘å¾Œå‰ N å¹´ï¼‰</label>
            <input id="phaseYears" type="number" value="10" min="1" max="30" step="1">
          </div>
          <div>
            <label>ä¸€éµä¿å®ˆï¼ˆå‰æœŸï¼‰</label>
            <select id="phaseHint">
              <option value="keep" selected>è‡ªè¡Œè¨­å®š</option>
              <option value="auto">å‰æœŸæˆé•·-1%ã€é€šè†¨+0.5%</option>
            </select>
          </div>
        </div>

        <details open>
          <summary>ç´¯ç©æœŸï¼ˆç¾åœ¨â†’é€€ä¼‘ï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>é€šè†¨ç‡ï¼ˆå¹´%ï¼‰</label>
                <input id="inflA" type="number" value="2.0" min="0" max="10" step="0.1">
              </div>
              <div>
                <label>è³‡æœ¬æˆé•·ç‡ï¼ˆå¹´%ï¼Œä¸å«æ®–åˆ©ï¼‰</label>
                <input id="capA" type="number" value="2.0" min="-10" max="15" step="0.1">
              </div>
            </div>
            <div class="row">
              <div>
                <label>ç¾é‡‘æ®–åˆ©ç‡ï¼ˆå¹´%ï¼‰</label>
                <input id="yldA" type="number" value="3.5" min="0" max="15" step="0.1">
              </div>
              <div>
                <label>æ®–åˆ©æ˜¯å¦å†æŠ•å…¥ï¼ˆé€€ä¼‘å‰ï¼‰</label>
                <select id="reinvestBefore">
                  <option value="yes" selected>æ˜¯ï¼ˆç´¯ç©æœŸå†æŠ•å…¥ï¼‰</option>
                  <option value="no">å¦ï¼ˆç´¯ç©æœŸç•¶ä½œæ”¶å…¥ä½¿ç”¨ï¼‰</option>
                </select>
              </div>
            </div>
          </div>
        </details>

        <details>
          <summary>é€€ä¼‘å‰æœŸï¼ˆé€€ä¼‘å¾Œå‰ N å¹´ï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>é€šè†¨ç‡ï¼ˆå¹´%ï¼‰</label>
                <input id="inflB" type="number" value="2.0" min="0" max="10" step="0.1">
              </div>
              <div>
                <label>è³‡æœ¬æˆé•·ç‡ï¼ˆå¹´%ï¼Œä¸å«æ®–åˆ©ï¼‰</label>
                <input id="capB" type="number" value="1.0" min="-10" max="15" step="0.1">
              </div>
            </div>
            <div class="row">
              <div>
                <label>ç¾é‡‘æ®–åˆ©ç‡ï¼ˆå¹´%ï¼‰</label>
                <input id="yldB" type="number" value="3.5" min="0" max="15" step="0.1">
              </div>
              <div class="mini">å»ºè­°å‰æœŸä¿å®ˆï¼šç”¨ä¾†æ•æ‰ã€Œé€€ä¼‘åˆæœŸåºåˆ—é¢¨éšªã€ã€‚</div>
            </div>
          </div>
        </details>

        <details>
          <summary>é€€ä¼‘å¾ŒæœŸï¼ˆé€€ä¼‘å‰æœŸçµæŸå¾Œï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>é€šè†¨ç‡ï¼ˆå¹´%ï¼‰</label>
                <input id="inflC" type="number" value="2.0" min="0" max="10" step="0.1">
              </div>
              <div>
                <label>è³‡æœ¬æˆé•·ç‡ï¼ˆå¹´%ï¼Œä¸å«æ®–åˆ©ï¼‰</label>
                <input id="capC" type="number" value="2.0" min="-10" max="15" step="0.1">
              </div>
            </div>
            <div class="row">
              <div>
                <label>ç¾é‡‘æ®–åˆ©ç‡ï¼ˆå¹´%ï¼‰</label>
                <input id="yldC" type="number" value="3.5" min="0" max="15" step="0.1">
              </div>
              <div class="mini">å¾ŒæœŸå¯ç”¨é•·æœŸå¹³å‡ï¼Œä½†å»ºè­°ä»è·‘å£“åŠ›æ¸¬è©¦ã€‚</div>
            </div>
          </div>
        </details>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">é€€ä¼‘å¾Œæ”¶å…¥</h3>
        <div class="row">
          <div>
            <label>å‹ä¿/å…¬ä¿ç­‰å¹´é‡‘ï¼ˆæ¯æœˆï¼Œè¬å…ƒï¼‰</label>
            <input id="monthlyPension" type="number" value="2.0" min="0" step="0.1">
          </div>
          <div>
            <label>å…¶ä»–é€€ä¼‘æ”¶å…¥ï¼ˆæ¯æœˆï¼Œè¬å…ƒï¼‰</label>
            <input id="monthlyOtherIncome" type="number" value="0.5" min="0" step="0.1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>å¹´é‡‘/æ”¶å…¥æ˜¯å¦éš¨é€šè†¨èª¿æ•´</label>
            <select id="incomeIndexMode">
              <option value="none" selected>ä¸èª¿æ•´ï¼ˆä¿å®ˆï¼‰</option>
              <option value="cpi">éš¨é€šè†¨èª¿æ•´ï¼ˆè¼ƒæ¨‚è§€ï¼‰</option>
              <option value="partial">éƒ¨åˆ†èª¿æ•´ï¼ˆåªèª¿æ•´ 50%ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ®–åˆ©ä½œç‚ºç¾é‡‘æµ</label>
            <select id="yieldAsCashflowAfter">
              <option value="yes" selected>æ˜¯ï¼ˆç”¨ä¾†æŠµæ”¯å‡ºï¼Œæ¸›å°‘æé ˜ï¼‰</option>
              <option value="no">å¦ï¼ˆé€€ä¼‘å¾Œä¹Ÿå†æŠ•å…¥ï¼Œæ”¯å‡ºå…¨é æé ˜ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">æé ˜ç­–ç•¥ï¼ˆæ–°å¢ï¼‰</h3>
        <div class="mini">
          <b>è£œç¼ºå£æé ˜</b>ï¼šæ”¯å‡ºå›ºå®šï¼ˆæœ€ç›´è§€ï¼‰ã€‚<br>
          <b>å›ºå®šæ¯”ä¾‹æé ˜</b>ï¼šæ¯å¹´æŒ‰è³‡ç”¢æ¯”ä¾‹æé ˜ï¼ˆæ›´åƒã€Œå¯æŒçºŒæé ˜ç‡ã€æ¡†æ¶ï¼‰ã€‚æ­¤æ™‚è¦æ±ºå®šæ”¯å‡ºæ˜¯å¦è·Ÿè‘—ç¸®æ”¾ï¼Œé¿å…æ¨¡å‹æ‰“æ¶ã€‚
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæé ˜æ–¹å¼</label>
            <select id="withdrawMode">
              <option value="gap" selected>è£œç¼ºå£æé ˜ï¼ˆå›ºå®šæ”¯å‡ºç›®æ¨™ï¼‰</option>
              <option value="pct">å›ºå®šæ¯”ä¾‹æé ˜ï¼ˆæ¯å¹´æŒ‰è³‡ç”¢%æé ˜ï¼‰</option>
            </select>
          </div>
          <div>
            <label>å›ºå®šæ¯”ä¾‹æé ˜ç‡ï¼ˆå¹´%ï¼‰</label>
            <input id="withdrawPct" type="number" value="4.0" min="0" max="12" step="0.1">
          </div>
        </div>

        <label>å›ºå®šæ¯”ä¾‹æ¨¡å¼ä¸‹ã€Œæ”¯å‡ºã€è™•ç†æ–¹å¼</label>
        <select id="withdrawSpendMode">
          <option value="fixed" selected>ç¶­æŒåŸæ”¯å‡ºç›®æ¨™ï¼ˆè‹¥ä¸è¶³ä»å¯èƒ½æ­¸é›¶ï¼‰</option>
          <option value="adaptive">æ”¯å‡ºè·Ÿè‘—å¯æ”¯é…ç¾é‡‘èª¿æ•´ï¼ˆæ›´ä¸æ˜“æ­¸é›¶ï¼‰</option>
          <option value="floor">è¨­æœ€ä½æ”¯å‡ºåº•ç·šï¼ˆ70%ï¼‰ï¼Œä¸è¶³å°±ç¸®ã€å¤ å°±å›åˆ°ç›®æ¨™</option>
        </select>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">å£“åŠ›æ¸¬è©¦ï¼ˆé¸ä¸€å€‹ï¼‰</h3>
        <div class="row">
          <div>
            <label>æƒ…å¢ƒ</label>
            <select id="stressMode">
              <option value="base" selected>åŸºæº–æƒ…å¢ƒ</option>
              <option value="lowreturn">ä½æˆé•·ï¼šå„æ®µè³‡æœ¬æˆé•·ç‡ -2%</option>
              <option value="highinfl">é«˜é€šè†¨ï¼šå„æ®µé€šè†¨ +2%</option>
              <option value="drawdown">é€€ä¼‘åˆæœŸå›æ’¤ï¼šé€€ä¼‘ç¬¬1å¹´ -20%ï¼ˆä¸€æ¬¡æ€§ï¼‰</option>
            </select>
          </div>
          <div>
            <label>è©•åˆ†é–€æª»</label>
            <select id="scoreRule">
              <option value="pass" selected>åŠæ ¼ï¼šä¸æ­¸é›¶</option>
              <option value="buffer">å„ªï¼šä¸æ­¸é›¶ä¸”æœ€ä½è³‡ç”¢ â‰¥ 3å¹´æ”¯å‡º</option>
            </select>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn" id="btnRun">ç«‹å³æ¨¡æ“¬</button>
          <button class="btn ghost" id="btnCSV">ä¸‹è¼‰å¹´åº¦æ˜ç´° CSV</button>
        </div>

        <div id="msgBox"></div>

        <footer>
          â€» æ•™è‚²ç”¨é€”ï¼šå±¬æƒ…å¢ƒè©¦ç®—ï¼›è«‹ç”¨ã€Œå¤šæƒ…å¢ƒ + å£“åŠ›æ¸¬è©¦ã€åˆ¤æ–·ï¼Œè€Œä¸æ˜¯è¿·ä¿¡å–®ä¸€æ•¸å­—ã€‚
        </footer>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="charts">
        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">çµæœæ‘˜è¦</h2>
          <div class="kpi">
            <div class="box">
              <div class="t">é€€ä¼‘æ™‚è³‡ç”¢ï¼ˆè¬å…ƒï¼‰</div>
              <div class="v" id="kpiAssetRet">â€”</div>
            </div>
            <div class="box">
              <div class="t">è³‡ç”¢æœ€ä½é»ï¼ˆè¬å…ƒï¼‰</div>
              <div class="v" id="kpiMinAsset">â€”</div>
            </div>
            <div class="box">
              <div class="t">çµè«– / è©•åˆ†</div>
              <div class="v" id="kpiScore">â€”</div>
            </div>
            <div class="box">
              <div class="t">é€€ä¼‘ç¬¬1å¹´æé ˜ç‡ï¼ˆä¼°ï¼‰</div>
              <div class="v" id="kpiWR1">â€”</div>
            </div>
          </div>
          <p class="small" id="kpiNote" style="margin:10px 0 0;"></p>

          <div class="conclusion" id="advisorBox" style="display:none;"></div>
        </div>

        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">è³‡ç”¢èµ°å‹¢ï¼ˆåç›® vs å¯¦è³ªï¼‰</h2>
          <canvas id="chartAsset" height="130"></canvas>
          <p class="small" style="margin:10px 0 0;">
            å¯¦è³ªè³‡ç”¢ï¼æŠŠåç›®è³‡ç”¢é™¤ä»¥é€šè†¨ç´¯ç©ï¼ˆä»¥ã€Œä»Šå¤©è³¼è²·åŠ›ã€çœ‹ä½ åˆ°åº•å‰©å¤šå°‘ï¼‰ã€‚
          </p>
        </div>

        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">é€€ä¼‘å¾Œï¼šæ”¶å…¥ vs æ”¯å‡ºï¼ˆå¹´åº¦ï¼‰</h2>
          <canvas id="chartFlow" height="150"></canvas>
          <p class="small" style="margin:10px 0 0;">
            è‹¥æ”¯å‡ºé•·æœŸé«˜æ–¼æ”¶å…¥ï¼ˆå«æ®–åˆ©ï¼‰ï¼Œå·®é¡ç”±æé ˜è£œæ´ â†’ è³‡ç”¢é€å¹´ä¸‹é™ã€‚
          </p>
        </div>

        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">å¹´åº¦æ˜ç´°</h2>

          <details open>
            <summary>ç²¾ç°¡æ¬„ä½ï¼ˆå»ºè­°å…ˆçœ‹ï¼‰ <span class="chip">ä¸å¢åŠ è¤‡é›œåº¦</span></summary>
            <div class="inner">
              <div class="tablewrap">
                <table id="tblSimple">
                  <thead>
                    <tr>
                      <th>å¹´é½¡</th>
                      <th>æœŸåˆè³‡ç”¢(è¬)</th>
                      <th>é€€ä¼‘æ”¯å‡º(å«ä¸€æ¬¡æ€§)(è¬)</th>
                      <th>æ”¶å…¥(å¹´é‡‘/å…¶ä»–)(è¬)</th>
                      <th>æ®–åˆ©(è¬)</th>
                      <th>æé ˜(è¬)</th>
                      <th>æœŸæœ«è³‡ç”¢(è¬)</th>
                      <th>æœŸæœ«è³‡ç”¢(å¯¦è³ª,è¬)</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </details>

          <details>
            <summary>å®Œæ•´æ¬„ä½ï¼ˆé€²éšæª¢æ ¸ï¼‰</summary>
            <div class="inner">
              <div class="tablewrap">
                <table id="tblFull">
                  <thead>
                    <tr>
                      <th>å¹´é½¡</th>
                      <th>é€šè†¨å› å­</th>
                      <th>æœŸåˆè³‡ç”¢(è¬)</th>
                      <th>æŠ•å…¥(è¬)</th>
                      <th>è³‡æœ¬æˆé•·(è¬)</th>
                      <th>ç¾é‡‘æ®–åˆ©(è¬)</th>
                      <th>é€€ä¼‘æ”¯å‡º(è¬)</th>
                      <th>å¹´é‡‘/å…¶ä»–(è¬)</th>
                      <th>ä¸€æ¬¡æ€§æ”¯å‡º(è¬)</th>
                      <th>æé ˜(è¬)</th>
                      <th>æœŸæœ«è³‡ç”¢(è¬)</th>
                      <th>æœŸæœ«è³‡ç”¢(å¯¦è³ª,è¬)</th>
                      <th>æ®µè½</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </details>

          <p class="small" style="margin-top:10px;">
            äº’å‹•æé†’ï¼šæŠŠã€Œé€šè†¨ã€ã€Œæ”¯å‡ºã€ã€Œè³‡æœ¬æˆé•·ã€ã€Œæ®–åˆ©ã€å„ä¸Šä¸‹èª¿ä¸€é»ï¼Œè§€å¯Ÿçµè«–æ˜¯å¦ç¿»è½‰â€”â€”é€™å°±æ˜¯ä½ çš„è„†å¼±é»ã€‚
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
  let assetChart, flowChart;
  let lastRows = [];

  function n(v){ return Number(v || 0); }
  function fmt(x){
    if (!isFinite(x)) return "â€”";
    return Math.round(x).toLocaleString("zh-Hant");
  }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function buildCSV(rows){
    const header = [
      "age","phase","infl_factor","begin_asset_wan","save_wan","cap_growth_wan","cash_yield_wan",
      "spend_wan","pension_other_wan","oneoff_wan","withdraw_wan",
      "end_asset_wan","end_asset_real_wan"
    ];
    const lines = [header.join(",")];
    rows.forEach(r=>{
      lines.push([
        r.age, r.phase, r.inflFactor, r.begin, r.save, r.capGrowth, r.cashYield,
        r.spend, r.pensionOther, r.oneoff, r.withdraw,
        r.end, r.endReal
      ].join(","));
    });
    return lines.join("\n");
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function indexFactor(mode, inflation){
    if (mode === "cpi") return inflation;
    if (mode === "partial") return inflation * 0.70;
    return 0;
  }
  function incomeIndexFactor(mode, inflation){
    if (mode === "cpi") return inflation;
    if (mode === "partial") return inflation * 0.50;
    return 0;
  }

  function phaseOf(age, ageRet, phaseYears){
    if (age < ageRet) return "A";              // ç´¯ç©æœŸ
    if (age < ageRet + phaseYears) return "B"; // é€€ä¼‘å‰æœŸ
    return "C";                                // é€€ä¼‘å¾ŒæœŸ
  }

  function simulate(){
    const ageNow = n(document.getElementById("ageNow").value);
    const ageRet = n(document.getElementById("ageRet").value);
    const ageEnd = n(document.getElementById("ageEnd").value);

    const assetNow = n(document.getElementById("assetNow").value); // è¬å…ƒ
    const monthlySave = n(document.getElementById("monthlySave").value); // è¬å…ƒ/æœˆ
    const monthlySpendReal = n(document.getElementById("monthlySpendReal").value); // è¬å…ƒ/æœˆ (today purchasing power)

    const spendIndexMode = document.getElementById("spendIndexMode").value;
    const reinvestBefore = document.getElementById("reinvestBefore").value; // yes/no
    const yieldAsCashflowAfter = document.getElementById("yieldAsCashflowAfter").value; // yes/no

    const monthlyPension = n(document.getElementById("monthlyPension").value);
    const monthlyOtherIncome = n(document.getElementById("monthlyOtherIncome").value);
    const incomeIndexMode = document.getElementById("incomeIndexMode").value;

    const oneOffCost = n(document.getElementById("oneOffCost").value); // è¬å…ƒï¼ˆé€€ä¼‘å¾Œä¸€æ¬¡æ€§ï¼‰
    const stressMode = document.getElementById("stressMode").value;
    const scoreRule = document.getElementById("scoreRule").value;

    const phaseYears = n(document.getElementById("phaseYears").value);
    const phaseHint = document.getElementById("phaseHint").value;

    const withdrawMode = document.getElementById("withdrawMode").value; // gap / pct
    const withdrawPct = n(document.getElementById("withdrawPct").value) / 100;
    const withdrawSpendMode = document.getElementById("withdrawSpendMode").value; // fixed/adaptive/floor

    // phase params
    let inflA = n(document.getElementById("inflA").value) / 100;
    let capA  = n(document.getElementById("capA").value)  / 100;
    let yldA  = n(document.getElementById("yldA").value)  / 100;

    let inflB = n(document.getElementById("inflB").value) / 100;
    let capB  = n(document.getElementById("capB").value)  / 100;
    let yldB  = n(document.getElementById("yldB").value)  / 100;

    let inflC = n(document.getElementById("inflC").value) / 100;
    let capC  = n(document.getElementById("capC").value)  / 100;
    let yldC  = n(document.getElementById("yldC").value)  / 100;

    // Basic validation
    if (ageRet <= ageNow) return {error: "é€€ä¼‘å¹´é½¡éœ€å¤§æ–¼ç›®å‰å¹´é½¡ã€‚"};
    if (ageEnd <= ageRet) return {error: "æ¨¡æ“¬çµ‚é»å¹´é½¡éœ€å¤§æ–¼é€€ä¼‘å¹´é½¡ã€‚"};
    if (assetNow < 0) return {error: "è³‡ç”¢ä¸å¯ç‚ºè² ã€‚"};
    if (phaseYears <= 0) return {error: "é€€ä¼‘å‰æœŸ N å¹´éœ€å¤§æ–¼ 0ã€‚"};
    if (!isFinite(withdrawPct) || withdrawPct < 0) return {error: "å›ºå®šæ¯”ä¾‹æé ˜ç‡éœ€ç‚ºéè² æ•¸ã€‚"};

    // One-key conservative (phase B)
    if (phaseHint === "auto"){
      capB = capB - 0.01;
      inflB = inflB + 0.005;
    }

    // Stress adjust
    let oneTimeDrawdownYear = null;
    if (stressMode === "lowreturn"){ capA -= 0.02; capB -= 0.02; capC -= 0.02; }
    if (stressMode === "highinfl"){ inflA += 0.02; inflB += 0.02; inflC += 0.02; }
    if (stressMode === "drawdown") oneTimeDrawdownYear = ageRet; // é€€ä¼‘ç¬¬1å¹´æœŸåˆç™¼ç”Ÿ

    // Guardrails
    const clampInfl = (x)=>clamp(x, 0, 0.20);
    const clampYld  = (x)=>clamp(x, 0, 0.30);
    const clampCap  = (x)=>clamp(x, -0.50, 0.50);

    inflA = clampInfl(inflA); inflB = clampInfl(inflB); inflC = clampInfl(inflC);
    yldA  = clampYld(yldA);   yldB  = clampYld(yldB);   yldC  = clampYld(yldC);
    capA  = clampCap(capA);   capB  = clampCap(capB);   capC  = clampCap(capC);

    const rows = [];
    let asset = assetNow;
    let minAsset = asset;
    let assetAtRet = null;

    // é€šè†¨å› å­ï¼ˆä»Šå¤©=1ï¼‰ï¼Œç”¨ä¾†æŠŠåç›®è½‰å¯¦è³ª
    let inflFactor = 1;

    // For advisor summary
    let firstRetRow = null;

    for (let age = ageNow; age < ageEnd; age++){
      const isRetired = age >= ageRet;
      const begin = asset;

      // decide phase
      const phase = phaseOf(age, ageRet, phaseYears);
      const thisInfl = (phase === "A") ? inflA : (phase === "B") ? inflB : inflC;
      const thisCap  = (phase === "A") ? capA  : (phase === "B") ? capB  : capC;
      const thisYld  = (phase === "A") ? yldA  : (phase === "B") ? yldB  : yldC;

      // æ›´æ–°é€šè†¨å› å­ï¼šç”¨ã€Œç•¶å¹´æ®µè½é€šè†¨ã€æ¨é€²
      if (age > ageNow){
        inflFactor *= (1 + thisInfl);
      }

      // ä¸€æ¬¡æ€§å›æ’¤ï¼ˆé€€ä¼‘ç¬¬ä¸€å¹´æœŸåˆï¼‰
      let beginAfterShock = begin;
      if (oneTimeDrawdownYear !== null && age === oneTimeDrawdownYear){
        beginAfterShock = begin * 0.80; // -20%
      }

      // é€€ä¼‘å‰æŠ•å…¥
      const save = isRetired ? 0 : (monthlySave * 12);

      // ç¾é‡‘æ®–åˆ©ï¼ˆä»¥æœŸåˆè³‡ç”¢è¨ˆç®—ï¼šç•¶æœŸç¾é‡‘æµï¼‰
      const cashIncome = beginAfterShock * thisYld;

      // è³‡æœ¬æˆé•·ï¼ˆä¸å«ç¾é‡‘æ®–åˆ©ï¼‰
      const capGain = beginAfterShock * thisCap;

      // é€€ä¼‘æ”¯å‡ºï¼ˆåç›®ï¼‰ï¼šä»¥ã€Œä»Šå¤©è³¼è²·åŠ›ã€ä¹˜ä¸Šæ”¯å‡ºèª¿æ•´ï¼ˆCPI/éƒ¨åˆ†/ä¸èª¿ï¼‰
      let spend = 0;
      if (isRetired){
        const spendIndex = indexFactor(spendIndexMode, thisInfl);
        const spendNominalMonthly = monthlySpendReal * Math.pow(1 + spendIndex, (age - ageNow));
        spend = spendNominalMonthly * 12;
      }

      // å¹´é‡‘/å…¶ä»–æ”¶å…¥ï¼ˆå¯é¸æ˜¯å¦éš¨é€šè†¨èª¿æ•´ï¼›ç”¨ç•¶å¹´æ®µè½é€šè†¨ï¼‰
      let pensionOther = 0;
      if (isRetired){
        const base = (monthlyPension + monthlyOtherIncome) * 12;
        const incomeIdx = incomeIndexFactor(incomeIndexMode, thisInfl);
        const adj = Math.pow(1 + incomeIdx, (age - ageNow));
        pensionOther = base * adj;
      }

      // ä¸€æ¬¡æ€§å¤§æ”¯å‡ºï¼šè¨­å®šç‚ºé€€ä¼‘ç¬¬ 1 å¹´ç™¼ç”Ÿ
      let oneoff = 0;
      if (isRetired && age === ageRet){
        oneoff = oneOffCost;
      }

      // é€€ä¼‘å¾Œï¼šæ”¶å…¥ä¾†æºï¼ˆå¹´é‡‘/å…¶ä»– + å¯èƒ½çš„æ®–åˆ©ï¼‰
      const yieldAsCash = (isRetired && yieldAsCashflowAfter === "yes");
      const inflow = pensionOther + (yieldAsCash ? cashIncome : 0);

      // ===== æé ˜ç­–ç•¥ï¼ˆå®Œæ•´ä¸€è‡´æ€§ï¼‰=====
      let withdraw = 0;

      if (isRetired){
        if (withdrawMode === "gap"){
          // è£œç¼ºå£ï¼šå›ºå®šæ”¯å‡ºç›®æ¨™
          const gap = (spend + oneoff) - inflow;
          withdraw = Math.max(0, gap);
        }else{
          // å›ºå®šæ¯”ä¾‹ï¼šå…ˆæ±ºå®šç•¶å¹´æé ˜é¡
          withdraw = Math.max(0, beginAfterShock * withdrawPct);

          // å†æ±ºå®šæ”¯å‡ºå¦‚ä½•è™•ç†ï¼ˆé¿å…è·Ÿå›ºå®šæ¯”ä¾‹æ‰“æ¶ï¼‰
          const totalAvailableCash = inflow + withdraw;

          if (withdrawSpendMode === "adaptive"){
            // æ”¯å‡ºè·Ÿè‘—å¯æ”¯é…ç¾é‡‘ï¼ˆæŠŠæ¨¡å‹è®Šæˆã€Œæ”¯å‡ºå¯è®Šã€ï¼‰
            spend = Math.max(0, totalAvailableCash - oneoff);
          }else if (withdrawSpendMode === "floor"){
            const spendFloor = spend * 0.70; // ä»¥ç›®æ¨™æ”¯å‡ºç‚ºåŸºæº–çš„åº•ç·š
            const adaptiveSpend = Math.max(0, totalAvailableCash - oneoff);
            spend = Math.max(spendFloor, adaptiveSpend);
          }else{
            // fixedï¼šç¶­æŒåŸæ”¯å‡ºç›®æ¨™ï¼ˆæ­¤æ™‚å¯èƒ½ä»æœƒæ­¸é›¶ï¼‰
          }

          // è‹¥ fixed/floor ä»è¶…å‡ºå¯æ”¯é…ç¾é‡‘ â†’ æœƒæœ‰é¡å¤–ç¼ºå£ï¼Œå¿…é ˆå†è£œï¼ˆå¦å‰‡æœƒå‡ºç¾ç¾é‡‘æµä¸å®ˆæ†ï¼‰
          // é€™è£¡ç”¨ã€Œé¡å¤–è£œæ´æé ˜ã€ç¢ºä¿ç¾é‡‘æµä¸€è‡´ï¼›ä½†æœƒå¢åŠ æ­¸é›¶é¢¨éšªï¼Œæ­£æ˜¯ fixed æ¨¡å¼çš„ç‰¹æ€§ã€‚
          const gapAfterRule = (spend + oneoff) - inflow;
          if (gapAfterRule > withdraw){
            withdraw = gapAfterRule; // éœ€è¦æ›´é«˜æé ˜æ‰èƒ½é”åˆ°æ”¯å‡º
          }
        }
      }

      // ===== è³‡ç”¢æ›´æ–°ï¼ˆé¿å… double countï¼‰=====
      // æœŸæœ« = æœŸåˆ(å«shock) + æŠ•å…¥ + è³‡æœ¬æˆé•·
      //      +ï¼ˆæ®–åˆ©è‹¥å†æŠ•å…¥ï¼‰ -ï¼ˆæé ˜ï¼‰
      let end = beginAfterShock + save + capGain;

      // æ®–åˆ©å…¥è³‡ç”¢çš„è¦å‰‡ï¼š
      // - é€€ä¼‘å‰ï¼šè‹¥é¸å†æŠ•å…¥ï¼Œæ®–åˆ©åŠ å…¥è³‡ç”¢ï¼›è‹¥ä¸å†æŠ•å…¥ï¼Œè¦–ç‚ºæ‹¿å»èŠ±ï¼Œä¸åŠ å›
      // - é€€ä¼‘å¾Œï¼šè‹¥æ®–åˆ©æ‹¿ä¾†ç•¶ç¾é‡‘æµæŠµæ”¯å‡ºï¼ˆyieldAsCash=trueï¼‰ï¼Œå°±ä¸åŠ å›è³‡ç”¢ï¼›
      //          è‹¥é€€ä¼‘å¾Œä¹Ÿå†æŠ•å…¥ï¼ˆyieldAsCash=falseï¼‰ï¼Œå‰‡åŠ å›è³‡ç”¢
      if (!isRetired){
        if (reinvestBefore === "yes") end += cashIncome;
      }else{
        if (!yieldAsCash) end += cashIncome;
      }

      // æ‰£æé ˜
      end -= withdraw;

      // ä¸ä½æ–¼0
      if (end < 0) end = 0;

      // é€€ä¼‘æ™‚è³‡ç”¢ï¼ˆé€€ä¼‘å‰ä¸€å¹´æœŸæœ«ï¼‰
      if (age === ageRet - 1){
        assetAtRet = end;
      }

      const endReal = end / inflFactor; // ä»¥ä»Šå¤©è³¼è²·åŠ›

      const row = {
        age,
        phase,
        inflFactor: +inflFactor.toFixed(4),
        begin: +beginAfterShock.toFixed(2),
        save: +save.toFixed(2),
        capGrowth: +capGain.toFixed(2),
        cashYield: +cashIncome.toFixed(2),
        spend: +spend.toFixed(2),
        pensionOther: +pensionOther.toFixed(2),
        oneoff: +oneoff.toFixed(2),
        withdraw: +withdraw.toFixed(2),
        end: +end.toFixed(2),
        endReal: +endReal.toFixed(2),
        inflow: +inflow.toFixed(2)
      };

      rows.push(row);

      if (isRetired && age === ageRet) firstRetRow = row;

      asset = end;
      if (asset < minAsset) minAsset = asset;
    }

    // Score
    const neverZero = minAsset > 0.0001;
    let score = "â€”";
    let note = "";

    if (scoreRule === "pass"){
      score = neverZero ? "åŠæ ¼ âœ…" : "ä¸åŠæ ¼ âš ï¸";
      note = neverZero
        ? "è³‡ç”¢æœªåœ¨æ¨¡æ“¬æœŸé–“æ­¸é›¶ã€‚ä¸‹ä¸€æ­¥è«‹åˆ‡æ›å£“åŠ›æ¸¬è©¦ï¼Œç‰¹åˆ¥çœ‹é€€ä¼‘åˆæœŸå›æ’¤èˆ‡é«˜é€šè†¨ã€‚"
        : "è³‡ç”¢æœƒåœ¨æ¨¡æ“¬æœŸé–“æ­¸é›¶ã€‚é€šå¸¸éœ€è¦ï¼šé™ä½æ”¯å‡ºã€å»¶å¾Œé€€ä¼‘ã€æé«˜æŠ•å…¥ã€æˆ–æé«˜å¯æŒçºŒç¾é‡‘æµï¼ˆæ®–åˆ©/å¹´é‡‘ï¼‰ã€‚";
    }else{
      const r = firstRetRow;
      const threeYearsSpend = r ? (r.spend * 3) : 0;
      const okBuffer = neverZero && (minAsset >= threeYearsSpend);

      score = okBuffer ? "å„ª âœ…" : (neverZero ? "åŠæ ¼ âœ…" : "ä¸åŠæ ¼ âš ï¸");
      note = okBuffer
        ? "è³‡ç”¢ä¸æ­¸é›¶ä¸”ä¿æœ‰ 3 å¹´æ”¯å‡ºå®‰å…¨é‚Šéš›ã€‚å»ºè­°æŠŠç„¦é»è½‰å‘ï¼šé†«ç™‚/é•·ç…§ã€æˆ¿å±‹å¤§ä¿®ç¹•ã€èˆ‡å›æ’¤å¹´ä»½çš„æ‡‰å°ã€‚"
        : (neverZero
          ? "é›–æœªæ­¸é›¶ï¼Œä½†å®‰å…¨é‚Šéš›ä¸è¶³ï¼ˆé‡åˆ°å›æ’¤/å¤§æ”¯å‡ºæ™‚å®¹æ˜“ç¿»è»Šï¼‰ã€‚å»ºè­°æŠŠæœ€ä½è³‡ç”¢æ‹‰åˆ°è‡³å°‘ 3 å¹´æ”¯å‡ºã€‚"
          : "è³‡ç”¢æœƒæ­¸é›¶ï¼Œéœ€èª¿æ•´ç­–ç•¥ã€‚");
    }

    // KPIï¼šé€€ä¼‘ç¬¬ä¸€å¹´æé ˜ç‡ï¼ˆä¼°ï¼‰
    let wr1 = null;
    if (firstRetRow && assetAtRet && assetAtRet > 0){
      wr1 = firstRetRow.withdraw / assetAtRet;
    }

    // Advisor summary inputs
    const advisor = buildAdvisorSummary({
      score,
      neverZero,
      minAsset,
      assetAtRet,
      firstRetRow,
      withdrawMode,
      withdrawSpendMode,
      stressMode
    });

    return {rows, assetAtRet, minAsset, score, note, wr1, advisor};
  }

  function buildAdvisorSummary(x){
    const {score, neverZero, minAsset, assetAtRet, firstRetRow, withdrawMode, withdrawSpendMode, stressMode} = x;

    const lines = [];
    const tips = [];

    const modeText =
      (withdrawMode === "gap")
        ? "è£œç¼ºå£æé ˜ï¼ˆæ”¯å‡ºå›ºå®šç›®æ¨™ï¼‰"
        : `å›ºå®šæ¯”ä¾‹æé ˜ï¼ˆæ”¯å‡ºæ¨¡å¼ï¼š${
            withdrawSpendMode === "adaptive" ? "è·Ÿè‘—å¯æ”¯é…ç¾é‡‘èª¿æ•´"
            : withdrawSpendMode === "floor" ? "æœ‰ 70% åº•ç·š"
            : "ç¶­æŒåŸæ”¯å‡ºç›®æ¨™"
          }ï¼‰`;

    lines.push(`ä½ ç›®å‰ä½¿ç”¨ï¼š<b>${modeText}</b>ï¼›å£“åŠ›æ¸¬è©¦æƒ…å¢ƒï¼š<b>${stressMode}</b>ã€‚`);

    if (assetAtRet != null){
      lines.push(`é€€ä¼‘æ™‚è³‡ç”¢ç´„ <b>${fmt(assetAtRet)}</b> è¬å…ƒï¼›æ¨¡æ“¬æœŸé–“æœ€ä½è³‡ç”¢ç´„ <b>${fmt(minAsset)}</b> è¬å…ƒã€‚`);
    }

    if (firstRetRow){
      const spend1 = firstRetRow.spend + firstRetRow.oneoff;
      const income1 = firstRetRow.inflow;
      const gap1 = Math.max(0, spend1 - income1);
      const cover = (spend1 > 0) ? (income1 / spend1) : 0;

      lines.push(`é€€ä¼‘ç¬¬1å¹´ï¼šæ”¯å‡ºï¼ˆå«ä¸€æ¬¡æ€§ï¼‰ç´„ <b>${fmt(spend1)}</b> è¬/å¹´ï¼›æ”¶å…¥ï¼ˆå«æ®–åˆ©è‹¥é¸ç¾é‡‘æµï¼‰ç´„ <b>${fmt(income1)}</b> è¬/å¹´ã€‚`);
      lines.push(`æ”¶å…¥è¦†è“‹ç‡ç´„ <b>${(cover*100).toFixed(0)}%</b>ï¼›ç¼ºå£ç´„ <b>${fmt(gap1)}</b> è¬/å¹´ï¼ˆç´„ ${(gap1/12).toFixed(1)} è¬/æœˆï¼‰ã€‚`);

      if (cover < 0.7) tips.push("æ”¶å…¥è¦†è“‹ç‡åä½ï¼šå„ªå…ˆè™•ç†ã€Œé™ä½æ”¯å‡ºã€æˆ–ã€Œæé«˜å¯æŒçºŒç¾é‡‘æµã€ï¼ˆå¹´é‡‘/æ®–åˆ©/æˆ¿ç§Ÿï¼‰ã€‚");
      if (firstRetRow.oneoff > 0) tips.push("æœ‰ä¸€æ¬¡æ€§æ”¯å‡ºï¼šå»ºè­°åœ¨é€€ä¼‘å‰é ç•™å°ˆæ¬¾æˆ–åˆ†æ”¤åˆ°å‰å¹¾å¹´ï¼Œé¿å…å–®å¹´æŠ½è¡€ã€‚");
    }

    if (!neverZero){
      tips.push("æ­¤æƒ…å¢ƒä¸‹æœƒæ­¸é›¶ï¼šå…ˆå˜—è©¦å»¶å¾Œé€€ä¼‘ 2 å¹´æˆ–æŠŠæ”¯å‡ºä¸‹ä¿® 10%ï¼Œå†è§€å¯Ÿæ˜¯å¦ç¿»è½‰ã€‚");
      tips.push("ä¹Ÿå¯æŠŠã€Œå›ºå®šæ¯”ä¾‹æé ˜ã€æ”¹æˆã€Œadaptive / floorã€ï¼Œé€šå¸¸èƒ½é¡¯è‘—é™ä½æ­¸é›¶é¢¨éšªï¼ˆä½†æ”¯å‡ºå¯èƒ½æ³¢å‹•ï¼‰ã€‚");
    }else{
      tips.push("é›–å¯è¡Œï¼Œä»å»ºè­°åˆ‡æ›ã€Œé€€ä¼‘åˆæœŸå›æ’¤ã€èˆ‡ã€Œé«˜é€šè†¨ã€ç¢ºèªæŠ—å£“æ€§ã€‚");
      tips.push("æŠŠä¸‰æ®µæœŸä¸­çš„ã€Œé€€ä¼‘å‰æœŸã€è¨­æ›´ä¿å®ˆï¼Œæ˜¯é¿å…åºåˆ—é¢¨éšªçš„é—œéµã€‚");
    }

    return { lines, tips };
  }

  function render(res){
    const msgBox = document.getElementById("msgBox");
    msgBox.innerHTML = "";

    if (res.error){
      msgBox.innerHTML = `<div class="warn">${res.error}</div>`;
      return;
    }

    const rows = res.rows;
    lastRows = rows;

    // KPI
    document.getElementById("kpiAssetRet").textContent = fmt(res.assetAtRet);
    document.getElementById("kpiMinAsset").textContent = fmt(res.minAsset);
    document.getElementById("kpiScore").textContent = res.score;
    document.getElementById("kpiWR1").textContent = (res.wr1==null) ? "â€”" : (res.wr1*100).toFixed(1) + "%";
    document.getElementById("kpiNote").textContent = res.note;

    // Advisor box
    const adv = document.getElementById("advisorBox");
    adv.style.display = "block";
    adv.innerHTML = `
      <b>é¡§å•å¼çµè«–ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</b>
      <ul class="ul">${res.advisor.lines.map(s=>`<li>${s}</li>`).join("")}</ul>
      <b style="display:block;margin-top:8px">ä¸‹ä¸€æ­¥å»ºè­°</b>
      <ul class="ul">${res.advisor.tips.map(s=>`<li>${s}</li>`).join("")}</ul>
    `;

    // message box
    msgBox.innerHTML = (res.score.includes("ä¸åŠæ ¼"))
      ? `<div class="warn"><b>æé†’ï¼š</b>æ­¤æƒ…å¢ƒä¸‹æœƒå‡ºç¾è³‡ç”¢æ­¸é›¶é¢¨éšªã€‚å…ˆæŠŠã€Œé€€ä¼‘å¾Œæ”¯å‡ºã€é™ä½ 10% æˆ–ã€Œå»¶å¾Œé€€ä¼‘ã€2 å¹´ï¼Œæˆ–æ”¹ç”¨ã€Œå›ºå®šæ¯”ä¾‹æé ˜ + adaptive/floorã€å†è·‘ä¸€æ¬¡ã€‚</div>`
      : `<div class="ok"><b>çœ‹èµ·ä¾†å¯è¡Œï¼š</b>æ­¤æƒ…å¢ƒä¸‹å¯ç¶­æŒç¾é‡‘æµã€‚æ¥è‘—è«‹åˆ‡æ›å£“åŠ›æ¸¬è©¦ï¼ˆé€€ä¼‘åˆæœŸå›æ’¤ã€é«˜é€šè†¨ã€ä½æˆé•·ï¼‰ç¢ºèªæŠ—å£“æ€§ã€‚</div>`;

    // Tables
    const tbodyS = document.querySelector("#tblSimple tbody");
    const tbodyF = document.querySelector("#tblFull tbody");
    tbodyS.innerHTML = "";
    tbodyF.innerHTML = "";

    rows.forEach(r=>{
      const trS = document.createElement("tr");
      trS.innerHTML = `
        <td>${r.age}</td>
        <td>${fmt(r.begin)}</td>
        <td>${fmt(r.spend + r.oneoff)}</td>
        <td>${fmt(r.pensionOther)}</td>
        <td>${fmt(r.cashYield)}</td>
        <td>${fmt(r.withdraw)}</td>
        <td>${fmt(r.end)}</td>
        <td>${fmt(r.endReal)}</td>
      `;
      tbodyS.appendChild(trS);

      const trF = document.createElement("tr");
      trF.innerHTML = `
        <td>${r.age}</td>
        <td>${r.inflFactor}</td>
        <td>${fmt(r.begin)}</td>
        <td>${fmt(r.save)}</td>
        <td>${fmt(r.capGrowth)}</td>
        <td>${fmt(r.cashYield)}</td>
        <td>${fmt(r.spend)}</td>
        <td>${fmt(r.pensionOther)}</td>
        <td>${fmt(r.oneoff)}</td>
        <td>${fmt(r.withdraw)}</td>
        <td>${fmt(r.end)}</td>
        <td>${fmt(r.endReal)}</td>
        <td>${r.phase}</td>
      `;
      tbodyF.appendChild(trF);
    });

    // Charts
    const labels = rows.map(r=>String(r.age));
    const assetsNom = rows.map(r=>r.end);
    const assetsReal = rows.map(r=>r.endReal);

    const retRows = rows.filter(r=>r.spend > 0 || r.pensionOther > 0 || r.oneoff > 0);
    const labelsRet = retRows.map(r=>String(r.age));
    const spendRet = retRows.map(r=>r.spend + r.oneoff);
    const yieldAsCash = (document.getElementById("yieldAsCashflowAfter").value==="yes");
    const incomeRet = retRows.map(r=>r.pensionOther + (yieldAsCash ? r.cashYield : 0));

    if (assetChart) assetChart.destroy();
    if (flowChart) flowChart.destroy();

    assetChart = new Chart(document.getElementById("chartAsset"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "æœŸæœ«è³‡ç”¢ï¼ˆåç›®ï¼Œè¬å…ƒï¼‰", data: assetsNom, tension: 0.25 },
          { label: "æœŸæœ«è³‡ç”¢ï¼ˆå¯¦è³ªï¼Œè¬å…ƒï¼‰", data: assetsReal, tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          y: { ticks: { callback: (v)=> Number(v).toLocaleString("zh-Hant") } }
        }
      }
    });

    flowChart = new Chart(document.getElementById("chartFlow"), {
      type: "line",
      data: {
        labels: labelsRet,
        datasets: [
          { label: "é€€ä¼‘æ”¯å‡ºï¼ˆå«ä¸€æ¬¡æ€§ï¼Œè¬å…ƒ/å¹´ï¼‰", data: spendRet, tension: 0.25 },
          { label: "æ”¶å…¥ï¼ˆå¹´é‡‘/å…¶ä»– + æ®–åˆ©ï¼Œè¬å…ƒ/å¹´ï¼‰", data: incomeRet, tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          y: { ticks: { callback: (v)=> Number(v).toLocaleString("zh-Hant") } }
        }
      }
    });
  }

  document.getElementById("btnRun").addEventListener("click", ()=> render(simulate()));

  document.getElementById("btnCSV").addEventListener("click", ()=>{
    if (!lastRows || lastRows.length === 0){
      render({error:"è«‹å…ˆæŒ‰ã€Œç«‹å³æ¨¡æ“¬ã€ï¼Œç”¢ç”Ÿå¹´åº¦æ˜ç´°å¾Œå†ä¸‹è¼‰ã€‚"});
      return;
    }
    const csv = buildCSV(lastRows);
    downloadText("retirement_cashflow_detail.csv", csv);
  });

  // åˆå§‹è‡ªå‹•è·‘ä¸€æ¬¡
  render(simulate());
</script>
</body>
</html>
