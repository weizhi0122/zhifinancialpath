<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é€€ä¼‘ç¾é‡‘æµæ¨¡æ“¬å·¥å…·ï½œæ™º Financial Path</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="é€€ä¼‘ç¾é‡‘æµæ¨¡æ“¬ï¼šå€åˆ†è³‡æœ¬æˆé•·èˆ‡ç¾é‡‘æ®–åˆ©ç‡ã€é€šè†¨/å¯¦è³ªè³¼è²·åŠ›ã€å£“åŠ›æ¸¬è©¦ã€é€€ä¼‘åˆæœŸåºåˆ—é¢¨éšªã€åœ–è¡¨èˆ‡å¹´åº¦æ˜ç´°ã€‚" />

  <!-- Chart.js CDNï¼ˆç´”å‰ç«¯ï¼ŒGitHub Pages å¯ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f6f8fb;color:#333;line-height:1.8}
    .topbar{background:#fff;border-bottom:1px solid #e6e8ee;padding:12px 20px;position:sticky;top:0;z-index:999}
    .topbar .inner{max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .topbar a{color:#0b3d91;text-decoration:none;font-size:14px}
    .container{max-width:1100px;margin:auto;padding:22px 20px 70px}
    h1,h2,h3{color:#0b3d91;margin:0 0 10px}
    .muted{color:#666;font-size:14px}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){ .row{grid-template-columns:1fr} }

    label{display:block;font-size:13px;color:#444;margin:10px 0 6px}
    input,select{width:100%;padding:10px 10px;border:1px solid #d7deea;border-radius:10px;font-size:14px;background:#fff}
    input:focus,select:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-block;background:#0b3d91;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;border:0;cursor:pointer;font-size:14px}
    .btn:hover{opacity:.92}
    .btn.ghost{background:#fff;color:#0b3d91;border:1px solid #cfe0ff}

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    @media (max-width: 720px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{background:#f3f7ff;border:1px solid #dfeaff;border-radius:12px;padding:12px}
    .kpi .box .t{font-size:12px;color:#4a5b7a}
    .kpi .box .v{font-size:18px;font-weight:700;color:#0b3d91;margin-top:4px}

    .charts{display:grid;grid-template-columns:1fr;gap:14px}
    canvas{background:#fff;border-radius:14px}
    .tablewrap{overflow:auto;border-radius:14px;border:1px solid #e6e8ee}
    table{border-collapse:collapse;width:100%;min-width:980px;background:#fff}
    th,td{padding:10px 10px;border-bottom:1px solid #eef1f6;text-align:right;font-size:13px;white-space:nowrap}
    th{text-align:right;background:#f7f9fd;color:#0b3d91;position:sticky;top:0}
    td:first-child, th:first-child{text-align:left}
    .warn{background:#fff4f4;border-left:4px solid #d92c2c;padding:12px;border-radius:12px;margin-top:12px}
    .ok{background:#f1fff5;border-left:4px solid #15a34a;padding:12px;border-radius:12px;margin-top:12px}
    .small{font-size:13px;color:#666}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:#0b3d91;border:1px solid #dbe7ff}
    footer{margin-top:18px;color:#777;font-size:12px}

    .mini{font-size:12px;color:#7a8699;line-height:1.4;margin-top:6px}
    .hr{border:none;border-top:1px solid #eef1f6;margin:14px 0}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <a href="./tools.html">â† å›å·¥å…·</a>
      <div>
        <a href="./index.html" style="margin-right:14px;">ğŸ  å›ä¸»é </a>
        <a href="./library.html">ğŸ“š çŸ¥è­˜åº«</a>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¾é‡‘æµæ¨¡æ“¬å·¥å…· <span class="pill">æ›´çœŸå¯¦ï¼šé¿å… double countã€åŒæ™‚çœ‹åç›®/å¯¦è³ªè³¼è²·åŠ›</span></h1>
    <p class="muted">
      é€™å€‹å·¥å…·ç”¨ã€Œå¹´åº¦ç¾é‡‘æµã€åšæ¨¡æ“¬ï¼šæŠŠé€šè†¨ã€è³‡ç”¢æˆé•·ï¼ˆè³‡æœ¬åˆ©å¾—ï¼‰ã€ç¾é‡‘æ®–åˆ©ç‡ï¼ˆè‚¡åˆ©/ç§Ÿé‡‘/é…æ¯ç­‰ï¼‰ã€é€€ä¼‘æ”¯å‡ºã€å¹´é‡‘æ”¶å…¥èˆ‡å¿…è¦æé ˜æ•´åˆæˆä¸€å¼µè¡¨ï¼Œ
      ä¸¦åŠ å…¥ã€Œé€€ä¼‘åˆæœŸåºåˆ—é¢¨éšªã€èˆ‡ã€Œå£“åŠ›æ¸¬è©¦ã€ã€‚
    </p>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <h2 style="font-size:18px;margin-bottom:6px;">è¼¸å…¥</h2>
        <p class="small" style="margin:0 0 8px;">
          å–®ä½ï¼šé‡‘é¡ä»¥ã€Œè¬å…ƒã€ï¼›æœˆé‡‘é¡æœƒè‡ªå‹•æ›ç®—æˆå¹´åº¦ã€‚
        </p>

        <div class="row">
          <div>
            <label>ç›®å‰å¹´é½¡</label>
            <input id="ageNow" type="number" value="35" min="18" max="80">
          </div>
          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <input id="ageRet" type="number" value="60" min="30" max="85">
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ¨¡æ“¬åˆ°å¹¾æ­²ï¼ˆå£½å‘½å‡è¨­ï¼‰</label>
            <input id="ageEnd" type="number" value="90" min="60" max="110">
          </div>
          <div>
            <label>ç›®å‰å¯æŠ•è³‡è³‡ç”¢ï¼ˆè¬å…ƒï¼‰</label>
            <input id="assetNow" type="number" value="800" min="0" step="1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆå¯æŠ•å…¥ï¼ˆè¬å…ƒï¼‰</label>
            <input id="monthlySave" type="number" value="3" min="0" step="0.1">
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™æ”¯å‡ºï¼ˆè¬å…ƒï¼Œä»¥ã€Œä»Šå¤©ã€è³¼è²·åŠ›ï¼‰</label>
            <input id="monthlySpendReal" type="number" value="6" min="0" step="0.1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€šè†¨ç‡ï¼ˆå¹´ï¼‰</label>
            <input id="inflation" type="number" value="2.0" min="0" max="10" step="0.1">
          </div>
          <div>
            <label>æ”¯å‡ºèª¿æ•´æ–¹å¼</label>
            <select id="spendIndexMode">
              <option value="cpi" selected>æ¯å¹´éš¨é€šè†¨ï¼ˆCPIï¼‰èª¿æ•´</option>
              <option value="partial">éƒ¨åˆ†èª¿æ•´ï¼ˆåªèª¿æ•´ 70%ï¼‰</option>
              <option value="flat">ä¸èª¿æ•´ï¼ˆåç›®å›ºå®šï¼‰</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">å ±é…¬æ‹†è§£ï¼ˆæ›´çœŸå¯¦ï¼‰</h3>
        <div class="mini">
          ä»¥å‰ç‰ˆæœ¬å®¹æ˜“ã€Œdouble countã€ï¼šåŒæ™‚ç”¨ç¸½å ±é…¬ç‡æˆé•·ã€åˆæŠŠè¢«å‹•æ”¶ç›Šç•¶æ”¶å…¥æŠµæ”¯å‡ºã€‚é€™ç‰ˆæ”¹ç‚ºï¼š<br>
          <b>è³‡æœ¬æˆé•·ç‡ï¼ˆä¸å«ç¾é‡‘æ®–åˆ©ï¼‰</b>ï¼‹<b>ç¾é‡‘æ®–åˆ©ç‡ï¼ˆè‚¡åˆ©/ç§Ÿé‡‘/é…æ¯ï¼‰</b>ï¼Œå…©è€…åˆ†é–‹è¨ˆã€‚
        </div>

        <div class="row">
          <div>
            <label>è³‡æœ¬æˆé•·ç‡ï¼ˆå¹´ï¼Œä¸å«è‚¡åˆ©/ç§Ÿé‡‘ï¼‰</label>
            <input id="capGrowth" type="number" value="2.0" min="-10" max="15" step="0.1">
          </div>
          <div>
            <label>ç¾é‡‘æ®–åˆ©ç‡ï¼ˆå¹´ï¼Œè‚¡åˆ©/ç§Ÿé‡‘/é…æ¯ï¼‰</label>
            <input id="cashYield" type="number" value="3.5" min="0" max="15" step="0.1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ®–åˆ©æ˜¯å¦å†æŠ•å…¥ï¼ˆé€€ä¼‘å‰ï¼‰</label>
            <select id="reinvestBefore">
              <option value="yes" selected>æ˜¯ï¼ˆç´¯ç©æœŸå†æŠ•å…¥ï¼‰</option>
              <option value="no">å¦ï¼ˆç´¯ç©æœŸç•¶ä½œæ”¶å…¥ä½¿ç”¨ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ®–åˆ©ä½œç‚ºç¾é‡‘æµ</label>
            <select id="yieldAsCashflowAfter">
              <option value="yes" selected>æ˜¯ï¼ˆç”¨ä¾†æŠµæ”¯å‡ºï¼Œæ¸›å°‘æé ˜ï¼‰</option>
              <option value="no">å¦ï¼ˆé€€ä¼‘å¾Œä¹Ÿå†æŠ•å…¥ï¼Œæ”¯å‡ºå…¨é æé ˜ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">é€€ä¼‘å¾Œæ”¶å…¥</h3>
        <div class="row">
          <div>
            <label>å‹ä¿/å…¬ä¿ç­‰å¹´é‡‘ï¼ˆæ¯æœˆï¼Œè¬å…ƒï¼‰</label>
            <input id="monthlyPension" type="number" value="2.0" min="0" step="0.1">
          </div>
          <div>
            <label>å…¶ä»–é€€ä¼‘æ”¶å…¥ï¼ˆæ¯æœˆï¼Œè¬å…ƒï¼‰</label>
            <input id="monthlyOtherIncome" type="number" value="0.5" min="0" step="0.1">
          </div>
        </div>

        <div class="row">
          <div>
            <label>å¹´é‡‘/æ”¶å…¥æ˜¯å¦éš¨é€šè†¨èª¿æ•´</label>
            <select id="incomeIndexMode">
              <option value="none" selected>ä¸èª¿æ•´ï¼ˆä¿å®ˆï¼‰</option>
              <option value="cpi">éš¨é€šè†¨èª¿æ•´ï¼ˆè¼ƒæ¨‚è§€ï¼‰</option>
              <option value="partial">éƒ¨åˆ†èª¿æ•´ï¼ˆåªèª¿æ•´ 50%ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œä¸€æ¬¡æ€§å¤§æ”¯å‡ºï¼ˆè¬å…ƒï¼‰</label>
            <input id="oneOffCost" type="number" value="0" min="0" step="1">
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="font-size:16px;margin:0 0 4px;">å£“åŠ›æ¸¬è©¦ï¼ˆé¸ä¸€å€‹ï¼‰</h3>
        <div class="row">
          <div>
            <label>æƒ…å¢ƒ</label>
            <select id="stressMode">
              <option value="base" selected>åŸºæº–æƒ…å¢ƒ</option>
              <option value="lowreturn">ä½æˆé•·ï¼šè³‡æœ¬æˆé•·ç‡ -2%</option>
              <option value="highinfl">é«˜é€šè†¨ï¼šé€šè†¨ +2%</option>
              <option value="drawdown">é€€ä¼‘åˆæœŸå›æ’¤ï¼šé€€ä¼‘ç¬¬1å¹´ -20%ï¼ˆä¸€æ¬¡æ€§ï¼‰</option>
              <option value="bad5">åºåˆ—é¢¨éšªï¼šé€€ä¼‘å‰5å¹´æˆé•·ç‡ä¸‹é™ï¼ˆ-3%ï¼‰</option>
            </select>
          </div>
          <div>
            <label>è©•åˆ†é–€æª»</label>
            <select id="scoreRule">
              <option value="pass" selected>åŠæ ¼ï¼šä¸æ­¸é›¶</option>
              <option value="buffer">å„ªï¼šä¸æ­¸é›¶ä¸”æœ€ä½è³‡ç”¢ â‰¥ 3å¹´æ”¯å‡º</option>
            </select>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn" id="btnRun">ç«‹å³æ¨¡æ“¬</button>
          <button class="btn ghost" id="btnCSV">ä¸‹è¼‰å¹´åº¦æ˜ç´° CSV</button>
        </div>

        <div id="msgBox"></div>

        <footer>
          â€» æ•™è‚²ç”¨é€”ï¼šå±¬æƒ…å¢ƒè©¦ç®—ï¼›è«‹å‹™å¿…ç”¨ã€Œå¤šæƒ…å¢ƒ + å£“åŠ›æ¸¬è©¦ã€åˆ¤æ–·ï¼Œè€Œä¸æ˜¯è¿·ä¿¡å–®ä¸€æ•¸å­—ã€‚
        </footer>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="charts">
        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">çµæœæ‘˜è¦</h2>
          <div class="kpi">
            <div class="box">
              <div class="t">é€€ä¼‘æ™‚è³‡ç”¢ï¼ˆè¬å…ƒï¼‰</div>
              <div class="v" id="kpiAssetRet">â€”</div>
            </div>
            <div class="box">
              <div class="t">è³‡ç”¢æœ€ä½é»ï¼ˆè¬å…ƒï¼‰</div>
              <div class="v" id="kpiMinAsset">â€”</div>
            </div>
            <div class="box">
              <div class="t">çµè«– / è©•åˆ†</div>
              <div class="v" id="kpiScore">â€”</div>
            </div>
          </div>
          <p class="small" id="kpiNote" style="margin:10px 0 0;"></p>
        </div>

        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">è³‡ç”¢èµ°å‹¢ï¼ˆåç›® vs å¯¦è³ªï¼‰</h2>
          <canvas id="chartAsset" height="130"></canvas>
          <p class="small" style="margin:10px 0 0;">
            å¯¦è³ªè³‡ç”¢ï¼æŠŠåç›®è³‡ç”¢é™¤ä»¥é€šè†¨ç´¯ç©ï¼ˆä»¥ã€Œä»Šå¤©è³¼è²·åŠ›ã€çœ‹ä½ åˆ°åº•å‰©å¤šå°‘ï¼‰ã€‚
          </p>
        </div>

        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">é€€ä¼‘å¾Œï¼šæ”¶å…¥ vs æ”¯å‡ºï¼ˆå¹´åº¦ï¼‰</h2>
          <canvas id="chartFlow" height="150"></canvas>
          <p class="small" style="margin:10px 0 0;">
            è‹¥æ”¯å‡ºé•·æœŸé«˜æ–¼æ”¶å…¥ï¼ˆå«æ®–åˆ©ï¼‰ï¼Œå·®é¡ç”±æé ˜è£œæ´ â†’ è³‡ç”¢é€å¹´ä¸‹é™ã€‚
          </p>
        </div>

        <div class="card">
          <h2 style="font-size:18px;margin-bottom:6px;">å¹´åº¦æ˜ç´°</h2>
          <div class="tablewrap">
            <table id="tbl">
              <thead>
                <tr>
                  <th>å¹´é½¡</th>
                  <th>é€šè†¨å› å­</th>
                  <th>æœŸåˆè³‡ç”¢(è¬)</th>
                  <th>æŠ•å…¥(è¬)</th>
                  <th>è³‡æœ¬æˆé•·(è¬)</th>
                  <th>ç¾é‡‘æ®–åˆ©(è¬)</th>
                  <th>é€€ä¼‘æ”¯å‡º(è¬)</th>
                  <th>å¹´é‡‘/å…¶ä»–(è¬)</th>
                  <th>ä¸€æ¬¡æ€§æ”¯å‡º(è¬)</th>
                  <th>æé ˜è£œæ´(è¬)</th>
                  <th>æœŸæœ«è³‡ç”¢(è¬)</th>
                  <th>æœŸæœ«è³‡ç”¢(å¯¦è³ª,è¬)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p class="small" style="margin-top:10px;">
            äº’å‹•æé†’ï¼šæŠŠã€Œé€šè†¨ã€ã€Œæ”¯å‡ºã€ã€Œè³‡æœ¬æˆé•·ã€ã€Œæ®–åˆ©ã€å„ä¸Šä¸‹èª¿ä¸€é»ï¼Œè§€å¯Ÿçµè«–æ˜¯å¦ç¿»è½‰â€”â€”é€™å°±æ˜¯ä½ çš„è„†å¼±é»ã€‚
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
  let assetChart, flowChart;
  let lastRows = [];

  function n(v){ return Number(v || 0); }
  function fmt(x){
    if (!isFinite(x)) return "â€”";
    return Math.round(x).toLocaleString("zh-Hant");
  }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function buildCSV(rows){
    const header = [
      "age","infl_factor","begin_asset_wan","save_wan","cap_growth_wan","cash_yield_wan",
      "spend_wan","pension_other_wan","oneoff_wan","withdraw_wan",
      "end_asset_wan","end_asset_real_wan"
    ];
    const lines = [header.join(",")];
    rows.forEach(r=>{
      lines.push([
        r.age, r.inflFactor, r.begin, r.save, r.capGrowth, r.cashYield,
        r.spend, r.pensionOther, r.oneoff, r.withdraw,
        r.end, r.endReal
      ].join(","));
    });
    return lines.join("\n");
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function indexFactor(mode, inflation){
    if (mode === "cpi") return inflation;
    if (mode === "partial") return inflation * 0.70;
    return 0; // flat
  }
  function incomeIndexFactor(mode, inflation){
    if (mode === "cpi") return inflation;
    if (mode === "partial") return inflation * 0.50;
    return 0;
  }

  function simulate(){
    // Inputs
    const ageNow = n(document.getElementById("ageNow").value);
    const ageRet = n(document.getElementById("ageRet").value);
    const ageEnd = n(document.getElementById("ageEnd").value);

    const assetNow = n(document.getElementById("assetNow").value); // è¬å…ƒ
    const monthlySave = n(document.getElementById("monthlySave").value); // è¬å…ƒ/æœˆ
    const monthlySpendReal = n(document.getElementById("monthlySpendReal").value); // è¬å…ƒ/æœˆ (today purchasing power)

    let inflation = n(document.getElementById("inflation").value) / 100;
    let capGrowth = n(document.getElementById("capGrowth").value) / 100; // è³‡æœ¬æˆé•·ï¼ˆä¸å«ç¾é‡‘æ®–åˆ©ï¼‰
    let cashYield = n(document.getElementById("cashYield").value) / 100; // ç¾é‡‘æ®–åˆ©

    const spendIndexMode = document.getElementById("spendIndexMode").value;
    const reinvestBefore = document.getElementById("reinvestBefore").value; // yes/no
    const yieldAsCashflowAfter = document.getElementById("yieldAsCashflowAfter").value; // yes/no

    const monthlyPension = n(document.getElementById("monthlyPension").value);
    const monthlyOtherIncome = n(document.getElementById("monthlyOtherIncome").value);
    const incomeIndexMode = document.getElementById("incomeIndexMode").value;

    const oneOffCost = n(document.getElementById("oneOffCost").value); // è¬å…ƒï¼ˆé€€ä¼‘å¾Œä¸€æ¬¡æ€§ï¼‰
    const stressMode = document.getElementById("stressMode").value;
    const scoreRule = document.getElementById("scoreRule").value;

    // Basic validation
    if (ageRet <= ageNow) return {error: "é€€ä¼‘å¹´é½¡éœ€å¤§æ–¼ç›®å‰å¹´é½¡ã€‚"};
    if (ageEnd <= ageRet) return {error: "æ¨¡æ“¬çµ‚é»å¹´é½¡éœ€å¤§æ–¼é€€ä¼‘å¹´é½¡ã€‚"};
    if (assetNow < 0) return {error: "è³‡ç”¢ä¸å¯ç‚ºè² ã€‚"};

    // Stress adjust
    let oneTimeDrawdownYear = null;
    if (stressMode === "lowreturn") capGrowth = capGrowth - 0.02;
    if (stressMode === "highinfl") inflation = inflation + 0.02;
    if (stressMode === "drawdown") oneTimeDrawdownYear = ageRet; // é€€ä¼‘ç¬¬1å¹´æœŸåˆç™¼ç”Ÿ
    // åºåˆ—é¢¨éšªï¼šé€€ä¼‘å‰ 5 å¹´è³‡æœ¬æˆé•·ä¸‹é™ï¼ˆæ›´è²¼è¿‘â€œé€€ä¼‘å‰é‡åˆ°ç†Šå¸‚â€ï¼‰
    const bad5 = (stressMode === "bad5");

    // Guardrails
    inflation = clamp(inflation, 0, 0.20);
    cashYield = clamp(cashYield, 0, 0.30);
    capGrowth = clamp(capGrowth, -0.50, 0.50);

    const rows = [];
    let asset = assetNow;

    let minAsset = asset;
    let assetAtRet = null;

    // é€šè†¨å› å­ï¼ˆä»Šå¤©=1ï¼‰ï¼Œç”¨ä¾†æŠŠåç›®è½‰å¯¦è³ª
    let inflFactor = 1;

    // é€€ä¼‘å¾Œæ”¯å‡ºï¼šä»¥ã€Œä»Šå¤©è³¼è²·åŠ›ã€ç‚ºåŸºæº–ï¼Œå†ä¾æ”¯å‡ºèª¿æ•´æ–¹å¼æ¨åç›®
    const spendIndex = indexFactor(spendIndexMode, inflation);
    const incomeIndex = incomeIndexFactor(incomeIndexMode, inflation);

    for (let age = ageNow; age < ageEnd; age++){
      const isRetired = age >= ageRet;
      const begin = asset;

      // æ›´æ–°é€šè†¨å› å­ï¼ˆå‡è¨­æ¯å¹´å¹´æœ«é€šè†¨å®Œæˆï¼‰
      // æ³¨æ„ï¼šé€™è£¡ç”¨ â€œå¾ç¾åœ¨åˆ°è©²å¹´â€ çš„ç´¯ç©ï¼Œç°¡åŒ–è™•ç†
      if (age > ageNow){
        inflFactor *= (1 + inflation);
      }

      // ä¸€æ¬¡æ€§å›æ’¤ï¼ˆé€€ä¼‘ç¬¬ä¸€å¹´æœŸåˆï¼‰
      let beginAfterShock = begin;
      if (oneTimeDrawdownYear !== null && age === oneTimeDrawdownYear){
        beginAfterShock = begin * 0.80; // -20%
      }

      // é€€ä¼‘å‰æŠ•å…¥
      const save = isRetired ? 0 : (monthlySave * 12);

      // è³‡æœ¬æˆé•·ç‡ï¼ˆåºåˆ—é¢¨éšªï¼šé€€ä¼‘å‰5å¹´ä¸‹ä¿®ï¼‰
      let thisCapGrowth = capGrowth;
      if (bad5 && !isRetired && (age >= ageRet - 5) && (age < ageRet)){
        thisCapGrowth = capGrowth - 0.03; // å†ä¸‹ä¿®
      }

      // 1) ç¾é‡‘æ®–åˆ©ï¼ˆä»¥æœŸåˆè³‡ç”¢è¨ˆç®—ï¼šæ›´è²¼è¿‘è‚¡åˆ©/ç§Ÿé‡‘çš„â€œç•¶æœŸç¾é‡‘æµâ€ï¼‰
      //    é€€ä¼‘å‰ï¼šå¯é¸æ“‡å†æŠ•å…¥ or ç•¶ä½œæ”¶å…¥ï¼ˆä¸å…¥è³‡ç”¢ï¼‰
      //    é€€ä¼‘å¾Œï¼šè‹¥é¸æ“‡ä½œç‚ºç¾é‡‘æµï¼Œå°±å…ˆç”¨ä¾†æŠµæ”¯å‡ºï¼ˆä¸ double countï¼‰
      const cashIncome = beginAfterShock * cashYield;

      // 2) è³‡æœ¬æˆé•·ï¼ˆä¸å«ç¾é‡‘æ®–åˆ©ï¼‰ï¼Œç”¨æœŸåˆè³‡ç”¢è¨ˆç®—
      const capGain = beginAfterShock * thisCapGrowth;

      // é€€ä¼‘æ”¯å‡ºï¼ˆåç›®ï¼‰ï¼šä»¥ã€Œä»Šå¤©è³¼è²·åŠ›ã€ä¹˜ä¸Šæ”¯å‡ºèª¿æ•´ï¼ˆCPI/éƒ¨åˆ†/ä¸èª¿ï¼‰
      let spend = 0;
      if (isRetired){
        const spendNominalMonthly = monthlySpendReal * Math.pow(1 + spendIndex, (age - ageNow));
        spend = spendNominalMonthly * 12;
      }

      // å¹´é‡‘/å…¶ä»–æ”¶å…¥ï¼ˆå¯é¸æ˜¯å¦éš¨é€šè†¨èª¿æ•´ï¼‰
      let pensionOther = 0;
      if (isRetired){
        const base = (monthlyPension + monthlyOtherIncome) * 12;
        const adj = Math.pow(1 + incomeIndex, (age - ageNow));
        pensionOther = base * adj;
      }

      // ä¸€æ¬¡æ€§å¤§æ”¯å‡ºï¼šè¨­å®šç‚ºé€€ä¼‘ç¬¬ 1 å¹´ç™¼ç”Ÿï¼ˆä½ ä¹Ÿå¯æ”¹æˆå¤šæ¬¡äº‹ä»¶ï¼‰
      let oneoff = 0;
      if (isRetired && age === ageRet){
        oneoff = oneOffCost;
      }

      // é€€ä¼‘å¾Œï¼šæ”¶å…¥ä¾†æºï¼ˆå¹´é‡‘/å…¶ä»– + å¯èƒ½çš„æ®–åˆ©ï¼‰
      const yieldAsCash = (isRetired && yieldAsCashflowAfter === "yes");
      const inflow = pensionOther + (yieldAsCash ? cashIncome : 0);

      // ç¼ºå£ â†’ ç”±æé ˜è£œæ´
      let withdraw = 0;
      if (isRetired){
        const gap = (spend + oneoff) - inflow;
        withdraw = Math.max(0, gap);
      }

      // è³‡ç”¢æ›´æ–°ï¼ˆé¿å… double count çš„æ ¸å¿ƒï¼‰ï¼š
      // æœŸæœ« = æœŸåˆ(å«shock) + æŠ•å…¥ + è³‡æœ¬æˆé•·
      //      +ï¼ˆæ®–åˆ©è‹¥å†æŠ•å…¥ï¼‰ -ï¼ˆæé ˜ï¼‰
      let end = beginAfterShock + save + capGain;

      // æ®–åˆ©å…¥è³‡ç”¢çš„è¦å‰‡ï¼š
      // - é€€ä¼‘å‰ï¼šè‹¥é¸å†æŠ•å…¥ï¼Œæ®–åˆ©åŠ å…¥è³‡ç”¢ï¼›è‹¥ä¸å†æŠ•å…¥ï¼Œè¦–ç‚ºæ‹¿å»èŠ±ï¼Œä¸åŠ å›
      // - é€€ä¼‘å¾Œï¼šè‹¥æ®–åˆ©æ‹¿ä¾†ç•¶ç¾é‡‘æµæŠµæ”¯å‡ºï¼ˆyieldAsCash=trueï¼‰ï¼Œå°±ä¸åŠ å›è³‡ç”¢ï¼›
      //          è‹¥é€€ä¼‘å¾Œä¹Ÿå†æŠ•å…¥ï¼ˆyieldAsCash=falseï¼‰ï¼Œå‰‡åŠ å›è³‡ç”¢ï¼Œæ”¯å‡ºé æé ˜è£œæ´ã€‚
      if (!isRetired){
        if (reinvestBefore === "yes") end += cashIncome;
      }else{
        if (!yieldAsCash) end += cashIncome;
      }

      // æ‰£æé ˜
      end -= withdraw;

      // ä¸ä½æ–¼0
      if (end < 0) end = 0;

      // é€€ä¼‘æ™‚è³‡ç”¢ï¼ˆé€€ä¼‘èµ·å§‹ = é€€ä¼‘å‰ä¸€å¹´æœŸæœ«ï¼‰
      if (age === ageRet - 1){
        assetAtRet = end;
      }

      const endReal = end / inflFactor; // ä»¥ä»Šå¤©è³¼è²·åŠ›

      rows.push({
        age,
        inflFactor: +inflFactor.toFixed(4),
        begin: +beginAfterShock.toFixed(2),
        save: +save.toFixed(2),
        capGrowth: +capGain.toFixed(2),
        cashYield: +cashIncome.toFixed(2),
        spend: +spend.toFixed(2),
        pensionOther: +pensionOther.toFixed(2),
        oneoff: +oneoff.toFixed(2),
        withdraw: +withdraw.toFixed(2),
        end: +end.toFixed(2),
        endReal: +endReal.toFixed(2)
      });

      asset = end;
      if (asset < minAsset) minAsset = asset;
    }

    // Score
    const neverZero = minAsset > 0.0001;
    let score = "â€”";
    let note = "";

    if (scoreRule === "pass"){
      score = neverZero ? "åŠæ ¼ âœ…" : "ä¸åŠæ ¼ âš ï¸";
      note = neverZero
        ? "è³‡ç”¢æœªåœ¨æ¨¡æ“¬æœŸé–“æ­¸é›¶ã€‚ä¸‹ä¸€æ­¥è«‹åˆ‡æ›å£“åŠ›æ¸¬è©¦ï¼Œç‰¹åˆ¥çœ‹é€€ä¼‘åˆæœŸå›æ’¤èˆ‡åºåˆ—é¢¨éšªã€‚"
        : "è³‡ç”¢æœƒåœ¨æ¨¡æ“¬æœŸé–“æ­¸é›¶ã€‚é€šå¸¸éœ€è¦ï¼šé™ä½æ”¯å‡ºã€å»¶å¾Œé€€ä¼‘ã€æé«˜æŠ•å…¥ã€æˆ–æå‡å¯æŒçºŒç¾é‡‘æµï¼ˆæ®–åˆ©/å¹´é‡‘ï¼‰ã€‚";
    }else{
      // bufferï¼šæœ€ä½è³‡ç”¢ >= 3å¹´æ”¯å‡ºï¼ˆç”¨é€€ä¼‘ç¬¬ä¸€å¹´çš„æ”¯å‡ºç•¶åŸºæº–ï¼šç›´è§€ï¼‰
      const firstRetRow = rows.find(r => r.age === ageRet);
      const threeYearsSpend = firstRetRow ? firstRetRow.spend * 3 : 0;
      const okBuffer = neverZero && (minAsset >= threeYearsSpend);

      score = okBuffer ? "å„ª âœ…" : (neverZero ? "åŠæ ¼ âœ…" : "ä¸åŠæ ¼ âš ï¸");
      note = okBuffer
        ? "è³‡ç”¢ä¸æ­¸é›¶ä¸”ä¿æœ‰ 3 å¹´æ”¯å‡ºå®‰å…¨é‚Šéš›ã€‚å»ºè­°æŠŠç„¦é»è½‰å‘ï¼šé†«ç™‚/é•·ç…§ã€æˆ¿å±‹å¤§ä¿®ç¹•ã€èˆ‡å¸‚å ´å›æ’¤å¹´ä»½çš„æ‡‰å°ã€‚"
        : (neverZero
          ? "é›–æœªæ­¸é›¶ï¼Œä½†å®‰å…¨é‚Šéš›ä¸è¶³ï¼ˆé‡åˆ°å›æ’¤/å¤§æ”¯å‡ºæ™‚å®¹æ˜“ç¿»è»Šï¼‰ã€‚å»ºè­°æŠŠæœ€ä½è³‡ç”¢æ‹‰åˆ°è‡³å°‘ 3 å¹´æ”¯å‡ºã€‚"
          : "è³‡ç”¢æœƒæ­¸é›¶ï¼Œéœ€èª¿æ•´ç­–ç•¥ã€‚");
    }

    return {rows, assetAtRet, minAsset, score, note};
  }

  function render(res){
    const msgBox = document.getElementById("msgBox");
    msgBox.innerHTML = "";

    if (res.error){
      msgBox.innerHTML = `<div class="warn">${res.error}</div>`;
      return;
    }

    const rows = res.rows;
    lastRows = rows;

    // KPI
    document.getElementById("kpiAssetRet").textContent = fmt(res.assetAtRet);
    document.getElementById("kpiMinAsset").textContent = fmt(res.minAsset);
    document.getElementById("kpiScore").textContent = res.score;
    document.getElementById("kpiNote").textContent = res.note;

    // message box
    msgBox.innerHTML = (res.score.includes("ä¸åŠæ ¼"))
      ? `<div class="warn"><b>æé†’ï¼š</b>æ­¤æƒ…å¢ƒä¸‹æœƒå‡ºç¾è³‡ç”¢æ­¸é›¶é¢¨éšªã€‚å…ˆæŠŠã€Œé€€ä¼‘å¾Œæ”¯å‡ºã€é™ä½ 10% æˆ–ã€Œå»¶å¾Œé€€ä¼‘ã€2 å¹´ï¼Œå†è·‘ä¸€æ¬¡çœ‹çœ‹çµè«–æ˜¯å¦ç¿»è½‰ã€‚</div>`
      : `<div class="ok"><b>çœ‹èµ·ä¾†å¯è¡Œï¼š</b>æ­¤æƒ…å¢ƒä¸‹å¯ç¶­æŒç¾é‡‘æµã€‚æ¥è‘—è«‹åˆ‡æ›å£“åŠ›æ¸¬è©¦ï¼ˆé€€ä¼‘åˆæœŸå›æ’¤ã€åºåˆ—é¢¨éšªï¼‰ç¢ºèªæŠ—å£“æ€§ã€‚</div>`;

    // Table
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.age}</td>
        <td>${r.inflFactor}</td>
        <td>${fmt(r.begin)}</td>
        <td>${fmt(r.save)}</td>
        <td>${fmt(r.capGrowth)}</td>
        <td>${fmt(r.cashYield)}</td>
        <td>${fmt(r.spend)}</td>
        <td>${fmt(r.pensionOther)}</td>
        <td>${fmt(r.oneoff)}</td>
        <td>${fmt(r.withdraw)}</td>
        <td>${fmt(r.end)}</td>
        <td>${fmt(r.endReal)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Charts
    const labels = rows.map(r=>String(r.age));
    const assetsNom = rows.map(r=>r.end);
    const assetsReal = rows.map(r=>r.endReal);

    // income vs spendï¼ˆé€€ä¼‘å¾Œï¼‰
    const retRows = rows.filter(r=>r.spend > 0 || r.pensionOther > 0 || r.oneoff > 0);
    const labelsRet = retRows.map(r=>String(r.age));
    const spendRet = retRows.map(r=>r.spend + r.oneoff);
    const incomeRet = retRows.map(r=>r.pensionOther + (document.getElementById("yieldAsCashflowAfter").value==="yes" ? r.cashYield : 0));

    // destroy old
    if (assetChart) assetChart.destroy();
    if (flowChart) flowChart.destroy();

    assetChart = new Chart(document.getElementById("chartAsset"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "æœŸæœ«è³‡ç”¢ï¼ˆåç›®ï¼Œè¬å…ƒï¼‰", data: assetsNom, tension: 0.25 },
          { label: "æœŸæœ«è³‡ç”¢ï¼ˆå¯¦è³ªï¼Œè¬å…ƒï¼‰", data: assetsReal, tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          y: { ticks: { callback: (v)=> v.toLocaleString("zh-Hant") } }
        }
      }
    });

    flowChart = new Chart(document.getElementById("chartFlow"), {
      type: "line",
      data: {
        labels: labelsRet,
        datasets: [
          { label: "é€€ä¼‘æ”¯å‡ºï¼ˆå«ä¸€æ¬¡æ€§ï¼Œè¬å…ƒ/å¹´ï¼‰", data: spendRet, tension: 0.25 },
          { label: "æ”¶å…¥ï¼ˆå¹´é‡‘/å…¶ä»– + æ®–åˆ©ï¼Œè¬å…ƒ/å¹´ï¼‰", data: incomeRet, tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          y: { ticks: { callback: (v)=> v.toLocaleString("zh-Hant") } }
        }
      }
    });
  }

  document.getElementById("btnRun").addEventListener("click", ()=>{
    render(simulate());
  });

  document.getElementById("btnCSV").addEventListener("click", ()=>{
    if (!lastRows || lastRows.length === 0){
      render({error:"è«‹å…ˆæŒ‰ã€Œç«‹å³æ¨¡æ“¬ã€ï¼Œç”¢ç”Ÿå¹´åº¦æ˜ç´°å¾Œå†ä¸‹è¼‰ã€‚"});
      return;
    }
    const csv = buildCSV(lastRows);
    downloadText("retirement_cashflow_detail.csv", csv);
  });

  // åˆå§‹è‡ªå‹•è·‘ä¸€æ¬¡
  render(simulate());
</script>
</body>
</html>
