<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è³‡ç”¢é…ç½®é¢¨éšªæ¨¡å‹ï¼ˆé€²éšï¼‰ï½œæ™º Financial Path</title>
<meta name="description" content="å«å†å¹³è¡¡ã€æŠ•å…¥/æé ˜ã€è’™åœ°å¡ç¾…è·¯å¾‘èˆ‡å£“åŠ›æ¸¬è©¦ï¼šè®“é…ç½®æ±ºç­–æ›´æ¥è¿‘çœŸå¯¦äººç”Ÿã€‚">

<!-- Chart.js CDNï¼ˆç´”å‰ç«¯ï¼ŒGitHub Pages å¯ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#223; --muted:#6b7280;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --shadow:0 10px 22px rgba(16,24,40,.06); --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:#333;line-height:1.85}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:12px 20px;position:sticky;top:0;z-index:10}
  .topbar .inner{max-width:1120px;margin:auto;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
  .topbar a{color:var(--primary);text-decoration:none;font-size:14px}
  .topbar a:hover{text-decoration:underline}

  .container{max-width:1120px;margin:auto;padding:26px 20px 90px}
  h1,h2,h3{color:var(--primary);margin:0 0 10px}
  .sub{color:#4b5563;margin:0 0 14px}
  .grid{display:grid;grid-template-columns:420px 1fr;gap:14px;align-items:start}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid #edf0f6;padding:16px}
  label{display:block;font-size:13px;color:#475569;margin:10px 0 6px}
  input,select{width:100%;padding:10px 12px;border:1px solid #d9e2f2;border-radius:12px;background:#fff;font-size:14px}
  input:focus,select:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}

  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media(max-width:520px){ .row2,.row3{grid-template-columns:1fr} }

  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--primary);color:#fff;cursor:pointer;font-size:14px}
  .btn.secondary{background:#fff;color:var(--primary);border:1px solid #cfe0ff}
  .btn:hover{opacity:.92}

  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .kpi .box{background:#f7f9ff;border:1px solid #dfeaff;border-radius:14px;padding:12px}
  .kpi .box b{color:var(--primary)}
  .small{font-size:13px;color:#666}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--soft);color:var(--primary);font-size:12px;border:1px solid #dfeaff}
  .note{background:#fff;border-left:4px solid var(--primary);border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);margin-top:12px}
  .warn{background:#fff4f4;border-left:4px solid #d92c2c;border-radius:14px;padding:12px 14px;margin-top:12px}
  .ok{background:#f1fff5;border-left:4px solid #15a34a;border-radius:14px;padding:12px 14px;margin-top:12px}

  canvas{background:#fff;border-radius:14px;border:1px solid var(--line)}
  .charts{display:grid;grid-template-columns:1fr;gap:14px}

  .tablewrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
  table{border-collapse:collapse;width:100%;min-width:980px;background:#fff}
  th,td{padding:10px 10px;border-bottom:1px solid #eef1f6;text-align:right;font-size:13px;white-space:nowrap}
  th{text-align:right;background:#f7f9fd;color:var(--primary);position:sticky;top:0}
  td:first-child, th:first-child{text-align:left}

  details{background:#fff;border:1px solid #edf0f6;border-radius:14px;padding:10px 12px;margin-top:12px}
  summary{cursor:pointer;color:#111827;font-weight:700}
  .help ul{margin:8px 0 0 18px}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>è³‡ç”¢é…ç½®é¢¨éšªæ¨¡å‹ï¼ˆé€²éšï¼‰</h1>
    <p class="sub">
      é€™ç‰ˆæŠŠã€Œç¾å¯¦æœƒç™¼ç”Ÿçš„äº‹ã€åŠ é€²ä¾†ï¼š<b>å†å¹³è¡¡</b>ã€<b>æŠ•å…¥/æé ˜</b>ã€<b>å£“åŠ›æ¸¬è©¦</b>ã€<b>è’™åœ°å¡ç¾…è·¯å¾‘</b>ã€‚
      ä½ æœƒçœ‹åˆ°ï¼šåŒä¸€çµ„é…ç½®ï¼Œåœ¨ä¸åŒå£æƒ…å¢ƒä¸‹æœƒä¸æœƒå´©ã€‚
    </p>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <h2 style="margin-top:0">è¼¸å…¥</h2>

        <div class="note help">
          <span class="badge">å¦‚ä½•æ‰¾è³‡æ–™å¡«å…¥ï¼Ÿï¼ˆå¿…çœ‹ï¼‰</span>
          <ul>
            <li><b>é æœŸå ±é…¬ï¼ˆ%ï¼‰</b>ï¼šç”¨é•·æœŸå¹´åŒ–ã€Œåˆç†å€é–“ã€å³å¯ï¼Œåˆ¥ç”¨ä»Šå¹´/å–®ä¸€å¹´ã€‚</li>
            <li><b>æ³¢å‹•ï¼ˆ%ï¼‰</b>ï¼šç”¨æŒ‡æ•¸/ETF çš„é•·æœŸå¹´åŒ–æ³¢å‹•å€é–“ï¼ˆå¸¸è¦‹ï¼šè‚¡ 15~20%ã€å‚µ 4~8%ã€ç¾é‡‘ ~0ï¼‰ã€‚</li>
            <li><b>ç›¸é—œä¿‚æ•¸</b>ï¼šè‚¡å‚µé•·æœŸå¤šåœ¨ -0.2~+0.3 ä¹‹é–“ï¼ˆå±æ©Ÿæ™‚å¯èƒ½è®Šæ­£ã€ä¿å®ˆå¯å¡« +0.2ï¼‰ã€‚</li>
            <li><b>è³‡æ–™å»å“ªæ‰¾ï¼Ÿ</b>
              <ul>
                <li>è‚¡ç¥¨ï¼šç”¨å¤§ç›¤ï¼ˆå¦‚ S&P 500 æˆ–å…¨çƒè‚¡å¸‚ ETFï¼‰çœ‹é•·æœŸå¹´åŒ–å ±é…¬/æ³¢å‹•ã€‚</li>
                <li>å‚µåˆ¸ï¼šç”¨ä¸­é•·å¤©æœŸå…¬å‚µ/ç¶œåˆå‚µ ETFï¼ˆæ³¨æ„ï¼šåˆ©ç‡æ€¥å‡å¹´æœƒå¾ˆå·®ï¼‰ã€‚</li>
                <li>ç¾é‡‘ï¼šå¯ç”¨ã€Œç„¡é¢¨éšªåˆ©ç‡ã€æˆ–å®šå­˜/è²¨å¹£å¸‚å ´åŸºé‡‘çš„åˆç†å€é–“ã€‚</li>
              </ul>
            </li>
            <li><b>ä½ ä¸çŸ¥é“å°±æ€éº¼å¡«ï¼Ÿ</b>ï¼šå…ˆç”¨é è¨­å€¼è·‘ï¼Œå†ç”¨ã€Œå£“åŠ›æ¸¬è©¦ã€çœ‹æœ€å£æƒ…å¢ƒæ˜¯å¦èƒ½æ‰¿å—ã€‚</li>
          </ul>
          <div class="small" style="margin-top:8px">
            æé†’ï¼šé€™æ˜¯æ•™è‚²ç”¨é€”æ¨¡å‹ã€‚ä½ è¶Šä¿å®ˆå¡«ï¼Œæ±ºç­–è¶Šç©©å¥ã€‚
          </div>
        </div>

        <h3 style="margin-top:14px">A. é…ç½®æ¯”ä¾‹ï¼ˆ%ï¼‰</h3>
        <div class="row3">
          <div><label>è‚¡ç¥¨</label><input id="wE" type="number" step="1" value="60" min="0"></div>
          <div><label>å‚µåˆ¸</label><input id="wB" type="number" step="1" value="35" min="0"></div>
          <div><label>ç¾é‡‘</label><input id="wC" type="number" step="1" value="5" min="0"></div>
        </div>
        <div class="small" id="normHint" style="margin-top:8px;">â€”</div>

        <h3 style="margin-top:14px">B. å ±é…¬ / é¢¨éšªå‡è¨­ï¼ˆå¹´åŒ–ï¼‰</h3>
        <div class="row3">
          <div><label>è‚¡ç¥¨é æœŸå ±é…¬ï¼ˆ%ï¼‰</label><input id="rE" type="number" step="0.1" value="8"></div>
          <div><label>å‚µåˆ¸é æœŸå ±é…¬ï¼ˆ%ï¼‰</label><input id="rB" type="number" step="0.1" value="3"></div>
          <div><label>ç¾é‡‘å ±é…¬ï¼ˆ%ï¼‰</label><input id="rC" type="number" step="0.1" value="1.5"></div>
        </div>

        <div class="row3">
          <div><label>è‚¡ç¥¨æ³¢å‹•ï¼ˆ%ï¼‰</label><input id="sE" type="number" step="0.1" value="18" min="0"></div>
          <div><label>å‚µåˆ¸æ³¢å‹•ï¼ˆ%ï¼‰</label><input id="sB" type="number" step="0.1" value="6" min="0"></div>
          <div><label>è‚¡å‚µç›¸é—œä¿‚æ•¸ï¼ˆ-1~1ï¼‰</label><input id="rho" type="number" step="0.05" value="0.2" min="-1" max="1"></div>
        </div>

        <div class="row2">
          <div><label>ç„¡é¢¨éšªåˆ©ç‡ï¼ˆ%ï¼‰ï¼ˆç”¨ä¾†ç®— Sharpeï¼‰</label><input id="rf" type="number" step="0.1" value="1.5"></div>
          <div><label>é€šè†¨ï¼ˆ%ï¼‰ï¼ˆç”¨æ–¼æé ˜/æŠ•å…¥æ˜¯å¦æˆé•·ï¼‰</label><input id="infl" type="number" step="0.1" value="2.0"></div>
        </div>

        <h3 style="margin-top:14px">C. äººç”Ÿæµç¨‹ï¼ˆæŠ•å…¥ / æé ˜ / å†å¹³è¡¡ï¼‰</h3>
        <div class="row2">
          <div><label>ç›®å‰å¹´é½¡</label><input id="ageNow" type="number" step="1" value="35" min="18" max="80"></div>
          <div><label>é€€ä¼‘å¹´é½¡</label><input id="ageRet" type="number" step="1" value="60" min="30" max="90"></div>
        </div>
        <div class="row2">
          <div><label>æ¨¡æ“¬åˆ°å¹¾æ­²ï¼ˆå£½å‘½å‡è¨­ï¼‰</label><input id="ageEnd" type="number" step="1" value="90" min="60" max="110"></div>
          <div><label>åˆå§‹è³‡ç”¢ï¼ˆè¬å…ƒï¼‰</label><input id="asset0" type="number" step="1" value="800" min="0"></div>
        </div>

        <div class="row2">
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆæŠ•å…¥ï¼ˆè¬å…ƒï¼‰</label>
            <input id="saveM" type="number" step="0.1" value="3" min="0">
            <div class="small">å¯è¨­ 0ï¼Œä»£è¡¨ä¸å†æŠ•å…¥ã€‚</div>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆæé ˜ï¼ˆè¬å…ƒï¼‰</label>
            <input id="withM" type="number" step="0.1" value="6" min="0">
            <div class="small">é€™è£¡åªæ¨¡æ“¬ã€Œå¾è³‡ç”¢æé ˜ã€ï¼Œä¸å«å¹´é‡‘æ”¶å…¥ï¼ˆå¯åœ¨é€€ä¼‘å·¥å…·åšæ•´åˆï¼‰ã€‚</div>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>æŠ•å…¥æ˜¯å¦éš¨é€šè†¨æˆé•·ï¼Ÿ</label>
            <select id="saveInfl">
              <option value="no" selected>å¦ï¼ˆå›ºå®šé‡‘é¡ï¼‰</option>
              <option value="yes">æ˜¯ï¼ˆæ¯å¹´éš¨é€šè†¨èª¿æ•´ï¼‰</option>
            </select>
          </div>
          <div>
            <label>æé ˜æ˜¯å¦éš¨é€šè†¨æˆé•·ï¼Ÿ</label>
            <select id="withInfl">
              <option value="yes" selected>æ˜¯ï¼ˆé€€ä¼‘å¾Œæ”¯å‡ºæœƒè¢«é€šè†¨æ¨é«˜ï¼‰</option>
              <option value="no">å¦ï¼ˆå›ºå®šé‡‘é¡ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>å†å¹³è¡¡é »ç‡</label>
            <select id="rebalance">
              <option value="monthly">æ¯æœˆ</option>
              <option value="quarterly">æ¯å­£</option>
              <option value="yearly" selected>æ¯å¹´</option>
              <option value="none">ä¸å†å¹³è¡¡</option>
            </select>
          </div>
          <div>
            <label>è’™åœ°å¡ç¾…è·¯å¾‘æ•¸ï¼ˆè¶Šå¤šè¶Šæ…¢ï¼‰</label>
            <input id="paths" type="number" step="50" value="500" min="100" max="5000">
          </div>
        </div>

        <h3 style="margin-top:14px">D. å£“åŠ›æ¸¬è©¦ï¼ˆä¸€æ¬¡æ€§é‡æŒ«ï¼‰</h3>
        <div class="row2">
          <div>
            <label>æƒ…å¢ƒ</label>
            <select id="shockCase">
              <option value="none" selected>ä¸å•Ÿç”¨ï¼ˆåªè·‘éš¨æ©Ÿè·¯å¾‘ï¼‰</option>
              <option value="classic">ç¶“å…¸ï¼šè‚¡-30% / å‚µ+2% / ç¾0%</option>
              <option value="crisis2008">é¡2008ï¼šè‚¡-45% / å‚µ+6% / ç¾+1%</option>
              <option value="covid2020">é¡2020ï¼šè‚¡-35% / å‚µ+3% / ç¾+0.5%</option>
              <option value="rateShock">åˆ©ç‡æ€¥å‡ï¼šè‚¡-25% / å‚µ-10% / ç¾+2%</option>
              <option value="custom">è‡ªè¨‚ï¼ˆä¸‹æ–¹å¡«ï¼‰</option>
            </select>
          </div>
          <div>
            <label>ç¬¬å¹¾å¹´ç™¼ç”Ÿï¼Ÿï¼ˆä¾‹å¦‚ 1 = ç¬¬ä¸€å¹´æœŸåˆï¼‰</label>
            <input id="shockYear" type="number" step="1" value="1" min="1" max="60">
          </div>
        </div>

        <div id="customShockBox" class="row3" style="display:none">
          <div><label>è‡ªè¨‚ï¼šè‚¡ç¥¨ï¼ˆ%ï¼‰</label><input id="shE" type="number" step="1" value="-30"></div>
          <div><label>è‡ªè¨‚ï¼šå‚µåˆ¸ï¼ˆ%ï¼‰</label><input id="shB" type="number" step="1" value="2"></div>
          <div><label>è‡ªè¨‚ï¼šç¾é‡‘ï¼ˆ%ï¼‰</label><input id="shC" type="number" step="1" value="0"></div>
        </div>

        <div class="btnrow">
          <button class="btn" id="btnRun">ç«‹å³æ¨¡æ“¬</button>
          <button class="btn secondary" id="btnReset">é‡è¨­</button>
          <button class="btn secondary" id="btnCSV">ä¸‹è¼‰å¹´åº¦æ˜ç´° CSVï¼ˆä¸­ä½æ•¸è·¯å¾‘ï¼‰</button>
        </div>

        <div id="msg"></div>

        <details class="help">
          <summary>æˆ‘åˆ°åº•è¦æ€éº¼ã€Œæ‰¾è³‡æ–™ã€å¡«å ±é…¬/æ³¢å‹•/ç›¸é—œï¼Ÿï¼ˆæ›´å…·é«”ï¼‰</summary>
          <ul>
            <li><b>æœ€çœäº‹åšæ³•ï¼ˆå»ºè­°ï¼‰</b>ï¼šç›´æ¥ç”¨ã€Œå¸¸è¦‹å€é–“ã€ï¼š
              <ul>
                <li>è‚¡ç¥¨ï¼šå ±é…¬ 6~9%ï¼Œæ³¢å‹• 15~20%</li>
                <li>å‚µåˆ¸ï¼šå ±é…¬ 2~4%ï¼Œæ³¢å‹• 4~8%</li>
                <li>è‚¡å‚µç›¸é—œï¼š-0.2~+0.3ï¼ˆä¿å®ˆå¯ç”¨ +0.2ï¼‰</li>
              </ul>
            </li>
            <li><b>ä½ æƒ³æ›´åš´è¬¹</b>ï¼šæ‰¾ä½ å¯¦éš›æœƒè²·çš„ ETFï¼š
              <ul>
                <li>åˆ°åˆ¸å•†/ETF å®˜ç¶²/å…¬é–‹è³‡æ–™çœ‹ã€Œè¿‘ 3/5/10 å¹´å¹´åŒ–å ±é…¬ã€èˆ‡ã€Œå¹´åŒ–æ³¢å‹•ã€</li>
                <li>å¦‚æœç¶²ç«™æ²’æœ‰æ³¢å‹•ï¼šç”¨æœˆå ±é…¬è‡ªå·±ç®—ï¼ˆExcelï¼šSTDEV.P(æœˆå ±é…¬)*SQRT(12)ï¼‰</li>
                <li>ç›¸é—œä¿‚æ•¸ï¼šç”¨ Excel CORREL(è‚¡æœˆå ±é…¬, å‚µæœˆå ±é…¬)</li>
              </ul>
            </li>
            <li><b>ä¿å®ˆè¼¸å…¥æŠ€å·§</b>ï¼šå ±é…¬å¡«ä½ä¸€é»ã€æ³¢å‹•å¡«é«˜ä¸€é»ã€ç›¸é—œå¡«åæ­£ï¼ˆä¾‹å¦‚ +0.2ï¼‰â†’ ä½ æœƒå¾—åˆ°æ›´å®‰å…¨çš„çµè«–ã€‚</li>
          </ul>
        </details>
      </div>

      <!-- RIGHT: Outputs -->
      <div class="charts">
        <div class="card">
          <h2 style="margin-top:0">çµæœæ‘˜è¦</h2>
          <div class="kpi">
            <div class="box">
              <b>æˆåŠŸç‡ï¼ˆè³‡ç”¢ä¸æ­¸é›¶ï¼‰</b>
              <div id="kpiSurvive" style="margin-top:6px;">â€”</div>
              <div class="small">åœ¨æŠ•å…¥/æé ˜èˆ‡å£“åŠ›æƒ…å¢ƒä¸‹ï¼Œä»ä¸ç ´ç”¢çš„æ¯”ä¾‹ã€‚</div>
            </div>
            <div class="box">
              <b>é€€ä¼‘æ™‚è³‡ç”¢ï¼ˆä¸­ä½æ•¸ï¼Œè¬å…ƒï¼‰</b>
              <div id="kpiAtRet" style="margin-top:6px;">â€”</div>
              <div class="small">ä»£è¡¨æ€§è·¯å¾‘ï¼Œä¸æ˜¯ä¿è­‰ã€‚</div>
            </div>
            <div class="box">
              <b>æœ€ç—›å›æ’¤ï¼ˆä¸­ä½æ•¸ MDDï¼‰</b>
              <div id="kpiMDD" style="margin-top:6px;">â€”</div>
              <div class="small">å›æ’¤è¶Šæ·±ï¼Œè¶Šå®¹æ˜“åœ¨éŒ¯çš„æ™‚å€™è³£å‡ºã€‚</div>
            </div>
            <div class="box">
              <b>Sharpeï¼ˆè¿‘ä¼¼ï¼‰</b>
              <div id="kpiSharpe" style="margin-top:6px;">â€”</div>
              <div class="small">ç”¨ä½ è¼¸å…¥çš„ç„¡é¢¨éšªåˆ©ç‡ä¼°ç®—ã€‚</div>
            </div>
          </div>
          <div class="note">
            <b>è§£è®€æ–¹å¼ï¼š</b><br>
            ä½ è¦æ‰¾çš„ä¸æ˜¯ã€Œæœ€é«˜å ±é…¬ã€ï¼Œè€Œæ˜¯ã€Œåœ¨å£æƒ…å¢ƒä¸‹ä»èƒ½æ´»ä¸‹ä¾†ã€çš„é…ç½®ã€‚<br>
            æ‰€ä»¥è«‹å…ˆçœ‹æˆåŠŸç‡èˆ‡å›æ’¤ï¼Œå†è«‡å ±é…¬ã€‚
          </div>
        </div>

        <div class="card">
          <h2 style="margin-top:0">è³‡ç”¢æ›²ç·šï¼ˆä¸­ä½æ•¸ / 10% / 90%ï¼‰</h2>
          <canvas id="chartWealth" height="130"></canvas>
          <p class="small" style="margin:10px 0 0">
            10%ï¼šè¼ƒå·®æƒ…å¢ƒï¼ˆä½†ä¸æ˜¯æœ€å·®ï¼‰ï½œ90%ï¼šè¼ƒå¥½æƒ…å¢ƒã€‚ä½ è¦å•ï¼š<b>æˆ‘èƒ½ä¸èƒ½æ¥å— 10% çš„è·¯å¾‘ï¼Ÿ</b>
          </p>
        </div>

        <div class="card">
          <h2 style="margin-top:0">åˆ†å¸ƒï¼šé€€ä¼‘å¾Œç ´ç”¢å¹´é½¡ï¼ˆè‹¥ç™¼ç”Ÿï¼‰</h2>
          <canvas id="chartRuin" height="120"></canvas>
          <p class="small" style="margin:10px 0 0">
            è‹¥å¾ˆå¤šè·¯å¾‘æœƒç ´ç”¢ï¼Œè¡¨ç¤ºä½ çš„æé ˜/é…ç½®éœ€è¦èª¿æ•´ï¼ˆæ¸›æ”¯å‡ºã€å»¶å¾Œé€€ä¼‘ã€æé«˜å‚µ/ç¾é‡‘ç·©è¡ã€æˆ–æé«˜æŠ•å…¥ï¼‰ã€‚
          </p>
        </div>

        <div class="card">
          <h2 style="margin-top:0">å¹´åº¦æ˜ç´°ï¼ˆä¸­ä½æ•¸è·¯å¾‘ï¼‰</h2>
          <div class="tablewrap">
            <table id="tbl">
              <thead>
                <tr>
                  <th>å¹´é½¡</th>
                  <th>æœŸåˆè³‡ç”¢(è¬)</th>
                  <th>æŠ•å…¥/æé ˜(è¬)</th>
                  <th>ç•¶å¹´å ±é…¬(%)</th>
                  <th>æœŸæœ«è³‡ç”¢(è¬)</th>
                  <th>å¹´å…§æœ€å¤§å›æ’¤(%)</th>
                  <th>è‚¡ç¥¨æ¯”é‡(%)</th>
                  <th>å‚µåˆ¸æ¯”é‡(%)</th>
                  <th>ç¾é‡‘æ¯”é‡(%)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p class="small" style="margin-top:10px">
            æé†’ï¼šå¦‚æœä½ é¸ã€Œä¸å†å¹³è¡¡ã€ï¼Œè‚¡ç¥¨æ¯”é‡å¯èƒ½åœ¨å¤§æ¼²å¾Œè¶Šä¾†è¶Šé«˜ï¼Œå›æ’¤ä¹Ÿæœƒè·Ÿè‘—è®Šæ·±ã€‚
          </p>
        </div>
      </div>
    </div>

    <div class="footer-links" style="text-align:center;margin-top:24px">
      <a href="./chapter_investing.html">â† å›æŠ•è³‡æ±ºç­–ç³»çµ±</a>
      <a href="./tools.html">å›å·¥å…·</a>
      <a href="./index.html">å›ä¸»é </a>
    </div>
  </div>

<script>
  // =========================
  // Utilities
  // =========================
  function n(v){ return Number(v||0); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function fmtWan(x){
    if(!isFinite(x)) return "â€”";
    return Math.round(x).toLocaleString("zh-Hant");
  }
  function fmtPct(x){
    if(!isFinite(x)) return "â€”";
    return (x*100).toFixed(2) + "%";
  }
  function quantile(arr, q){
    const a = arr.slice().sort((x,y)=>x-y);
    if(a.length===0) return NaN;
    const pos = (a.length-1)*q;
    const base = Math.floor(pos);
    const rest = pos-base;
    if(a[base+1]===undefined) return a[base];
    return a[base] + rest*(a[base+1]-a[base]);
  }
  function buildCSV(rows){
    const header = ["age","begin_wan","flow_wan","return_pct","end_wan","mdd_pct","wE_pct","wB_pct","wC_pct"];
    const lines=[header.join(",")];
    rows.forEach(r=>{
      lines.push([
        r.age, r.begin, r.flow, (r.ret*100).toFixed(4), r.end, (r.mdd*100).toFixed(4),
        (r.wE*100).toFixed(2),(r.wB*100).toFixed(2),(r.wC*100).toFixed(2)
      ].join(","));
    });
    return lines.join("\n");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Normal random via Box-Muller
  function randn(){
    let u=0,v=0;
    while(u===0) u=Math.random();
    while(v===0) v=Math.random();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  // Cholesky for 2x2 correlation matrix
  // cov = [[1, rho],[rho,1]] -> L = [[1,0],[rho, sqrt(1-rho^2)]]
  function correlatedNormals(rho){
    rho = clamp(rho, -0.999, 0.999);
    const z1 = randn();
    const z2 = randn();
    const e = z1;
    const b = rho*z1 + Math.sqrt(1-rho*rho)*z2;
    return {e,b}; // correlated N(0,1)
  }

  // =========================
  // Inputs / Normalization
  // =========================
  function normalizeWeights(){
    let wE=n(document.getElementById("wE").value);
    let wB=n(document.getElementById("wB").value);
    let wC=n(document.getElementById("wC").value);
    wE=Math.max(0,wE); wB=Math.max(0,wB); wC=Math.max(0,wC);
    let sum=wE+wB+wC;
    if(sum<=0){ wE=60; wB=35; wC=5; sum=100; }
    const ne=wE/sum, nb=wB/sum, nc=wC/sum;
    document.getElementById("normHint").innerHTML =
      `è¼¸å…¥åŠ ç¸½ï¼š<b>${sum.toFixed(1)}%</b> â†’ æ­£è¦åŒ–å¾Œï¼šè‚¡ç¥¨ <b>${(ne*100).toFixed(1)}%</b>ï¼Œå‚µåˆ¸ <b>${(nb*100).toFixed(1)}%</b>ï¼Œç¾é‡‘ <b>${(nc*100).toFixed(1)}%</b>`;
    return {wE:ne,wB:nb,wC:nc};
  }

  function getShock(){
    const mode=document.getElementById("shockCase").value;
    if(mode==="none") return {enabled:false};

    if(mode==="custom"){
      return {
        enabled:true,
        shE:n(document.getElementById("shE").value)/100,
        shB:n(document.getElementById("shB").value)/100,
        shC:n(document.getElementById("shC").value)/100,
        name:"è‡ªè¨‚"
      };
    }
    if(mode==="crisis2008") return {enabled:true, shE:-0.45, shB:+0.06, shC:+0.01, name:"é¡2008"};
    if(mode==="covid2020")  return {enabled:true, shE:-0.35, shB:+0.03, shC:+0.005, name:"é¡2020"};
    if(mode==="rateShock")  return {enabled:true, shE:-0.25, shB:-0.10, shC:+0.02, name:"åˆ©ç‡æ€¥å‡"};
    return {enabled:true, shE:-0.30, shB:+0.02, shC:0.00, name:"ç¶“å…¸"};
  }

  function rebalanceIfNeeded(stepIndex, freq){
    // stepIndex: 0..months-1 (month based)
    if(freq==="none") return false;
    if(freq==="monthly") return true;
    if(freq==="quarterly") return ((stepIndex+1)%3===0);
    if(freq==="yearly") return ((stepIndex+1)%12===0);
    return false;
  }

  // =========================
  // Core Simulation
  // =========================
  function simulateOnce(params, recordPath=false){
    const {
      ageNow, ageRet, ageEnd,
      asset0, saveM, withM,
      saveInfl, withInfl,
      infl,
      w0, // target weights
      muE, muB, muC,
      sigE, sigB,
      rho,
      rebalance,
      shock, shockYear,
    } = params;

    const months = (ageEnd - ageNow) * 12;
    const retMonth = (ageRet - ageNow) * 12;

    // start holdings by target weights
    let total = asset0;
    let hE = total * w0.wE;
    let hB = total * w0.wB;
    let hC = total * w0.wC;

    // tracking
    let peak = total;
    let mdd = 0;        // most negative drawdown
    let ruined = false;
    let ruinAge = null;

    const yearlyRows = [];
    let yearBeginTotal = total;
    let yearPeak = total;
    let yearMDD = 0;

    for(let m=0; m<months; m++){
      const isRetired = (m >= retMonth);

      // one-time shock at the beginning of shockYear (1-based year)
      if(shock.enabled){
        const shockMonth = (shockYear-1)*12; // month index at start of that year
        if(m === shockMonth){
          hE *= (1 + shock.shE);
          hB *= (1 + shock.shB);
          hC *= (1 + shock.shC);
        }
      }

      // monthly cashflow (in ä¸‡å…ƒ)
      let flow = 0; // + contribution, - withdrawal
      const yearsFromNow = m/12;

      if(!isRetired){
        let c = saveM;
        if(saveInfl==="yes") c = saveM * Math.pow(1+infl, yearsFromNow);
        flow = +c;
      }else{
        let w = withM;
        if(withInfl==="yes") w = withM * Math.pow(1+infl, yearsFromNow);
        flow = -w;
      }

      // apply flow into cash first (realistic: contribution as cash, withdrawal from cash then sell)
      hC += flow;

      // if cash negative -> sell bond then equity to cover (simple rule)
      if(hC < 0){
        let need = -hC;
        const sellB = Math.min(hB, need);
        hB -= sellB; need -= sellB;
        const sellE = Math.min(hE, need);
        hE -= sellE; need -= sellE;
        hC = 0;
        if(need > 1e-9){
          // can't cover -> ruin
          ruined = true;
        }
      }

      // returns (monthly)
      const {e, b} = correlatedNormals(rho);
      const rEm = (muE/12) + (sigE/Math.sqrt(12))*e;
      const rBm = (muB/12) + (sigB/Math.sqrt(12))*b;
      const rCm = (muC/12); // cash assumed stable

      hE *= (1 + rEm);
      hB *= (1 + rBm);
      hC *= (1 + rCm);

      total = hE + hB + hC;

      // track drawdown
      if(total > peak) peak = total;
      const dd = (total/peak) - 1;
      if(dd < mdd) mdd = dd;

      if(total > yearPeak) yearPeak = total;
      const ydd = (total/yearPeak) - 1;
      if(ydd < yearMDD) yearMDD = ydd;

      // rebalance
      if(rebalanceIfNeeded(m, rebalance) && total > 0){
        hE = total * w0.wE;
        hB = total * w0.wB;
        hC = total * w0.wC;
      }

      // ruin check
      if(!ruined && total <= 0.0001){
        ruined = true;
      }
      if(ruined && ruinAge===null){
        ruinAge = ageNow + Math.floor(m/12);
      }

      // year end record
      const isYearEnd = ((m+1)%12===0);
      if(isYearEnd && recordPath){
        const age = ageNow + Math.floor(m/12);
        const yearEndTotal = total;

        // compute realized yearly return approx: (end - begin - sum(flow in year))/begin
        // we didn't store all flows; for UI we approximate using end/begin -1 (still useful)
        const approxYearRet = (yearBeginTotal>0) ? (yearEndTotal/yearBeginTotal - 1) : 0;

        yearlyRows.push({
          age,
          begin: +yearBeginTotal.toFixed(2),
          flow: 0,                 // optional detail not tracked monthly in this simplified yearly row
          ret: +approxYearRet.toFixed(6),
          end: +yearEndTotal.toFixed(2),
          mdd: +yearMDD.toFixed(6),
          wE: total>0 ? (hE/total) : 0,
          wB: total>0 ? (hB/total) : 0,
          wC: total>0 ? (hC/total) : 0,
        });

        yearBeginTotal = yearEndTotal;
        yearPeak = yearEndTotal;
        yearMDD = 0;
      }
    }

    return {final: total, mdd, ruined, ruinAge, yearlyRows};
  }

  function runSimulation(){
    const msg = document.getElementById("msg");
    msg.innerHTML = "";

    const w0 = normalizeWeights();

    // assumptions
    const muE = n(document.getElementById("rE").value)/100;
    const muB = n(document.getElementById("rB").value)/100;
    const muC = n(document.getElementById("rC").value)/100;
    const sigE = Math.max(0, n(document.getElementById("sE").value)/100);
    const sigB = Math.max(0, n(document.getElementById("sB").value)/100);
    const rho  = clamp(n(document.getElementById("rho").value), -1, 1);

    const rf   = n(document.getElementById("rf").value)/100;
    const infl = n(document.getElementById("infl").value)/100;

    const ageNow = n(document.getElementById("ageNow").value);
    const ageRet = n(document.getElementById("ageRet").value);
    const ageEnd = n(document.getElementById("ageEnd").value);

    const asset0 = n(document.getElementById("asset0").value);
    const saveM  = n(document.getElementById("saveM").value);
    const withM  = n(document.getElementById("withM").value);
    const saveInfl = document.getElementById("saveInfl").value;
    const withInfl = document.getElementById("withInfl").value;

    const rebalance = document.getElementById("rebalance").value;
    const paths = clamp(n(document.getElementById("paths").value), 100, 5000);

    const shock = getShock();
    const shockYear = clamp(n(document.getElementById("shockYear").value), 1, 60);

    // validation
    if(ageRet <= ageNow){
      msg.innerHTML = `<div class="warn"><b>è¼¸å…¥éŒ¯èª¤ï¼š</b>é€€ä¼‘å¹´é½¡éœ€å¤§æ–¼ç›®å‰å¹´é½¡ã€‚</div>`;
      return;
    }
    if(ageEnd <= ageRet){
      msg.innerHTML = `<div class="warn"><b>è¼¸å…¥éŒ¯èª¤ï¼š</b>æ¨¡æ“¬çµ‚é»å¹´é½¡éœ€å¤§æ–¼é€€ä¼‘å¹´é½¡ã€‚</div>`;
      return;
    }
    if(asset0 < 0){
      msg.innerHTML = `<div class="warn"><b>è¼¸å…¥éŒ¯èª¤ï¼š</b>åˆå§‹è³‡ç”¢ä¸å¯ç‚ºè² ã€‚</div>`;
      return;
    }

    const sharpeApprox = (sigE===0 && sigB===0) ? NaN : ((w0.wE*muE + w0.wB*muB + w0.wC*muC - rf) /
      Math.sqrt(Math.max(1e-9, (w0.wE*w0.wE*sigE*sigE + w0.wB*w0.wB*sigB*sigB + 2*w0.wE*w0.wB*rho*sigE*sigB))));

    // run MC
    const finals = [];
    const mdds = [];
    const ruinAges = []; // only if ruined

    // For quantile wealth curves (yearly), we need store yearly totals for each path
    const years = (ageEnd - ageNow);
    const wealthByPath = []; // [path][t] yearly end wealth

    // also pick a representative "median-like" path later
    for(let i=0;i<paths;i++){
      const res = simulateOnce({
        ageNow, ageRet, ageEnd,
        asset0, saveM, withM,
        saveInfl, withInfl,
        infl,
        w0,
        muE, muB, muC,
        sigE, sigB,
        rho,
        rebalance,
        shock, shockYear
      }, false);

      finals.push(res.final);
      mdds.push(res.mdd);
      if(res.ruined && res.ruinAge!==null) ruinAges.push(res.ruinAge);

      // To build curves without yearlyRows, we can re-run for each path with yearly record (costly).
      // Instead: run one more lightweight yearly tracker by rerunning at a lower path count? (we want 10/50/90 curves)
      // We'll do a compromise: store yearly curve for first N paths up to 800 to keep speed.
      if(i < Math.min(paths, 800)){
        const r2 = simulateOnce({
          ageNow, ageRet, ageEnd,
          asset0, saveM, withM,
          saveInfl, withInfl,
          infl,
          w0,
          muE, muB, muC,
          sigE, sigB,
          rho,
          rebalance,
          shock, shockYear
        }, true);
        const yr = r2.yearlyRows.map(x=>x.end);
        // ensure length == years (ages ageNow..ageEnd-1 year end)
        while(yr.length < years) yr.push(yr.length? yr[yr.length-1] : asset0);
        wealthByPath.push(yr.slice(0, years));
      }
    }

    const survive = finals.filter(x=>x>0.0001).length / finals.length;

    // retirement-time wealth distribution: approximate by running yearly record once more for median selection
    // We'll use wealthByPath (subset) and pick median by final wealth within that subset.
    let medianPathRows = [];
    if(wealthByPath.length>0){
      const subsetFinals = wealthByPath.map(arr=>arr[arr.length-1]);
      const med = quantile(subsetFinals, 0.5);
      let bestIdx=0, bestDist=Infinity;
      subsetFinals.forEach((v,idx)=>{
        const d=Math.abs(v-med);
        if(d<bestDist){bestDist=d; bestIdx=idx;}
      });

      // rebuild the chosen path with detailed yearly rows
      const chosen = simulateOnce({
        ageNow, ageRet, ageEnd,
        asset0, saveM, withM,
        saveInfl, withInfl,
        infl,
        w0,
        muE, muB, muC,
        sigE, sigB,
        rho,
        rebalance,
        shock, shockYear
      }, true);
      medianPathRows = chosen.yearlyRows;
    }

    // build quantile curves (10/50/90) from wealthByPath subset
    const ages = Array.from({length: years}, (_,k)=> String(ageNow + k));
    const q10=[], q50=[], q90=[];
    if(wealthByPath.length>0){
      for(let t=0;t<years;t++){
        const col = wealthByPath.map(p=>p[t]);
        q10.push(quantile(col,0.10));
        q50.push(quantile(col,0.50));
        q90.push(quantile(col,0.90));
      }
    }

    // retirement wealth at ageRet (year end of ageRet-?):
    // We'll approximate by using q50 at index (ageRet-ageNow-1) year end.
    const idxRet = Math.max(0, Math.min(years-1, (ageRet - ageNow - 1)));
    const wealthAtRetMed = (q50.length ? q50[idxRet] : NaN);

    // median MDD
    const mddMed = quantile(mdds, 0.5);

    // render KPI
    document.getElementById("kpiSurvive").textContent = (survive*100).toFixed(1) + "%";
    document.getElementById("kpiAtRet").textContent = isFinite(wealthAtRetMed) ? fmtWan(wealthAtRetMed) : "â€”";
    document.getElementById("kpiMDD").textContent = isFinite(mddMed) ? fmtPct(mddMed) : "â€”";
    document.getElementById("kpiSharpe").textContent = isFinite(sharpeApprox) ? sharpeApprox.toFixed(2) : "â€”";

    // message
    if(survive < 0.8){
      msg.innerHTML = `<div class="warn"><b>æé†’ï¼š</b>æˆåŠŸç‡åä½ï¼ˆ${(survive*100).toFixed(1)}%ï¼‰ã€‚é€šå¸¸è¦å…ˆèª¿ã€Œæé ˜/é€€ä¼‘å¹´é½¡/ç¾é‡‘å‚µåˆ¸æ¯”ä¾‹ã€ã€‚</div>`;
    }else{
      msg.innerHTML = `<div class="ok"><b>ç‹€æ…‹ï¼š</b>æˆåŠŸç‡ ${ (survive*100).toFixed(1) }%ã€‚ä¸‹ä¸€æ­¥è«‹åˆ‡æ›å£“åŠ›æ¸¬è©¦ï¼ˆå°¤å…¶æ˜¯åˆ©ç‡æ€¥å‡ / é¡2008ï¼‰ï¼Œçœ‹çµè«–æœƒä¸æœƒç¿»è½‰ã€‚</div>`;
    }

    // render charts + table
    renderWealthChart(ages, q10, q50, q90);
    renderRuinChart(ruinAges, ageRet, ageEnd);
    renderTable(medianPathRows);

    // cache for csv
    window.__medianRows = medianPathRows;
  }

  // =========================
  // Rendering
  // =========================
  let chartWealth, chartRuin;

  function renderWealthChart(labels, q10, q50, q90){
    if(chartWealth) chartWealth.destroy();
    chartWealth = new Chart(document.getElementById("chartWealth"), {
      type:"line",
      data:{
        labels,
        datasets:[
          {label:"10%ï¼ˆè¼ƒå·®ï¼‰", data:q10, tension:0.25},
          {label:"50%ï¼ˆä¸­ä½æ•¸ï¼‰", data:q50, tension:0.25},
          {label:"90%ï¼ˆè¼ƒå¥½ï¼‰", data:q90, tension:0.25},
        ]
      },
      options:{
        responsive:true,
        plugins:{legend:{display:true}},
        scales:{
          y:{ticks:{callback:(v)=>Number(v).toLocaleString("zh-Hant")}}
        }
      }
    });
  }

  function renderRuinChart(ruinAges, ageRet, ageEnd){
    if(chartRuin) chartRuin.destroy();

    // histogram by age bins
    const bins = {};
    ruinAges.forEach(a=>{
      const k = String(a);
      bins[k] = (bins[k]||0)+1;
    });

    const labels = [];
    for(let a=ageRet; a<=ageEnd; a++){
      labels.push(String(a));
    }
    const data = labels.map(k=>bins[k]||0);

    chartRuin = new Chart(document.getElementById("chartRuin"), {
      type:"bar",
      data:{ labels, datasets:[{label:"ç ´ç”¢æ¬¡æ•¸ï¼ˆè·¯å¾‘æ•¸ï¼‰", data}]},
      options:{
        responsive:true,
        plugins:{legend:{display:true}},
        scales:{
          y:{beginAtZero:true, ticks:{precision:0}}
        }
      }
    });
  }

  function renderTable(rows){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    if(!rows || rows.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="9" style="text-align:left;color:#666">ï¼ˆç„¡è³‡æ–™ï¼‰è«‹å…ˆæŒ‰ã€Œç«‹å³æ¨¡æ“¬ã€ã€‚</td>`;
      tbody.appendChild(tr);
      return;
    }
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.age}</td>
        <td>${fmtWan(r.begin)}</td>
        <td>${fmtWan(r.flow)}</td>
        <td>${(r.ret*100).toFixed(2)}%</td>
        <td>${fmtWan(r.end)}</td>
        <td>${(r.mdd*100).toFixed(2)}%</td>
        <td>${(r.wE*100).toFixed(1)}%</td>
        <td>${(r.wB*100).toFixed(1)}%</td>
        <td>${(r.wC*100).toFixed(1)}%</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // =========================
  // UI Events
  // =========================
  document.getElementById("btnRun").addEventListener("click", runSimulation);
  document.getElementById("btnReset").addEventListener("click", ()=>{
    // weights
    document.getElementById("wE").value=60;
    document.getElementById("wB").value=35;
    document.getElementById("wC").value=5;

    // assumptions
    document.getElementById("rE").value=8;
    document.getElementById("rB").value=3;
    document.getElementById("rC").value=1.5;
    document.getElementById("sE").value=18;
    document.getElementById("sB").value=6;
    document.getElementById("rho").value=0.2;
    document.getElementById("rf").value=1.5;
    document.getElementById("infl").value=2.0;

    // life
    document.getElementById("ageNow").value=35;
    document.getElementById("ageRet").value=60;
    document.getElementById("ageEnd").value=90;
    document.getElementById("asset0").value=800;
    document.getElementById("saveM").value=3;
    document.getElementById("withM").value=6;
    document.getElementById("saveInfl").value="no";
    document.getElementById("withInfl").value="yes";
    document.getElementById("rebalance").value="yearly";
    document.getElementById("paths").value=500;

    // shock
    document.getElementById("shockCase").value="none";
    document.getElementById("shockYear").value=1;
    document.getElementById("customShockBox").style.display="none";
    document.getElementById("shE").value=-30;
    document.getElementById("shB").value=2;
    document.getElementById("shC").value=0;

    normalizeWeights();
    runSimulation();
  });

  document.getElementById("btnCSV").addEventListener("click", ()=>{
    const rows = window.__medianRows || [];
    if(!rows.length){
      document.getElementById("msg").innerHTML = `<div class="warn"><b>æé†’ï¼š</b>è«‹å…ˆæŒ‰ã€Œç«‹å³æ¨¡æ“¬ã€ï¼Œæœ‰å¹´åº¦æ˜ç´°å¾Œæ‰èƒ½ä¸‹è¼‰ã€‚</div>`;
      return;
    }
    const csv = buildCSV(rows);
    downloadText("asset_allocation_mc_median_detail.csv", csv);
  });

  document.getElementById("shockCase").addEventListener("change", (e)=>{
    const isCustom = e.target.value==="custom";
    document.getElementById("customShockBox").style.display = isCustom ? "grid" : "none";
  });

  ["wE","wB","wC"].forEach(id=>{
    document.getElementById(id).addEventListener("input", normalizeWeights);
  });

  // init
  normalizeWeights();
  runSimulation();
</script>
</body>
</html>
