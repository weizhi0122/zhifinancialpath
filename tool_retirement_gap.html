<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿çµ¦ä»˜ï¼‹è³‡ç”¢æ¨¡æ“¬ï½œæ™º Financial Path</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿è€å¹´å¹´é‡‘/ä¸€æ¬¡é‡‘ï¼šè¼¸å…¥å‡ºç”Ÿå¹´æœˆæ—¥ã€å¹´è³‡ã€é€€ä¼‘å¹´é½¡ã€å¹³å‡æŠ•ä¿è–ªè³‡ã€ç¾åœ¨æŠ•è³‡è³‡ç”¢ã€å ±é…¬ç‡ã€è¢«å‹•æ”¶å…¥èˆ‡ç”Ÿæ´»è²»ï¼Œæ¨¡æ“¬é€€ä¼‘å‰å¢å€¼èˆ‡é€€ä¼‘å¾Œç¾é‡‘æµæ˜¯å¦æ’å¾—åˆ°ï¼ˆæ•™è‚²ç”¨é€”ï¼‰ã€‚" />
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300;
    --goodbg:#ecfdf3; --good:#027a48;
    --chip:#f8fafc;
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text)}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:10px 18px;position:sticky;top:0;z-index:10}
  .topbar-inner{max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left-nav{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .container{max-width:1100px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:26px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:980px){ .grid{grid-template-columns:1.15fr 0.85fr} }

  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0f172a}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a}
  input,select,textarea,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  textarea{min-height:140px;resize:vertical;line-height:1.35}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1;min-width:160px}
  .hr{border:0;border-top:1px solid var(--line);margin:14px 0}
  button{margin-top:14px;background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:800}
  button.secondary{background:#334155}
  .warn,.ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.4}
  .warn{background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5}
  .ok{background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc}
  .small{font-size:12.5px;color:var(--muted);line-height:1.45;margin-top:10px}
  .result{display:none}
  .kpi{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  @media (min-width:980px){ .kpi{grid-template-columns:1fr 1fr} }
  .kpi-box{border:1px solid #dbe7ff;background:var(--soft);border-radius:12px;padding:12px}
  .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi-value{font-size:18px;font-weight:900;color:var(--primary)}
  .kpi-sub{font-size:12.5px;color:var(--muted);margin-top:6px}
  .chip{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid #e5e7eb;font-size:12px;color:#334155}
  details{margin-top:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  summary{cursor:pointer;padding:12px 12px;font-weight:800;color:#0f172a}
  details .inner{padding:0 12px 12px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table td:last-child{text-align:right}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿çµ¦ä»˜ï¼‹è³‡ç”¢æ¨¡æ“¬ <span class="chip">ç°¡å–®è¼¸å…¥ / åš´è¬¹è¨ˆç®—</span></h1>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Step 1ï½œä½ çš„åŸºæœ¬è³‡æ–™</h2>

        <div class="row">
          <div>
            <label>å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆè¥¿å…ƒï¼‰</label>
            <input id="birthDate" type="date" />
          </div>
          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <div class="row">
              <div><input id="retireYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="retireMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
        </div>

        <label>ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆæœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
        <div class="row">
          <div><input id="insYearsNow" type="number" min="0" step="1" value="30" /><div class="small">å¹´</div></div>
          <div><input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
          <div><input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" /><div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div></div>
        </div>

        <div class="row">
          <div>
            <label>åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
            <select id="keepInsured">
              <option value="yes" selected>æ˜¯ï¼šä¸€ç›´æŠ•ä¿åˆ°é€€ä¼‘</option>
              <option value="no">å¦ï¼šç”¨ç›®å‰å¹´è³‡ï¼ˆä¸å†å¢åŠ ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆå¹´é‡‘ææ—©/å±•å»¶ç”¨ï¼‰</label>
            <div class="row">
              <div><input id="claimYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="claimMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
        </div>

        <hr class="hr" />

        <h2>Step 2ï½œå‹ä¿çµ¦ä»˜ï¼ˆç°¡åŒ–è¼¸å…¥ï¼‰</h2>
        <div class="small">
          åªè¦å¡«å…©å€‹æ•¸å­—å°±èƒ½ç®—ï¼š<br/>
          <span class="chip">å¹´é‡‘</span> ç”¨ã€Œæœ€é«˜60å€‹æœˆå¹³å‡ã€çš„å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆä½ å¯ç›´æ¥å¡«ï¼‰<br/>
          <span class="chip">ä¸€æ¬¡é‡‘</span> ç”¨ã€Œæœ€è¿‘36å€‹æœˆå¹³å‡ã€çš„å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆä½ å¯ç›´æ¥å¡«ï¼‰<br/>
          æƒ³æ›´ç²¾æº–å¯å±•é–‹é€²éšè²¼æ˜ç´°ã€‚
        </div>

        <div class="row">
          <div>
            <label>å¹´é‡‘å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€é«˜60æœˆå¹³å‡ï¼‰</label>
            <input id="avgSalaryPension" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
          <div>
            <label>ä¸€æ¬¡é‡‘å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€è¿‘36æœˆå¹³å‡ï¼‰</label>
            <input id="avgSalaryLump36" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
        </div>

        <details>
          <summary>é€²éšï¼šè²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆè‡ªå‹•ç®—ã€Œæœ€é«˜60æœˆã€èˆ‡ã€Œæœ€è¿‘36æœˆã€ï¼‰</summary>
          <div class="inner">
            <div class="small">
              æ ¼å¼ï¼š<span class="mono">YYYY-MM é‡‘é¡</span> æˆ–åªè²¼é‡‘é¡ï¼ˆä¾æ™‚é–“é †åºï¼‰<br/>
              å¹´é‡‘æœƒå–<strong>æœ€é«˜60ç­†</strong>ï¼›ä¸€æ¬¡é‡‘æœƒå–<strong>æœ€å¾Œ36ç­†</strong>ã€‚
            </div>
            <label>æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆå¯ç•™ç©ºï¼›æœ‰è²¼å°±å„ªå…ˆä½¿ç”¨ï¼‰</label>
            <textarea id="salaryLines" placeholder="ä¾‹ï¼š
2024-01 45800
2024-02 45800
..."></textarea>
          </div>
        </details>

        <details>
          <summary>é€²éšï¼šä¸€æ¬¡é‡‘çš„ã€Œ60æ­²å¾Œå¹´è³‡ã€è¦å‰‡ï¼ˆæœ‰éœ€è¦å†å¡«ï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>60æ­²å¾ŒåŠ ä¿å¹´è³‡ï¼ˆæœ€å¤š5å¹´ï¼‰</label>
                <div class="row">
                  <div><input id="insAfter60Years" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="insAfter60Months" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>
              <div>
                <label>æ˜¯å¦æœªæ»¿60æ­²è«‹é ˜ä¸€æ¬¡é‡‘ï¼Ÿ</label>
                <select id="claimBefore60">
                  <option value="no" selected>å¦ï¼ˆ60æ­²æˆ–ä¹‹å¾Œï¼‰</option>
                  <option value="yes">æ˜¯ï¼ˆæœªæ»¿60æ­²ï¼‰</option>
                </select>
                <div class="small">æœªæ»¿60æ­²è«‹é ˜ï¼šä¸€æ¬¡é‡‘ä¸Šé™ä»¥45æœˆç‚ºä¸»ã€‚</div>
              </div>
            </div>
          </div>
        </details>

        <hr class="hr" />

        <h2>Step 3ï½œä½ çš„è³‡ç”¢èˆ‡é€€ä¼‘ç”Ÿæ´»ï¼ˆä½ æƒ³è¦çš„æ ¸å¿ƒï¼‰</h2>

        <div class="row">
          <div>
            <label>ç¾åœ¨æŠ•è³‡ç¸½é¡ï¼ˆç¾æœ‰è³‡ç”¢ï¼‰</label>
            <input id="assetNow" type="number" min="0" step="10000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆæŠ•å…¥ï¼ˆå­˜/æŠ•è³‡ï¼‰</label>
            <input id="contribMonthly" type="number" min="0" step="1000" value="0" />
            <div class="small">è‹¥ä½ ä¸æœƒå›ºå®šæŠ•å…¥ï¼Œå¡« 0 ä¹Ÿå¯ä»¥ã€‚</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–å ±é…¬ç‡ï¼ˆåç›® %ï¼‰</label>
            <input id="rPre" type="number" step="0.1" value="3.0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–å ±é…¬ç‡ï¼ˆåç›® %ï¼‰</label>
            <input id="rPost" type="number" step="0.1" value="3.0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆè¢«å‹•æ”¶å…¥ï¼ˆè‚¡æ¯/æˆ¿ç§Ÿç­‰ï¼‰</label>
            <input id="passiveMonthly" type="number" min="0" step="1000" value="0" />
          </div>
          <div>
            <label>è¢«å‹•æ”¶å…¥ç”¨é€”</label>
            <select id="passiveUse">
              <option value="spend" selected>æ‹¿ä¾†æ”¯ä»˜ç”Ÿæ´»è²»ï¼ˆå¯æŠµç¼ºå£ï¼‰</option>
              <option value="reinvest">å†æŠ•å…¥ï¼ˆä¸æŠµç”Ÿæ´»è²»ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™ç”Ÿæ´»è²»ï¼ˆä»¥ä»Šå¤©åƒ¹å€¼ï¼‰</label>
            <input id="needMonthlyToday" type="number" min="0" step="1000" value="80000" />
          </div>
          <div>
            <label>é æœŸé€šè†¨ï¼ˆå¹´ %ï¼‰</label>
            <input id="inflation" type="number" min="0" step="0.1" value="2.0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é è¨ˆå£½å‘½ï¼ˆæ­²ï¼‰</label>
            <input id="lifeExpectancy" type="number" min="0" step="1" value="90" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ˜¯å¦ç¹¼çºŒæŠ•å…¥ï¼Ÿ</label>
            <select id="postContribMode">
              <option value="no" selected>å¦ï¼šé€€ä¼‘å¾Œä¸å†æŠ•å…¥</option>
              <option value="yes">æ˜¯ï¼šé€€ä¼‘å¾Œä»æ¯æœˆæŠ•å…¥ï¼ˆå¡«ä¸‹æ–¹é‡‘é¡ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆæŠ•å…¥ï¼ˆè‹¥æœ‰ï¼‰</label>
            <input id="postContribMonthly" type="number" min="0" step="1000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå…¶ä»–æ¯æœˆæ”¶å…¥ï¼ˆä¸å«å‹ä¿èˆ‡è¢«å‹•ï¼‰</label>
            <input id="otherMonthlyIncome" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <div class="row">
          <button onclick="calcAll()">è¨ˆç®—ï¼ˆç°¡æ½”çµæœï¼‹å¯å±•é–‹ç´°ç¯€ï¼‰</button>
          <button class="secondary" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
        </div>

        <div id="warnBox" class="warn"></div>
        <div id="okBox" class="ok"></div>

        <p class="small">
          â€» æ•™è‚²ç”¨é€”ï¼šå‹ä¿æ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ã€‚è³‡ç”¢æ¨¡æ“¬ä»¥ã€Œæ¯æœˆç¾é‡‘æµã€æ¨ä¼°ï¼Œå¯ç”¨ä¾†æ¯”è¼ƒä¸åŒå ±é…¬ç‡ã€æŠ•å…¥é¡èˆ‡æ”¯å‡ºæƒ…å¢ƒã€‚
        </p>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>çµæœï¼ˆå…ˆçœ‹é‡é»ï¼‰</h2>
        <div id="output" class="result"></div>
      </div>
    </div>
  </div>

<script>
/* ===================== å‹ä¿è¦å‰‡ï¼ˆç¶­æŒåš´è¬¹ï¼‰ ===================== */
const RULES = {
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  },
  maxAdjYears: 5,
  adjPerYear: 0.04
};

function $(id){ return document.getElementById(id); }
function clampInt(v){ if(!Number.isFinite(v)) return NaN; return Math.max(0, Math.floor(v)); }
function money(v){ const n = Number(String(v||"").replace(/[,ï¼Œ\s]/g,"")); return Number.isFinite(n) ? n : NaN; }
function fmt(n){ try { return Number(n).toLocaleString("en-US"); } catch { return String(n); } }
function showWarn(msg){ const w=$("warnBox"); if(!msg){w.style.display="none";w.textContent="";return;} w.style.display="block";w.textContent=msg; }
function showOk(msg){ const o=$("okBox"); if(!msg){o.style.display="none";o.textContent="";return;} o.style.display="block";o.textContent=msg; }
function hideOutput(){ $("output").style.display="none"; $("output").innerHTML=""; }

function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }

function calcAgeMonths(birthDate, today){
  let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
  if (today.getDate() < birthDate.getDate()) months -= 1;
  return Math.max(0, months);
}
function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}
function monthsBetween(today, future){
  let m = (future.getFullYear()-today.getFullYear())*12 + (future.getMonth()-today.getMonth());
  if (future.getDate() < today.getDate()) m -= 1;
  return Math.max(0, m);
}
function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}
function adjustFactor(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths;
  const rawYears = diffMonths / 12;
  const cappedYears = Math.max(-RULES.maxAdjYears, Math.min(RULES.maxAdjYears, rawYears));
  const factor = 1 + cappedYears * RULES.adjPerYear;
  return { factor, diffMonths, rawYears, cappedYears };
}

/* ---------- è–ªè³‡æ˜ç´°ï¼ˆé€²éšï¼‰ ---------- */
function parseSalaryLines(text){
  const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const dated = [];
  const seq = [];
  for(const line of lines){
    const m = line.match(/^(\d{4})[\/\-](\d{1,2})[^\d]+([\d,ï¼Œ]+(\.\d+)?)$/);
    if(m){
      const yyyy=Number(m[1]), mm=Number(m[2]);
      const sal=money(m[3]);
      if(!Number.isFinite(yyyy)||!Number.isFinite(mm)||mm<1||mm>12||!Number.isFinite(sal)||sal<=0) continue;
      dated.push({ key: yyyy*12+mm, salary: sal });
      continue;
    }
    const sal = money(line);
    if(Number.isFinite(sal) && sal>0) seq.push(sal);
  }
  if(dated.length){
    const map=new Map();
    for(const it of dated) map.set(it.key, it.salary);
    const arr=[...map.entries()].sort((a,b)=>a[0]-b[0]).map(([k,s])=>s);
    return { mode:"dated", salaries: arr, count: arr.length };
  }
  return { mode:"sequence", salaries: seq, count: seq.length };
}
function avgTop60(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  if(n<60){
    const sum=salaries.reduce((a,b)=>a+b,0);
    return { avg: sum/n, rule:"æœªæ»¿60å€‹æœˆï¼šä»¥å¯¦éš›æœŸé–“å¹³å‡ï¼ˆå¹´é‡‘ï¼‰" };
  }
  const top = salaries.slice().sort((a,b)=>b-a).slice(0,60);
  const sum=top.reduce((a,b)=>a+b,0);
  return { avg: sum/60, rule:"æœ€é«˜60å€‹æœˆå¹³å‡ï¼ˆå¹´é‡‘ï¼‰" };
}
function avgLast36(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  const used = (n<=36) ? salaries.slice() : salaries.slice(n-36);
  const sum=used.reduce((a,b)=>a+b,0);
  return { avg: sum/used.length, rule:(n<36) ? "æœªæ»¿36å€‹æœˆï¼šä»¥å¯¦éš›æœŸé–“å¹³å‡ï¼ˆä¸€æ¬¡é‡‘ï¼‰" : "æœ€è¿‘36å€‹æœˆå¹³å‡ï¼ˆä¸€æ¬¡é‡‘ï¼‰" };
}

/* ---------- å¹´é‡‘ ---------- */
function calcPension(avgSalary, insMonths, factor){
  const insYears = insMonths / 12;
  const base1 = avgSalary * insYears * 0.00775 + 3000;
  const base2 = avgSalary * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2) ? "å¼1(0.775%+3000)" : "å¼2(1.55%)";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly };
}

/* ---------- ä¸€æ¬¡é‡‘ï¼ˆçµ¦ä»˜æœˆæ•¸ï¼šå‰15å¹´Ã—1ã€å¾ŒçºŒÃ—2ï¼Œä¸Šé™45ï¼›60å¾Œæœ€å¤š+5ï¼Œä¸Šé™50ï¼‰ ---------- */
function lumpBenefitMonths(insMonthsTotal, after60MonthsInput, claimBefore60){
  const after60MonthsCapped = Math.min(Math.max(0, after60MonthsInput), 60);
  const after60Months = claimBefore60 ? 0 : after60MonthsCapped;

  let pre60Months = Math.max(0, insMonthsTotal - after60Months);
  pre60Months = Math.min(pre60Months, 360); // 60æ­²å‰å¹´è³‡æœ€å¤š30å¹´

  const pre60Years = pre60Months / 12;
  const y1 = Math.min(15, pre60Years);
  const y2 = Math.max(0, pre60Years - 15);
  const benefitPre60 = Math.min(y1*1 + y2*2, 45);

  const benefitAfter60 = after60Months / 12; // æœ€å¤š+5
  const cap = claimBefore60 ? 45 : 50;

  const total = Math.min(benefitPre60 + benefitAfter60, cap);
  return { benefitMonths: total, cap };
}

/* ===================== è³‡ç”¢æ¨¡æ“¬ï¼ˆä½ è¦çš„æ ¸å¿ƒï¼‰ ===================== */
/** æœˆåº¦æ¨¡æ“¬ï¼š
 * é€€ä¼‘å‰ï¼šè³‡ç”¢ = è³‡ç”¢*(1+rPre/12) + æ¯æœˆæŠ•å…¥
 * é€€ä¼‘å¾Œï¼šè³‡ç”¢ = è³‡ç”¢*(1+rPost/12) + é€€ä¼‘å¾ŒæŠ•å…¥ + (è¢«å‹•æ”¶å…¥è‹¥reinvest) - ç”Ÿæ´»è²»ç¼ºå£(åç›®)
 */
function simulatePlan(params){
  const {
    monthsToRetire, monthsRetired,
    assetNow, contribMonthly,
    rPre, rPost,
    needMonthlyToday, inflation,
    laborMonthlyAtRetire, otherMonthlyIncomeAtRetire,
    passiveMonthly, passiveUse,
    postContribMode, postContribMonthly
  } = params;

  let asset = assetNow;

  const rPreM = (1 + rPre/100) ** (1/12) - 1;
  const rPostM = (1 + rPost/100) ** (1/12) - 1;
  const infM = (1 + inflation/100) ** (1/12) - 1;

  // é€€ä¼‘å‰
  for(let t=0; t<monthsToRetire; t++){
    asset = asset * (1 + rPreM) + contribMonthly;
  }
  const assetAtRetire = asset;

  // é€€ä¼‘ç•¶æœˆèµ·ï¼šå°‡ã€Œä»Šå¤©ç”Ÿæ´»è²»ã€è†¨è„¹åˆ°é€€ä¼‘ç•¶æœˆï¼ˆåç›®ï¼‰
  let needM = needMonthlyToday * ((1 + infM) ** monthsToRetire);

  // é€€ä¼‘ç•¶æœˆèµ·ï¼šå…¶ä»–æ”¶å…¥ä¹ŸæŒ‰é€šè†¨æ¨åˆ°é€€ä¼‘ï¼ˆåç›®ï¼‰
  let otherIncomeM = otherMonthlyIncomeAtRetire;
  let passiveM = passiveMonthly;
  let laborM = laborMonthlyAtRetire;

  // é€€ä¼‘å¾Œ
  let minAsset = asset;
  for(let k=0; k<monthsRetired; k++){
    // æ¯æœˆç”Ÿæ´»è²»ä¹Ÿç¹¼çºŒé€šè†¨ä¸Šå‡
    if(k>0) needM *= (1 + infM);

    // å¯ç”¨æ”¶å…¥ï¼ˆè‹¥è¢«å‹•æ”¶å…¥æ‹¿ä¾†èŠ±æ‰ç®—æŠµï¼‰
    const usablePassive = (passiveUse === "spend") ? passiveM : 0;
    const usableIncome = laborM + otherIncomeM + usablePassive;

    const gap = Math.max(0, needM - usableIncome); // éœ€è¦å¾è³‡ç”¢æé ˜çš„ç¼ºå£ï¼ˆåç›®ï¼‰

    // é€€ä¼‘å¾ŒæŠ•å…¥ï¼ˆå¯é¸ï¼‰
    const postContrib = (postContribMode === "yes") ? postContribMonthly : 0;

    // è‹¥è¢«å‹•æ”¶å…¥é¸æ“‡ reinvestï¼Œè¦–ç‚ºç›´æ¥æŠ•å…¥è³‡ç”¢
    const reinvestPassive = (passiveUse === "reinvest") ? passiveM : 0;

    // è³‡ç”¢æ›´æ–°
    asset = asset * (1 + rPostM) + postContrib + reinvestPassive - gap;

    if(asset < minAsset) minAsset = asset;
    if(asset < 0){
      return { ok:false, assetAtRetire, assetEnd: asset, monthBroke: k+1, minAsset };
    }
  }
  return { ok:true, assetAtRetire, assetEnd: asset, monthBroke: null, minAsset };
}

/** åæ¨ï¼šç‚ºäº†ä¸ç ´ç”¢ï¼Œé€€ä¼‘å‰æ¯æœˆè¦å¤šå­˜å¤šå°‘ï¼ˆç”¨äºŒåˆ†æœå°‹ï¼‰ */
function solveExtraContribution(baseParams){
  // è‹¥æœ¬ä¾†å°±OKï¼Œä¸éœ€è¦
  const base = simulatePlan(baseParams);
  if(base.ok) return { extra: 0, base };

  // ç›®æ¨™ï¼šæ‰¾åˆ° extraï¼Œä½¿å¾— ok=true
  let lo = 0, hi = 200000; // hi å¯ä¾éœ€æ±‚èª¿å¤§
  for(let i=0;i<30;i++){
    const mid = (lo+hi)/2;
    const test = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + mid });
    if(test.ok) hi = mid;
    else lo = mid;
  }
  const extra = Math.ceil(hi);
  const final = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + extra });
  return { extra, base, final };
}

/* ===================== ä¸»è¨ˆç®— ===================== */
function calcAll(){
  showWarn(""); showOk(""); hideOutput();

  const today = new Date();
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  const birthDate = new Date($("birthDate").value + "T00:00:00");
  if(isNaN(birthDate.getTime())){ alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´æœˆæ—¥"); return; }

  const retireY = clampInt(Number($("retireYears").value));
  const retireM = clampInt(Number($("retireMonths").value));
  if(!Number.isFinite(retireY) || retireM>11){ alert("é€€ä¼‘å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || claimM>11){ alert("è«‹é ˜å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){ alert("æŠ•ä¿å¹´è³‡éœ€å¤§æ–¼0"); return; }

  const keepInsured = $("keepInsured").value === "yes";

  // å¹´é½¡æ¨ç®—
  const ageNowMonths = calcAgeMonths(birthDate, today);
  const ageNowY = Math.floor(ageNowMonths/12);
  const ageNowMR = ageNowMonths%12;

  const retireAgeMonths = ageToMonths(retireY, retireM);
  const retireDate = calcDateAtAge(birthDate, retireAgeMonths);
  const monthsToRetire = monthsBetween(today, retireDate);
  const yearsToRetire = monthsToRetire/12;

  const insAtRetireMonths = keepInsured ? (insNowMonths + monthsToRetire) : insNowMonths;

  // è–ªè³‡ï¼šå„ªå…ˆç”¨æ˜ç´°ï¼ˆè‹¥æœ‰è²¼ï¼‰ï¼Œå¦å‰‡ç”¨ç°¡åŒ–è¼¸å…¥
  const detail = parseSalaryLines($("salaryLines")?.value || "");
  let avgPension = money($("avgSalaryPension").value);
  let avgLump36 = money($("avgSalaryLump36").value);
  let salaryNote = "";

  if(detail.count){
    const p = avgTop60(detail.salaries);
    const l = avgLast36(detail.salaries);
    avgPension = p.avg;
    avgLump36 = l.avg;
    salaryNote = `å·²ä½¿ç”¨æ˜ç´°ï¼š${p.rule} / ${l.rule}ï¼ˆå…±${detail.count}ç­†ï¼‰`;
  }else{
    if(!Number.isFinite(avgPension) || avgPension<=0 || !Number.isFinite(avgLump36) || avgLump36<=0){
      alert("æœªè²¼æ˜ç´°æ™‚ï¼Œè«‹è‡³å°‘å¡«ï¼šå¹´é‡‘å¹³å‡è–ªè³‡ã€ä¸€æ¬¡é‡‘36æœˆå¹³å‡è–ªè³‡");
      return;
    }
    salaryNote = "æœªè²¼æ˜ç´°ï¼šä½¿ç”¨ä½ è¼¸å…¥çš„å…©å€‹å¹³å‡è–ªè³‡";
  }

  // æ³•å®šå¹´é½¡èˆ‡åŠ æ¸›çµ¦ä¿‚æ•¸
  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalMonths = ageToMonths(legal.years, legal.months);
  const claimMonthsTotal = ageToMonths(claimY, claimM);
  const adj = adjustFactor(legalMonths, claimMonthsTotal);

  // å¹´é‡‘
  const eligiblePension = insAtRetireMonths >= 15*12;
  const pension = eligiblePension ? calcPension(avgPension, insAtRetireMonths, adj.factor) : null;
  const laborMonthlyAtRetire = eligiblePension ? pension.finalMonthly : 0;

  // ä¸€æ¬¡é‡‘ï¼ˆé€²éšï¼‰
  const claimBefore60 = ($("claimBefore60")?.value || "no") === "yes";
  const after60MonthsInput = insToMonths($("insAfter60Years")?.value || 0, $("insAfter60Months")?.value || 0, 0);
  const bm = lumpBenefitMonths(insAtRetireMonths, after60MonthsInput, claimBefore60);
  const lumpAmount = Math.round(avgLump36 * bm.benefitMonths);

  // è³‡ç”¢åƒæ•¸
  const assetNow = Math.max(0, money($("assetNow").value) || 0);
  const contribMonthly = Math.max(0, money($("contribMonthly").value) || 0);
  const rPre = Number($("rPre").value);
  const rPost = Number($("rPost").value);

  const passiveMonthly = Math.max(0, money($("passiveMonthly").value) || 0);
  const passiveUse = $("passiveUse").value;
  const otherMonthlyIncome = Math.max(0, money($("otherMonthlyIncome").value) || 0);

  const needMonthlyToday = Math.max(0, money($("needMonthlyToday").value) || 0);
  const inflation = Number($("inflation").value);
  const lifeExp = Number($("lifeExpectancy").value);

  const postContribMode = $("postContribMode").value;
  const postContribMonthly = Math.max(0, money($("postContribMonthly").value) || 0);

  if(!Number.isFinite(rPre) || !Number.isFinite(rPost) || !Number.isFinite(inflation) || !Number.isFinite(lifeExp)){
    alert("å ±é…¬ç‡/é€šè†¨/å£½å‘½ è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return;
  }

  const retireYearsSpan = Math.max(0, lifeExp - (retireY + retireM/12));
  const monthsRetired = Math.floor(retireYearsSpan * 12);

  // æŠŠã€Œå…¶ä»–æ”¶å…¥ã€æ¨åˆ°é€€ä¼‘ç•¶æœˆï¼ˆåç›®ï¼‰ï¼šç”¨æœˆé€šè†¨æ¨ï¼ˆç°¡åŒ–ä½†ä¸€è‡´ï¼‰
  const infM = (1 + inflation/100) ** (1/12) - 1;
  const otherMonthlyIncomeAtRetire = otherMonthlyIncome * ((1 + infM) ** monthsToRetire);

  // ä»¥æ¨¡æ“¬åˆ¤æ–·å¯å¦æ’åˆ°
  const baseParams = {
    monthsToRetire, monthsRetired,
    assetNow, contribMonthly,
    rPre, rPost,
    needMonthlyToday, inflation,
    laborMonthlyAtRetire,
    otherMonthlyIncomeAtRetire,
    passiveMonthly, passiveUse,
    postContribMode, postContribMonthly
  };

  const sim = simulatePlan(baseParams);
  const solve = solveExtraContribution(baseParams);

  // UI: KPI + å¯å±•é–‹ç´°ç¯€
  const out = $("output");
  out.style.display="block";

  const retireDateStr = `${retireDate.getFullYear()}-${String(retireDate.getMonth()+1).padStart(2,"0")}-${String(retireDate.getDate()).padStart(2,"0")}`;

  const statusTitle = sim.ok ? "âœ… å¯æ’åˆ°é è¨ˆå£½å‘½" : "âš ï¸ å¯èƒ½æå‰ç”¨å®Œè³‡ç”¢";
  const statusSub = sim.ok
    ? `æ¨¡æ“¬åˆ° ${lifeExp} æ­²çµæŸï¼Œè³‡ç”¢ä»ç‚ºæ­£ã€‚`
    : `æ¨¡æ“¬åˆ°ç¬¬ ${sim.monthBroke} å€‹é€€ä¼‘æœˆè³‡ç”¢è½‰ç‚ºè² ï¼ˆç´„é€€ä¼‘å¾Œ ${(sim.monthBroke/12).toFixed(1)} å¹´ï¼‰ã€‚`;

  const extraText = (solve.extra<=0)
    ? "ä½ ç›®å‰çš„æŠ•å…¥èˆ‡å ±é…¬å‡è¨­ä¸‹ï¼Œä¸éœ€è¦é¡å¤–å¢åŠ æŠ•å…¥ã€‚"
    : `è‹¥è¦æ’åˆ° ${lifeExp} æ­²ï¼ˆåœ¨åŒæ¨£å‡è¨­ä¸‹ï¼‰ï¼Œé€€ä¼‘å‰æ¯æœˆç´„éœ€ã€Œå†å¤šå­˜ã€ï¼šNT$ ${fmt(solve.extra)}ã€‚`;

  // ææ—©/å±•å»¶æç¤º
  const diffText = (adj.diffMonths === 0) ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0) ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼‰`
    : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼‰`;

  out.innerHTML = `
    <div class="kpi">
      <div class="kpi-box">
        <div class="kpi-title">${statusTitle}</div>
        <div class="kpi-value">é€€ä¼‘æ™‚è³‡ç”¢ï¼šNT$ ${fmt(Math.round(sim.assetAtRetire))}</div>
        <div class="kpi-sub">${statusSub}</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-title">å»ºè­°ï¼ˆç”¨åŒä¸€å¥—å‡è¨­åæ¨ï¼‰</div>
        <div class="kpi-value">${solve.extra<=0 ? "ä¸éœ€åŠ å­˜" : "éœ€åŠ å­˜"}</div>
        <div class="kpi-sub">${extraText}</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-title">å‹ä¿è€å¹´å¹´é‡‘ï¼ˆä¼°ï¼‰</div>
        <div class="kpi-value">NT$ ${fmt(laborMonthlyAtRetire)} /æœˆ</div>
        <div class="kpi-sub">${eligiblePension ? `æ¡ ${pension.chosen}ï¼›${diffText}` : "å¹´è³‡æœªæ»¿15å¹´ï¼šå¹´é‡‘=0ï¼ˆä¸€æ¬¡é‡‘ä»å¯ä¼°ï¼‰"}</div>
      </div>
      <div class="kpi-box">
        <div class="kpi-title">å‹ä¿ä¸€æ¬¡é‡‘ï¼ˆä¼°ï¼‰</div>
        <div class="kpi-value">NT$ ${fmt(lumpAmount)}</div>
        <div class="kpi-sub">çµ¦ä»˜æœˆæ•¸ï¼š${bm.benefitMonths.toFixed(2)}ï¼ˆä¸Šé™${bm.cap}ï¼‰</div>
      </div>
    </div>

    <details style="margin-top:12px">
      <summary>å±•é–‹ï¼šæˆ‘é€™æ¬¡çš„è¨ˆç®—ç´°ç¯€ï¼ˆçµ¦æƒ³è¦åš´è¬¹çš„äººï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">ç›®å‰å¹´é½¡ï¼ˆä¼°ï¼‰</td><td>${ageNowY}æ­²${ageNowMR}æœˆ</td></tr>
          <tr><td class="muted">é€€ä¼‘æ—¥æœŸï¼ˆä¼°ï¼‰</td><td>${retireDateStr}</td></tr>
          <tr><td class="muted">è·é›¢é€€ä¼‘</td><td>${monthsToRetire}å€‹æœˆï¼ˆâ‰ˆ${yearsToRetire.toFixed(2)}å¹´ï¼‰</td></tr>
          <tr><td class="muted">é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ï¼ˆä¼°ï¼‰</td><td>${(insAtRetireMonths/12).toFixed(2)}å¹´</td></tr>
          <tr><td class="muted">è–ªè³‡ä¾†æº</td><td>${salaryNote}</td></tr>
          <tr><td class="muted">å¹´é‡‘å¹³å‡è–ªè³‡ï¼ˆæœ€é«˜60æœˆï¼‰</td><td>NT$ ${fmt(Math.round(avgPension))}</td></tr>
          <tr><td class="muted">ä¸€æ¬¡é‡‘å¹³å‡è–ªè³‡ï¼ˆæœ€è¿‘36æœˆï¼‰</td><td>NT$ ${fmt(Math.round(avgLump36))}</td></tr>
          <tr><td class="muted">æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆROC ${rocBirthYear}ï¼‰</td><td>${legal.years}æ­²</td></tr>
          <tr><td class="muted">ææ—©/å±•å»¶</td><td>${diffText}</td></tr>
          <tr><td class="muted">è³‡ç”¢æ¨¡æ“¬ï¼šé€€ä¼‘å‰æ¯æœˆæŠ•å…¥</td><td>NT$ ${fmt(Math.round(contribMonthly))}</td></tr>
          <tr><td class="muted">è³‡ç”¢æ¨¡æ“¬ï¼šé€€ä¼‘å‰/å¾Œå ±é…¬ç‡</td><td>${rPre.toFixed(1)}% / ${rPost.toFixed(1)}%</td></tr>
          <tr><td class="muted">é€€ä¼‘ç”Ÿæ´»è²»ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td>NT$ ${fmt(Math.round(needMonthlyToday))}/æœˆï¼›é€šè†¨${inflation.toFixed(1)}%</td></tr>
          <tr><td class="muted">è¢«å‹•æ”¶å…¥</td><td>NT$ ${fmt(Math.round(passiveMonthly))}/æœˆï¼ˆ${passiveUse==="spend"?"æ‹¿ä¾†èŠ±":"å†æŠ•å…¥"}ï¼‰</td></tr>
          <tr><td class="muted">é€€ä¼‘å¾Œå…¶ä»–æ”¶å…¥ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td>NT$ ${fmt(Math.round(otherMonthlyIncome))}/æœˆ</td></tr>
          <tr><td class="muted">é€€ä¼‘å¾Œæ˜¯å¦æŠ•å…¥</td><td>${postContribMode==="yes" ? `æ˜¯ï¼šNT$ ${fmt(Math.round(postContribMonthly))}/æœˆ` : "å¦"}</td></tr>
        </table>
      </div>
    </details>
  `;

  // å°æé†’ï¼šè‹¥è«‹é ˜å·®è¶…é5å¹´
  if(Math.abs(adj.diffMonths) > 60){
    showWarn("ä½ è¼¸å…¥çš„è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é5å¹´ï¼›å¹´é‡‘åŠ æ¸›çµ¦å·²ä¾è¦å‰‡å°é ‚ï¼ˆÂ±20%ï¼‰ã€‚");
  }else{
    showOk("å·²å®Œæˆï¼šå‹ä¿ï¼ˆåš´è¬¹è¦å‰‡ï¼‰ï¼‹è³‡ç”¢å¢å€¼ï¼‹é€€ä¼‘å¾Œç¾é‡‘æµæ¨¡æ“¬ã€‚");
  }
}

function loadExample(){
  $("birthDate").value = "1980-01-01";
  $("retireYears").value = 65; $("retireMonths").value = 0;
  $("claimYears").value = 65; $("claimMonths").value = 0;

  $("insYearsNow").value = 28; $("insMonthsNow").value = 0; $("insDaysNow").value = 5;
  $("keepInsured").value = "yes";

  $("avgSalaryPension").value = 45800;
  $("avgSalaryLump36").value = 45800;

  $("assetNow").value = 8000000;
  $("contribMonthly").value = 30000;
  $("rPre").value = 5.0;
  $("rPost").value = 3.0;

  $("passiveMonthly").value = 25000;
  $("passiveUse").value = "spend";

  $("needMonthlyToday").value = 80000;
  $("inflation").value = 2.0;
  $("lifeExpectancy").value = 90;

  $("postContribMode").value = "no";
  $("postContribMonthly").value = 0;
  $("otherMonthlyIncome").value = 0;

  $("salaryLines").value = "";
  $("insAfter60Years").value = 0;
  $("insAfter60Months").value = 0;
  $("claimBefore60").value = "no";

  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼š8Mè³‡ç”¢ã€æ¯æœˆæŠ•å…¥3è¬ã€é€€ä¼‘å¾Œè¢«å‹•æ”¶å…¥2.5è¬ã€ç”Ÿæ´»è²»8è¬ã€‚");
  showWarn("");
  hideOutput();
}

(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  [
    "birthDate","retireYears","retireMonths","claimYears","claimMonths",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsured",
    "avgSalaryPension","avgSalaryLump36","salaryLines",
    "insAfter60Years","insAfter60Months","claimBefore60",
    "assetNow","contribMonthly","rPre","rPost",
    "passiveMonthly","passiveUse",
    "needMonthlyToday","inflation","lifeExpectancy",
    "postContribMode","postContribMonthly","otherMonthlyIncome"
  ].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", hideOutput);
    el.addEventListener("change", hideOutput);
  });
})();
</script>
</body>
</html>
