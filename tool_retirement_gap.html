<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿è€å¹´çµ¦ä»˜è©¦ç®—ï½œæ™º Financial Path</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="é€€ä¼‘ç¼ºå£è©¦ç®—ï¼‹å‹ä¿è€å¹´å¹´é‡‘/ä¸€æ¬¡é‡‘ï¼šè¼¸å…¥å‡ºç”Ÿå¹´æœˆæ—¥ã€å¹´è³‡ã€é€€ä¼‘/è«‹é ˜å¹´é½¡ã€æŠ•ä¿è–ªè³‡æ˜ç´°ï¼Œå®Œå…¨ä¾è¦å‰‡è¨ˆç®—æœ€é«˜60å€‹æœˆå¹³å‡ã€æœ€è¿‘36å€‹æœˆå¹³å‡ã€ä¸€æ¬¡é‡‘çµ¦ä»˜æœˆæ•¸ä¸Šé™èˆ‡60æ­²å¾Œå¹´è³‡è¦å‰‡ï¼ˆæ•™è‚²ç”¨é€”ï¼‰ã€‚" />
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#222; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300;
    --goodbg:#ecfdf3; --good:#027a48;
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text)}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}

  .topbar{
    background:#fff;border-bottom:1px solid var(--line);
    padding:10px 18px; position:sticky; top:0; z-index:100;
  }
  .topbar-inner{
    max-width:1100px;margin:auto;
    display:flex;justify-content:space-between;align-items:center;gap:12px;
  }
  .left-nav{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .container{max-width:1100px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:26px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:980px){ .grid{grid-template-columns:1.28fr 0.72fr} }

  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0f172a}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a}
  input,select,textarea,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  textarea{min-height:160px;resize:vertical;line-height:1.35}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1; min-width: 160px;}
  button{margin-top:14px;background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:800}
  button.secondary{background:#334155}
  .result{margin-top:14px;padding:14px;border-radius:12px;background:var(--soft);color:var(--primary);display:none}
  .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5;font-size:13px;line-height:1.4}
  .ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc;font-size:13px;line-height:1.4}
  .small{font-size:12.5px;color:var(--muted);line-height:1.45;margin-top:10px}
  .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:var(--primary);border:1px solid #dbe7ff}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table th{text-align:left;color:#0f172a}
  .table td:last-child,.table th:last-child{text-align:right}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #dbe2f0;color:#334155;background:#f8fafc;font-size:12px;margin-left:6px}
  .hr{border:0;border-top:1px solid var(--line);margin:14px 0}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿è€å¹´çµ¦ä»˜è©¦ç®— <span class="pill">å¹´é‡‘(æœ€é«˜60æœˆ)ï¼‹ä¸€æ¬¡é‡‘(æœ€è¿‘36æœˆ)ï¼‹ç¼ºå£è³‡ç”¢</span></h1>

    <div class="grid">
      <!-- å·¦ï¼šè¼¸å…¥ -->
      <div class="card">
        <h2>1) åŸºæœ¬è³‡æ–™ï¼ˆè‡ªå‹•æ¨ç®—ç¾åœ¨å¹´é½¡ã€é€€ä¼‘æ—¥ã€é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ï¼‰</h2>

        <div class="row">
          <div>
            <label>å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆè¥¿å…ƒï¼‰</label>
            <input id="birthDate" type="date" />
            <div class="small">ç”¨ä¾†æ¨ï¼šæ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”Ÿå¹´æ¬¡ï¼‰</div>
          </div>

          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <div class="row">
              <div>
                <input id="retireYears" type="number" min="0" step="1" value="65" />
                <div class="small">æ­²</div>
              </div>
              <div>
                <input id="retireMonths" type="number" min="0" max="11" step="1" value="0" />
                <div class="small">æœˆ</div>
              </div>
            </div>
          </div>
        </div>

        <label>ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆå¯å¡«åˆ°å¤©ï¼›æœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
        <div class="row">
          <div>
            <input id="insYearsNow" type="number" min="0" step="1" value="30" />
            <div class="small">å¹´</div>
          </div>
          <div>
            <input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" />
            <div class="small">æœˆ</div>
          </div>
          <div>
            <input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" />
            <div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
            <select id="keepInsured">
              <option value="yes" selected>æ˜¯ï¼šä¸€ç›´æŠ•ä¿åˆ°é€€ä¼‘</option>
              <option value="no">å¦ï¼šä¸å†å¢åŠ å¹´è³‡ï¼ˆç”¨ç›®å‰å¹´è³‡ï¼‰</option>
            </select>
            <div class="small">è‹¥ä½ æœªå¿…æ¯æœˆéƒ½æœ‰æŠ•ä¿ï¼Œå»ºè­°é¸ã€Œå¦ã€ã€‚</div>
          </div>

          <div>
            <label>é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆå¹´é‡‘ææ—©/å±•å»¶ç”¨ï¼‰</label>
            <div class="row">
              <div>
                <input id="claimYears" type="number" min="0" step="1" value="65" />
                <div class="small">æ­²</div>
              </div>
              <div>
                <input id="claimMonths" type="number" min="0" max="11" step="1" value="0" />
                <div class="small">æœˆ</div>
              </div>
            </div>
          </div>
        </div>

        <hr class="hr" />

        <h2>2) æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆåŒä¸€ä»½æ˜ç´°åŒæ™‚ç”¨æ–¼ï¼šå¹´é‡‘æœ€é«˜60æœˆã€ä¸€æ¬¡é‡‘æœ€è¿‘36æœˆï¼‰</h2>

        <div class="small">
          æ ¼å¼äºŒé¸ä¸€ï¼š<br/>
          A) åªè²¼é‡‘é¡ï¼Œä¸€è¡Œä¸€å€‹æœˆï¼ˆä¾æ™‚é–“é †åºï¼‰<span class="chip">æ¨è–¦</span><br/>
          B) <span class="mono">YYYY-MM é‡‘é¡</span> æˆ– <span class="mono">YYYY/MM é‡‘é¡</span>ï¼Œä¾‹ï¼š<span class="mono">2024-01 45800</span><br/>
          <span class="muted">å¹´é‡‘ç”¨ï¼šæœ€é«˜60å€‹æœˆå¹³å‡ï¼›ä¸€æ¬¡é‡‘ç”¨ï¼šé€€ä¿ç•¶æœˆèµ·æœ€è¿‘36å€‹æœˆå¹³å‡ï¼ˆä¸è¶³ç”¨å¯¦éš›ï¼‰ã€‚</span>
        </div>

        <label>æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆè‡³å°‘ 1 ç­†ï¼‰</label>
        <textarea id="salaryLines" placeholder="ä¾‹ï¼š
45800
45800
...
æˆ–ï¼š
2024-01 45800
2024-02 45800"></textarea>

        <div class="row">
          <div>
            <label>è‹¥ä½ ä¸æƒ³è²¼æ˜ç´°ï¼šå¹´é‡‘ç”¨å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆå¯é¸å¡«ï¼‰</label>
            <input id="avgSalaryForPension" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
            <div class="small">ä¸å¡«å‰‡è‡ªå‹•ç”¨æ˜ç´°è¨ˆç®—ã€‚</div>
          </div>
          <div>
            <label>è‹¥ä½ ä¸æƒ³è²¼æ˜ç´°ï¼šä¸€æ¬¡é‡‘ç”¨æœ€è¿‘36æœˆå¹³å‡è–ªè³‡ï¼ˆå¯é¸å¡«ï¼‰</label>
            <input id="avgSalaryForLump36" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
            <div class="small">ä¸å¡«å‰‡è‡ªå‹•ç”¨æ˜ç´°å–ã€Œæœ€å¾Œ36ç­†ã€ã€‚</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ä¸€æ¬¡é‡‘ï¼š60æ­²å¾ŒåŠ ä¿å¹´è³‡ï¼ˆè‹¥æ²’æœ‰å¡«0ï¼‰</label>
            <div class="row">
              <div>
                <input id="insAfter60Years" type="number" min="0" step="1" value="0" />
                <div class="small">å¹´</div>
              </div>
              <div>
                <input id="insAfter60Months" type="number" min="0" max="11" step="1" value="0" />
                <div class="small">æœˆ</div>
              </div>
            </div>
            <div class="small">
              è¦å‰‡ï¼š60æ­²å¾Œå¹´è³‡æœ€å¤šç®—5å¹´ï¼ˆ60å€‹æœˆï¼‰ï¼›èˆ‡60æ­²å‰åˆä½µï¼Œä¸€æ¬¡é‡‘çµ¦ä»˜æœˆæ•¸æœ€é«˜50å€‹æœˆã€‚
            </div>
          </div>

          <div>
            <label>ä¸€æ¬¡é‡‘ï¼šæ˜¯å¦åœ¨60æ­²å‰é€€ä¿/è«‹é ˜ï¼Ÿ</label>
            <select id="claimBefore60">
              <option value="no" selected>å¦ï¼ˆ60æ­²æˆ–ä¹‹å¾Œï¼‰</option>
              <option value="yes">æ˜¯ï¼ˆæœªæ»¿60æ­²ï¼‰</option>
            </select>
            <div class="small">
              è‹¥æœªæ»¿60æ­²ï¼Œ60æ­²å¾Œå¹´è³‡è¦å‰‡ä¸é©ç”¨ï¼›ä¸€æ¬¡é‡‘ä¸Šé™ä»¥45å€‹æœˆç‚ºä¸»ï¼ˆ60æ­²å‰å¹´è³‡æœ€å¤šç®—30å¹´ï¼‰ã€‚
            </div>
          </div>
        </div>

        <hr class="hr" />

        <h2>3) é€€ä¼‘ç¼ºå£ï¼ˆç›®æ¨™ç”Ÿæ´»è²» â†’ æ‰£é™¤æ”¶å…¥ â†’ éœ€è¦æº–å‚™å¤šå°‘è³‡ç”¢ï¼‰</h2>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™ç”Ÿæ´»è²»ï¼ˆä»¥ã€Œä»Šå¤©ã€åƒ¹å€¼ï¼‰</label>
            <input id="needMonthlyToday" type="number" min="0" step="1000" value="80000" />
          </div>
          <div>
            <label>é æœŸé€šè†¨ï¼ˆå¹´ %ï¼‰</label>
            <input id="inflation" type="number" min="0" step="0.1" value="2.0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œå…¶ä»–ã€Œæ¯æœˆã€æ”¶å…¥ï¼ˆä¸å«å‹ä¿ï¼‰</label>
            <input id="otherMonthlyIncome" type="number" min="0" step="1000" value="0" />
          </div>
          <div>
            <label>é è¨ˆå£½å‘½ï¼ˆæ­²ï¼‰</label>
            <input id="lifeExpectancy" type="number" min="0" step="1" value="90" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾ŒæŠ•è³‡å ±é…¬ï¼ˆå¹´ï¼Œåç›® %ï¼‰</label>
            <input id="returnNominal" type="number" step="0.1" value="3.0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰æŠ•è³‡å ±é…¬ï¼ˆå¹´ï¼Œåç›® %ï¼‰</label>
            <input id="returnPreNominal" type="number" step="0.1" value="3.0" />
          </div>
        </div>

        <div class="row">
          <button onclick="calcAll()">è¨ˆç®—ï¼ˆå®Œå…¨ä¾è¦å‰‡ï¼‰</button>
          <button class="secondary" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
        </div>

        <div id="warnBox" class="warn"></div>
        <div id="okBox" class="ok"></div>

        <p class="small">
          â€» æ•™è‚²ç”¨é€”ï¼šæ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ã€‚æ­¤å·¥å…·é‡é»æ˜¯ç”¨åŒä¸€å¥—è¦å‰‡ï¼Œè®“è®€è€…èƒ½å»ºç«‹ã€Œé€€ä¼‘ç¼ºå£ã€èˆ‡ã€Œå¹´é‡‘/ä¸€æ¬¡é‡‘ã€æ¦‚å¿µã€‚
        </p>
      </div>

      <!-- å³ï¼šçµæœ -->
      <div class="card">
        <h2>çµæœ</h2>
        <div id="output" class="result"></div>
      </div>
    </div>
  </div>

<script>
/** ========= è¦å‰‡ =========
 * å¹´é‡‘ï¼š
 * - å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼šåŠ ä¿æœŸé–“æœ€é«˜60å€‹æœˆå¹³å‡ï¼›æœªæ»¿60å€‹æœˆç”¨å¯¦éš›å¹³å‡
 * - æœˆé ˜ï¼šå…©å¼æ“‡å„ª
 *   â‘  å¹³å‡è–ªè³‡Ã—å¹´è³‡Ã—0.775% + 3000
 *   â‘¡ å¹³å‡è–ªè³‡Ã—å¹´è³‡Ã—1.55%
 * - ææ—©/å±•å»¶ï¼šæ¯å¹´ Â±4%ï¼Œæœ€å¤š Â±20%(5å¹´)ï¼Œæœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹
 *
 * ä¸€æ¬¡é‡‘ï¼ˆä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼‰ï¼š
 * - å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼šé€€ä¿ç•¶æœˆèµ·æœ€è¿‘36å€‹æœˆå¹³å‡ï¼›æœªæ»¿36å€‹æœˆç”¨å¯¦éš›å¹³å‡
 * - çµ¦ä»˜æœˆæ•¸ï¼ˆå¹´è³‡æ›ç®—ï¼‰ï¼š
 *   å‰15å¹´ï¼šæ¯æ»¿1å¹´ç™¼1å€‹æœˆ
 *   ç¬¬16å¹´èµ·ï¼šæ¯æ»¿1å¹´ç™¼2å€‹æœˆ
 * - 60æ­²å‰å¹´è³‡æœ€å¤šç®—30å¹´ â†’ çµ¦ä»˜æœˆæ•¸æœ€å¤š45å€‹æœˆ
 * - 60æ­²å¾Œå¹´è³‡æœ€å¤šç®—5å¹´ â†’ åˆä½µæœ€é«˜50å€‹æœˆ
 *
 * å¹´è³‡æ›ç®—ï¼š
 * - æœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹ï¼›æœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼ˆæˆ‘å€‘ç”¨ã€Œå¤©>0ã€+1æœˆï¼‰
 */

const RULES = {
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  },
  maxAdjYears: 5,
  adjPerYear: 0.04
};

function $(id){ return document.getElementById(id); }
function clampInt(v){ if(!Number.isFinite(v)) return NaN; return Math.max(0, Math.floor(v)); }
function parseMoneyStr(s){
  const cleaned = (s||"").toString().trim().replace(/[,ï¼Œ]/g,"");
  if(!cleaned) return NaN;
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}
function fmt(n){ try { return Number(n).toLocaleString("en-US"); } catch { return String(n); } }
function showWarn(msg){ const w=$("warnBox"); if(!msg){w.style.display="none";w.textContent="";return;} w.style.display="block";w.textContent=msg; }
function showOk(msg){ const o=$("okBox"); if(!msg){o.style.display="none";o.textContent="";return;} o.style.display="block";o.textContent=msg; }
function hideOutput(){ $("output").style.display="none"; $("output").innerHTML=""; }

function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }

function calcAgeMonths(birthDate, today){
  let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
  if (today.getDate() < birthDate.getDate()) months -= 1;
  return Math.max(0, months);
}

function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}

function monthsBetween(today, future){
  // ä»¥ã€Œæ»¿æœˆã€è¨ˆç®—
  let m = (future.getFullYear()-today.getFullYear())*12 + (future.getMonth()-today.getMonth());
  if (future.getDate() < today.getDate()) m -= 1;
  return Math.max(0, m);
}

function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}

function adjustFactor(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths;
  const rawYears = diffMonths / 12;
  const cappedYears = Math.max(-RULES.maxAdjYears, Math.min(RULES.maxAdjYears, rawYears));
  const factor = 1 + cappedYears * RULES.adjPerYear;
  return { factor, diffMonths, rawYears, cappedYears };
}

/** è§£æè–ªè³‡æ˜ç´°ï¼šæ”¯æ´ YYYY-MM é‡‘é¡ æˆ–ä¸€è¡Œé‡‘é¡ */
function parseSalaryLines(text){
  const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const dated = [];
  const seq = [];
  for(const line of lines){
    const m = line.match(/^(\d{4})[\/\-](\d{1,2})[^\d]+([\d,ï¼Œ]+(\.\d+)?)$/);
    if(m){
      const yyyy=Number(m[1]), mm=Number(m[2]);
      const salary=parseMoneyStr(m[3]);
      if(!Number.isFinite(yyyy)||!Number.isFinite(mm)||mm<1||mm>12||!Number.isFinite(salary)||salary<=0) continue;
      dated.push({ key: yyyy*12 + mm, salary });
      continue;
    }
    const salary=parseMoneyStr(line);
    if(Number.isFinite(salary) && salary>0) seq.push(salary);
  }

  if(dated.length>0){
    // åŒæœˆå–æœ€å¾Œä¸€ç­†
    const map=new Map();
    for(const it of dated) map.set(it.key, it.salary);
    const arr=[...map.entries()].sort((a,b)=>a[0]-b[0]).map(([key,salary])=>salary);
    return { mode:"dated", salaries: arr, count: arr.length };
  }

  return { mode:"sequence", salaries: seq, count: seq.length };
}

/** å¹´é‡‘ï¼šæœ€é«˜60å€‹æœˆå¹³å‡ï¼ˆä¸è¶³60ç”¨å…¨éƒ¨å¹³å‡ï¼‰ */
function avgTop60(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  if(n<60){
    const sum=salaries.reduce((a,b)=>a+b,0);
    return { avg: sum/n, rule:"æœªæ»¿5å¹´ï¼šä»¥å¯¦éš›æŠ•ä¿æœŸé–“å¹³å‡" };
  }
  const sorted=salaries.slice().sort((a,b)=>b-a);
  const top60=sorted.slice(0,60);
  const sum=top60.reduce((a,b)=>a+b,0);
  return { avg: sum/60, rule:"æœ€é«˜60å€‹æœˆå¹³å‡" };
}

/** ä¸€æ¬¡é‡‘ï¼šæœ€è¿‘36å€‹æœˆå¹³å‡ï¼ˆä¸è¶³36ç”¨å…¨éƒ¨å¹³å‡ï¼‰
 * - datedï¼šå·²æ’åºï¼Œå–æœ€å¾Œ36ç­†
 * - sequenceï¼šè¦–è¼¸å…¥é †åºç‚ºæ™‚é–“é †åºï¼Œå–æœ€å¾Œ36ç­†
 */
function avgLast36(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  const used = (n<=36) ? salaries.slice() : salaries.slice(n-36);
  const sum = used.reduce((a,b)=>a+b,0);
  return { avg: sum/used.length, rule: (n<36) ? "æœªæ»¿36å€‹æœˆï¼šä»¥å¯¦éš›æœŸé–“å¹³å‡" : "é€€ä¿ç•¶æœˆèµ·æœ€è¿‘36å€‹æœˆå¹³å‡" };
}

/** å¹´é‡‘å…©å¼æ“‡å„ª + ææ—©/å±•å»¶ */
function calcPension(avgSalary, insMonths, factor){
  const insYears = insMonths / 12;
  const base1 = avgSalary * insYears * 0.00775 + 3000;
  const base2 = avgSalary * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2)
    ? "ç¬¬1å¼ï¼šå¹³å‡è–ªè³‡Ã—å¹´è³‡Ã—0.775%ï¼‹3,000"
    : "ç¬¬2å¼ï¼šå¹³å‡è–ªè³‡Ã—å¹´è³‡Ã—1.55%";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly, insYears };
}

/** ä¸€æ¬¡é‡‘çµ¦ä»˜æœˆæ•¸ï¼ˆå®Œå…¨æŒ‰åœ–ä¸Šè¦å‰‡ï¼‰ */
function lumpBenefitMonths(insMonthsTotal, after60MonthsInput, claimBefore60){
  // 60æ­²å¾Œå¹´è³‡æœ€å¤šè¨ˆ 60 å€‹æœˆï¼ˆ5å¹´ï¼‰
  const after60MonthsCapped = Math.min(Math.max(0, after60MonthsInput), 60);

  // è‹¥æœªæ»¿60æ­²è«‹é ˜ï¼š60æ­²å¾Œå¹´è³‡ä¸é©ç”¨
  const useAfter60 = (!claimBefore60);

  const after60Months = useAfter60 ? after60MonthsCapped : 0;

  // 60æ­²å‰å¹´è³‡ = ç¸½å¹´è³‡ - 60å¾Œå¹´è³‡ï¼ˆä½†ä¸å¾—å°æ–¼0ï¼‰
  let pre60Months = Math.max(0, insMonthsTotal - after60Months);

  // 60æ­²å‰å¹´è³‡æœ€å¤šç®— 30å¹´ = 360å€‹æœˆ
  pre60Months = Math.min(pre60Months, 360);

  const pre60Years = pre60Months / 12;
  const y1 = Math.min(15, pre60Years);
  const y2 = Math.max(0, pre60Years - 15);

  const benefitPre60 = y1 * 1 + y2 * 2; // å‰15å¹´Ã—1 + å¾ŒçºŒÃ—2
  // 60æ­²å‰å¹´è³‡æœ€å¤š30å¹´ => æœ€å¤§ 15*1 + 15*2 = 45
  const benefitPre60Capped = Math.min(benefitPre60, 45);

  // 60æ­²å¾Œï¼šæœ€å¤š5å¹´ï¼ŒåŠ åˆ°ç¸½ä¸Šé™ 50ï¼ˆæœˆæ•¸ï¼‰
  const benefitAfter60 = after60Months / 12; // 1å¹´=1æœˆï¼ˆç¬¦åˆ45+5=50ï¼‰
  const total = benefitPre60Capped + benefitAfter60;

  const cap = claimBefore60 ? 45 : 50;
  return {
    benefitPre60: benefitPre60Capped,
    benefitAfter60,
    benefitTotal: Math.min(total, cap),
    cap,
    pre60MonthsUsed: pre60Months,
    after60MonthsUsed: after60Months
  };
}

/** ä¸€æ¬¡é‡‘é‡‘é¡ = å¹³å‡æœˆæŠ•ä¿è–ªè³‡(æœ€è¿‘36æœˆ) Ã— çµ¦ä»˜æœˆæ•¸ */
function calcLumpSum(avgSalary36, benefitMonths){
  return Math.round(avgSalary36 * benefitMonths);
}

/** ======== é€€ä¼‘ç¼ºå£ï¼ˆç”¨å¯¦è³ªåˆ©ç‡é¿å…é€šè†¨é‡ç®—ï¼‰ ======== */
function realRate(nominalPct, inflationPct){
  return (1 + nominalPct/100) / (1 + inflationPct/100) - 1;
}

function pvOfRealAnnuityGap(monthlyGapToday, years, realAnnual){
  if(monthlyGapToday <= 0) return 0;
  const n = Math.max(0, Math.floor(years*12));
  if(n === 0) return 0;
  const r = realAnnual / 12;
  if(Math.abs(r) < 1e-9) return monthlyGapToday * n;
  return monthlyGapToday * (1 - Math.pow(1+r, -n)) / r;
}

function pmtToReachFV(fvToday, years, realAnnual){
  if(fvToday <= 0) return 0;
  const n = Math.max(0, Math.floor(years*12));
  if(n === 0) return Infinity;
  const r = realAnnual / 12;
  if(Math.abs(r) < 1e-9) return fvToday / n;
  return fvToday * r / (Math.pow(1+r, n) - 1);
}

function calcAll(){
  showWarn(""); showOk(""); hideOutput();

  const today = new Date();
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  const birthDate = new Date($("birthDate").value + "T00:00:00");
  if(!(birthDate instanceof Date) || isNaN(birthDate.getTime())){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´æœˆæ—¥"); return;
  }

  const retireY = clampInt(Number($("retireYears").value));
  const retireM = clampInt(Number($("retireMonths").value));
  if(!Number.isFinite(retireY) || !Number.isFinite(retireM) || retireM>11){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é è¨ˆé€€ä¼‘å¹´é½¡ï¼ˆæœˆä»½0~11ï¼‰"); return;
  }

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆéœ€>0ï¼‰"); return;
  }

  const keepInsured = $("keepInsured").value === "yes";

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || !Number.isFinite(claimM) || claimM>11){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„è«‹é ˜å¹´é½¡ï¼ˆæœˆä»½0~11ï¼‰"); return;
  }

  const claimBefore60 = $("claimBefore60").value === "yes";

  const after60MonthsInput = insToMonths($("insAfter60Years").value, $("insAfter60Months").value, 0);
  if(!Number.isFinite(after60MonthsInput) || after60MonthsInput<0){
    alert("60æ­²å¾ŒåŠ ä¿å¹´è³‡è¼¸å…¥æœ‰èª¤"); return;
  }

  // å¹´é½¡èˆ‡é€€ä¼‘æ™‚é–“
  const ageNowMonths = calcAgeMonths(birthDate, today);
  const ageNowY = Math.floor(ageNowMonths/12);
  const ageNowMR = ageNowMonths % 12;

  const retireAgeMonths = ageToMonths(retireY, retireM);
  const retireDate = calcDateAtAge(birthDate, retireAgeMonths);
  const monthsToRetire = monthsBetween(today, retireDate);
  const yearsToRetire = monthsToRetire / 12;

  // é€€ä¼‘æ™‚å¹´è³‡ï¼ˆæœˆï¼‰
  const insAtRetireMonths = keepInsured ? (insNowMonths + monthsToRetire) : insNowMonths;

  // è§£æè–ªè³‡æ˜ç´°
  const salaryParsed = parseSalaryLines($("salaryLines").value);
  const avgSalaryForPensionInput = parseMoneyStr($("avgSalaryForPension").value);
  const avgSalaryForLump36Input = parseMoneyStr($("avgSalaryForLump36").value);

  if((!salaryParsed.count) && (!Number.isFinite(avgSalaryForPensionInput) || avgSalaryForPensionInput<=0) && (!Number.isFinite(avgSalaryForLump36Input) || avgSalaryForLump36Input<=0)){
    alert("è«‹è‡³å°‘ï¼šè²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼Œæˆ–è¼¸å…¥å¹´é‡‘/ä¸€æ¬¡é‡‘çš„å¹³å‡è–ªè³‡ï¼ˆå…¶ä¸­ä¸€ç¨®ï¼‰");
    return;
  }

  // å¹´é‡‘å¹³å‡è–ªè³‡
  let avgPension = NaN;
  let avgPensionRule = "";
  if(Number.isFinite(avgSalaryForPensionInput) && avgSalaryForPensionInput>0){
    avgPension = avgSalaryForPensionInput;
    avgPensionRule = "ä½¿ç”¨ä½ è¼¸å…¥çš„å¹´é‡‘å¹³å‡è–ªè³‡";
  }else{
    if(!salaryParsed.count){ alert("å¹´é‡‘å¹³å‡è–ªè³‡æœªå¡«ï¼Œä¸”æ˜ç´°ä¸è¶³"); return; }
    const r = avgTop60(salaryParsed.salaries);
    avgPension = r.avg;
    avgPensionRule = r.rule;
  }

  // ä¸€æ¬¡é‡‘å¹³å‡è–ªè³‡ï¼ˆæœ€è¿‘36ï¼‰
  let avgLump36 = NaN;
  let avgLumpRule = "";
  if(Number.isFinite(avgSalaryForLump36Input) && avgSalaryForLump36Input>0){
    avgLump36 = avgSalaryForLump36Input;
    avgLumpRule = "ä½¿ç”¨ä½ è¼¸å…¥çš„ä¸€æ¬¡é‡‘æœ€è¿‘36æœˆå¹³å‡è–ªè³‡";
  }else{
    if(!salaryParsed.count){ alert("ä¸€æ¬¡é‡‘å¹³å‡è–ªè³‡æœªå¡«ï¼Œä¸”æ˜ç´°ä¸è¶³"); return; }
    const r = avgLast36(salaryParsed.salaries);
    avgLump36 = r.avg;
    avgLumpRule = r.rule;
  }

  if(!Number.isFinite(avgPension) || avgPension<=0){ alert("å¹´é‡‘å¹³å‡è–ªè³‡ç„¡æ³•å–å¾—"); return; }
  if(!Number.isFinite(avgLump36) || avgLump36<=0){ alert("ä¸€æ¬¡é‡‘å¹³å‡è–ªè³‡ç„¡æ³•å–å¾—"); return; }

  // æ³•å®šå¹´é½¡èˆ‡åŠ æ¸›çµ¦ä¿‚æ•¸
  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalMonths = ageToMonths(legal.years, legal.months);
  const claimMonthsTotal = ageToMonths(claimY, claimM);
  const adj = adjustFactor(legalMonths, claimMonthsTotal);

  // å¹´é‡‘è³‡æ ¼
  const eligiblePension = insAtRetireMonths >= 15*12;
  const pension = eligiblePension ? calcPension(avgPension, insAtRetireMonths, adj.factor) : null;

  // ä¸€æ¬¡é‡‘ï¼ˆå®Œå…¨è¦å‰‡ï¼‰
  const bm = lumpBenefitMonths(insAtRetireMonths, after60MonthsInput, claimBefore60);
  const lumpAmount = calcLumpSum(avgLump36, bm.benefitTotal);

  // é€€ä¼‘ç¼ºå£
  const needMonthlyToday = parseMoneyStr($("needMonthlyToday").value);
  const inflation = Number($("inflation").value);
  const otherMonthlyIncome = parseMoneyStr($("otherMonthlyIncome").value) || 0;
  const lifeExp = Number($("lifeExpectancy").value);
  const rNominalPost = Number($("returnNominal").value);
  const rNominalPre  = Number($("returnPreNominal").value);

  if(!Number.isFinite(needMonthlyToday) || needMonthlyToday<0){ alert("é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™ç”Ÿæ´»è²»è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(inflation) || inflation<0){ alert("é€šè†¨è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(lifeExp) || lifeExp<=0){ alert("é è¨ˆå£½å‘½è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(rNominalPost) || !Number.isFinite(rNominalPre)){ alert("å ±é…¬ç‡è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }

  const retireYearsSpan = Math.max(0, lifeExp - retireY - retireM/12);

  const needAtRetireNominal = needMonthlyToday * Math.pow(1 + inflation/100, yearsToRetire);

  const laborMonthlyAtRetire = eligiblePension ? pension.finalMonthly : 0;
  const otherAtRetireNominal = otherMonthlyIncome * Math.pow(1 + inflation/100, yearsToRetire);

  const gapAtRetireNominal = Math.max(0, needAtRetireNominal - (laborMonthlyAtRetire + otherAtRetireNominal));
  const gapToday = gapAtRetireNominal / Math.pow(1 + inflation/100, yearsToRetire);

  const rRealPost = realRate(rNominalPost, inflation);
  const rRealPre  = realRate(rNominalPre, inflation);

  const pvGapAtRetireToday = pvOfRealAnnuityGap(gapToday, retireYearsSpan, rRealPost);
  const pmtNeedToday = pmtToReachFV(pvGapAtRetireToday, yearsToRetire, rRealPre);

  // è¨Šæ¯
  if(salaryParsed.count){
    showOk(`å·²è®€å–æŠ•ä¿è–ªè³‡æ˜ç´° ${salaryParsed.count} ç­†ï¼ˆ${salaryParsed.mode==="dated" ? "ä¾æœˆä»½æ’åº" : "ä¾è¼¸å…¥é †åº"}ï¼‰ã€‚`);
  }else{
    showWarn("ä½ æœªè²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼Œå·²æ”¹ç”¨ä½ è¼¸å…¥çš„å¹³å‡è–ªè³‡è¨ˆç®—ã€‚");
  }

  const diffText = (adj.diffMonths === 0)
    ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0)
      ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆç´„ ${adj.rawYears.toFixed(2)} å¹´ï¼›å°é ‚æ¡ ${adj.cappedYears.toFixed(2)} å¹´ï¼‰`
      : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆç´„ ${Math.abs(adj.rawYears).toFixed(2)} å¹´ï¼›å°é ‚æ¡ ${Math.abs(adj.cappedYears).toFixed(2)} å¹´ï¼‰`;

  const earlyTooMuch = (adj.diffMonths < -60);
  const lateTooMuch  = (adj.diffMonths >  60);

  const capWarn = (earlyTooMuch || lateTooMuch)
    ? `<div class="warn" style="display:block;margin-top:10px">
         ä½ è¼¸å…¥çš„è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é 5 å¹´ã€‚ä¾è¦å®šææ—©/å±•å»¶æœ€å¤š 5 å¹´ï¼ˆÂ±20%ï¼‰ï¼Œæœ¬å·¥å…·å·²è‡ªå‹•å°é ‚ã€‚
       </div>`
    : "";

  const out = $("output");
  out.style.display="block";

  const pensionBlock = eligiblePension ? `
    <div style="font-weight:900;font-size:16px;margin-top:10px">A) è€å¹´å¹´é‡‘ï¼ˆå®Œå…¨è¦å‰‡ï¼‰</div>
    <div style="font-weight:900;font-size:18px;margin-top:6px">
      é ä¼°æ¯æœˆå¯é ˜ï¼šNT$ ${fmt(laborMonthlyAtRetire)}
      <span class="muted" style="font-weight:600;font-size:12.5px">ï¼ˆæ¡ç”¨ï¼š${pension.chosen}ï¼‰</span>
    </div>

    <table class="table">
      <tr><td class="muted">å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆå¹´é‡‘ï¼‰</td><td>NT$ ${fmt(Math.round(avgPension))} <span class="muted">ï¼ˆ${avgPensionRule}ï¼‰</span></td></tr>
      <tr><td class="muted">ç¬¬1å¼ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base1))}</td></tr>
      <tr><td class="muted">ç¬¬2å¼ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base2))}</td></tr>
      <tr><td class="muted">æ“‡å„ªåŸºç¤é‡‘é¡ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.chosenBase))}</td></tr>
      <tr><td class="muted">ææ—©/å±•å»¶ä¿‚æ•¸</td><td>Ã— ${adj.factor.toFixed(4)}</td></tr>
      <tr><td style="font-weight:900">åŠ æ¸›çµ¦å¾Œæœˆé ˜</td><td style="font-weight:900">NT$ ${fmt(laborMonthlyAtRetire)}</td></tr>
    </table>
  ` : `
    <div class="warn" style="display:block;margin-top:10px">
      é€€ä¼‘æ™‚æ¨ä¼°æŠ•ä¿å¹´è³‡æœªæ»¿ 15 å¹´ï¼šä¸€èˆ¬ä¸ç¬¦åˆã€Œè€å¹´å¹´é‡‘ã€æ¢ä»¶ï¼›ä¸‹é¢ä»æä¾›ã€Œä¸€æ¬¡é‡‘ã€ä¼°ç®—ï¼›é€€ä¼‘ç¼ºå£ä»¥å‹ä¿å¹´é‡‘=0ä¼°ç®—ã€‚
    </div>
  `;

  const lumpBlock = `
    <div style="font-weight:900;font-size:16px;margin-top:14px">B) ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆä¸€æ¬¡é‡‘ï¼Œå®Œå…¨è¦å‰‡ï¼‰</div>
    <table class="table">
      <tr><td class="muted">å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆä¸€æ¬¡é‡‘ï¼‰</td><td>NT$ ${fmt(Math.round(avgLump36))} <span class="muted">ï¼ˆ${avgLumpRule}ï¼‰</span></td></tr>
      <tr><td class="muted">60æ­²å‰å¹´è³‡æ¡è¨ˆï¼ˆæœˆï¼‰</td><td>${bm.pre60MonthsUsed}ï¼ˆä¸Šé™360æœˆï¼‰</td></tr>
      <tr><td class="muted">60æ­²å¾Œå¹´è³‡æ¡è¨ˆï¼ˆæœˆï¼‰</td><td>${bm.after60MonthsUsed}ï¼ˆä¸Šé™60æœˆï¼‰</td></tr>
      <tr><td class="muted">60æ­²å‰çµ¦ä»˜æœˆæ•¸ï¼ˆ1å€+2å€ï¼Œä¸Šé™45ï¼‰</td><td>${bm.benefitPre60.toFixed(4)} æœˆ</td></tr>
      <tr><td class="muted">60æ­²å¾Œè¿½åŠ çµ¦ä»˜æœˆæ•¸ï¼ˆæœ€å¤š+5æœˆï¼‰</td><td>${bm.benefitAfter60.toFixed(4)} æœˆ</td></tr>
      <tr><td class="muted">çµ¦ä»˜æœˆæ•¸ä¸Šé™</td><td>${bm.cap} æœˆ</td></tr>
      <tr><td style="font-weight:900">çµ¦ä»˜æœˆæ•¸ï¼ˆæœ€çµ‚ï¼‰</td><td style="font-weight:900">${bm.benefitTotal.toFixed(4)} æœˆ</td></tr>
      <tr><td style="font-weight:900">ä¸€æ¬¡é‡‘é‡‘é¡ï¼ˆæœ€çµ‚ï¼‰</td><td style="font-weight:900">NT$ ${fmt(lumpAmount)}</td></tr>
    </table>
    <div class="small muted">
      è¨»ï¼šä¸€æ¬¡é‡‘çš„ã€Œå‰15å¹´æ¯å¹´1æœˆã€ç¬¬16å¹´èµ·æ¯å¹´2æœˆã€æœƒè®“å¹´è³‡é•·çš„äººä¸€æ¬¡é‡‘é«˜å¾ˆå¤šï¼›ä½†60æ­²å‰å¹´è³‡æœ€å¤šç®—30å¹´ï¼ˆæœ€å¤š45æœˆï¼‰ï¼Œ60æ­²å¾Œæœ€å¤šå†åŠ 5å¹´ï¼ˆåˆè¨ˆæœ€å¤š50æœˆï¼‰ã€‚
    </div>
  `;

  const gapBlock = `
    <div style="font-weight:900;font-size:16px;margin-top:14px">C) é€€ä¼‘ç¼ºå£ï¼ˆç¼ºå£è³‡ç”¢ï¼‹æ¯æœˆéœ€å­˜ï¼‰</div>
    <table class="table">
      <tr><td class="muted">é€€ä¼‘å¾Œç›®æ¨™ç”Ÿæ´»è²»ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td>NT$ ${fmt(Math.round(needMonthlyToday))} /æœˆ</td></tr>
      <tr><td class="muted">æ¨ä¼°é€€ä¼‘ç•¶å¹´ç›®æ¨™ç”Ÿæ´»è²»ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(needAtRetireNominal))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘ç•¶å¹´å‹ä¿å¹´é‡‘ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(laborMonthlyAtRetire))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘ç•¶å¹´å…¶ä»–æ”¶å…¥ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(otherAtRetireNominal))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘ç•¶å¹´æ¯æœˆç¼ºå£ï¼ˆåç›®ï¼‰</td><td style="font-weight:900">NT$ ${fmt(Math.round(gapAtRetireNominal))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘å¾ŒæœŸé–“ï¼ˆè‡³ ${lifeExp} æ­²ï¼‰</td><td>${retireYearsSpan.toFixed(2)} å¹´</td></tr>
      <tr><td class="muted">é€€ä¼‘å¾Œå¯¦è³ªå ±é…¬ï¼ˆæ‰£é€šè†¨ï¼‰</td><td>${(rRealPost*100).toFixed(2)}%</td></tr>
      <tr><td class="muted">é€€ä¼‘æ™‚éœ€æº–å‚™è³‡ç”¢ï¼ˆä»¥ä»Šå¤©åƒ¹å€¼ï¼‰</td><td style="font-weight:900">NT$ ${fmt(Math.round(pvGapAtRetireToday))}</td></tr>
      <tr><td class="muted">è·é›¢é€€ä¼‘</td><td>${monthsToRetire} å€‹æœˆï¼ˆâ‰ˆ ${yearsToRetire.toFixed(2)} å¹´ï¼‰</td></tr>
      <tr><td class="muted">é€€ä¼‘å‰å¯¦è³ªå ±é…¬ï¼ˆæ‰£é€šè†¨ï¼‰</td><td>${(rRealPre*100).toFixed(2)}%</td></tr>
      <tr><td class="muted">ç‚ºé”æˆç¼ºå£è³‡ç”¢ï¼šç¾åœ¨èµ·æ¯æœˆéœ€å­˜ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td style="font-weight:900">${isFinite(pmtNeedToday) ? "NT$ " + fmt(Math.round(pmtNeedToday)) + " /æœˆ" : "â€”"}</td></tr>
    </table>
    <div class="small muted">
      æœ¬ç¼ºå£æ¨¡å‹æ¡ç”¨ã€Œå¯¦è³ªåˆ©ç‡ã€è¨ˆç®—ï¼šå…ˆæŠŠé€€ä¼‘ç•¶å¹´ç¼ºå£æ›å›ä»Šå¤©åƒ¹å€¼ï¼Œå†ç”¨æ‰£é€šè†¨å¾Œçš„å ±é…¬ç‡ä¼°ç®—æ‰€éœ€è³‡ç”¢ï¼Œé¿å…æŠŠé€šè†¨ç®—å…©æ¬¡ã€‚
    </div>
  `;

  out.innerHTML = `
    <div style="font-weight:900;font-size:16px">é—œéµæ¨ç®—ï¼ˆè‡ªå‹•ï¼‰</div>
    <table class="table">
      <tr><td class="muted">ç›®å‰å¹´é½¡ï¼ˆä¼°ï¼‰</td><td>${ageNowY} æ­² ${ageNowMR} æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘æ—¥æœŸï¼ˆä¼°ï¼‰</td><td>${retireDate.getFullYear()}-${String(retireDate.getMonth()+1).padStart(2,"0")}-${String(retireDate.getDate()).padStart(2,"0")}</td></tr>
      <tr><td class="muted">ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆæœˆï¼‰</td><td>${insNowMonths}ï¼ˆâ‰ˆ ${(insNowMonths/12).toFixed(2)} å¹´ï¼‰</td></tr>
      <tr><td class="muted">åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿</td><td>${keepInsured ? "æ˜¯ï¼ˆå¹´è³‡æœƒå¢åŠ ï¼‰" : "å¦ï¼ˆå¹´è³‡ä¸å¢åŠ ï¼‰"}</td></tr>
      <tr><td class="muted">é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ï¼ˆä¼°ï¼‰</td><td><b>${insAtRetireMonths}</b>ï¼ˆâ‰ˆ ${(insAtRetireMonths/12).toFixed(2)} å¹´ï¼‰</td></tr>
      <tr><td class="muted">æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”Ÿå¹´æ¬¡ ROC ${rocBirthYear}ï¼‰</td><td>${legal.years}æ­²</td></tr>
      <tr><td class="muted">ä½ è¨­å®šçš„è«‹é ˜å¹´é½¡</td><td>${claimY}æ­² ${claimM}æœˆ</td></tr>
      <tr><td class="muted">ææ—©/å±•å»¶åˆ¤å®š</td><td>${diffText}</td></tr>
    </table>

    ${capWarn}
    ${pensionBlock}
    ${lumpBlock}
    ${gapBlock}
  `;
}

function loadExample(){
  // ç¯„ä¾‹ï¼š72å€‹æœˆè–ªè³‡åºåˆ—ï¼ˆæ™‚é–“åºï¼‰ï¼Œæœ€å¾Œ36ç­†èˆ‡æœ€é«˜60ç­†æœƒè‡ªå‹•æŠ“
  const arr = [];
  for(let i=0;i<12;i++) arr.push("38200");
  for(let i=0;i<24;i++) arr.push("45800");
  for(let i=0;i<36;i++) arr.push("48000");
  $("salaryLines").value = arr.join("\n");

  $("birthDate").value = "1980-01-01";
  $("insYearsNow").value = 28;
  $("insMonthsNow").value = 6;
  $("insDaysNow").value = 10;

  $("keepInsured").value = "yes";
  $("retireYears").value = 65;
  $("retireMonths").value = 0;

  $("claimYears").value = 65;
  $("claimMonths").value = 0;

  $("insAfter60Years").value = 2;
  $("insAfter60Months").value = 0;
  $("claimBefore60").value = "no";

  $("needMonthlyToday").value = 80000;
  $("inflation").value = 2.0;
  $("otherMonthlyIncome").value = 0;
  $("lifeExpectancy").value = 90;
  $("returnNominal").value = 3.0;
  $("returnPreNominal").value = 3.0;

  $("avgSalaryForPension").value = "";
  $("avgSalaryForLump36").value = "";

  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼š72å€‹æœˆè–ªè³‡æ˜ç´°ï¼‹60æ­²å¾Œå¹´è³‡2å¹´ï¼ˆä¸€æ¬¡é‡‘ä¸Šé™è¦å‰‡æœƒç”Ÿæ•ˆï¼‰");
  showWarn("");
  hideOutput();
}

(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  [
    "birthDate","retireYears","retireMonths",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsured",
    "claimYears","claimMonths",
    "salaryLines","avgSalaryForPension","avgSalaryForLump36",
    "insAfter60Years","insAfter60Months","claimBefore60",
    "needMonthlyToday","inflation","otherMonthlyIncome","lifeExpectancy",
    "returnNominal","returnPreNominal"
  ].forEach(id=>{
    $(id).addEventListener("input", hideOutput);
    $(id).addEventListener("change", hideOutput);
  });
})();
</script>
</body>
</html>
