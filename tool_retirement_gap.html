<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿è€å¹´çµ¦ä»˜è©¦ç®—ï½œæ™º Financial Path</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="é€€ä¼‘ç¼ºå£è©¦ç®—ï¼‹å‹ä¿è€å¹´å¹´é‡‘/ä¸€æ¬¡é‡‘ï¼šè¼¸å…¥å‡ºç”Ÿå¹´æœˆæ—¥ã€ç›®å‰æŠ•ä¿å¹´è³‡ã€é€€ä¼‘å¹´é½¡ã€å¹³å‡æœˆæŠ•ä¿è–ªè³‡æˆ–è²¼è–ªè³‡æ˜ç´°ï¼Œè‡ªå‹•æ¨ä¼°é€€ä¼‘æ™‚å¹´è³‡ã€å‹ä¿çµ¦ä»˜èˆ‡é€€ä¼‘ç¼ºå£ï¼ˆæ•™è‚²ç”¨é€”ï¼‰ã€‚" />
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#222; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300;
    --goodbg:#ecfdf3; --good:#027a48;
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text)}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}

  .topbar{
    background:#fff;border-bottom:1px solid var(--line);
    padding:10px 18px; position:sticky; top:0; z-index:100;
  }
  .topbar-inner{
    max-width:1100px;margin:auto;
    display:flex;justify-content:space-between;align-items:center;gap:12px;
  }
  .left-nav{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .container{max-width:1100px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:26px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:980px){ .grid{grid-template-columns:1.25fr 0.75fr} }

  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0f172a}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a}
  input,select,textarea,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  textarea{min-height:140px;resize:vertical;line-height:1.35}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1; min-width: 160px;}
  button{margin-top:14px;background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:800}
  button.secondary{background:#334155}
  .result{margin-top:14px;padding:14px;border-radius:12px;background:var(--soft);color:var(--primary);display:none}
  .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5;font-size:13px;line-height:1.4}
  .ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc;font-size:13px;line-height:1.4}
  .small{font-size:12.5px;color:var(--muted);line-height:1.45;margin-top:10px}
  .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:var(--primary);border:1px solid #dbe7ff}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table th{text-align:left;color:#0f172a}
  .table td:last-child,.table th:last-child{text-align:right}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #dbe2f0;color:#334155;background:#f8fafc;font-size:12px;margin-left:6px}
  .hr{border:0;border-top:1px solid var(--line);margin:14px 0}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¼ºå£ï¼‹å‹ä¿è€å¹´çµ¦ä»˜è©¦ç®— <span class="pill">å¯ç®—åˆ°é€€ä¼‘ç¸½å¹´è³‡ / å¹´é‡‘ / ç¼ºå£è³‡ç”¢</span></h1>

    <div class="grid">
      <!-- å·¦ï¼šè¼¸å…¥ -->
      <div class="card">
        <h2>1) åŸºæœ¬è³‡æ–™ï¼ˆæœƒè‡ªå‹•æ¨ç®—ç¾åœ¨å¹´é½¡ã€é€€ä¼‘æ—¥ã€é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ï¼‰</h2>

        <div class="row">
          <div>
            <label>å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆè¥¿å…ƒï¼‰</label>
            <input id="birthDate" type="date" />
            <div class="small">ä¾‹ï¼š1985-06-15</div>
          </div>

          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <div class="row">
              <div>
                <input id="retireYears" type="number" min="0" step="1" value="65" />
                <div class="small">æ­²</div>
              </div>
              <div>
                <input id="retireMonths" type="number" min="0" max="11" step="1" value="0" />
                <div class="small">æœˆ</div>
              </div>
            </div>
          </div>
        </div>

        <label>ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆå¯å¡«åˆ°å¤©ï¼›æœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
        <div class="row">
          <div>
            <input id="insYearsNow" type="number" min="0" step="1" value="30" />
            <div class="small">å¹´</div>
          </div>
          <div>
            <input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" />
            <div class="small">æœˆ</div>
          </div>
          <div>
            <input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" />
            <div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
            <select id="keepInsured">
              <option value="yes" selected>æ˜¯ï¼šä¸€ç›´æŠ•ä¿åˆ°é€€ä¼‘</option>
              <option value="no">å¦ï¼šä¸å†å¢åŠ å¹´è³‡ï¼ˆç”¨ç›®å‰å¹´è³‡ï¼‰</option>
            </select>
            <div class="small">è‹¥ä½ æœªå¿…æ¯æœˆéƒ½æœ‰æŠ•ä¿ï¼Œå»ºè­°é¸ã€Œå¦ã€æˆ–è‡ªè¡Œè²¼è–ªè³‡æ˜ç´°ã€‚</div>
          </div>

          <div>
            <label>é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆå¹´é‡‘åŠ æ¸›çµ¦ç”¨ï¼‰</label>
            <div class="row">
              <div>
                <input id="claimYears" type="number" min="0" step="1" value="65" />
                <div class="small">æ­²</div>
              </div>
              <div>
                <input id="claimMonths" type="number" min="0" max="11" step="1" value="0" />
                <div class="small">æœˆ</div>
              </div>
            </div>
          </div>
        </div>

        <hr class="hr" />

        <h2>2) æŠ•ä¿è–ªè³‡ï¼ˆå…©ç¨®æ–¹å¼æ“‡ä¸€ï¼šå¡«ã€Œå¹³å‡æœˆæŠ•ä¿è–ªè³‡ã€æˆ–è²¼ã€ŒæŠ•ä¿è–ªè³‡æ˜ç´°ã€ï¼‰</h2>

        <div class="row">
          <div>
            <label>å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆç›´æ¥è¼¸å…¥ï¼‰</label>
            <input id="avgSalaryInput" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
            <div class="small">è‹¥ä½ ä¸æƒ³è²¼æ˜ç´°ï¼Œç›´æ¥å¡«é€™æ¬„å³å¯ã€‚</div>
          </div>
          <div>
            <label>æ˜¯å¦ä»¥æ˜ç´°è¨ˆç®—ã€Œæœ€é«˜60å€‹æœˆå¹³å‡ã€ï¼Ÿ</label>
            <select id="salaryMode">
              <option value="auto" selected>è‡ªå‹•ï¼šæœ‰è²¼æ˜ç´°å°±ç”¨æ˜ç´°ï¼Œæ²’æœ‰å°±ç”¨å¹³å‡è–ªè³‡</option>
              <option value="detail">å¼·åˆ¶ç”¨æ˜ç´°ï¼ˆéœ€è‡³å°‘1ç­†ï¼‰</option>
              <option value="avg">å¼·åˆ¶ç”¨å¹³å‡è–ªè³‡ï¼ˆå¿½ç•¥æ˜ç´°ï¼‰</option>
            </select>
            <div class="small">è¦æ›´æº–ï¼Œè«‹ç”¨æ˜ç´°ï¼ˆå¯æŠ“æœ€é«˜60å€‹æœˆï¼‰ã€‚</div>
          </div>
        </div>

        <div class="small">
          æ˜ç´°æ ¼å¼ï¼š<br/>
          A) åªè²¼é‡‘é¡ï¼Œä¸€è¡Œä¸€å€‹æœˆï¼ˆæœ€å¿«ï¼‰<span class="chip">æ¨è–¦</span><br/>
          B) <span class="mono">YYYY-MM é‡‘é¡</span> æˆ– <span class="mono">YYYY/MM é‡‘é¡</span>ï¼Œä¾‹ï¼š<span class="mono">2024-01 45800</span>
        </div>

        <label>æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆå¯ç•™ç©ºï¼‰</label>
        <textarea id="salaryLines" placeholder="ä¾‹ï¼š
45800
45800
...
æˆ–ï¼š
2024-01 45800
2024-02 45800"></textarea>

        <hr class="hr" />

        <h2>3) é€€ä¼‘ç¼ºå£ï¼ˆä½ çœŸæ­£æƒ³ç®—çš„ï¼‰</h2>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™ç”Ÿæ´»è²»ï¼ˆä»¥ã€Œä»Šå¤©ã€åƒ¹å€¼ï¼‰</label>
            <input id="needMonthlyToday" type="number" min="0" step="1000" value="80000" />
            <div class="small">ä¾‹ï¼š8è¬/æœˆï¼ˆæœƒç”¨é€šè†¨æ¨åˆ°é€€ä¼‘ç•¶å¹´ï¼‰ã€‚</div>
          </div>
          <div>
            <label>é æœŸé€šè†¨ï¼ˆå¹´ï¼‰</label>
            <input id="inflation" type="number" min="0" step="0.1" value="2.0" />
            <div class="small">ä¾‹ï¼š2.0 è¡¨ç¤º 2%</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œå…¶ä»–ã€Œæ¯æœˆã€æ”¶å…¥ï¼ˆé€€ä¼‘é‡‘/æˆ¿ç§Ÿ/é…å¶å¹´é‡‘ç­‰ï¼‰</label>
            <input id="otherMonthlyIncome" type="number" min="0" step="1000" value="0" />
            <div class="small">ä¸å«å‹ä¿å¹´é‡‘ï¼ˆå‹ä¿æœƒè‡ªå‹•ç®—ï¼‰ã€‚</div>
          </div>
          <div>
            <label>é è¨ˆå£½å‘½ï¼ˆæ­²ï¼‰</label>
            <input id="lifeExpectancy" type="number" min="0" step="1" value="90" />
            <div class="small">é€€ä¼‘åˆ°å£½å‘½ä¹‹é–“çš„æœŸé–“ç”¨ä¾†ç®—ç¼ºå£è³‡ç”¢ã€‚</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾ŒæŠ•è³‡å ±é…¬ï¼ˆå¹´ï¼Œåç›®ï¼‰</label>
            <input id="returnNominal" type="number" step="0.1" value="3.0" />
            <div class="small">ä¾‹ï¼š3.0 è¡¨ç¤º 3%ï¼ˆç”¨ä¾†ç®—ç¼ºå£è³‡ç”¢ç¾å€¼ï¼‰ã€‚</div>
          </div>
          <div>
            <label>é€€ä¼‘å‰æŠ•è³‡å ±é…¬ï¼ˆå¹´ï¼Œåç›®ï¼‰</label>
            <input id="returnPreNominal" type="number" step="0.1" value="3.0" />
            <div class="small">ç”¨ä¾†ç®—ã€Œå¾ç¾åœ¨åˆ°é€€ä¼‘æ¯æœˆè¦å­˜å¤šå°‘ã€ã€‚</div>
          </div>
        </div>

        <div class="row">
          <button onclick="calcAll()">è¨ˆç®—ï¼ˆå‹ä¿ï¼‹é€€ä¼‘ç¼ºå£ï¼‰</button>
          <button class="secondary" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
        </div>

        <div id="warnBox" class="warn"></div>
        <div id="okBox" class="ok"></div>

        <p class="small">
          â€» æ•™è‚²ç”¨é€”ï¼šå‹ä¿æ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ã€‚æœ¬å·¥å…·ä»¥ã€Œä½ è¼¸å…¥çš„åƒæ•¸ã€æ¨ä¼°é€€ä¼‘ç¼ºå£ï¼Œé©åˆç”¨ä¾†åšæ±ºç­–èˆ‡æ¯”è¼ƒä¸åŒæƒ…å¢ƒã€‚
        </p>
      </div>

      <!-- å³ï¼šçµæœ -->
      <div class="card">
        <h2>çµæœ</h2>
        <div id="output" class="result"></div>
      </div>
    </div>
  </div>

<script>
/** ========= å‹ä¿å¹´é‡‘è¦å‰‡ï¼ˆä½ åŸæœ¬çš„æ ¸å¿ƒï¼‰ =========
 * è€å¹´å¹´é‡‘ï¼šå…©å¼æ“‡å„ª
 * â‘  å¹³å‡æœˆæŠ•ä¿è–ªè³‡ Ã— å¹´è³‡ Ã— 0.775% + 3,000
 * â‘¡ å¹³å‡æœˆæŠ•ä¿è–ªè³‡ Ã— å¹´è³‡ Ã— 1.55%
 * ææ—©/å±•å»¶ï¼šæ¯å¹´ Â±4%ï¼Œæœ€å¤š Â±20%ï¼Œæœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹
 * å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼šåŠ ä¿æœŸé–“ã€Œæœ€é«˜60å€‹æœˆã€å¹³å‡ï¼›æœªæ»¿5å¹´å‰‡ç”¨å¯¦éš›æŠ•ä¿æœŸé–“å¹³å‡
 * å¹´è³‡æœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹ï¼›æœªæ»¿30æ—¥è€…ä»¥1å€‹æœˆè¨ˆ
 */
const RULES = {
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  },
  maxAdjYears: 5,
  adjPerYear: 0.04
};

function $(id){ return document.getElementById(id); }
function clampInt(v){ if(!Number.isFinite(v)) return NaN; return Math.max(0, Math.floor(v)); }
function parseMoneyStr(s){
  const cleaned = (s||"").toString().trim().replace(/[,ï¼Œ]/g,"");
  if(!cleaned) return NaN;
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}
function fmt(n){ try { return Number(n).toLocaleString("en-US"); } catch { return String(n); } }
function showWarn(msg){ const w=$("warnBox"); if(!msg){w.style.display="none";w.textContent="";return;} w.style.display="block";w.textContent=msg; }
function showOk(msg){ const o=$("okBox"); if(!msg){o.style.display="none";o.textContent="";return;} o.style.display="block";o.textContent=msg; }
function hideOutput(){ $("output").style.display="none"; $("output").innerHTML=""; }

function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }

/** å‡ºç”Ÿå¹´æœˆæ—¥ -> æ°‘åœ‹å¹´æ¬¡ï¼ˆåªå–ã€Œå‡ºç”Ÿå¹´ã€ï¼‰ */
function birthDateToRocYear(birthDate){
  // ROC = AD - 1911
  return birthDate.getFullYear() - 1911;
}

/** è¨ˆç®—æŸäººåœ¨ today çš„å¹´é½¡ï¼ˆæœˆï¼‰ */
function calcAgeMonths(birthDate, today){
  let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
  // è‹¥ä»Šå¤©æ—¥æœŸ < å‡ºç”Ÿæ—¥æ—¥æœŸï¼Œç®—æœªæ»¿æœˆï¼Œé€€1å€‹æœˆ
  if (today.getDate() < birthDate.getDate()) months -= 1;
  return Math.max(0, months);
}

/** ç”± birthDate + é€€ä¼‘å¹´é½¡(æœˆ) -> é€€ä¼‘æ—¥æœŸï¼ˆä»¥ç”Ÿæ—¥ç‚ºåŸºæº–ï¼‰ */
function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  // å…ˆåŠ æœˆä»½
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}

/** å¹´è³‡ï¼šå¹´/æœˆ/å¤© -> æœˆï¼ˆå¤©>0 è¦–ç‚º+1æœˆï¼‰ */
function insToMonths(years, months, days){
  const y=clampInt(years), m=clampInt(months), d=clampInt(days);
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}

/** ææ—©/å±•å»¶ä¿‚æ•¸ */
function adjustFactor(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths;
  const rawYears = diffMonths / 12;
  const cappedYears = Math.max(-RULES.maxAdjYears, Math.min(RULES.maxAdjYears, rawYears));
  const factor = 1 + cappedYears * RULES.adjPerYear;
  return { factor, diffMonths, rawYears, cappedYears };
}

/** è§£ææŠ•ä¿è–ªè³‡æ˜ç´° */
function parseSalaryLines(text){
  const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const items = [];
  for(const line of lines){
    const m = line.match(/^(\d{4})[\/\-](\d{1,2})[^\d]+([\d,ï¼Œ]+(\.\d+)?)$/);
    if(m){
      const yyyy=Number(m[1]), mm=Number(m[2]);
      const salary=parseMoneyStr(m[3]);
      if(!Number.isFinite(yyyy) || !Number.isFinite(mm) || mm<1 || mm>12 || !Number.isFinite(salary) || salary<=0) continue;
      const key = yyyy*12 + mm;
      items.push({ key, salary });
      continue;
    }
    const salary=parseMoneyStr(line);
    if(Number.isFinite(salary) && salary>0) items.push({ key:null, salary });
  }

  const hasKey = items.some(x=>x.key!==null);
  if(hasKey){
    const map = new Map();
    for(const it of items){
      if(it.key===null) continue;
      map.set(it.key, it.salary);
    }
    const arr=[...map.entries()].sort((a,b)=>a[0]-b[0]).map(([key,salary])=>({key,salary}));
    return { mode:"dated", salaries:arr.map(x=>x.salary), count:arr.length };
  }
  return { mode:"sequence", salaries:items.map(x=>x.salary), count:items.length };
}

/** å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼šæœ€é«˜60å€‹æœˆå¹³å‡ï¼›æœªæ»¿60ç”¨å…¨éƒ¨å¹³å‡ */
function calcAvgTop60(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  if(n<60){
    const sum=salaries.reduce((a,b)=>a+b,0);
    return { avg:sum/n, rule:"æœªæ»¿5å¹´ï¼šä»¥å¯¦éš›æŠ•ä¿æœŸé–“å¹³å‡" };
  }
  const sorted=salaries.slice().sort((a,b)=>b-a);
  const top60=sorted.slice(0,60);
  const sum=top60.reduce((a,b)=>a+b,0);
  return { avg:sum/60, rule:"æœ€é«˜60å€‹æœˆå¹³å‡" };
}

/** è€å¹´å¹´é‡‘ï¼šå…©å¼æ“‡å„ªï¼‹åŠ æ¸›çµ¦ */
function calcPension(avgSalary, insMonths, factor){
  const insYears = insMonths / 12;
  const base1 = avgSalary * insYears * 0.00775 + 3000;
  const base2 = avgSalary * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2)
    ? "ç¬¬1å¼ï¼šå¹³å‡æœˆæŠ•ä¿è–ªè³‡Ã—å¹´è³‡Ã—0.775%ï¼‹3,000"
    : "ç¬¬2å¼ï¼šå¹³å‡æœˆæŠ•ä¿è–ªè³‡Ã—å¹´è³‡Ã—1.55%";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly, insYears };
}

/** ä¸€æ¬¡é‡‘ï¼ˆç°¡åŒ–ä¼°ç®—ï¼‰ */
function calcLumpSum(avgSalary, insMonths){
  const benefitMonths = insMonths / 12; // æ¯æ»¿1å¹´â‰ˆ1å€‹æœˆ
  const amount = Math.round(avgSalary * benefitMonths);
  return { benefitMonths, amount };
}

/** ======== é€€ä¼‘ç¼ºå£æ¨¡å‹ï¼ˆå®Œæ•´ã€å¯ç†è§£ã€å¯è½åœ°ï¼‰ ========
 * 1) æŠŠã€Œä»Šå¤©çš„æ¯æœˆç”Ÿæ´»è²»ã€ç”¨é€šè†¨æ¨åˆ°é€€ä¼‘ç•¶å¹´ï¼ˆåç›®ï¼‰
 * 2) é€€ä¼‘ç•¶å¹´èµ·ï¼Œæ¯å¹´æ”¯å‡ºä¹Ÿéš¨é€šè†¨æˆé•·ï¼ˆåç›®ï¼‰
 * 3) é€€ä¼‘æ”¶å…¥ï¼šå‹ä¿å¹´é‡‘ï¼ˆæœˆï¼‰+ å…¶ä»–æ¯æœˆæ”¶å…¥ï¼ˆè‡ªå¡«ï¼‰ï¼Œå‡è¨­åŒæ¨£éš¨é€šè†¨èª¿æ•´ï¼ˆåç›®ï¼‰
 * 4) ä»¥ã€Œé€€ä¼‘å¾Œåç›®å ±é…¬ã€èˆ‡é€šè†¨æ›ç®—æˆã€Œå¯¦è³ªå ±é…¬ã€ï¼Œè¨ˆç®—é€€ä¼‘æ™‚æ‰€éœ€è³‡ç”¢ï¼ˆPV at retirementï¼‰
 * 5) å†ç”¨ã€Œé€€ä¼‘å‰åç›®å ±é…¬ã€æ¨ç®—ï¼šå¾ç¾åœ¨åˆ°é€€ä¼‘æ¯æœˆéœ€å­˜å¤šå°‘ï¼ˆPMTï¼‰
 */
function realRate(nominalPct, inflationPct){
  const r = (1 + nominalPct/100) / (1 + inflationPct/100) - 1;
  return r;
}

/** é€€ä¼‘æ™‚ç¼ºå£è³‡ç”¢ï¼ˆä»¥é€€ä¼‘æ™‚çš„ã€Œä»Šå¤©å¹£å€¼ã€è¨ˆç®—ï¼Œç”¨å¯¦è³ªåˆ©ç‡ï¼‰ */
function pvOfRealAnnuityGap(monthlyGapTodayValue, years, realAnnual){
  // è‹¥ gap <=0ï¼ŒPV=0
  if(monthlyGapTodayValue <= 0) return 0;
  const n = Math.max(0, Math.floor(years*12));
  if(n === 0) return 0;

  const r = realAnnual / 12; // å¯¦è³ªæœˆåˆ©ç‡
  if(Math.abs(r) < 1e-9){
    return monthlyGapTodayValue * n;
  }
  // PV = PMT * (1 - (1+r)^-n)/r
  return monthlyGapTodayValue * (1 - Math.pow(1+r, -n)) / r;
}

/** é€€ä¼‘å‰æ¯æœˆå­˜æ¬¾éœ€æ±‚ï¼ˆä»¥ã€Œä»Šå¤©å¹£å€¼ã€è¨ˆç®—ï¼Œç”¨å¯¦è³ªåˆ©ç‡ï¼‰ */
function pmtToReachFV(fvTodayValue, years, realAnnual){
  if(fvTodayValue <= 0) return 0;
  const n = Math.max(0, Math.floor(years*12));
  if(n === 0) return Infinity;

  const r = realAnnual / 12;
  if(Math.abs(r) < 1e-9){
    return fvTodayValue / n;
  }
  // FV = PMT * ((1+r)^n - 1)/r  => PMT = FV * r / ((1+r)^n - 1)
  return fvTodayValue * r / (Math.pow(1+r, n) - 1);
}

function calcAll(){
  showWarn(""); showOk(""); hideOutput();

  const today = new Date();
  // è®“ date input æ²’å¡«æ™‚ï¼Œçµ¦é è¨­ï¼ˆé¿å… NaNï¼‰
  if(!$("birthDate").value){
    // é è¨­ 1980-01-01ï¼ˆä½ å¯æ”¹ï¼‰
    $("birthDate").value = "1980-01-01";
  }
  const birthDate = new Date($("birthDate").value + "T00:00:00");

  if(!(birthDate instanceof Date) || isNaN(birthDate.getTime())){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´æœˆæ—¥");
    return;
  }

  const retireY = clampInt(Number($("retireYears").value));
  const retireM = clampInt(Number($("retireMonths").value));
  if(!Number.isFinite(retireY) || !Number.isFinite(retireM) || retireM>11){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é è¨ˆé€€ä¼‘å¹´é½¡ï¼ˆæœˆä»½ 0~11ï¼‰");
    return;
  }

  const insNowMonths = insToMonths(
    Number($("insYearsNow").value),
    Number($("insMonthsNow").value),
    Number($("insDaysNow").value)
  );
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆéœ€å¤§æ–¼0ï¼‰");
    return;
  }

  const keepInsured = $("keepInsured").value === "yes";

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || !Number.isFinite(claimM) || claimM>11){
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆæœˆä»½ 0~11ï¼‰");
    return;
  }

  // å¹´é½¡æ¨ç®—
  const ageNowMonths = calcAgeMonths(birthDate, today);
  const ageNowYearsFloor = Math.floor(ageNowMonths/12);
  const ageNowMonthsR = ageNowMonths % 12;

  const retireAgeMonths = ageToMonths(retireY, retireM);
  const retireDate = calcDateAtAge(birthDate, retireAgeMonths);

  const monthsToRetire = Math.max(0, (retireDate.getFullYear()-today.getFullYear())*12 + (retireDate.getMonth()-today.getMonth())
    + ((retireDate.getDate() >= today.getDate()) ? 0 : -1)
  );
  const yearsToRetire = monthsToRetire / 12;

  if(retireAgeMonths <= ageNowMonths){
    showWarn("ä½ è¼¸å…¥çš„é€€ä¼‘å¹´é½¡ â‰¤ ç›®å‰å¹´é½¡ï¼šåˆ°é€€ä¼‘æ™‚é–“ç‚º 0ã€‚è‹¥ä½ å·²é€€ä¼‘ï¼Œå»ºè­°ç›´æ¥ç”¨é€€ä¼‘å¾Œæƒ…å¢ƒä¼°ç®—ã€‚");
  }

  // é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ï¼ˆæœˆï¼‰
  const insAtRetireMonths = keepInsured ? (insNowMonths + monthsToRetire) : insNowMonths;

  // è–ªè³‡ï¼šæ˜ç´° or å¹³å‡
  const salaryMode = $("salaryMode").value;
  const detail = parseSalaryLines($("salaryLines").value);
  const avgSalaryInput = parseMoneyStr($("avgSalaryInput").value);

  let avgSalary = NaN;
  let avgRule = "";
  let salaryInfo = "";

  if(salaryMode === "avg"){
    if(!Number.isFinite(avgSalaryInput) || avgSalaryInput<=0){
      alert("ä½ é¸æ“‡å¼·åˆ¶ç”¨å¹³å‡è–ªè³‡ï¼Œä½†å¹³å‡æœˆæŠ•ä¿è–ªè³‡æœªå¡«æˆ–ç„¡æ•ˆ");
      return;
    }
    avgSalary = avgSalaryInput;
    avgRule = "ä½¿ç”¨ä½ è¼¸å…¥çš„å¹³å‡æœˆæŠ•ä¿è–ªè³‡";
    salaryInfo = "å¹³å‡è–ªè³‡æ¨¡å¼";
  } else if(salaryMode === "detail"){
    if(!detail.count){
      alert("ä½ é¸æ“‡å¼·åˆ¶ç”¨æ˜ç´°ï¼Œä½†æ˜ç´°æ²’æœ‰æœ‰æ•ˆè³‡æ–™");
      return;
    }
    const avgRes = calcAvgTop60(detail.salaries);
    avgSalary = avgRes.avg;
    avgRule = avgRes.rule;
    salaryInfo = `æ˜ç´°æ¨¡å¼ï¼ˆ${detail.count} ç­†ï¼‰`;
  } else {
    // auto
    if(detail.count){
      const avgRes = calcAvgTop60(detail.salaries);
      avgSalary = avgRes.avg;
      avgRule = avgRes.rule;
      salaryInfo = `è‡ªå‹•ï¼šæ¡ç”¨æ˜ç´°ï¼ˆ${detail.count} ç­†ï¼‰`;
    } else {
      if(!Number.isFinite(avgSalaryInput) || avgSalaryInput<=0){
        alert("æœªè²¼æ˜ç´°æ™‚ï¼Œè«‹è‡³å°‘è¼¸å…¥ã€Œå¹³å‡æœˆæŠ•ä¿è–ªè³‡ã€");
        return;
      }
      avgSalary = avgSalaryInput;
      avgRule = "è‡ªå‹•ï¼šç„¡æ˜ç´°ï¼Œä½¿ç”¨ä½ è¼¸å…¥çš„å¹³å‡æœˆæŠ•ä¿è–ªè³‡";
      salaryInfo = "è‡ªå‹•ï¼šå¹³å‡è–ªè³‡";
    }
  }

  if(!Number.isFinite(avgSalary) || avgSalary<=0){
    alert("æŠ•ä¿è–ªè³‡ç„¡æ³•è§£æï¼Œè«‹ç¢ºèªè¼¸å…¥");
    return;
  }

  // å‹ä¿æ³•å®šå¹´é½¡ï¼†åŠ æ¸›çµ¦ä¿‚æ•¸
  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalMonths = ageToMonths(legal.years, legal.months);
  const claimMonthsTotal = ageToMonths(claimY, claimM);
  const adj = adjustFactor(legalMonths, claimMonthsTotal);

  const earlyTooMuch = (adj.diffMonths < -60);
  const lateTooMuch  = (adj.diffMonths >  60);

  const eligiblePension = insAtRetireMonths >= 15*12;
  let pension = null;
  if(eligiblePension){
    pension = calcPension(avgSalary, insAtRetireMonths, adj.factor);
  }
  const lump = calcLumpSum(avgSalary, insAtRetireMonths);

  // ====== é€€ä¼‘ç¼ºå£ ======
  const needMonthlyToday = parseMoneyStr($("needMonthlyToday").value);
  const inflation = Number($("inflation").value);
  const otherMonthlyIncome = parseMoneyStr($("otherMonthlyIncome").value) || 0;
  const lifeExp = Number($("lifeExpectancy").value);
  const rNominalPost = Number($("returnNominal").value);
  const rNominalPre  = Number($("returnPreNominal").value);

  if(!Number.isFinite(needMonthlyToday) || needMonthlyToday<0){ alert("é€€ä¼‘å¾Œæ¯æœˆç›®æ¨™ç”Ÿæ´»è²»è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(inflation) || inflation<0){ alert("é€šè†¨è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(lifeExp) || lifeExp<=0){ alert("é è¨ˆå£½å‘½è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(rNominalPost)){ alert("é€€ä¼‘å¾ŒæŠ•è³‡å ±é…¬è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
  if(!Number.isFinite(rNominalPre)){ alert("é€€ä¼‘å‰æŠ•è³‡å ±é…¬è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }

  // é€€ä¼‘å¹´æ•¸
  const retireYearsSpan = Math.max(0, lifeExp - retireY - retireM/12);

  // æŠŠã€Œä»Šå¤©çš„ç”Ÿæ´»è²»ã€æ¨åˆ°é€€ä¼‘ç•¶å¹´çš„åç›®ï¼šneedRetire = needToday*(1+inf)^yearsToRetire
  const needMonthlyAtRetireNominal = needMonthlyToday * Math.pow(1 + inflation/100, yearsToRetire);

  // æ”¶å…¥ï¼šå‹ä¿å¹´é‡‘ + å…¶ä»–æ¯æœˆæ”¶å…¥ï¼ˆå‡è¨­åŒæ¨£æœƒéš¨é€šè†¨ï¼Œå…ˆç”¨ä»Šå¤©åƒ¹å€¼ â†’ é€€ä¼‘åç›®ï¼‰
  const laborMonthlyAtRetire = eligiblePension ? pension.finalMonthly : 0;
  const otherMonthlyAtRetireNominal = otherMonthlyIncome * Math.pow(1 + inflation/100, yearsToRetire);

  // é€€ä¼‘ç•¶å¹´åç›®ç¼ºå£ï¼ˆæ¯æœˆï¼‰
  const gapMonthlyAtRetireNominal = Math.max(0, needMonthlyAtRetireNominal - (laborMonthlyAtRetire + otherMonthlyAtRetireNominal));

  // ç”¨å¯¦è³ªåˆ©ç‡è¨ˆç®—ã€Œä»¥ä»Šå¤©å¹£å€¼ã€çš„ç¼ºå£è³‡ç”¢
  const rRealPost = realRate(rNominalPost, inflation);
  const rRealPre  = realRate(rNominalPre, inflation);

  // å…ˆæŠŠé€€ä¼‘ç•¶å¹´çš„åç›®ç¼ºå£æ›å›ã€Œä»Šå¤©åƒ¹å€¼ã€ï¼šgapToday = gapAtRetire / (1+inf)^yearsToRetire
  const gapMonthlyTodayValue = gapMonthlyAtRetireNominal / Math.pow(1 + inflation/100, yearsToRetire);

  const pvGapAtRetireTodayValue = pvOfRealAnnuityGap(gapMonthlyTodayValue, retireYearsSpan, rRealPost);
  const pmtNeedTodayValue = pmtToReachFV(pvGapAtRetireTodayValue, yearsToRetire, rRealPre);

  // é¡¯ç¤ºç”¨è³‡è¨Š
  if(detail.count && detail.count < insAtRetireMonths){
    showWarn(`ä½ è²¼çš„æŠ•ä¿è–ªè³‡æ˜ç´°æœˆæ•¸ï¼ˆ${detail.count}ï¼‰å°æ–¼ã€Œé ä¼°åˆ°é€€ä¼‘çš„ç¸½æŠ•ä¿æœˆæ•¸ã€ï¼ˆ${insAtRetireMonths}ï¼‰ã€‚é€™ä¸ä¸€å®šéŒ¯ï¼ˆå¯èƒ½æœ‰ç©ºçª—/æœªæŠ•ä¿ï¼‰ï¼Œä½†è‹¥ä½ è¦æ›´è²¼è¿‘å‹ä¿è¨ˆç®—ï¼Œå»ºè­°è²¼æ›´å¤šå¯¦éš›æœˆä»½è³‡æ–™ã€‚`);
  }else{
    showOk(`å·²å®Œæˆæ¨ç®—ï¼šç›®å‰å¹´é½¡ç´„ ${ageNowYearsFloor}æ­²${ageNowMonthsR}æœˆï¼›è·é›¢é€€ä¼‘ç´„ ${yearsToRetire.toFixed(2)} å¹´ï¼›é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ç´„ ${(insAtRetireMonths/12).toFixed(2)} å¹´ã€‚`);
  }

  const diffText = (adj.diffMonths === 0)
    ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0)
      ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆç´„ ${adj.rawYears.toFixed(2)} å¹´ï¼›å°é ‚æ¡ ${adj.cappedYears.toFixed(2)} å¹´ï¼‰`
      : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆç´„ ${Math.abs(adj.rawYears).toFixed(2)} å¹´ï¼›å°é ‚æ¡ ${Math.abs(adj.cappedYears).toFixed(2)} å¹´ï¼‰`;

  const capWarn = (earlyTooMuch || lateTooMuch)
    ? `<div class="warn" style="display:block;margin-top:10px">
         ä½ è¼¸å…¥çš„è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é 5 å¹´ã€‚ä¾è¦å®šææ—©/å±•å»¶æœ€å¤š 5 å¹´ï¼ˆÂ±20%ï¼‰ï¼Œæœ¬å·¥å…·å·²è‡ªå‹•å°é ‚è¨ˆç®—ã€‚
       </div>`
    : "";

  const out = $("output");
  out.style.display="block";

  const pensionBlock = eligiblePension ? `
    <div style="font-weight:900;font-size:16px;margin-top:10px">A) å‹ä¿è€å¹´å¹´é‡‘ï¼ˆä¼°ç®—ï¼‰</div>
    <div style="font-weight:900;font-size:18px;margin-top:6px">
      é ä¼°æ¯æœˆå¯é ˜ï¼šNT$ ${fmt(laborMonthlyAtRetire)}
      <span class="muted" style="font-weight:600;font-size:12.5px">ï¼ˆæ¡ç”¨ï¼š${pension.chosen}ï¼‰</span>
    </div>

    <table class="table">
      <tr><td class="muted">ç¬¬1å¼ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base1))}</td></tr>
      <tr><td class="muted">ç¬¬2å¼ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base2))}</td></tr>
      <tr><td class="muted">æ“‡å„ªåŸºç¤é‡‘é¡ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.chosenBase))}</td></tr>
      <tr><td class="muted">ææ—©/å±•å»¶ä¿‚æ•¸</td><td>Ã— ${adj.factor.toFixed(4)}</td></tr>
      <tr><td style="font-weight:900">åŠ æ¸›çµ¦å¾Œæœˆé ˜</td><td style="font-weight:900">NT$ ${fmt(laborMonthlyAtRetire)}</td></tr>
    </table>
  ` : `
    <div class="warn" style="display:block;margin-top:10px">
      é€€ä¼‘æ™‚æ¨ä¼°æŠ•ä¿å¹´è³‡æœªæ»¿ 15 å¹´ï¼šä¸€èˆ¬ä¸ç¬¦åˆã€Œè€å¹´å¹´é‡‘ã€æ¢ä»¶ï¼›ä¸‹é¢ä»æä¾›ä¸€æ¬¡é‡‘ä¼°ç®—ï¼Œé€€ä¼‘ç¼ºå£æœƒä»¥ã€Œå‹ä¿å¹´é‡‘=0ã€ä¼°ç®—ã€‚
    </div>
  `;

  const gapBlock = `
    <div style="font-weight:900;font-size:16px;margin-top:14px">B) é€€ä¼‘ç¼ºå£ï¼ˆä½ çœŸæ­£è¦çš„ï¼‰</div>
    <table class="table">
      <tr><td class="muted">é€€ä¼‘å¾Œç›®æ¨™ç”Ÿæ´»è²»ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td>NT$ ${fmt(Math.round(needMonthlyToday))} /æœˆ</td></tr>
      <tr><td class="muted">æ¨ä¼°é€€ä¼‘ç•¶å¹´ç›®æ¨™ç”Ÿæ´»è²»ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(needMonthlyAtRetireNominal))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘ç•¶å¹´å‹ä¿å¹´é‡‘ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(laborMonthlyAtRetire))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘ç•¶å¹´å…¶ä»–æ”¶å…¥ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(otherMonthlyAtRetireNominal))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘ç•¶å¹´æ¯æœˆç¼ºå£ï¼ˆåç›®ï¼‰</td><td style="font-weight:900">NT$ ${fmt(Math.round(gapMonthlyAtRetireNominal))} /æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘å¾ŒæœŸé–“ï¼ˆè‡³ ${lifeExp} æ­²ï¼‰</td><td>${retireYearsSpan.toFixed(2)} å¹´</td></tr>
      <tr><td class="muted">é€€ä¼‘å¾Œå¯¦è³ªå ±é…¬ï¼ˆå·²æ‰£é€šè†¨ï¼‰</td><td>${(rRealPost*100).toFixed(2)}%</td></tr>
      <tr><td class="muted">é€€ä¼‘æ™‚éœ€æº–å‚™è³‡ç”¢ï¼ˆä»¥ä»Šå¤©åƒ¹å€¼ï¼‰</td><td style="font-weight:900">NT$ ${fmt(Math.round(pvGapAtRetireTodayValue))}</td></tr>
      <tr><td class="muted">è·é›¢é€€ä¼‘æ™‚é–“</td><td>${yearsToRetire.toFixed(2)} å¹´</td></tr>
      <tr><td class="muted">é€€ä¼‘å‰å¯¦è³ªå ±é…¬ï¼ˆå·²æ‰£é€šè†¨ï¼‰</td><td>${(rRealPre*100).toFixed(2)}%</td></tr>
      <tr><td class="muted">ç‚ºé”æˆç¼ºå£è³‡ç”¢ï¼šç¾åœ¨èµ·æ¯æœˆéœ€å­˜ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td style="font-weight:900">NT$ ${isFinite(pmtNeedTodayValue) ? fmt(Math.round(pmtNeedTodayValue)) : "â€”"} /æœˆ</td></tr>
    </table>

    <div class="small muted" style="margin-top:8px;">
      èªªæ˜ï¼šæœ¬å·¥å…·ç”¨ã€Œå¯¦è³ªåˆ©ç‡ã€ï¼ˆåç›®å ±é…¬æ‰£é€šè†¨ï¼‰è¨ˆç®—ç¼ºå£è³‡ç”¢ï¼Œèƒ½é¿å…æŠŠé€šè†¨ç®—å…©æ¬¡ã€‚<br>
      è‹¥ä½ æœ‰ã€Œè‡ªæé€€ä¼‘é‡‘ã€å‹é€€ã€ä¼æ¥­å¹´é‡‘ã€æˆ¿ç§Ÿã€é…å¶å¹´é‡‘ã€ç­‰ï¼Œè«‹å¡«åœ¨ã€Œå…¶ä»–æ¯æœˆæ”¶å…¥ã€ã€‚
    </div>
  `;

  out.innerHTML = `
    <div style="font-weight:900;font-size:16px">é—œéµæ¨ç®—ï¼ˆè‡ªå‹•ï¼‰</div>
    <table class="table">
      <tr><td class="muted">ç›®å‰æ—¥æœŸ</td><td>${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}</td></tr>
      <tr><td class="muted">ç›®å‰å¹´é½¡ï¼ˆä¼°ï¼‰</td><td>${ageNowYearsFloor} æ­² ${ageNowMonthsR} æœˆ</td></tr>
      <tr><td class="muted">é€€ä¼‘æ—¥æœŸï¼ˆä¼°ï¼‰</td><td>${retireDate.getFullYear()}-${String(retireDate.getMonth()+1).padStart(2,"0")}-${String(retireDate.getDate()).padStart(2,"0")}</td></tr>
      <tr><td class="muted">è·é›¢é€€ä¼‘</td><td>${monthsToRetire} å€‹æœˆï¼ˆâ‰ˆ ${yearsToRetire.toFixed(2)} å¹´ï¼‰</td></tr>
      <tr><td class="muted">ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆæœˆï¼‰</td><td>${insNowMonths}ï¼ˆâ‰ˆ ${(insNowMonths/12).toFixed(2)} å¹´ï¼‰</td></tr>
      <tr><td class="muted">åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿</td><td>${keepInsured ? "æ˜¯ï¼ˆå¹´è³‡æœƒå¢åŠ ï¼‰" : "å¦ï¼ˆå¹´è³‡ä¸å¢åŠ ï¼‰"}</td></tr>
      <tr><td class="muted">é€€ä¼‘æ™‚æŠ•ä¿å¹´è³‡ï¼ˆä¼°ï¼‰</td><td><b>${insAtRetireMonths}</b>ï¼ˆâ‰ˆ ${(insAtRetireMonths/12).toFixed(2)} å¹´ï¼‰</td></tr>
      <tr><td class="muted">æŠ•ä¿è–ªè³‡æ¡ç”¨æ–¹å¼</td><td>${salaryInfo}</td></tr>
      <tr><td class="muted">å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆçµæœï¼‰</td><td><b>NT$ ${fmt(Math.round(avgSalary))}</b> <span class="muted">ï¼ˆ${avgRule}ï¼‰</span></td></tr>
      <tr><td class="muted">æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”Ÿå¹´æ¬¡ ROC ${rocBirthYear}ï¼‰</td><td>${legal.years}æ­²</td></tr>
      <tr><td class="muted">ä½ è¨­å®šçš„è«‹é ˜å¹´é½¡</td><td>${claimY}æ­² ${claimM}æœˆ</td></tr>
      <tr><td class="muted">ææ—©/å±•å»¶åˆ¤å®š</td><td>${diffText}</td></tr>
    </table>

    ${capWarn}

    ${pensionBlock}

    <div style="font-weight:900;font-size:16px;margin-top:14px">C) å‹ä¿ä¸€æ¬¡é‡‘ï¼ˆä¼°ç®—ï¼‰</div>
    <div class="small muted">çµ¦ä»˜é‡‘é¡ï¼å¹³å‡æœˆæŠ•ä¿è–ªè³‡ Ã— çµ¦ä»˜æœˆæ•¸ï¼ˆå¹´è³‡æ¯æ»¿1å¹´ç´„=1å€‹æœˆï¼›ä¸è¶³æŒ‰æ¯”ä¾‹ï¼›æœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰ã€‚</div>
    <table class="table">
      <tr><td class="muted">çµ¦ä»˜æœˆæ•¸ï¼ˆä¼°ï¼‰</td><td>${lump.benefitMonths.toFixed(4)} å€‹æœˆ</td></tr>
      <tr><td style="font-weight:900">ä¸€æ¬¡é‡‘é‡‘é¡ï¼ˆä¼°ï¼‰</td><td style="font-weight:900">NT$ ${fmt(lump.amount)}</td></tr>
    </table>

    ${gapBlock}
  `;
}

function loadExample(){
  // ç¯„ä¾‹ï¼šå‡è¨­æœ‰ 72 å€‹æœˆæŠ•ä¿è–ªè³‡åºåˆ—ï¼Œå·¥å…·æœƒå–æœ€é«˜60å€‹æœˆå¹³å‡
  const arr = [];
  for(let i=0;i<12;i++) arr.push("38200");
  for(let i=0;i<24;i++) arr.push("45800");
  for(let i=0;i<36;i++) arr.push("48000");
  $("salaryLines").value = arr.join("\n");

  // ç¯„ä¾‹å‡ºç”Ÿæ—¥æœŸ
  $("birthDate").value = "1980-01-01";

  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼šå‡ºç”Ÿ 1980-01-01 + 72å€‹æœˆæŠ•ä¿è–ªè³‡åºåˆ—ï¼ˆæœƒè‡ªå‹•å–æœ€é«˜60å€‹æœˆå¹³å‡ï¼‰");
  showWarn("");
  hideOutput();
}

(function init(){
  // é è¨­å‡ºç”Ÿæ—¥æœŸï¼šé¿å…ç©ºç™½æ™‚ä½¿ç”¨è€…æŒ‰è¨ˆç®—æœƒè·³éŒ¯
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";

  [
    "birthDate","retireYears","retireMonths",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsured",
    "claimYears","claimMonths",
    "avgSalaryInput","salaryMode","salaryLines",
    "needMonthlyToday","inflation","otherMonthlyIncome",
    "lifeExpectancy","returnNominal","returnPreNominal"
  ].forEach(id=>{
    $(id).addEventListener("input", hideOutput);
    $(id).addEventListener("change", hideOutput);
  });
})();
</script>
</body>
</html>
