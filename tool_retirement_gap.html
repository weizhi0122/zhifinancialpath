<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é€€ä¼‘ç¼ºå£å°ˆæ¥­å·¥å…·ï¼ˆå‹ä¿åˆ¶åº¦ç²¾æº–ï¼‹è³‡ç”¢æ¨¡æ“¬ï¼‹å¹´é‡‘vsä¸€æ¬¡è«‹é ˜æ¯”è¼ƒï¼‰ï½œæ™º Financial Path</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="å‹ä¿è€å¹´å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘/ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆåˆ¶åº¦ç²¾æº–åˆ†æµï¼‰ï¼‹é€€ä¼‘ç¼ºå£è³‡ç”¢æ¨¡æ“¬ï¼ˆè‚¡æ¯/å‚µæ¯/å¢å€¼/æˆ¿ç§Ÿ/é€šè†¨/æŠ•å…¥ï¼‰ï¼‹å·®é¡åæ¨ï¼ˆå¤šå­˜/å°‘èŠ±ï¼‰ï¼‹å¹´é‡‘vsä¸€æ¬¡è«‹é ˜æ¯”è¼ƒã€‚" />

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300;
    --goodbg:#ecfdf3; --good:#027a48;
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text)}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:10px 18px;position:sticky;top:0;z-index:10}
  .topbar-inner{max-width:1120px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left-nav{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .container{max-width:1120px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:26px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:980px){ .grid{grid-template-columns:1.2fr 0.8fr} }

  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0f172a}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a}
  input,select,textarea,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  textarea{min-height:120px;resize:vertical;line-height:1.35}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1;min-width:160px}
  .hr{border:0;border-top:1px solid var(--line);margin:14px 0}
  button{margin-top:14px;background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:900}
  button.secondary{background:#334155}
  .warn,.ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.4}
  .warn{background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5}
  .ok{background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc}
  .small{font-size:12.5px;color:var(--muted);line-height:1.45;margin-top:10px}
  .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:var(--primary);border:1px solid #dbe7ff}
  .result{display:none}
  .kpi{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  @media (min-width:980px){ .kpi{grid-template-columns:1fr 1fr} }
  .kpi-box{border:1px solid #dbe7ff;background:var(--soft);border-radius:12px;padding:12px}
  .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi-value{font-size:18px;font-weight:900;color:var(--primary)}
  .kpi-sub{font-size:12.5px;color:var(--muted);margin-top:6px}
  details{margin-top:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  summary{cursor:pointer;padding:12px 12px;font-weight:900;color:#0f172a}
  details .inner{padding:0 12px 12px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table td:last-child{text-align:right}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .tag{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #dbe7ff;background:#fff;color:var(--primary);margin-left:6px}
  .danger{color:#b42318;font-weight:900}
  .oktext{color:#027a48;font-weight:900}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¼ºå£å°ˆæ¥­å·¥å…· <span class="chip">åˆ¶åº¦ç²¾æº–ï¼‹ç¼ºå£æ¨¡æ“¬ï¼‹å¹´é‡‘vsä¸€æ¬¡è«‹é ˜æ¯”è¼ƒ</span></h1>

    <div class="grid">
      <!-- LEFT INPUT -->
      <div class="card">
        <h2>Step 1ï½œåŸºæœ¬è³‡æ–™ï¼ˆç”¨ä¾†è‡ªå‹•åˆ¤æ–·æ³•å®šå¹´é½¡èˆ‡è³‡æ ¼ï¼‰</h2>

        <div class="row">
          <div>
            <label>å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆè¥¿å…ƒï¼‰</label>
            <input id="birthDate" type="date" />
          </div>

          <div>
            <label>æ€§åˆ¥ï¼ˆå½±éŸ¿èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼šå¥³æ€§55æ­²æ¢ä»¶ï¼‰</label>
            <select id="gender">
              <option value="male" selected>ç”·æ€§</option>
              <option value="female">å¥³æ€§</option>
            </select>
          </div>

          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡ï¼ˆè³‡ç”¢æ¨¡æ“¬ï¼šä½•æ™‚åœæ­¢æŠ•å…¥/é–‹å§‹æ”¯å‡ºï¼‰</label>
            <div class="row">
              <div><input id="retireYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="retireMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é è¨ˆå£½å‘½ï¼ˆç”¨ä¾†è©•ä¼°å¹´é‡‘ vs ä¸€æ¬¡è«‹é ˜ï¼‰</label>
            <input id="lifeExpectancy" type="number" min="0" step="1" value="90" />
            <div class="small">åŒæ™‚ç”¨æ–¼ã€Œç¼ºå£æ¨¡æ“¬ã€èˆ‡ã€Œå¹´é‡‘ç´¯ç©é‡‘é¡æ¯”è¼ƒã€ã€‚</div>
          </div>

          <div>
            <label>ä½ ç¬¬ä¸€æ¬¡é–‹å§‹åŠ ä¿ï¼ˆç”¨ä¾†åˆ¤æ–·æ˜¯å¦æœ‰ 98/01/01 å‰å¹´è³‡ï¼‰</label>
            <input id="firstInsuredDate" type="date" />
            <div class="small">è‹¥æ—©æ–¼ 2009-01-01 â†’ å¯èƒ½å…·å‚™ã€Œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ã€é¸æ“‡æ¬Šã€‚</div>
          </div>

          <div>
            <label>æ˜¯å¦å·²é›¢è·é€€ä¿ï¼ˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜éœ€é›¢è·é€€ä¿ï¼‰</label>
            <select id="hasWithdrawn">
              <option value="yes" selected>æ˜¯ï¼ˆæˆ–é€€ä¼‘æ™‚æœƒé€€ä¿ï¼‰</option>
              <option value="no">å¦ï¼ˆå°šæœª/ä¸æœƒé€€ä¿ï¼‰</option>
            </select>
          </div>
        </div>

        <label>ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆæœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
        <div class="row">
          <div><input id="insYearsNow" type="number" min="0" step="1" value="30" /><div class="small">å¹´</div></div>
          <div><input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
          <div><input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" /><div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div></div>
        </div>

        <div class="row">
          <div>
            <label>åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
            <select id="keepInsured">
              <option value="yes" selected>æ˜¯ï¼šä¸€ç›´æŠ•ä¿åˆ°é€€ä¼‘</option>
              <option value="no">å¦ï¼šç”¨ç›®å‰å¹´è³‡ï¼ˆä¸å†å¢åŠ ï¼‰</option>
            </select>
          </div>

          <div>
            <label>é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆå½±éŸ¿å¹´é‡‘ææ—©/å±•å»¶ï¼‰</label>
            <div class="row">
              <div><input id="claimYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="claimMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>

          <div>
            <label>åœ‹æ°‘å¹´é‡‘å¹´è³‡ï¼ˆé¸å¡«ï¼›ç”¨æ–¼ã€Œå‹ä¿æœªæ»¿15ä½†ä½µè¨ˆæ»¿15ã€ï¼‰</label>
            <div class="row">
              <div><input id="natYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
              <div><input id="natMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
        </div>

        <details>
          <summary>é€²éšï½œç‰¹æ®Šå·¥ä½œï¼ˆå±éšª/å …å¼·é«”åŠ›ç­‰ï¼‰èˆ‡èˆŠåˆ¶æ¢ä»¶ï¼ˆåªåœ¨ä½ ç¬¦åˆæ™‚æ‰éœ€è¦å¡«ï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>ç‰¹æ®Šå·¥ä½œå¹´è³‡ï¼ˆæ»¿15å¹´ä¸”55æ­²ï¼šå¯è«‹é ˜å¹´é‡‘ï¼‰</label>
                <div class="row">
                  <div><input id="specialYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="specialMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>

              <div>
                <label>åŒä¸€æŠ•ä¿å–®ä½å¹´è³‡ï¼ˆèˆŠåˆ¶æ¢ä»¶ï¼šåŒä¸€å–®ä½æ»¿25å¹´é€€è·ï¼‰</label>
                <div class="row">
                  <div><input id="sameUnitYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="sameUnitMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>
            </div>

            <div class="small muted">
              æé†’ï¼šé€™å…©é …åªå½±éŸ¿ã€Œå¹´é‡‘55æ­²ç‰¹æ®Šæ¢ä»¶ã€æˆ–ã€ŒèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜é¸æ“‡æ¬Šã€çš„åˆ¤æ–·ï¼›ä¸€èˆ¬äººå¯ä¸å¡«ã€‚
            </div>
          </div>
        </details>

        <hr class="hr" />

        <h2>Step 2ï½œå‹ä¿è–ªè³‡ï¼ˆåˆ¶åº¦ç²¾æº–ï¼š60æœˆæœ€é«˜å¹³å‡ / èˆŠåˆ¶3å¹´å¹³å‡ï¼‰</h2>
        <div class="small">
          å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼šä»¥<strong>åŠ ä¿æœŸé–“æœ€é«˜60å€‹æœˆå¹³å‡</strong>è¨ˆç®—ã€‚<br/>
          èˆŠåˆ¶ã€Œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ã€ï¼šä»¥<strong>é€€ä¿ç•¶æœˆèµ·å‰3å¹´ï¼ˆ36æœˆï¼‰å¹³å‡</strong>è¨ˆç®—ã€‚
        </div>

        <div class="row">
          <div>
            <label>å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€é«˜60æœˆå¹³å‡ï¼šå¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼‰</label>
            <input id="avgSalary60" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
          <div>
            <label>å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆé€€ä¿å‰3å¹´å¹³å‡ï¼šèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰</label>
            <input id="avgSalary36Old" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
        </div>

        <details>
          <summary>é€²éšï½œè²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆè‡ªå‹•ç®—ï¼š60æœˆæœ€é«˜å¹³å‡ï¼‹36æœˆæœ€è¿‘å¹³å‡ï¼‰</summary>
          <div class="inner">
            <div class="small">
              æ ¼å¼ï¼š<span class="mono">YYYY-MM é‡‘é¡</span> æˆ–åªè²¼é‡‘é¡ï¼ˆä¾æ™‚é–“é †åºï¼‰ã€‚<br/>
              60æœˆï¼šå–æœ€é«˜60ç­†ï¼›36æœˆï¼šå–æœ€å¾Œ36ç­†ã€‚
            </div>
            <label>æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆå¯ç•™ç©ºï¼›æœ‰è²¼å°±å„ªå…ˆä½¿ç”¨ï¼‰</label>
            <textarea id="salaryLines" placeholder="ä¾‹ï¼š
2024-01 45800
2024-02 45800
..."></textarea>
          </div>
        </details>

        <hr class="hr" />

        <h2>Step 3ï½œè³‡ç”¢æ¨¡æ“¬ï¼ˆç¼ºå£ä»ä¿ç•™ï¼šè‚¡æ¯/å‚µæ¯/å¢å€¼/æˆ¿ç§Ÿ/é€šè†¨/æŠ•å…¥ï¼‰</h2>

        <div class="row">
          <div>
            <label>ç¾åœ¨æŠ•è³‡ç¸½é¡ï¼ˆè³‡ç”¢æ± æœ¬é‡‘ï¼‰</label>
            <input id="assetNow" type="number" min="0" step="10000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆæŠ•å…¥ï¼ˆå­˜/æŠ•è³‡ï¼‰</label>
            <input id="contribMonthly" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–è‚¡æ¯ %ï¼ˆç¾é‡‘æµï¼‰</label>
            <input id="divPre" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–å‚µæ¯ %ï¼ˆç¾é‡‘æµï¼‰</label>
            <input id="bondPre" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–å¢å€¼ %ï¼ˆè³‡ç”¢æˆé•·ï¼‰</label>
            <input id="growthPre" type="number" step="0.1" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰ï¼šè‚¡æ¯/å‚µæ¯æ˜¯å¦å†æŠ•å…¥ï¼Ÿ</label>
            <select id="reinvestPre">
              <option value="yes" selected>æ˜¯ï¼šè‚¡æ¯/å‚µæ¯å†æŠ•å…¥è³‡ç”¢æ± </option>
              <option value="no">å¦ï¼šè‚¡æ¯/å‚µæ¯ä¸æŠ•å…¥ï¼ˆç´¯ç©æˆç¾é‡‘/æº–å‚™é‡‘ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œï¼šè‚¡æ¯/å‚µæ¯ç”¨é€”</label>
            <select id="reinvestPost">
              <option value="spend" selected>æ‹¿ä¾†ç”Ÿæ´»è²»ï¼ˆæŠµç¼ºå£ï¼‰</option>
              <option value="reinvest">å†æŠ•å…¥ï¼ˆä¸æŠµç”Ÿæ´»è²»ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–è‚¡æ¯ %</label>
            <input id="divPost" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–å‚µæ¯ %</label>
            <input id="bondPost" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–å¢å€¼ %</label>
            <input id="growthPost" type="number" step="0.1" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>æˆ¿ç§Ÿæ”¶å…¥ï¼ˆé¸å¡«ï¼Œå›ºå®šæœˆé¡ï¼‰</label>
            <input id="rentMonthly" type="number" min="0" step="1000" value="0" />
            <div class="small">æˆ¿ç§Ÿç‚ºå›ºå®šæœˆé¡ï¼ˆä¸æ˜¯%ï¼‰ã€‚</div>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ˜¯å¦ä»æ¯æœˆæŠ•å…¥ï¼Ÿ</label>
            <select id="postContribMode">
              <option value="no" selected>å¦ï¼šé€€ä¼‘å¾Œä¸å†æŠ•å…¥</option>
              <option value="yes">æ˜¯ï¼šé€€ä¼‘å¾Œä»æ¯æœˆæŠ•å…¥ï¼ˆä¸‹æ–¹å¡«é‡‘é¡ï¼‰</option>
            </select>
            <div class="small">å¯æ¨¡æ“¬ã€ŒåŠé€€ä¼‘ã€æˆ–ã€ŒæŒçºŒå·¥ä½œã€ã€‚</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆæŠ•å…¥ï¼ˆè‹¥æœ‰ï¼‰</label>
            <input id="postContribMonthly" type="number" min="0" step="1000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå…¶ä»–æ¯æœˆæ”¶å…¥ï¼ˆä¸å«å‹ä¿/è‚¡æ¯å‚µæ¯/æˆ¿ç§Ÿï¼‰</label>
            <input id="otherIncomeMonthly" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç”Ÿæ´»è²»ï¼ˆä»¥ä»Šå¤©åƒ¹å€¼ï¼‰</label>
            <input id="needMonthlyToday" type="number" min="0" step="1000" value="80000" />
          </div>
          <div>
            <label>é æœŸé€šè†¨ï¼ˆå¹´%ï¼‰</label>
            <input id="inflation" type="number" min="0" step="0.1" value="2.0" />
          </div>
        </div>

        <div class="row">
          <button onclick="calcAll()">è¨ˆç®—ï¼ˆåˆ¶åº¦ç²¾æº–ï¼‹ç¼ºå£æ¨¡æ“¬ï¼‹å¹´é‡‘vsä¸€æ¬¡è«‹é ˜æ¯”è¼ƒï¼‰</button>
          <button class="secondary" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
        </div>

        <div id="warnBox" class="warn"></div>
        <div id="okBox" class="ok"></div>

        <p class="small">
          â€» æ•™è‚²ç”¨é€”ï¼šå¯¦éš›æ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ï¼›èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜éœ€é›¢è·é€€ä¿ä¸”ç¬¦åˆæ¢ä»¶ï¼Œé€™è£¡ä»¥ä½ è¼¸å…¥è³‡è¨Šåšåˆ¤æ–·ã€‚
        </p>
      </div>

      <!-- RIGHT OUTPUT -->
      <div class="card">
        <h2>çµæœï¼ˆæ¸…æ™°ï¼‹è©³ç´°ï¼‰</h2>
        <div id="output" class="result"></div>
      </div>
    </div>
  </div>

<script>
/* ===================== å·¥å…·å‡½æ•¸ ===================== */
function $(id){ return document.getElementById(id); }
function fmt(n){ try { return Number(n).toLocaleString("en-US"); } catch { return String(n); } }
function money(v){ const n = Number(String(v||"").replace(/[,ï¼Œ\s]/g,"")); return Number.isFinite(n) ? n : NaN; }
function clampInt(v){ if(!Number.isFinite(v)) return NaN; return Math.max(0, Math.floor(v)); }
function showWarn(msg){ const w=$("warnBox"); if(!msg){w.style.display="none";w.textContent="";return;} w.style.display="block"; w.textContent=msg; }
function showOk(msg){ const o=$("okBox"); if(!msg){o.style.display="none";o.textContent="";return;} o.style.display="block"; o.textContent=msg; }
function hideOutput(){ $("output").style.display="none"; $("output").innerHTML=""; }

/* å¹´é½¡/æ—¥æœŸ */
function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }
function calcAgeMonths(birthDate, today){
  let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
  if (today.getDate() < birthDate.getDate()) months -= 1;
  return Math.max(0, months);
}
function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}
function monthsBetween(today, future){
  let m = (future.getFullYear()-today.getFullYear())*12 + (future.getMonth()-today.getMonth());
  if (future.getDate() < today.getDate()) m -= 1;
  return Math.max(0, m);
}
function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}

/* ===================== åˆ¶åº¦è¦å‰‡ï¼ˆç²¾æº–åˆ†æµï¼‰ ===================== */
/*
ä½ æä¾›çš„è¦é»å·²å…¨éƒ¨è½åœ°ï¼š
1) è€å¹´å¹´é‡‘ï¼šå¹´æ»¿æ³•å®šå¹´é½¡ + å¹´è³‡>=15ï¼›æˆ–ç‰¹æ®Šå·¥ä½œæ»¿15å¹´ä¸”55ï¼›æˆ–å‹ä¿<15ä½†ä½µè¨ˆåœ‹ä¿>=15ä¸”65æ­²å¯é¸å¹´é‡‘
2) è€å¹´ä¸€æ¬¡é‡‘ï¼šå¹´æ»¿æ³•å®šå¹´é½¡ + å¹´è³‡<15
3) ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆèˆŠåˆ¶ï¼‰ï¼š98/01/01å‰å·²æœ‰ä¿éšªå¹´è³‡è€…ï¼Œç¬¦åˆæ¢ä»¶ä¹‹ä¸€å¯é¸ï¼›å¹³å‡è–ªè³‡=é€€ä¿å‰3å¹´å¹³å‡ï¼›æœˆæ•¸=1+2å€ï¼Œä¸Šé™45ï¼›60å¾Œæœ€å¤š5å¹´ï¼Œåˆä½µä¸Šé™50
4) æ³•å®šè«‹é ˜å¹´é½¡ï¼šä»¥å‡ºç”Ÿæ°‘åœ‹å¹´æ¬¡å°æ‡‰ï¼ˆ46â†“60ï¼›47â†’61ï¼›48â†’62ï¼›49â†’63ï¼›50â†’64ï¼›51â†‘65ï¼‰
5) å¹´é‡‘ææ—©/å±•å»¶ï¼šÂ±4%/å¹´ï¼Œæœ€å¤šÂ±20%ï¼Œæœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹
*/
const RULES = {
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  },
  maxAdjYears: 5,
  adjPerYear: 0.04,
  oldSystemCutoff: new Date("2009-01-01T00:00:00") // 98/01/01
};

function adjustFactor(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths; // >0å±•å»¶ <0ææ—©
  const rawYears = diffMonths / 12;
  const cappedYears = Math.max(-RULES.maxAdjYears, Math.min(RULES.maxAdjYears, rawYears));
  const factor = 1 + cappedYears * RULES.adjPerYear;
  return { factor, diffMonths, rawYears, cappedYears };
}

/* ---------- è–ªè³‡æ˜ç´° ---------- */
function parseSalaryLines(text){
  const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const dated = [];
  const seq = [];
  for(const line of lines){
    const m = line.match(/^(\d{4})[\/\-](\d{1,2})[^\d]+([\d,ï¼Œ]+(\.\d+)?)$/);
    if(m){
      const yyyy=Number(m[1]), mm=Number(m[2]);
      const sal=money(m[3]);
      if(!Number.isFinite(yyyy)||!Number.isFinite(mm)||mm<1||mm>12||!Number.isFinite(sal)||sal<=0) continue;
      dated.push({ key: yyyy*12+mm, salary: sal });
      continue;
    }
    const sal = money(line);
    if(Number.isFinite(sal) && sal>0) seq.push(sal);
  }
  if(dated.length){
    const map=new Map();
    for(const it of dated) map.set(it.key, it.salary); // åŒæœˆå–æœ€å¾Œä¸€ç­†
    const arr=[...map.entries()].sort((a,b)=>a[0]-b[0]).map(([k,s])=>s);
    return { mode:"dated", salaries: arr, count: arr.length };
  }
  return { mode:"sequence", salaries: seq, count: seq.length };
}
function avgTop60(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  if(n<60){
    const sum=salaries.reduce((a,b)=>a+b,0);
    return { avg: sum/n, rule:"æœªæ»¿60å€‹æœˆï¼šç”¨å¯¦éš›æœŸé–“å¹³å‡ï¼ˆå¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼‰" };
  }
  const top = salaries.slice().sort((a,b)=>b-a).slice(0,60);
  const sum=top.reduce((a,b)=>a+b,0);
  return { avg: sum/60, rule:"æœ€é«˜60å€‹æœˆå¹³å‡ï¼ˆå¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼‰" };
}
function avgLast36(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  const used = (n<=36) ? salaries.slice() : salaries.slice(n-36);
  const sum=used.reduce((a,b)=>a+b,0);
  return { avg: sum/used.length, rule:(n<36) ? "æœªæ»¿36å€‹æœˆï¼šç”¨å¯¦éš›æœŸé–“å¹³å‡ï¼ˆèˆŠåˆ¶3å¹´å¹³å‡ï¼‰" : "é€€ä¿å‰3å¹´ï¼ˆ36æœˆï¼‰å¹³å‡ï¼ˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰" };
}

/* ---------- å¹´é‡‘è¨ˆç®—ï¼ˆå…©å¼æ“‡å„ª + ææ—©/å±•å»¶ä¿‚æ•¸ï¼‰ ---------- */
function calcPensionMonthly(avgSalary60, insMonths, factor){
  const insYears = insMonths / 12;
  const base1 = avgSalary60 * insYears * 0.00775 + 3000;
  const base2 = avgSalary60 * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2) ? "å¼1ï¼ˆ0.775%Ã—å¹´è³‡ + 3000ï¼‰" : "å¼2ï¼ˆ1.55%Ã—å¹´è³‡ï¼‰";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly };
}

/* ---------- è€å¹´ä¸€æ¬¡é‡‘ï¼ˆå¹´è³‡<15ï¼‰ï¼šçµ¦ä»˜æœˆæ•¸=å¹´è³‡ï¼ˆæŒ‰æœˆæ¯”ä¾‹ï¼‰ï¼Œ60å¾Œæœ€å¤š5å¹´è¨ˆå…¥ï¼ˆæ­¤å·¥å…·ä»¥ä½ è¼¸å…¥ç¸½å¹´è³‡ä¼°ï¼‰ ---------- */
function calcOldAgeLumpSumNew(avgSalary60, insMonths){
  const benefitMonths = insMonths / 12; // æŒ‰å¹´è³‡æ¯”ä¾‹
  const amount = Math.round(avgSalary60 * benefitMonths);
  return { benefitMonths, amount };
}

/* ---------- èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼šçµ¦ä»˜æœˆæ•¸ï¼ˆ1å€+2å€ï¼Œ45/50ä¸Šé™ï¼‰ ---------- */
function calcOldSystemBenefitMonths(insMonthsTotal, after60Months){
  // 60å¾Œæœ€å¤š5å¹´
  const after60Capped = Math.min(Math.max(0, after60Months), 60);
  let pre60Months = Math.max(0, insMonthsTotal - after60Capped);

  // ä»¥ã€Œå¹´è³‡ã€è¨ˆç®—ï¼šå‰15å¹´=1æœˆ/å¹´ï¼Œè¶…é=2æœˆ/å¹´ï¼Œä¸Šé™45
  const pre60Years = pre60Months / 12;
  const y1 = Math.min(15, pre60Years);
  const y2 = Math.max(0, pre60Years - 15);
  const benefitPre60 = Math.min(y1*1 + y2*2, 45);

  const benefitAfter60 = after60Capped / 12; // 0~5 (æœˆæ•¸ä»¥ã€Œå¹´ã€å°æ‡‰ã€Œæœˆã€æ¦‚å¿µï¼šè¦å‰‡æ–‡å­—æ˜¯æœ€å¤š5å¹´è¨ˆå…¥ï¼Œé€™è£¡ä»¥ã€Œå¹´=çµ¦ä»˜æœˆæ•¸ã€)
  const total = Math.min(benefitPre60 + benefitAfter60, 50);

  return { benefitMonths: total, cap: (after60Capped>0 ? 50 : 45) };
}

/* ---------- èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼šé‡‘é¡=é€€ä¿å‰3å¹´å¹³å‡Ã—çµ¦ä»˜æœˆæ•¸ ---------- */
function calcOldSystemLumpSum(avgSalary36, benefitMonths){
  return Math.round(avgSalary36 * benefitMonths);
}

/* ---------- èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜è³‡æ ¼åˆ¤æ–·ï¼ˆä¾ä½ æä¾›æ¢ä»¶ï¼Œéœ€åŒæ™‚ã€Œ98å‰å¹´è³‡ã€+ã€Œé€€è·é€€ä¿ã€+ ç¬¦åˆä»»ä¸€æ¢ä»¶ï¼‰ ---------- */
function eligibleOldSystemOneTime(hasOldSystem, hasWithdrawn, gender, claimAgeMonths, insMonths, sameUnitMonths, specialMonths){
  if(!hasOldSystem) return { ok:false, reason:"98/01/01å¾Œæ‰é–‹å§‹åŠ ä¿ï¼šä¸å…·èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜é¸æ“‡æ¬Šã€‚" };
  if(!hasWithdrawn) return { ok:false, reason:"èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜éœ€é›¢è·é€€ä¿ï¼›ä½ ç›®å‰é¸æ“‡ç‚ºã€Œæœªé€€ä¿ã€ã€‚" };

  const ageYears = claimAgeMonths/12;
  const insYears = insMonths/12;
  const sameUnitYears = sameUnitMonths/12;
  const specialYears = specialMonths/12;

  // (1) å¹´è³‡>=1å¹´ï¼Œå¹´æ»¿60æˆ–å¥³æ€§55é€€è·
  const cond1 = (insYears >= 1) && (ageYears >= (gender==="female" ? 55 : 60));
  // (2) å¹´è³‡>=15ï¼Œå¹´æ»¿55é€€è·
  const cond2 = (insYears >= 15) && (ageYears >= 55);
  // (3) åŒä¸€æŠ•ä¿å–®ä½å¹´è³‡>=25é€€è·
  const cond3 = (sameUnitYears >= 25);
  // (4) å¹´è³‡>=25ï¼Œå¹´æ»¿50é€€è·
  const cond4 = (insYears >= 25) && (ageYears >= 50);
  // (5) ç‰¹æ®Šå·¥ä½œ>=5å¹´ï¼Œå¹´æ»¿55é€€è·
  const cond5 = (specialYears >= 5) && (ageYears >= 55);

  const ok = cond1 || cond2 || cond3 || cond4 || cond5;
  if(!ok){
    return { ok:false, reason:"ä½ å…·98å‰å¹´è³‡ï¼Œä½†ç›®å‰è¼¸å…¥æ¢ä»¶æœªç¬¦åˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ä»»ä¸€æ¢ä»¶ï¼ˆ(1)~(5)ï¼‰ã€‚å¯å±•é–‹ã€Œé€²éšã€è£œè¶³åŒä¸€å–®ä½å¹´è³‡æˆ–ç‰¹æ®Šå·¥ä½œå¹´è³‡ã€‚" };
  }
  const hit = [];
  if(cond1) hit.push("(1) å¹´è³‡â‰¥1å¹´ä¸”é”å¹´é½¡é–€æª»");
  if(cond2) hit.push("(2) å¹´è³‡â‰¥15å¹´ä¸”â‰¥55æ­²");
  if(cond3) hit.push("(3) åŒä¸€å–®ä½å¹´è³‡â‰¥25å¹´");
  if(cond4) hit.push("(4) å¹´è³‡â‰¥25å¹´ä¸”â‰¥50æ­²");
  if(cond5) hit.push("(5) ç‰¹æ®Šå·¥ä½œâ‰¥5å¹´ä¸”â‰¥55æ­²");

  return { ok:true, reason:"ç¬¦åˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜æ¢ä»¶ï¼š" + hit.join("ã€") };
}

/* ---------- å¹´é‡‘ vs ä¸€æ¬¡è«‹é ˜æ¯”è¼ƒï¼ˆç´¯ç©ç¸½é ˜ vs ä¸€æ¬¡é‡‘ï¼‰ ---------- */
function comparePensionVsLump(pensionMonthly, lumpAmount, claimAgeYears, lifeExpYears){
  const months = Math.max(0, Math.floor((lifeExpYears - claimAgeYears) * 12));
  const totalPension = Math.round(pensionMonthly * months);

  // å›æœ¬å¹´é½¡ï¼ˆä¸æŠ˜ç¾ï¼‰ï¼šç´¯ç©å¹´é‡‘ >= ä¸€æ¬¡é‡‘ çš„æœˆä»½
  let breakevenMonths = null;
  if(pensionMonthly > 0 && lumpAmount > 0){
    breakevenMonths = Math.ceil(lumpAmount / pensionMonthly);
  }
  const breakevenAge = (breakevenMonths===null) ? null : (claimAgeYears + breakevenMonths/12);

  return { months, totalPension, breakevenMonths, breakevenAge };
}

/* ===================== è³‡ç”¢æ¨¡æ“¬ï¼ˆä¿ç•™ä½ åŸæœ¬ç¼ºå£èˆ‡å·®é¡åæ¨ï¼‰ ===================== */
function annualToMonthlyRate(r){
  return (1 + r) ** (1/12) - 1;
}

function simulatePlan(params){
  const {
    monthsToRetire, monthsRetired,
    principal0, reserve0,
    contribMonthly, reinvestPre,
    divPre, bondPre, growthPre,
    reinvestPostMode,
    divPost, bondPost, growthPost,
    rentMonthly, otherIncomeMonthlyAtRetire,
    laborMonthlyAtRetire,
    needMonthlyToday, inflation,
    postContribMode, postContribMonthly
  } = params;

  let principal = principal0;
  let reserve = reserve0;

  const gPreM = annualToMonthlyRate(growthPre);
  const dPreM = (divPre/12);
  const bPreM = (bondPre/12);

  for(let t=0; t<monthsToRetire; t++){
    principal = principal * (1 + gPreM);

    const divInc = principal * dPreM;
    const bondInc = principal * bPreM;

    if(reinvestPre){
      principal += (divInc + bondInc);
    }else{
      reserve += (divInc + bondInc);
    }

    principal += contribMonthly;
  }

  const principalAtRetire = principal;
  const reserveAtRetire = reserve;
  const totalAtRetire = principalAtRetire + reserveAtRetire;

  const infM = annualToMonthlyRate(inflation);
  let needM = needMonthlyToday * ((1 + infM) ** monthsToRetire);
  let otherIncomeM = otherIncomeMonthlyAtRetire;

  const gPostM = annualToMonthlyRate(growthPost);
  const dPostM = (divPost/12);
  const bPostM = (bondPost/12);

  let brokeMonth = null;
  let minTotal = totalAtRetire;

  for(let k=0; k<monthsRetired; k++){
    if(k>0) needM *= (1 + infM);

    principal = principal * (1 + gPostM);

    const divInc = principal * dPostM;
    const bondInc = principal * bPostM;

    let incomeFromYields = 0;
    if(reinvestPostMode === "reinvest"){
      principal += (divInc + bondInc);
    }else{
      incomeFromYields = divInc + bondInc;
    }

    const postContrib = (postContribMode === "yes") ? postContribMonthly : 0;
    principal += postContrib;

    const income = laborMonthlyAtRetire + otherIncomeM + rentMonthly + incomeFromYields;

    let gap = needM - income;

    if(gap <= 0){
      reserve += (-gap);
    }else{
      const useReserve = Math.min(reserve, gap);
      reserve -= useReserve;
      gap -= useReserve;

      if(gap > 0){
        principal -= gap;
      }
    }

    const total = principal + reserve;
    if(total < minTotal) minTotal = total;

    if(principal < 0){
      brokeMonth = k + 1;
      break;
    }
  }

  return {
    ok: brokeMonth === null,
    principalAtRetire, reserveAtRetire, totalAtRetire,
    principalEnd: principal, reserveEnd: reserve, totalEnd: principal + reserve,
    brokeMonth,
    minTotal
  };
}

function solveExtraContribution(baseParams){
  const base = simulatePlan(baseParams);
  if(base.ok) return { extra: 0, base, final: base };

  let lo = 0, hi = 300000;
  for(let i=0;i<32;i++){
    const mid = (lo+hi)/2;
    const test = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + mid });
    if(test.ok) hi = mid; else lo = mid;
  }
  const extra = Math.ceil(hi);
  const final = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + extra });
  return { extra, base, final };
}
function solveExpenseCut(baseParams){
  const base = simulatePlan(baseParams);
  if(base.ok) return { cut: 0, base, final: base };

  let lo = 0, hi = Math.max(0, baseParams.needMonthlyToday);
  for(let i=0;i<32;i++){
    const mid = (lo+hi)/2;
    const test = simulatePlan({ ...baseParams, needMonthlyToday: Math.max(0, baseParams.needMonthlyToday - mid) });
    if(test.ok) hi = mid; else lo = mid;
  }
  const cut = Math.ceil(hi);
  const final = simulatePlan({ ...baseParams, needMonthlyToday: Math.max(0, baseParams.needMonthlyToday - cut) });
  return { cut, base, final };
}

/* ===================== ä¸»æµç¨‹ï¼ˆåˆ¶åº¦ç²¾æº– + ç¼ºå£ + æ¯”è¼ƒæ¨¡å¼ï¼‰ ===================== */
function calcAll(){
  showWarn(""); showOk(""); hideOutput();

  const today = new Date();

  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  const birthDate = new Date($("birthDate").value + "T00:00:00");
  if(isNaN(birthDate.getTime())){ alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´æœˆæ—¥"); return; }

  if(!$("firstInsuredDate").value){
    // æ²’å¡«å°±ç”¨ä¿å®ˆï¼šè¦–ç‚º 98 å¾Œï¼ˆé¿å…éŒ¯èª¤çµ¦å‡ºèˆŠåˆ¶é¸æ“‡æ¬Šï¼‰
    $("firstInsuredDate").value = "2009-01-01";
  }
  const firstInsuredDate = new Date($("firstInsuredDate").value + "T00:00:00");
  if(isNaN(firstInsuredDate.getTime())){ alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¬¬ä¸€æ¬¡åŠ ä¿æ—¥æœŸ"); return; }

  const gender = $("gender").value;
  const hasWithdrawn = ($("hasWithdrawn").value === "yes");

  const retireY = clampInt(Number($("retireYears").value));
  const retireM = clampInt(Number($("retireMonths").value));
  if(!Number.isFinite(retireY) || retireM>11){ alert("é€€ä¼‘å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || claimM>11){ alert("è«‹é ˜å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }

  const lifeExp = Number($("lifeExpectancy").value);
  if(!Number.isFinite(lifeExp) || lifeExp <= 0){ alert("é è¨ˆå£½å‘½è¼¸å…¥éŒ¯èª¤"); return; }

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){ alert("æŠ•ä¿å¹´è³‡éœ€å¤§æ–¼0"); return; }

  const keepInsured = ($("keepInsured").value === "yes");

  // å¹´é½¡èˆ‡æ—¥æœŸ
  const ageNowMonths = calcAgeMonths(birthDate, today);
  const retireAgeMonths = ageToMonths(retireY, retireM);
  const claimAgeMonths = ageToMonths(claimY, claimM);

  const retireDate = calcDateAtAge(birthDate, retireAgeMonths);
  const monthsToRetire = monthsBetween(today, retireDate);

  // é€€ä¼‘æ™‚å¹´è³‡ï¼ˆå·¥å…·å‡è¨­ï¼šæŒçºŒæŠ•ä¿åˆ°é€€ä¼‘ç‚ºæ­¢ï¼›è«‹é ˜å¹´é½¡ä¸»è¦å½±éŸ¿å¹´é‡‘åŠ æ¸›çµ¦ï¼‰
  const insAtRetireMonths = keepInsured ? (insNowMonths + monthsToRetire) : insNowMonths;

  // åœ‹ä¿ä½µè¨ˆï¼ˆåƒ…ç”¨æ–¼åˆ¤æ–·ã€Œå‹ä¿<15ä½†ä½µè¨ˆ>=15ä¸”65æ­²å¯é¸å¹´é‡‘ã€ï¼‰
  const natMonths = insToMonths($("natYears").value, $("natMonths").value, 0);
  const natMonthsSafe = Number.isFinite(natMonths) ? natMonths : 0;

  // ç‰¹æ®Š/èˆŠåˆ¶é™„åŠ è³‡æ–™
  const specialMonths = insToMonths($("specialYears").value, $("specialMonths").value, 0);
  const sameUnitMonths = insToMonths($("sameUnitYears").value, $("sameUnitMonths").value, 0);
  const specialMonthsSafe = Number.isFinite(specialMonths) ? specialMonths : 0;
  const sameUnitMonthsSafe = Number.isFinite(sameUnitMonths) ? sameUnitMonths : 0;

  // è–ªè³‡ï¼ˆå„ªå…ˆæ˜ç´°ï¼‰
  const detail = parseSalaryLines($("salaryLines")?.value || "");
  let avg60 = money($("avgSalary60").value);
  let avg36 = money($("avgSalary36Old").value);
  let salaryNote = "";

  if(detail.count){
    const p = avgTop60(detail.salaries);
    const l = avgLast36(detail.salaries);
    avg60 = p.avg;
    avg36 = l.avg;
    salaryNote = `å·²ä½¿ç”¨æ˜ç´°ï¼š${p.rule} / ${l.rule}ï¼ˆå…±${detail.count}ç­†ï¼‰`;
  }else{
    if(!Number.isFinite(avg60) || avg60<=0 || !Number.isFinite(avg36) || avg36<=0){
      alert("æœªè²¼æ˜ç´°æ™‚ï¼Œè«‹å¡«ï¼š60æœˆå¹³å‡ï¼ˆå¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼‰èˆ‡ 3å¹´å¹³å‡ï¼ˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰");
      return;
    }
    salaryNote = "æœªè²¼æ˜ç´°ï¼šä½¿ç”¨ä½ è¼¸å…¥çš„ 60æœˆå¹³å‡ / 3å¹´å¹³å‡";
  }

  // æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”Ÿå¹´æ¬¡ï¼‰
  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalMonths = ageToMonths(legal.years, legal.months);

  // å¹´é‡‘ææ—©/å±•å»¶ä¿‚æ•¸ï¼ˆä¾è«‹é ˜å¹´é½¡ vs æ³•å®šï¼‰
  const adj = adjustFactor(legalMonths, claimAgeMonths);

  // æ˜¯å¦å…·èˆŠåˆ¶èº«åˆ†ï¼ˆ98å‰å·²æœ‰å¹´è³‡ï¼‰
  const hasOldSystem = firstInsuredDate < RULES.oldSystemCutoff;

  // å¹´é‡‘è³‡æ ¼åˆ¤æ–·ï¼ˆ3æ¢ï¼‰
  const insYearsAtRet = insAtRetireMonths/12;
  const claimAgeYears = claimAgeMonths/12;
  const legalAgeYears = legalMonths/12;

  const pensionCond1 = (claimAgeMonths >= legalMonths) && (insAtRetireMonths >= 15*12);
  const pensionCond2 = (claimAgeYears >= 55) && (specialMonthsSafe >= 15*12);
  const pensionCond3 = (claimAgeYears >= 65) && (insAtRetireMonths < 15*12) && ((insAtRetireMonths + natMonthsSafe) >= 15*12);

  const eligiblePension = pensionCond1 || pensionCond2 || pensionCond3;

  // è€å¹´ä¸€æ¬¡é‡‘ï¼ˆæ–°åˆ¶ï¼‰è³‡æ ¼ï¼šå¹´æ»¿æ³•å®šå¹´é½¡ + å¹´è³‡<15ï¼ˆæˆ–æœªèµ°å¹´é‡‘æ¢ä»¶ï¼‰
  const eligibleNewLump = (claimAgeMonths >= legalMonths) && (insAtRetireMonths < 15*12);

  // ä½ çš„é—œéµä¿®æ­£ï¼š98å¾Œæ‰æŠ•ä¿çš„äººï¼Œå¹´è³‡>=15ä¸èƒ½ä¸€æ¬¡é‡‘ï¼Œåªèƒ½æœˆé ˜ï¼›å¹´è³‡<15åªèƒ½ä¸€æ¬¡é‡‘
  // é€™è£¡æœƒç”¨åˆ†æµçµæœå¼·åˆ¶åŒ–é¡¯ç¤ºï¼ˆä¸çµ¦éŒ¯èª¤é¸é …ï¼‰
  let pension = null;
  let laborMonthlyAtRetire = 0;

  // è¨­å®šï¼šè³‡ç”¢æ¨¡æ“¬çš„ã€Œé€€ä¼‘å¾Œå‹ä¿æœˆé ˜ã€è¦ç”¨å“ªå€‹ï¼Ÿ
  // è‹¥ä½ æœ€å¾Œé¸ä¸€æ¬¡è«‹é ˜ï¼ˆèˆŠåˆ¶ï¼‰ï¼Œå‹ä¿æœˆé ˜=0ï¼›ä½†ä½ ä»å¯ç”¨æ¯”è¼ƒæ¨¡å¼çœ‹å…©æ–¹æ¡ˆã€‚
  // é€™è£¡å…ˆä»¥ã€Œåˆ¶åº¦é è¨­ä¸»æ–¹æ¡ˆã€ï¼šèƒ½å¹´é‡‘å°±ç”¨å¹´é‡‘ï¼›ä¸è¡Œå¹´é‡‘ä½†èƒ½è€å¹´ä¸€æ¬¡é‡‘å‰‡æœˆé ˜=0ã€‚
  if(eligiblePension){
    pension = calcPensionMonthly(avg60, insAtRetireMonths, adj.factor);
    laborMonthlyAtRetire = pension.finalMonthly;
  }else{
    laborMonthlyAtRetire = 0;
  }

  // æ–°åˆ¶è€å¹´ä¸€æ¬¡é‡‘é‡‘é¡
  let newLump = null;
  if(eligibleNewLump){
    newLump = calcOldAgeLumpSumNew(avg60, insAtRetireMonths);
  }

  // èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜è³‡æ ¼ + é‡‘é¡ï¼ˆè‹¥ç¬¦åˆæ‰é¡¯ç¤ºå¯é¸ï¼‰
  const oldElig = eligibleOldSystemOneTime(
    hasOldSystem, hasWithdrawn, gender, claimAgeMonths,
    insAtRetireMonths, sameUnitMonthsSafe, specialMonthsSafe
  );

  let oldBenefit = null;
  if(oldElig.ok){
    // 60æ­²å¾Œå¹´è³‡æœ€å¤š5å¹´è¨ˆå…¥ï¼šæ­¤å·¥å…·ç¼ºå°‘ç²¾æº–æ‹†åˆ†ï¼Œå› æ­¤çµ¦ã€Œä¿å®ˆå¯å¡«ã€æ¬„ä½ä¸å¦å¢åŠ ä»‹é¢è¤‡é›œåº¦ï¼Œ
    // ç›´æ¥ç”¨ï¼šè‹¥è«‹é ˜å¹´é½¡>=60ï¼Œè¦–ç‚º60å¾Œå¹´è³‡=0ï¼ˆä¿å®ˆï¼‰ï¼Œä½¿ç”¨è€…å¯åœ¨ã€ŒåŒä¸€å–®ä½/ç‰¹æ®Šå·¥ä½œã€å€å¡Šè£œè¶³è³‡æ–™å¾Œå†èª¿æ•´ã€‚
    // è‹¥ä½ å¸Œæœ›æ›´ç²¾æº–ï¼šå¯å†åŠ ä¸€å€‹ã€Œ60æ­²å¾Œå¹´è³‡ã€æ¬„ä½ï¼Œæˆ‘å†å¹«ä½ åŠ ã€‚
    const after60Months = 0;
    const bm = calcOldSystemBenefitMonths(insAtRetireMonths, after60Months);
    const amount = calcOldSystemLumpSum(avg36, bm.benefitMonths);
    oldBenefit = { benefitMonths: bm.benefitMonths, cap: bm.cap, amount };
  }

  // å¹´é‡‘ vs èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜æ¯”è¼ƒï¼ˆåªæœ‰å…©è€…éƒ½å­˜åœ¨æ‰åšï¼‰
  let compare = null;
  if(pension && oldBenefit){
    compare = comparePensionVsLump(pension.finalMonthly, oldBenefit.amount, claimAgeYears, lifeExp);
  }

  // ---------- è²¡å‹™åƒæ•¸ ----------
  const principal0 = Math.max(0, money($("assetNow").value) || 0);
  const contribMonthly = Math.max(0, money($("contribMonthly").value) || 0);

  const divPre = Math.max(0, Number($("divPre").value) || 0) / 100;
  const bondPre = Math.max(0, Number($("bondPre").value) || 0) / 100;
  const growthPre = Number($("growthPre").value || 0) / 100;

  const divPost = Math.max(0, Number($("divPost").value) || 0) / 100;
  const bondPost = Math.max(0, Number($("bondPost").value) || 0) / 100;
  const growthPost = Number($("growthPost").value || 0) / 100;

  const reinvestPre = ($("reinvestPre").value === "yes");
  const reinvestPostMode = $("reinvestPost").value; // spend / reinvest

  const rentMonthly = Math.max(0, money($("rentMonthly").value) || 0);
  const otherIncomeMonthly = Math.max(0, money($("otherIncomeMonthly").value) || 0);

  const needMonthlyToday = Math.max(0, money($("needMonthlyToday").value) || 0);
  const inflation = Math.max(0, Number($("inflation").value) || 0) / 100;

  const postContribMode = $("postContribMode").value; // yes/no
  const postContribMonthly = Math.max(0, money($("postContribMonthly").value) || 0);

  // é€€ä¼‘å¾ŒæœŸé–“ï¼ˆæœˆï¼‰
  const retireAgeYears = retireY + retireM/12;
  const monthsRetired = Math.max(0, Math.floor((lifeExp - retireAgeYears) * 12));

  // å…¶ä»–æ”¶å…¥æ¨åˆ°é€€ä¼‘ï¼ˆåç›®ï¼‰ï¼šç”¨é€šè†¨æœˆåŒ–æ¨
  const infM = annualToMonthlyRate(inflation);
  const otherIncomeMonthlyAtRetire = otherIncomeMonthly * ((1 + infM) ** monthsToRetire);

  // baseParamsï¼šç¼ºå£æ¨¡æ“¬ä½¿ç”¨ã€Œåˆ¶åº¦é è¨­ä¸»æ–¹æ¡ˆã€çš„å‹ä¿æœˆé ˜ï¼ˆèƒ½å¹´é‡‘å°±å¹´é‡‘ï¼Œå¦å‰‡0ï¼‰
  const baseParams = {
    monthsToRetire, monthsRetired,
    principal0, reserve0: 0,
    contribMonthly, reinvestPre,
    divPre, bondPre, growthPre,
    reinvestPostMode,
    divPost, bondPost, growthPost,
    rentMonthly, otherIncomeMonthlyAtRetire,
    laborMonthlyAtRetire,
    needMonthlyToday, inflation,
    postContribMode, postContribMonthly
  };

  const sim = simulatePlan(baseParams);
  const solveSave = solveExtraContribution(baseParams);
  const solveCut  = solveExpenseCut(baseParams);

  // é€€ä¼‘ç•¶ä¸‹å·®é¡é …ï¼ˆä»¥é€€ä¼‘ç•¶æœˆåç›®ï¼‰
  const divInc0 = (sim.principalAtRetire) * (divPost/12);
  const bondInc0 = (sim.principalAtRetire) * (bondPost/12);
  const incomeFromYields0 = (reinvestPostMode === "spend") ? (divInc0 + bondInc0) : 0;
  const infToRetire = (1 + infM) ** monthsToRetire;
  const needAtRetire = needMonthlyToday * infToRetire;

  const incomeAtRetire =
    laborMonthlyAtRetire +
    otherIncomeMonthlyAtRetire +
    rentMonthly +
    incomeFromYields0;

  const gapAtRetire = Math.max(0, needAtRetire - incomeAtRetire);

  const retireDateStr = `${retireDate.getFullYear()}-${String(retireDate.getMonth()+1).padStart(2,"0")}-${String(retireDate.getDate()).padStart(2,"0")}`;

  const diffText = (adj.diffMonths === 0) ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0) ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆÃ—${adj.factor.toFixed(3)}ï¼Œå°é ‚Â±20%ï¼‰`
    : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆÃ—${adj.factor.toFixed(3)}ï¼Œå°é ‚Â±20%ï¼‰`;

  // åˆ¶åº¦åˆ†æµæ–‡å­—ï¼ˆé‡é»ï¼šé¿å…éŒ¯èª¤é¸é …ï¼‰
  let systemFlow = "";
  if(!hasOldSystem){
    // 98å¾Œæ‰æŠ•ä¿ï¼š>=15åªèƒ½å¹´é‡‘ï¼Œ<15åªèƒ½è€å¹´ä¸€æ¬¡é‡‘
    if(insAtRetireMonths >= 15*12){
      systemFlow = "ä½ å±¬æ–¼ã€Œ98å¾Œæ‰æŠ•ä¿ã€ï¼šå¹´è³‡â‰¥15å¹´ â†’ ä¾æ³•åªèƒ½è«‹é ˜è€å¹´å¹´é‡‘ï¼ˆæœˆé ˜ï¼‰ã€‚";
    }else{
      systemFlow = "ä½ å±¬æ–¼ã€Œ98å¾Œæ‰æŠ•ä¿ã€ï¼šå¹´è³‡<15å¹´ â†’ ä¾æ³•åªèƒ½è«‹é ˜è€å¹´ä¸€æ¬¡é‡‘ï¼ˆä¸€æ¬¡çµ¦ä»˜ï¼‰ã€‚";
    }
  }else{
    // 98å‰å·²æœ‰å¹´è³‡ï¼šå¯èƒ½åŒæ™‚æœ‰å¹´é‡‘/ä¸€æ¬¡è«‹é ˜ï¼ˆèˆŠåˆ¶ï¼‰é¸æ“‡æ¬Šï¼ˆéœ€ç¬¦åˆæ¢ä»¶ï¼‰
    if(eligiblePension && oldElig.ok){
      systemFlow = "ä½ å…·ã€Œ98å‰å¹´è³‡ã€ä¸”ç¬¦åˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜æ¢ä»¶ï¼šå¯æ¯”è¼ƒã€Œå¹´é‡‘ï¼ˆæœˆé ˜ï¼‰ã€vsã€Œä¸€æ¬¡è«‹é ˜ï¼ˆèˆŠåˆ¶ï¼‰ã€ä¸¦é¸æ“‡å…¶ä¸€ï¼ˆæ ¸ä»˜å¾Œä¸å¯è®Šæ›´ï¼‰ã€‚";
    }else if(eligiblePension){
      systemFlow = "ä½ å…·ã€Œ98å‰å¹´è³‡ã€ï¼šç›®å‰å¯é ˜å¹´é‡‘ï¼›ä½†ä½ è¼¸å…¥æ¢ä»¶å°šæœªé”æˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜æ¢ä»¶ï¼ˆå¯å±•é–‹é€²éšè£œè¶³è³‡æ–™ï¼‰ã€‚";
    }else if(eligibleNewLump){
      systemFlow = "ä½ å…·ã€Œ98å‰å¹´è³‡ã€ä½†å¹´è³‡æœªæ»¿15å¹´ï¼šé€šå¸¸ä»¥è€å¹´ä¸€æ¬¡é‡‘ç‚ºä¸»ï¼›è‹¥ä»æƒ³åˆ¤æ–·èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼Œéœ€ç¬¦åˆèˆŠåˆ¶æ¢ä»¶ä¸¦é€€ä¿ã€‚";
    }else{
      systemFlow = "ä½ å…·ã€Œ98å‰å¹´è³‡ã€ï¼šç›®å‰æœªæ»¿è¶³å¹´é‡‘/ä¸€æ¬¡é‡‘çš„åŸºæœ¬æ¢ä»¶ï¼ˆä¾‹å¦‚æœªé”æ³•å®šå¹´é½¡ï¼‰ã€‚";
    }
  }

  const statusTitle = sim.ok ? "âœ… ç¼ºå£æ¨¡æ“¬ï¼šå¯æ’åˆ°é è¨ˆå£½å‘½" : "âš ï¸ ç¼ºå£æ¨¡æ“¬ï¼šå¯èƒ½æå‰ç”¨å®Œè³‡ç”¢";
  const statusSub = sim.ok
    ? `æ¨¡æ“¬åˆ° ${lifeExp} æ­²çµæŸï¼Œè³‡ç”¢ä»ç‚ºæ­£ã€‚`
    : `ç´„åœ¨é€€ä¼‘å¾Œç¬¬ ${sim.brokeMonth} å€‹æœˆè³‡ç”¢è½‰è² ï¼ˆâ‰ˆ ${(sim.brokeMonth/12).toFixed(1)} å¹´ï¼‰ã€‚`;

  const extraSaveText = (solveSave.extra<=0)
    ? "ä¸éœ€è¦é¡å¤–å¢åŠ é€€ä¼‘å‰æŠ•å…¥ã€‚"
    : `è‹¥è¦æ’åˆ° ${lifeExp} æ­²ï¼šé€€ä¼‘å‰æ¯æœˆéœ€ã€Œå†å¤šå­˜ã€ç´„ NT$ ${fmt(solveSave.extra)}ã€‚`;

  const cutText = (solveCut.cut<=0)
    ? "ç”Ÿæ´»è²»ä¸éœ€è¦èª¿é™ã€‚"
    : `æˆ–ï¼šæŠŠã€Œä»Šå¤©åƒ¹å€¼çš„ç”Ÿæ´»è²»ã€æ¯æœˆèª¿é™ç´„ NT$ ${fmt(solveCut.cut)}ï¼ˆå…¶ä»–å‡è¨­ä¸è®Šï¼‰ã€‚`;

  // Output
  const out = $("output");
  out.style.display="block";

  // å‹ä¿çµæœå€ï¼šå¹´é‡‘/æ–°åˆ¶ä¸€æ¬¡é‡‘/èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼ˆå«æ¯”è¼ƒæ¨¡å¼ï¼‰
  const pensionBox = eligiblePension
    ? `<div class="kpi-box">
         <div class="kpi-title">è€å¹´å¹´é‡‘ï¼ˆæœˆé ˜ï¼‰<span class="tag">åˆ¶åº¦åˆè¦</span></div>
         <div class="kpi-value">NT$ ${fmt(laborMonthlyAtRetire)} /æœˆ</div>
         <div class="kpi-sub">
           å…©å¼æ“‡å„ªï¼š${pension.chosen}ï¼›${diffText}<br/>
           å¹´é‡‘è³‡æ ¼ä¾†æºï¼š${pensionCond1 ? "ä¸€èˆ¬æ¢ä»¶(æ³•å®šå¹´é½¡+å¹´è³‡â‰¥15)" : (pensionCond2 ? "ç‰¹æ®Šå·¥ä½œ(55æ­²+ç‰¹æ®Šå¹´è³‡â‰¥15)" : "ä½µè¨ˆåœ‹ä¿(65æ­²+åˆè¨ˆâ‰¥15)") }
         </div>
       </div>`
    : `<div class="kpi-box">
         <div class="kpi-title">è€å¹´å¹´é‡‘ï¼ˆæœˆé ˜ï¼‰</div>
         <div class="kpi-value">â€”</div>
         <div class="kpi-sub">ç›®å‰æ¢ä»¶æœªç¬¦åˆè€å¹´å¹´é‡‘è³‡æ ¼ï¼ˆè«‹ç¢ºèªå¹´è³‡/å¹´é½¡/ç‰¹æ®Šå·¥ä½œ/åœ‹ä¿ä½µè¨ˆï¼‰ã€‚</div>
       </div>`;

  const newLumpBox = eligibleNewLump
    ? `<div class="kpi-box">
         <div class="kpi-title">è€å¹´ä¸€æ¬¡é‡‘ï¼ˆä¸€æ¬¡çµ¦ä»˜ï¼‰<span class="tag">å¹´è³‡æœªæ»¿15</span></div>
         <div class="kpi-value">NT$ ${fmt(newLump.amount)}</div>
         <div class="kpi-sub">çµ¦ä»˜æœˆæ•¸ï¼ˆæŒ‰å¹´è³‡æ¯”ä¾‹ï¼‰ï¼š${newLump.benefitMonths.toFixed(4)} æœˆè–ªè³‡</div>
       </div>`
    : `<div class="kpi-box">
         <div class="kpi-title">è€å¹´ä¸€æ¬¡é‡‘ï¼ˆä¸€æ¬¡çµ¦ä»˜ï¼‰</div>
         <div class="kpi-value">â€”</div>
         <div class="kpi-sub">å¹´è³‡â‰¥15 æˆ–æœªé”æ³•å®šå¹´é½¡æ™‚ï¼Œä¸é©ç”¨æ­¤çµ¦ä»˜ã€‚</div>
       </div>`;

  const oldLumpBox = oldBenefit
    ? `<div class="kpi-box">
         <div class="kpi-title">ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆèˆŠåˆ¶ï¼‰<span class="tag">98å‰å¹´è³‡</span></div>
         <div class="kpi-value">NT$ ${fmt(oldBenefit.amount)}</div>
         <div class="kpi-sub">çµ¦ä»˜æœˆæ•¸ï¼š${oldBenefit.benefitMonths.toFixed(2)}ï¼ˆä¸Šé™${oldBenefit.cap}ï¼‰<br/>è³‡æ ¼åˆ¤æ–·ï¼š<span class="oktext">${oldElig.reason}</span></div>
       </div>`
    : `<div class="kpi-box">
         <div class="kpi-title">ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆèˆŠåˆ¶ï¼‰</div>
         <div class="kpi-value">â€”</div>
         <div class="kpi-sub">${hasOldSystem ? `<span class="danger">ä¸å¯é¸ï¼š</span>${oldElig.reason}` : "98å¾Œæ‰é–‹å§‹åŠ ä¿ï¼šä¾æ³•ç„¡èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜é¸æ“‡æ¬Šã€‚"}</div>
       </div>`;

  let compareBox = `<div class="kpi-box">
      <div class="kpi-title">å¹´é‡‘ vs ä¸€æ¬¡è«‹é ˜ æ¯”è¼ƒæ¨¡å¼</div>
      <div class="kpi-value">â€”</div>
      <div class="kpi-sub">éœ€åŒæ™‚å…·å‚™ã€Œå¯é ˜å¹´é‡‘ã€èˆ‡ã€Œå¯é¸èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ã€æ‰æœƒé¡¯ç¤ºæ¯”è¼ƒçµæœã€‚</div>
    </div>`;

  if(compare){
    const breakevenTxt = (compare.breakevenAge && isFinite(compare.breakevenAge))
      ? `å›æœ¬å¹´é½¡ï¼ˆç´¯ç©å¹´é‡‘â‰¥ä¸€æ¬¡é‡‘ï¼‰ï¼šç´„ <b>${compare.breakevenAge.toFixed(1)} æ­²</b>`
      : "å›æœ¬å¹´é½¡ï¼šâ€”";

    const whichBetter = (compare.totalPension >= oldBenefit.amount)
      ? `ä»¥é è¨ˆå£½å‘½ ${lifeExp} æ­²è¨ˆï¼š<b>å¹´é‡‘ç´¯ç©</b>ï¼ˆNT$ ${fmt(compare.totalPension)}ï¼‰â‰¥ <b>ä¸€æ¬¡è«‹é ˜</b>ï¼ˆNT$ ${fmt(oldBenefit.amount)}ï¼‰`
      : `ä»¥é è¨ˆå£½å‘½ ${lifeExp} æ­²è¨ˆï¼š<b>ä¸€æ¬¡è«‹é ˜</b>ï¼ˆNT$ ${fmt(oldBenefit.amount)}ï¼‰> <b>å¹´é‡‘ç´¯ç©</b>ï¼ˆNT$ ${fmt(compare.totalPension)}ï¼‰`;

    compareBox = `<div class="kpi-box">
      <div class="kpi-title">å¹´é‡‘ vs ä¸€æ¬¡è«‹é ˜ æ¯”è¼ƒæ¨¡å¼ <span class="tag">ä¾é è¨ˆå£½å‘½</span></div>
      <div class="kpi-value">${whichBetter}</div>
      <div class="kpi-sub">
        å¾ ${claimAgeYears.toFixed(1)} æ­²é–‹å§‹é ˜ï¼Œåˆ° ${lifeExp} æ­²ï¼šå…± ${compare.months} å€‹æœˆ<br/>
        å¹´é‡‘ç´¯ç©ï¼šNT$ ${fmt(compare.totalPension)}ï¼ˆæœªæŠ˜ç¾ï¼‰<br/>
        ä¸€æ¬¡è«‹é ˜ï¼šNT$ ${fmt(oldBenefit.amount)}<br/>
        ${breakevenTxt}
      </div>
    </div>`;
  }

  out.innerHTML = `
    <div class="kpi">
      <div class="kpi-box">
        <div class="kpi-title">${statusTitle}</div>
        <div class="kpi-value">é€€ä¼‘æ™‚ç¸½è³‡ç”¢ï¼šNT$ ${fmt(Math.round(sim.totalAtRetire))}</div>
        <div class="kpi-sub">${statusSub}</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">å·®é¡é …ï¼ˆæœ€é‡è¦ï¼‰</div>
        <div class="kpi-value">é€€ä¼‘ç•¶ä¸‹æ¯æœˆç¼ºå£ï¼šNT$ ${fmt(Math.round(gapAtRetire))}</div>
        <div class="kpi-sub">
          ${extraSaveText}<br/>${cutText}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">åˆ¶åº¦è‡ªå‹•åˆ¤æ–·ï¼ˆåˆ†æµï¼‰</div>
        <div class="kpi-value">${systemFlow}</div>
        <div class="kpi-sub">
          æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”ŸROC ${rocBirthYear}ï¼‰ï¼š${legal.years}æ­²ï¼›ä½ è¨­å®šè«‹é ˜ï¼š${claimY}æ­²${claimM}æœˆ â†’ ${diffText}<br/>
          é€€ä¼‘å¹´è³‡ä¼°ç®—ï¼š${insYearsAtRet.toFixed(2)}å¹´ï¼ˆ${keepInsured ? "å«é€€ä¼‘å‰æŒçºŒæŠ•ä¿" : "ä¸å†å¢åŠ å¹´è³‡"}ï¼‰
        </div>
      </div>

      ${pensionBox}
      ${newLumpBox}
      ${oldLumpBox}
      ${compareBox}
    </div>

    <details style="margin-top:12px">
      <summary>å±•é–‹ï¼šé€€ä¼‘ç•¶ä¸‹ç¾é‡‘æµæ‹†è§£ï¼ˆç¼ºå£æ€éº¼ä¾†ï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">é€€ä¼‘æ—¥æœŸï¼ˆä¼°ï¼‰</td><td>${retireDateStr}</td></tr>
          <tr><td class="muted">é€€ä¼‘ç•¶ä¸‹ç”Ÿæ´»è²»ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(needAtRetire))}</td></tr>
          <tr><td class="muted">å‹ä¿æœˆé ˜ï¼ˆæ¨¡æ“¬ç”¨ï¼‰</td><td>NT$ ${fmt(laborMonthlyAtRetire)}</td></tr>
          <tr><td class="muted">å…¶ä»–æ”¶å…¥ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(otherIncomeMonthlyAtRetire))}</td></tr>
          <tr><td class="muted">æˆ¿ç§Ÿï¼ˆæœˆé¡ï¼‰</td><td>NT$ ${fmt(Math.round(rentMonthly))}</td></tr>
          <tr><td class="muted">è‚¡æ¯+å‚µæ¯ï¼ˆæœˆï¼‰</td><td>NT$ ${fmt(Math.round(incomeFromYields0))} ${reinvestPostMode==="reinvest" ? "ï¼ˆä½ é¸æ“‡å†æŠ•å…¥â†’æ­¤é …ä¸ä½œç”Ÿæ´»è²»æ”¶å…¥ï¼‰" : ""}</td></tr>
          <tr><td style="font-weight:900">åˆè¨ˆæ”¶å…¥</td><td style="font-weight:900">NT$ ${fmt(Math.round(incomeAtRetire))}</td></tr>
          <tr><td style="font-weight:900">ç¼ºå£ï¼ˆéœ€æé ˜/å‹•ç”¨è³‡ç”¢ï¼‰</td><td style="font-weight:900">NT$ ${fmt(Math.round(gapAtRetire))}</td></tr>
        </table>
      </div>
    </details>

    <details>
      <summary>å±•é–‹ï¼šåˆ¶åº¦è¨ˆç®—ç´°ç¯€ï¼ˆæƒ³æ ¸å°è¦å‰‡çš„äººï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">è–ªè³‡ä¾†æº</td><td>${salaryNote}</td></tr>
          <tr><td class="muted">60æœˆå¹³å‡ï¼ˆå¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼‰</td><td>NT$ ${fmt(Math.round(avg60))}</td></tr>
          <tr><td class="muted">3å¹´å¹³å‡ï¼ˆèˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰</td><td>NT$ ${fmt(Math.round(avg36))}</td></tr>
          <tr><td class="muted">98å‰å¹´è³‡åˆ¤æ–·</td><td>${hasOldSystem ? "æ˜¯ï¼ˆå¯è©•ä¼°èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰" : "å¦ï¼ˆç„¡èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜é¸æ“‡æ¬Šï¼‰"}</td></tr>
          <tr><td class="muted">é€€ä¼‘æ™‚å¹´è³‡ï¼ˆä¼°ï¼‰</td><td>${(insAtRetireMonths/12).toFixed(2)} å¹´</td></tr>
          <tr><td class="muted">æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”Ÿå¹´æ¬¡ï¼‰</td><td>${legal.years} æ­²</td></tr>
          <tr><td class="muted">ææ—©/å±•å»¶</td><td>${diffText}</td></tr>
          ${pension ? `
            <tr><td class="muted">å¹´é‡‘å¼1ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base1))}</td></tr>
            <tr><td class="muted">å¹´é‡‘å¼2ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base2))}</td></tr>
            <tr><td class="muted">æ“‡å„ªåŸºç¤ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.chosenBase))}</td></tr>
            <tr><td class="muted">åŠ æ¸›çµ¦ä¿‚æ•¸</td><td>Ã— ${adj.factor.toFixed(4)}</td></tr>
          ` : ``}
          ${newLump ? `
            <tr><td class="muted">è€å¹´ä¸€æ¬¡é‡‘çµ¦ä»˜æœˆæ•¸ï¼ˆæŒ‰å¹´è³‡æ¯”ä¾‹ï¼‰</td><td>${newLump.benefitMonths.toFixed(4)}</td></tr>
          ` : ``}
          ${oldBenefit ? `
            <tr><td class="muted">èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜çµ¦ä»˜æœˆæ•¸</td><td>${oldBenefit.benefitMonths.toFixed(2)}ï¼ˆä¸Šé™${oldBenefit.cap}ï¼‰</td></tr>
          ` : ``}
        </table>

        <div class="small muted">
          è¦å‰‡æ‘˜è¦ï¼š<br/>
          â€¢ å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ï¼š60æœˆæœ€é«˜å¹³å‡ï¼›å¹´é‡‘å…©å¼æ“‡å„ªï¼›ææ—©/å±•å»¶æ¯å¹´Â±4%å°é ‚Â±20%ï¼ˆæœªæ»¿ä¸€å¹´æŒ‰æœˆæ¯”ä¾‹ï¼‰<br/>
          â€¢ å¹´é‡‘è³‡æ ¼ï¼šæ³•å®šå¹´é½¡+å¹´è³‡â‰¥15ï¼›æˆ–ç‰¹æ®Šå·¥ä½œæ»¿15ä¸”55ï¼›æˆ–å‹ä¿<15ä½†ä½µè¨ˆåœ‹ä¿â‰¥15ä¸”65å¯é¸å¹´é‡‘<br/>
          â€¢ è€å¹´ä¸€æ¬¡é‡‘ï¼šæ³•å®šå¹´é½¡+å¹´è³‡<15ï¼ˆä¸€æ¬¡çµ¦ä»˜ï¼‰<br/>
          â€¢ èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼šéœ€98å‰å¹´è³‡+é€€è·é€€ä¿+ç¬¦åˆæ¢ä»¶(1)~(5)ï¼›å¹³å‡è–ªè³‡=é€€ä¿å‰3å¹´å¹³å‡ï¼›çµ¦ä»˜æœˆæ•¸=1å€+2å€ï¼Œä¸Šé™45ï¼›60å¾Œæœ€å¤š5å¹´åˆä½µä¸Šé™50
        </div>
      </div>
    </details>
  `;

  // è­¦ç¤ºï¼šè«‹é ˜å¹´é½¡ç›¸å·®éå¤§
  if(Math.abs(adj.diffMonths) > 60){
    showWarn("ä½ è¼¸å…¥çš„è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é5å¹´ï¼›å¹´é‡‘åŠ æ¸›çµ¦å·²ä¾è¦å‰‡å°é ‚ï¼ˆÂ±20%ï¼‰ã€‚");
  }else{
    showOk("å·²å®Œæˆï¼šåˆ¶åº¦ç²¾æº–åˆ†æµï¼ˆå¹´é‡‘/ä¸€æ¬¡é‡‘/èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰ï¼‹ç¼ºå£æ¨¡æ“¬ï¼ˆè‚¡æ¯/å‚µæ¯/å¢å€¼/æˆ¿ç§Ÿ/é€šè†¨/æŠ•å…¥ï¼‰ï¼‹å·®é¡åæ¨ï¼ˆå¤šå­˜/å°‘èŠ±ï¼‰ï¼‹æ¯”è¼ƒæ¨¡å¼ï¼ˆå¹´é‡‘ vs ä¸€æ¬¡è«‹é ˜ï¼‰ã€‚");
  }
}

/* ===================== ç¯„ä¾‹ ===================== */
function loadExample(){
  $("birthDate").value = "1980-01-01";
  $("gender").value = "male";
  $("firstInsuredDate").value = "2000-01-01"; // 98å‰èº«åˆ†
  $("hasWithdrawn").value = "yes";

  $("retireYears").value = 65; $("retireMonths").value = 0;
  $("claimYears").value = 65; $("claimMonths").value = 0;
  $("lifeExpectancy").value = 90;

  $("insYearsNow").value = 28; $("insMonthsNow").value = 0; $("insDaysNow").value = 5;
  $("keepInsured").value = "yes";

  $("natYears").value = 0; $("natMonths").value = 0;

  $("specialYears").value = 0; $("specialMonths").value = 0;
  $("sameUnitYears").value = 25; $("sameUnitMonths").value = 0; // è§¸ç™¼èˆŠåˆ¶æ¢ä»¶(3)

  $("avgSalary60").value = 45800;
  $("avgSalary36Old").value = 45800;
  $("salaryLines").value = "";

  $("assetNow").value = 8000000;
  $("contribMonthly").value = 30000;

  $("divPre").value = 3.0;
  $("bondPre").value = 1.0;
  $("growthPre").value = 3.0;
  $("reinvestPre").value = "yes";

  $("divPost").value = 3.0;
  $("bondPost").value = 1.0;
  $("growthPost").value = 2.0;
  $("reinvestPost").value = "spend";

  $("rentMonthly").value = 15000;
  $("otherIncomeMonthly").value = 0;

  $("needMonthlyToday").value = 80000;
  $("inflation").value = 2.0;

  $("postContribMode").value = "no";
  $("postContribMonthly").value = 0;

  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼šå«98å‰å¹´è³‡ + åŒä¸€å–®ä½25å¹´ï¼ˆå¯é¸èˆŠåˆ¶ä¸€æ¬¡è«‹é ˜ï¼‰ï¼Œä¸¦ä¿ç•™ç¼ºå£æ¨¡æ“¬åƒæ•¸ã€‚");
  showWarn("");
  hideOutput();
}

/* init */
(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  if(!$("firstInsuredDate").value) $("firstInsuredDate").value = "2009-01-01";
  [
    "birthDate","gender","firstInsuredDate","hasWithdrawn",
    "retireYears","retireMonths","claimYears","claimMonths","lifeExpectancy",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsured",
    "natYears","natMonths",
    "specialYears","specialMonths","sameUnitYears","sameUnitMonths",
    "avgSalary60","avgSalary36Old","salaryLines",
    "assetNow","contribMonthly",
    "divPre","bondPre","growthPre","reinvestPre",
    "divPost","bondPost","growthPost","reinvestPost",
    "rentMonthly","otherIncomeMonthly",
    "needMonthlyToday","inflation",
    "postContribMode","postContribMonthly"
  ].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", hideOutput);
    el.addEventListener("change", hideOutput);
  });
})();
</script>
</body>
</html>
