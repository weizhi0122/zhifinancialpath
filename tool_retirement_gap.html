<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å‹ä¿è€å¹´çµ¦ä»˜è©¦ç®—ï¼ˆ98å‰/å¾Œï¼‹60æ­²å¾ŒåŠ ä¿ï¼‰ï½œæ™º Financial Path</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300; --goodbg:#ecfdf3; --good:#027a48;
    --shadow:0 6px 16px rgba(0,0,0,.05);
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text);line-height:1.55}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}

  /* Topbar */
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:10px 18px;position:sticky;top:0;z-index:10}
  .topbar-inner{max-width:980px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left-nav{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .navbtn{
    display:inline-flex;align-items:center;gap:6px;
    padding:7px 10px;border-radius:999px;border:1px solid var(--line);
    background:#fff;color:#0f172a;font-weight:800;font-size:13px;
  }
  .navbtn:hover{background:#f8fafc;text-decoration:none}

  .container{max-width:980px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:24px}
  .sub{color:var(--muted);font-size:13.5px;margin-top:6px}

  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow)}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a;font-weight:800}
  input,select,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  input:focus,select:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1;min-width:170px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:900}
  button.ghost{background:#fff;color:var(--primary);border:1px solid #cfe0ff}
  button:hover{opacity:.92}
  .small{font-size:12.5px;color:var(--muted);line-height:1.55;margin-top:8px}
  .warn,.ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.45}
  .warn{background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5}
  .ok{background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc}
  .result{display:none;margin-top:14px}

  .kpi{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:860px){ .kpi{grid-template-columns:1fr 1fr} }
  .kpi-box{border:1px solid #dbe7ff;background:var(--soft);border-radius:12px;padding:12px}
  .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi-value{font-size:20px;font-weight:900;color:var(--primary)}
  .kpi-sub{font-size:12.5px;color:var(--muted);margin-top:6px;line-height:1.55}

  details{margin-top:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  summary{cursor:pointer;padding:12px 12px;font-weight:900;color:#0f172a}
  details .inner{padding:0 12px 12px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table td:last-child{text-align:right}

  .badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#334155}
  .badge.ok{border-color:#b7f0cc;background:#ecfdf3;color:#027a48}
  .badge.no{border-color:#ffd6d6;background:#fff4f4;color:#b42318}
  .badge.info{border-color:#dbe7ff;background:#eef4ff;color:#0b3d91}

  .chkline{display:flex;align-items:flex-start;gap:10px;margin-top:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .chkline input{width:auto;margin-top:3px}
  .chktext{display:flex;flex-direction:column;gap:2px}
  .chktext .t{font-weight:900;color:#0f172a}
  .chktext .d{font-size:12.5px;color:var(--muted);line-height:1.45}
  .hide{display:none}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>

<body>
  <!-- Top navigation -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <!-- å›ä¸Šé ï¼šç”¨ JS history.back()ï¼Œä¸ä¾è³´å›ºå®šè·¯å¾‘ -->
        <a class="navbtn" href="javascript:history.back()">â†© å›ä¸Šé </a>
        <!-- å›å·¥å…· / å›ä¸»é ï¼šä¾ä½ çš„ç«™å°æª”å -->
        <a class="navbtn" href="./tools.html">ğŸ§° å›å·¥å…·</a>
        <a class="navbtn" href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>å‹ä¿è€å¹´çµ¦ä»˜è©¦ç®— <span class="badge info">å¹´é‡‘ï¼‹ä¸€æ¬¡é‡‘ï¼‹ä¸€æ¬¡è«‹é ˜ï¼ˆåˆ¶åº¦åˆ†é–‹æ¸…æ¥šå¯«ï¼‰</span></h1>
    <div class="sub">
      å‹¾é¸ã€Œ98å‰å·²æœ‰æŠ•ä¿ã€ï¼è¦–ç‚º 98/01/01 å‰å·²æœ‰å¹´è³‡ï¼›ä¸å‹¾ï¼è¦–ç‚º 98 å¾Œé¦–æ¬¡æŠ•ä¿ã€‚<br/>
      ä¸ç®¡å‹¾ä¸å‹¾ï¼Œéƒ½æœƒä¾åˆ¶åº¦é¡¯ç¤ºï¼šå¹´é‡‘ / è€å¹´ä¸€æ¬¡é‡‘ /ï¼ˆå¯èƒ½ï¼‰ä¸€æ¬¡è«‹é ˜ã€‚
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:16px;color:#0f172a">è¼¸å…¥ï¼ˆç›¡é‡ç°¡å–®ï¼‰</h2>

      <div class="row">
        <div>
          <label>å‡ºç”Ÿæ—¥æœŸ</label>
          <input id="birthDate" type="date" />
        </div>
        <div>
          <label>è«‹é ˜å¹´é½¡</label>
          <div class="row">
            <div><input id="claimYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
            <div><input id="claimMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
          </div>
        </div>
      </div>

      <label>ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆæœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
      <div class="row">
        <div><input id="insYearsNow" type="number" min="0" step="1" value="30" /><div class="small">å¹´</div></div>
        <div><input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
        <div><input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" /><div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div></div>
      </div>

      <div class="row">
        <div>
          <label>åˆ°è«‹é ˜å¹´é½¡æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
          <select id="keepInsuredToClaim">
            <option value="yes" selected>æ˜¯ï¼ˆå¹´è³‡æœƒç´¯ç©åˆ°è«‹é ˜é»ï¼‰</option>
            <option value="no">å¦ï¼ˆå¹´è³‡ä»¥ç›®å‰ç‚ºæº–ï¼‰</option>
          </select>
          <div class="small">å¹´è³‡ä»¥ã€Œè«‹é ˜é»ã€èªå®šã€‚</div>
        </div>
        <div>
          <label>å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€é«˜60å€‹æœˆå¹³å‡ï¼‰</label>
          <input id="avgSalary60" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          <div class="small">å¹´é‡‘ã€è€å¹´ä¸€æ¬¡é‡‘éƒ½ç”¨é€™å€‹ï¼ˆ60æœˆæœ€é«˜å¹³å‡ï¼‰ã€‚</div>
        </div>
      </div>

      <div class="chkline">
        <input id="pre98" type="checkbox" />
        <div class="chktext">
          <div class="t">98/01/01 å‰å·²ç¶“æœ‰å‹ä¿å¹´è³‡ï¼ˆå‹¾é¸ä»£è¡¨ã€Œæœ‰ã€ï¼‰</div>
          <div class="d">ä¸å‹¾ï¼è¦–ç‚º 98/01/01 å¾Œæ‰é¦–æ¬¡æŠ•ä¿ã€‚</div>
        </div>
      </div>

      <label>60æ­²å¾Œç¹¼çºŒåŠ ä¿å¹´è³‡ï¼ˆå¯é¸å¡«ï¼Œä¸ç¢ºå®šå¡«0ï¼‰</label>
      <div class="row">
        <div><input id="insAfter60Years" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
        <div><input id="insAfter60Months" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
      </div>
      <div class="small">
        ç”¨é€”ï¼šå½±éŸ¿ä¸€æ¬¡çµ¦ä»˜çš„ã€Œ60æ­²å¾Œæœ€å¤š5å¹´ä½µå…¥ã€èˆ‡ã€Œä¸€æ¬¡è«‹é ˜ç¸½ä¸Šé™45/50æœˆã€ã€‚
      </div>

      <div id="avg36Block" class="row hide">
        <div>
          <label>ï¼ˆåƒ…98å‰ä¸€æ¬¡è«‹é ˜ç”¨ï¼‰å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€è¿‘36å€‹æœˆå¹³å‡ï¼‰</label>
          <input id="avgSalary36" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          <div class="small">ä¸€æ¬¡è«‹é ˜æ‰ç”¨ã€‚æœªå¡«ä»å¯æ­£å¸¸ç®—å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ã€‚</div>
        </div>
        <div>
          <label>ï¼ˆåƒ…98å‰ä¸€æ¬¡è«‹é ˜ç”¨ï¼‰æ˜¯å¦æœªæ»¿60æ­²å°±è«‹é ˜ï¼Ÿ</label>
          <select id="claimBefore60">
            <option value="no" selected>å¦ï¼ˆ60æ­²æˆ–ä¹‹å¾Œï¼‰</option>
            <option value="yes">æ˜¯ï¼ˆæœªæ»¿60æ­²ï¼‰</option>
          </select>
          <div class="small">å½±éŸ¿ä¸€æ¬¡è«‹é ˜ä¸Šé™ï¼šæœªæ»¿60æ­²ä»¥45æœˆç‚ºä¸»ã€‚</div>
        </div>
      </div>

      <details>
        <summary>é€²éšï¼ˆå¯é¸ï¼‰ï¼šç‰¹æ®Šå·¥ä½œ55æ­² / ä½µè¨ˆåœ‹æ°‘å¹´é‡‘ / ä¸€æ¬¡è«‹é ˜æ¢ä»¶</summary>
        <div class="inner">
          <div class="row">
            <div>
              <label>ç‰¹æ®Šæ€§è³ªå·¥ä½œä¸”å‹ä¿å¹´è³‡æ»¿15å¹´ï¼Ÿï¼ˆ55æ­²å¯é ˜å¹´é‡‘ï¼‰</label>
              <select id="specialWork15">
                <option value="no" selected>å¦</option>
                <option value="yes">æ˜¯</option>
              </select>
            </div>
            <div>
              <label>å‹ä¿æœªæ»¿15å¹´ï¼šæ˜¯å¦ä½µè¨ˆåœ‹æ°‘å¹´é‡‘æ»¿15å¹´ï¼ˆ65æ­²å¯é¸é ˜å‹ä¿å¹´é‡‘ï¼‰ï¼Ÿ</label>
              <select id="combineNP">
                <option value="no" selected>å¦</option>
                <option value="yes">æ˜¯</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>åœ‹æ°‘å¹´é‡‘å¹´è³‡ï¼ˆä½µè¨ˆç”¨ï¼‰</label>
              <div class="row">
                <div><input id="npYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                <div><input id="npMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
              </div>
            </div>
            <div>
              <label>ï¼ˆä¸€æ¬¡è«‹é ˜ï¼‰åŒä¸€æŠ•ä¿å–®ä½å¹´è³‡ï¼ˆä¸ç¢ºå®šå¯å¡«0ï¼‰</label>
              <div class="row">
                <div><input id="sameUnitYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                <div><input id="sameUnitMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>ï¼ˆä¸€æ¬¡è«‹é ˜ï¼‰ç‰¹æ®Šå·¥ä½œå¹´è³‡ï¼ˆæ»¿5å¹´ä¸”55æ­²é€€è·è€…æ¢ä»¶ä¹‹ä¸€ï¼‰</label>
              <div class="row">
                <div><input id="specialWorkYears5" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                <div><input id="specialWorkMonths5" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
              </div>
            </div>
            <div>
              <label>å¥³æ€§è¢«ä¿éšªäººï¼ˆä¸€æ¬¡è«‹é ˜æ¢ä»¶ä¹‹ä¸€å«å¥³55æ­²ï¼‰</label>
              <select id="isFemale">
                <option value="no" selected>å¦</option>
                <option value="yes">æ˜¯</option>
              </select>
            </div>
          </div>

          <div class="small">
            è‹¥ä½ ä¸å¡«é€²éšæ¢ä»¶ï¼šä¸€æ¬¡è«‹é ˜æ¡ã€Œä¿å®ˆä¸åˆ¤å®šã€é¿å…èª¤åˆ¤ï¼›å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘ä¸å—å½±éŸ¿ã€‚
          </div>
        </div>
      </details>

      <div class="btnrow">
        <button onclick="calcAllBenefits()">è¨ˆç®—ï¼ˆå¹´é‡‘ï¼‹ä¸€æ¬¡é‡‘ï¼‹ä¸€æ¬¡è«‹é ˜ï¼‰</button>
        <button class="ghost" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
      </div>

      <div id="warnBox" class="warn"></div>
      <div id="okBox" class="ok"></div>

      <div id="output" class="result"></div>

      <div class="small">
        â€» æ•™è‚²ç”¨é€”ï¼šå¯¦éš›æ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ã€‚æœ¬å·¥å…·ä»¥å¸¸è¦‹å…¬é–‹è¦å‰‡å»ºæ¨¡ï¼šå¹´é‡‘å…©å¼æ“‡å„ªï¼‹ææ—©/å±•å»¶æŒ‰æœˆæ¯”ä¾‹ï¼ˆÂ±20%å°é ‚ï¼‰ï¼Œä¸¦ä¾98å‰/å¾Œåˆ†æµåŠ60æ­²å¾ŒåŠ ä¿ä¸Šé™è™•ç†ã€‚
      </div>
    </div>
  </div>

<script>
const RULES = {
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  }
};

function $(id){ return document.getElementById(id); }
function fmt(n){ return Number(n).toLocaleString("en-US"); }
function money(v){
  const n = Number(String(v||"").replace(/[,ï¼Œ\s]/g,""));
  return Number.isFinite(n) ? n : NaN;
}
function clampInt(v){
  if(!Number.isFinite(v)) return NaN;
  return Math.max(0, Math.floor(v));
}
function showWarn(msg){
  const w=$("warnBox");
  if(!msg){ w.style.display="none"; w.textContent=""; return; }
  w.style.display="block"; w.textContent=msg;
}
function showOk(msg){
  const o=$("okBox");
  if(!msg){ o.style.display="none"; o.textContent=""; return; }
  o.style.display="block"; o.textContent=msg;
}
function hideOutput(){
  $("output").style.display="none";
  $("output").innerHTML="";
}

function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }
function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}
function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}
function monthsBetween(today, future){
  let m = (future.getFullYear()-today.getFullYear())*12 + (future.getMonth()-today.getMonth());
  if (future.getDate() < today.getDate()) m -= 1;
  return Math.max(0, m);
}

function adjustFactorByMonth(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths;
  const cappedMonths = Math.max(-60, Math.min(60, diffMonths));
  const factor = 1 + cappedMonths * (0.04/12);
  return { factor, diffMonths, cappedMonths };
}

function calcPension(avgSalary60, insMonths, factor){
  const insYears = insMonths / 12;
  const base1 = avgSalary60 * insYears * 0.00775 + 3000;
  const base2 = avgSalary60 * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2) ? "å¼1ï¼ˆ0.775%Ã—å¹´è³‡ + 3000ï¼‰" : "å¼2ï¼ˆ1.55%Ã—å¹´è³‡ï¼‰";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly };
}

function calcOldAgeLump60(avgSalary60, insMonthsTotal, after60MonthsInput){
  const rawAfter60 = Math.max(0, after60MonthsInput);
  const after60Used = Math.min(rawAfter60, 60);
  const pre60 = Math.max(0, insMonthsTotal - rawAfter60);
  const benefitMonths = (pre60/12) + (after60Used/12);
  const amount = Math.round(avgSalary60 * benefitMonths);
  return { amount, benefitMonths, after60Used, after60Cap: 60 };
}

function calcOneTimeLump36(avgSalary36, insMonthsTotal, after60MonthsInput, claimBefore60){
  const rawAfter60 = Math.max(0, after60MonthsInput);
  const after60Cap = Math.min(rawAfter60, 60);
  const after60Used = claimBefore60 ? 0 : after60Cap;

  const pre60Months = Math.max(0, insMonthsTotal - rawAfter60);
  const pre60Years = pre60Months / 12;

  const y1 = Math.min(15, pre60Years);
  const y2 = Math.max(0, pre60Years - 15);

  const benefitPre60 = Math.min(y1*1 + y2*2, 45);
  const benefitAfter60 = after60Used / 12;

  const cap = claimBefore60 ? 45 : 50;
  const benefitMonths = Math.min(benefitPre60 + benefitAfter60, cap);

  const amount = Math.round(avgSalary36 * benefitMonths);
  return {
    amount, benefitMonths, cap,
    benefitPre60, benefitAfter60,
    after60Used, after60Cap: 60
  };
}

function determinePensionEligibility({
  claimAgeMonths,
  legalAgeMonthsNormal,
  specialWork15,
  insMonthsAtClaim,
  combineNP,
  npMonths
}){
  const legalAgeMonths = specialWork15 ? ageToMonths(55,0) : legalAgeMonthsNormal;

  const eligibleGeneral = (claimAgeMonths >= legalAgeMonthsNormal) && (insMonthsAtClaim >= 15*12);
  const eligibleSpecial = (specialWork15) && (claimAgeMonths >= ageToMonths(55,0)) && (insMonthsAtClaim >= 15*12);
  const eligibleCombineNP =
    (combineNP) &&
    (insMonthsAtClaim < 15*12) &&
    ((insMonthsAtClaim + npMonths) >= 15*12) &&
    (claimAgeMonths >= ageToMonths(65,0));

  const eligible = eligibleGeneral || eligibleSpecial || eligibleCombineNP;
  return { legalAgeMonths, eligible, eligibleGeneral, eligibleSpecial, eligibleCombineNP };
}

function determineOneTimeEligibilityConservative({
  pre98,
  claimAgeMonths,
  insMonthsAtClaim,
  isFemale,
  sameUnitMonths,
  specialWorkMonths5
}){
  if(!pre98) return { eligible:false, reason:"98å¾Œé¦–æ¬¡æŠ•ä¿ â†’ ä¸€æ¬¡è«‹é ˜é€šå¸¸ä¸å¯ç”¨" };

  const anyAdvanced =
    (isFemale === true) ||
    (sameUnitMonths > 0) ||
    (specialWorkMonths5 > 0);

  if(!anyAdvanced){
    return { eligible:false, reason:"æœªæä¾›ä¸€æ¬¡è«‹é ˜æ¢ä»¶ â†’ æ¡ä¿å®ˆä¸åˆ¤å®šï¼ˆé¿å…èª¤åˆ¤ï¼‰" };
  }

  const cond1 = (insMonthsAtClaim >= 12) && (claimAgeMonths >= ageToMonths(60,0) || (isFemale && claimAgeMonths >= ageToMonths(55,0)));
  const cond2 = (insMonthsAtClaim >= 15*12) && (claimAgeMonths >= ageToMonths(55,0));
  const cond3 = (sameUnitMonths >= 25*12);
  const cond4 = (insMonthsAtClaim >= 25*12) && (claimAgeMonths >= ageToMonths(50,0));
  const cond5 = (specialWorkMonths5 >= 5*12) && (claimAgeMonths >= ageToMonths(55,0));

  const eligible = cond1 || cond2 || cond3 || cond4 || cond5;
  return { eligible, reason: eligible ? "ç¬¦åˆä¸€æ¬¡è«‹é ˜æ¢ä»¶ï¼ˆé€²éšï¼‰" : "é€²éšæ¢ä»¶ä¸ç¬¦åˆ â†’ ä¸å¯ä¸€æ¬¡è«‹é ˜" };
}

function badge(b, okTxt="ç¬¦åˆ", noTxt="ä¸ç¬¦åˆ"){
  return b ? `<span class="badge ok">${okTxt}</span>` : `<span class="badge no">${noTxt}</span>`;
}

function toggleAvg36(){
  const block = $("avg36Block");
  if($("pre98").checked) block.classList.remove("hide");
  else block.classList.add("hide");
}

function calcAllBenefits(){
  showWarn(""); showOk(""); hideOutput();

  const today = new Date();

  const birthStr = ($("birthDate").value || "").trim();
  if(!birthStr){ alert("è«‹å¡«å‡ºç”Ÿæ—¥æœŸ"); return; }
  const birthDate = new Date(birthStr + "T00:00:00");
  if(isNaN(birthDate.getTime())){ alert("å‡ºç”Ÿæ—¥æœŸæ ¼å¼ä¸æ­£ç¢º"); return; }

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || claimM>11){ alert("è«‹é ˜å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }
  const claimAgeMonths = ageToMonths(claimY, claimM);

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){ alert("æŠ•ä¿å¹´è³‡éœ€å¤§æ–¼0"); return; }

  const avgSalary60 = money($("avgSalary60").value);
  if(!Number.isFinite(avgSalary60) || avgSalary60<=0){ alert("è«‹å¡«å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆ60æœˆæœ€é«˜å¹³å‡ï¼‰"); return; }

  const pre98 = $("pre98").checked;

  const after60MonthsInputRaw = insToMonths($("insAfter60Years").value, $("insAfter60Months").value, 0);
  const after60MonthsInput = Number.isFinite(after60MonthsInputRaw) ? after60MonthsInputRaw : 0;

  const keepInsuredToClaim = ($("keepInsuredToClaim").value === "yes");
  const claimDate = calcDateAtAge(birthDate, claimAgeMonths);
  const monthsToClaimFromNow = monthsBetween(today, claimDate);
  const insAtClaimMonths = keepInsuredToClaim ? (insNowMonths + monthsToClaimFromNow) : insNowMonths;

  let after60Clamped = after60MonthsInput;
  let warnExtra = "";
  if(after60Clamped > insAtClaimMonths){
    after60Clamped = insAtClaimMonths;
    warnExtra = "ä½ å¡«çš„ã€Œ60æ­²å¾ŒåŠ ä¿å¹´è³‡ã€å¤§æ–¼ç¸½å¹´è³‡ï¼Œå·²è‡ªå‹•èª¿æ•´ç‚ºä¸è¶…éç¸½å¹´è³‡ã€‚";
  }

  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalAgeMonthsNormal = ageToMonths(legal.years, legal.months);

  const specialWork15 = ($("specialWork15").value === "yes");
  const combineNP = ($("combineNP").value === "yes");
  const npMonths = insToMonths($("npYears").value, $("npMonths").value, 0) || 0;

  const eligP = determinePensionEligibility({
    claimAgeMonths,
    legalAgeMonthsNormal,
    specialWork15,
    insMonthsAtClaim: insAtClaimMonths,
    combineNP,
    npMonths
  });

  const adj = adjustFactorByMonth(eligP.legalAgeMonths, claimAgeMonths);
  const diffText = (adj.diffMonths === 0)
    ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0)
      ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆæŒ‰æœˆæ¯”ä¾‹ï¼›ä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼›å°é ‚Â±20%ï¼‰`
      : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆæŒ‰æœˆæ¯”ä¾‹ï¼›ä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼›å°é ‚Â±20%ï¼‰`;

  const insYearsAtClaim = insAtClaimMonths/12;

  const pension = eligP.eligible ? calcPension(avgSalary60, insAtClaimMonths, adj.factor) : null;

  const oldAgeLumpEligible = (insAtClaimMonths < 15*12) && (claimAgeMonths >= eligP.legalAgeMonths);
  const oldAgeLumpReason = !oldAgeLumpEligible
    ? (insAtClaimMonths >= 15*12 ? "å¹´è³‡å·²æ»¿15å¹´ â†’ é€šå¸¸èµ°å¹´é‡‘" : (claimAgeMonths < eligP.legalAgeMonths ? "æœªé”æ³•å®šè«‹é ˜å¹´é½¡" : ""))
    : "";
  const oldAgeLump = oldAgeLumpEligible ? calcOldAgeLump60(avgSalary60, insAtClaimMonths, after60Clamped) : null;

  let oneTime = null;
  let oneTimeElig = { eligible:false, reason:"" };
  let avgSalary36 = NaN;
  let claimBefore60 = false;

  if(pre98){
    avgSalary36 = money($("avgSalary36").value);
    claimBefore60 = ($("claimBefore60").value === "yes");

    const isFemale = ($("isFemale").value === "yes");
    const sameUnitMonths = insToMonths($("sameUnitYears").value, $("sameUnitMonths").value, 0) || 0;
    const specialWorkMonths5 = insToMonths($("specialWorkYears5").value, $("specialWorkMonths5").value, 0) || 0;

    oneTimeElig = determineOneTimeEligibilityConservative({
      pre98,
      claimAgeMonths,
      insMonthsAtClaim: insAtClaimMonths,
      isFemale,
      sameUnitMonths,
      specialWorkMonths5
    });

    if(Number.isFinite(avgSalary36) && avgSalary36>0 && oneTimeElig.eligible){
      oneTime = calcOneTimeLump36(avgSalary36, insAtClaimMonths, after60Clamped, claimBefore60);
    }
  }else{
    oneTimeElig = { eligible:false, reason:"98å¾Œé¦–æ¬¡æŠ•ä¿ â†’ ä¸€æ¬¡è«‹é ˜é€šå¸¸ä¸å¯ç”¨" };
  }

  const out = $("output");
  out.style.display = "block";

  const sysBadge = pre98
    ? `<span class="badge ok">åˆ¶åº¦åˆ¤å®šï¼š98å‰å·²æŠ•ä¿ï¼ˆä½ å‹¾é¸ï¼‰</span>`
    : `<span class="badge ok">åˆ¶åº¦åˆ¤å®šï¼š98å¾Œé¦–æ¬¡æŠ•ä¿ï¼ˆä½ æœªå‹¾é¸ï¼‰</span>`;

  const claimDateStr = `${claimDate.getFullYear()}-${String(claimDate.getMonth()+1).padStart(2,"0")}-${String(claimDate.getDate()).padStart(2,"0")}`;

  const oldLumpBox = `
    <div class="kpi-box">
      <div class="kpi-title">ä¸€æ¬¡çµ¦ä»˜ Aï½œè€å¹´ä¸€æ¬¡é‡‘ï¼ˆ98å¾Œï¼šå¹´è³‡ï¼œ15å¹´ï¼‰</div>
      <div class="kpi-value">${oldAgeLump ? `NT$ ${fmt(oldAgeLump.amount)}` : "â€”"}</div>
      <div class="kpi-sub">
        è³‡æ ¼ï¼š${badge(oldAgeLumpEligible)} ${oldAgeLumpEligible ? "" : `ï¼ˆ${oldAgeLumpReason || "ä¸ç¬¦åˆæ¢ä»¶"}ï¼‰`}<br/>
        å¹³å‡è–ªè³‡ï¼š<span class="mono">avg60</span>ï¼ˆæœ€é«˜60æœˆå¹³å‡ï¼‰ï¼ NT$ ${fmt(Math.round(avgSalary60))}<br/>
        çµ¦ä»˜æœˆæ•¸ï¼š<span class="mono">ï¼ˆ60æ­²å‰å¹´è³‡/12ï¼‰ + ï¼ˆ60æ­²å¾Œä½µè¨ˆå¹´è³‡/12ï¼‰</span><br/>
        60æ­²å¾Œä½µè¨ˆï¼šæœ€å¤š <b>5å¹´ï¼ˆ60æœˆï¼‰</b>ï¼›æœ¬æ¬¡ä½¿ç”¨ <b>${oldAgeLump ? oldAgeLump.after60Used : 0}</b> æœˆ
        ${oldAgeLump ? `<br/>çµ¦ä»˜æœˆæ•¸ï¼ˆæœ¬æ¬¡ï¼‰ï¼š<b>${oldAgeLump.benefitMonths.toFixed(3)}</b>` : ""}
      </div>
    </div>
  `;

  const oneTimeBox = `
    <div class="kpi-box">
      <div class="kpi-title">ä¸€æ¬¡çµ¦ä»˜ Bï½œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆ98å‰å¯èƒ½ï¼‰</div>
      <div class="kpi-value">${oneTime ? `NT$ ${fmt(oneTime.amount)}` : "â€”"}</div>
      <div class="kpi-sub">
        è³‡æ ¼ï¼š${badge(oneTimeElig.eligible)}ï¼ˆ${oneTimeElig.reason || ""}ï¼‰<br/>
        å¹³å‡è–ªè³‡ï¼š<span class="mono">avg36</span>ï¼ˆæœ€è¿‘36æœˆå¹³å‡ï¼‰
        ${pre98 ? (Number.isFinite(avgSalary36) && avgSalary36>0 ? `ï¼ NT$ ${fmt(Math.round(avgSalary36))}` : "ï¼ï¼ˆæœªå¡« â†’ ä¸è¨ˆé‡‘é¡ï¼‰") : "ï¼ï¼ˆ98å¾Œä¸é©ç”¨ï¼‰"}<br/>
        60æ­²å‰çµ¦ä»˜æœˆæ•¸ï¼š<span class="mono">å‰15å¹´æ¯å¹´1æœˆï¼›è¶…é15å¹´æ¯å¹´2æœˆï¼›ä¸Šé™45æœˆ</span><br/>
        60æ­²å¾Œä½µè¨ˆï¼šæœ€å¤š <b>5å¹´ï¼ˆ60æœˆï¼‰</b>ï¼›ä»¥æœˆæ¯”ä¾‹åŠ åˆ°çµ¦ä»˜æœˆæ•¸<br/>
        ç¸½ä¸Šé™ï¼šæœªæ»¿60è«‹é ˜ â†’ <b>45æœˆ</b>ï¼›60æ­²(å«)å¾Œè«‹é ˜ â†’ <b>50æœˆ</b><br/>
        ${oneTime ? `
          æœ¬æ¬¡ï¼š60æ­²å‰çµ¦ä»˜ï¼<b>${oneTime.benefitPre60.toFixed(2)}</b> æœˆï¼Œ
          60æ­²å¾Œä½µè¨ˆï¼<b>${oneTime.benefitAfter60.toFixed(2)}</b> æœˆï¼ˆä½¿ç”¨ ${oneTime.after60Used} æœˆï¼‰<br/>
          çµ¦ä»˜æœˆæ•¸ï¼ˆå°é ‚å¾Œï¼‰ï¼š<b>${oneTime.benefitMonths.toFixed(2)}</b>ï¼ˆä¸Šé™${oneTime.cap}ï¼‰
        ` : ""}
      </div>
    </div>
  `;

  out.innerHTML = `
    <div class="kpi">
      <div class="kpi-box">
        <div class="kpi-title">åˆ¶åº¦åˆ†æµ</div>
        <div class="kpi-value">${sysBadge}</div>
        <div class="kpi-sub">
          å‡ºç”Ÿå¹´æ¬¡ï¼ˆæ°‘åœ‹ï¼‰ï¼š${rocBirthYear}ï½œä¸€èˆ¬æ³•å®šè«‹é ˜ï¼š${legal.years} æ­²<br/>
          æœ¬æ¬¡æ¡ç”¨æ³•å®šè«‹é ˜ï¼š${(eligP.legalAgeMonths/12).toFixed(0)} æ­² ${specialWork15 ? "ï¼ˆç‰¹æ®Šå·¥ä½œ55æ­²ï¼‰" : ""}<br/>
          è«‹é ˜å¹´é½¡ï¼š${claimY} æ­² ${claimM} æœˆï½œè«‹é ˜æ—¥ï¼ˆä¼°ï¼‰ï¼š${claimDateStr}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">å¹´è³‡ï¼ˆè«‹é ˜é»ï¼‰</div>
        <div class="kpi-value">è«‹é ˜æ™‚å¹´è³‡ï¼ˆä¼°ï¼‰ï¼š${insYearsAtClaim.toFixed(2)} å¹´</div>
        <div class="kpi-sub">
          60æ­²å¾ŒåŠ ä¿ï¼ˆä½ è¼¸å…¥ï¼‰ï¼š${(after60Clamped/12).toFixed(2)} å¹´ï¼ˆä½µè¨ˆä¸Šé™5å¹´ï¼‰<br/>
          å¹´é‡‘è³‡æ ¼ï¼š${badge(eligP.eligible)}<br/>
          ä¸€èˆ¬ï¼š${badge(eligP.eligibleGeneral)}ã€€ç‰¹æ®Šï¼š${badge(eligP.eligibleSpecial)}ã€€ä½µè¨ˆåœ‹æ°‘å¹´é‡‘ï¼š${badge(eligP.eligibleCombineNP)}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">è€å¹´å¹´é‡‘ï¼ˆæœˆé ˜ï¼‰</div>
        <div class="kpi-value">${pension ? `ç´„ NT$ ${fmt(pension.finalMonthly)} / æœˆ` : "â€”ï¼ˆæœªç¬¦åˆå¹´é‡‘è³‡æ ¼ï¼‰"}</div>
        <div class="kpi-sub">
          ${pension ? `
            è³‡æ ¼ï¼š${badge(true)}<br/>
            å¹³å‡è–ªè³‡ï¼š<span class="mono">avg60</span>ï¼ NT$ ${fmt(Math.round(avgSalary60))}<br/>
            æ“‡å„ªï¼š${pension.chosen}<br/>
            åŠ æ¸›çµ¦ï¼š${diffText}
          ` : `
            è³‡æ ¼ï¼š${badge(false)}ï¼ˆéœ€é”æ³•å®šå¹´é½¡ä¸”å¹´è³‡æ»¿15å¹´ï¼›æˆ–ç¬¦åˆç‰¹æ®Š/ä½µè¨ˆè·¯å¾‘ï¼‰
          `}
        </div>
      </div>

      ${oldLumpBox}
      ${oneTimeBox}
    </div>

    <details style="margin-top:12px">
      <summary>å±•é–‹ï¼šå®Œæ•´è¨ˆç®—è¡¨ï¼ˆå°ç…§ç”¨ï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td>å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆ60æœˆæœ€é«˜å¹³å‡ï¼‰</td><td>NT$ ${fmt(Math.round(avgSalary60))}</td></tr>
          <tr><td>è«‹é ˜æ™‚å¹´è³‡ï¼ˆä¼°ï¼‰</td><td>${insYearsAtClaim.toFixed(2)} å¹´</td></tr>
          <tr><td>60æ­²å¾ŒåŠ ä¿ï¼ˆä½ è¼¸å…¥ï¼‰</td><td>${(after60Clamped/12).toFixed(2)} å¹´</td></tr>

          ${pension ? `
            <tr><td>å¹´é‡‘å¼1ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base1))}</td></tr>
            <tr><td>å¹´é‡‘å¼2ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base2))}</td></tr>
            <tr><td>æ“‡å„ªåŸºç¤ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.chosenBase))}</td></tr>
            <tr><td>ææ—©/å±•å»¶æœˆæ•¸ï¼ˆæœªå°é ‚ï¼‰</td><td>${adj.diffMonths} æœˆ</td></tr>
            <tr><td>å°é ‚å¾Œæœˆæ•¸ï¼ˆÂ±60æœˆï¼‰</td><td>${adj.cappedMonths} æœˆ</td></tr>
            <tr><td>åŠ æ¸›çµ¦ä¿‚æ•¸ï¼ˆæŒ‰æœˆæ¯”ä¾‹ï¼‰</td><td>Ã— ${adj.factor.toFixed(4)}</td></tr>
          ` : ``}

          <tr><td>è€å¹´ä¸€æ¬¡é‡‘è³‡æ ¼</td><td>${oldAgeLumpEligible ? "ç¬¦åˆ" : "ä¸ç¬¦åˆ"} ${oldAgeLumpReason ? `ï¼ˆ${oldAgeLumpReason}ï¼‰` : ""}</td></tr>
          ${oldAgeLump ? `
            <tr><td>è€å¹´ä¸€æ¬¡é‡‘çµ¦ä»˜æœˆæ•¸</td><td>${oldAgeLump.benefitMonths.toFixed(3)}</td></tr>
            <tr><td>è€å¹´ä¸€æ¬¡é‡‘é‡‘é¡</td><td>NT$ ${fmt(oldAgeLump.amount)}</td></tr>
          ` : ``}

          <tr><td>ä¸€æ¬¡è«‹é ˜ï¼ˆ98å‰ï¼‰</td><td>${pre98 ? "å¯èƒ½ï¼ˆéœ€æ¢ä»¶ï¼‰" : "ä¸é©ç”¨ï¼ˆ98å¾Œï¼‰"}</td></tr>
          <tr><td>ä¸€æ¬¡è«‹é ˜è³‡æ ¼åˆ¤å®š</td><td>${oneTimeElig.eligible ? "ç¬¦åˆ" : "ä¸ç¬¦åˆ"}ï¼ˆ${oneTimeElig.reason}ï¼‰</td></tr>
          ${pre98 ? `
            <tr><td>ä¸€æ¬¡è«‹é ˜å¹³å‡è–ªè³‡ï¼ˆ36æœˆï¼‰</td><td>${Number.isFinite(avgSalary36) && avgSalary36>0 ? `NT$ ${fmt(Math.round(avgSalary36))}` : "æœªå¡«"}</td></tr>
          ` : ``}
          ${oneTime ? `
            <tr><td>ä¸€æ¬¡è«‹é ˜çµ¦ä»˜æœˆæ•¸ï¼ˆå°é ‚å¾Œï¼‰</td><td>${oneTime.benefitMonths.toFixed(2)}ï¼ˆä¸Šé™${oneTime.cap}ï¼‰</td></tr>
            <tr><td>ä¸€æ¬¡è«‹é ˜é‡‘é¡</td><td>NT$ ${fmt(oneTime.amount)}</td></tr>
          ` : ``}
        </table>
        <div class="small">${warnExtra ? "æ³¨æ„ï¼š" + warnExtra : ""}</div>
      </div>
    </details>
  `;

  if(warnExtra) showWarn(warnExtra);

  if(Math.abs(adj.diffMonths) > 60){
    showWarn((warnExtra ? warnExtra + " " : "") + "è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é5å¹´ï¼›å¹´é‡‘åŠ æ¸›çµ¦å·²å°é ‚ï¼ˆÂ±20%ï¼‰ã€‚");
  }else{
    showOk("å·²å®Œæˆï¼šå¹´é‡‘ï¼‹ä¸€æ¬¡é‡‘ï¼‹ä¸€æ¬¡è«‹é ˜ï¼ˆä¸€æ¬¡çµ¦ä»˜å·²åˆ†é–‹æ¸…æ¥šå‘ˆç¾ï¼‰ã€‚");
  }
}

function loadExample(){
  $("birthDate").value = "1980-01-01";
  $("claimYears").value = 65;
  $("claimMonths").value = 0;
  $("insYearsNow").value = 20;
  $("insMonthsNow").value = 0;
  $("insDaysNow").value = 5;
  $("keepInsuredToClaim").value = "yes";
  $("avgSalary60").value = 45800;

  $("pre98").checked = true;
  $("insAfter60Years").value = 2;
  $("insAfter60Months").value = 0;

  $("avgSalary36").value = 45800;
  $("claimBefore60").value = "no";

  $("specialWork15").value = "no";
  $("combineNP").value = "no";
  $("npYears").value = 0; $("npMonths").value = 0;

  $("sameUnitYears").value = 0; $("sameUnitMonths").value = 0;
  $("specialWorkYears5").value = 0; $("specialWorkMonths5").value = 0;
  $("isFemale").value = "no";

  toggleAvg36();
  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼šä¸€æ¬¡çµ¦ä»˜å·²åˆ†é–‹å‘ˆç¾ï¼ˆè€å¹´ä¸€æ¬¡é‡‘ vs ä¸€æ¬¡è«‹é ˜ï¼‰ï¼Œä¸¦ç´å…¥60æ­²å¾ŒåŠ ä¿ä½µè¨ˆä¸Šé™ã€‚");
  showWarn("");
  hideOutput();
}

(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  [
    "birthDate","claimYears","claimMonths",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsuredToClaim",
    "avgSalary60",
    "pre98","insAfter60Years","insAfter60Months",
    "avgSalary36","claimBefore60",
    "specialWork15","combineNP","npYears","npMonths",
    "sameUnitYears","sameUnitMonths","specialWorkYears5","specialWorkMonths5","isFemale"
  ].forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener("input", hideOutput);
    el.addEventListener("change", hideOutput);
  });

  $("pre98").addEventListener("change", () => { toggleAvg36(); hideOutput(); });

  toggleAvg36();
})();
</script>
</body>
</html>
