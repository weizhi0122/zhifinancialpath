<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>勞保老年給付試算（98前/後制度分流）</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300; --goodbg:#ecfdf3; --good:#027a48;
    --shadow:0 6px 16px rgba(0,0,0,.05);
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text);line-height:1.55}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:10px 18px;position:sticky;top:0;z-index:10}
  .topbar-inner{max-width:980px;margin:auto;display:flex;justify-content:space-between;align-items:center}
  .container{max-width:980px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:24px}
  .sub{color:var(--muted);font-size:13.5px;margin-top:6px}
  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow)}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a;font-weight:800}
  input,select,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  input:focus,select:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1;min-width:170px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:900}
  button.ghost{background:#fff;color:var(--primary);border:1px solid #cfe0ff}
  button:hover{opacity:.92}
  .small{font-size:12.5px;color:var(--muted);line-height:1.55;margin-top:8px}
  .warn,.ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.45}
  .warn{background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5}
  .ok{background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc}
  .result{display:none;margin-top:14px}
  .kpi{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:860px){ .kpi{grid-template-columns:1fr 1fr} }
  .kpi-box{border:1px solid #dbe7ff;background:var(--soft);border-radius:12px;padding:12px}
  .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi-value{font-size:20px;font-weight:900;color:var(--primary)}
  .kpi-sub{font-size:12.5px;color:var(--muted);margin-top:6px;line-height:1.55}
  details{margin-top:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  summary{cursor:pointer;padding:12px 12px;font-weight:900;color:#0f172a}
  details .inner{padding:0 12px 12px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table td:last-child{text-align:right}
  .badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#334155}
  .badge.ok{border-color:#b7f0cc;background:#ecfdf3;color:#027a48}
  .badge.no{border-color:#ffd6d6;background:#fff4f4;color:#b42318}
  .chkline{display:flex;align-items:flex-start;gap:10px;margin-top:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .chkline input{width:auto;margin-top:3px}
  .chktext{display:flex;flex-direction:column;gap:2px}
  .chktext .t{font-weight:900;color:#0f172a}
  .chktext .d{font-size:12.5px;color:var(--muted);line-height:1.45}
  .hide{display:none}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div style="font-weight:900;color:#0f172a">勞保老年給付試算</div>
      <div class="small">依 98 前/後制度分流計算（checkbox）</div>
    </div>
  </div>

  <div class="container">
    <h1>勞保老年給付試算 <span class="badge">98 前/後制度分流</span></h1>
    <div class="sub">
      不管你是 98 前或 98 後開始投保，都會依制度顯示：年金 / 老年一次金 /（可能的）一次請領。
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:16px;color:#0f172a">輸入（盡量簡單）</h2>

      <div class="row">
        <div>
          <label>出生日期</label>
          <input id="birthDate" type="date" />
        </div>
        <div>
          <label>請領年齡</label>
          <div class="row">
            <div><input id="claimYears" type="number" min="0" step="1" value="65" /><div class="small">歲</div></div>
            <div><input id="claimMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">月</div></div>
          </div>
        </div>
      </div>

      <label>目前投保年資（未滿30日以1個月計）</label>
      <div class="row">
        <div><input id="insYearsNow" type="number" min="0" step="1" value="30" /><div class="small">年</div></div>
        <div><input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" /><div class="small">月</div></div>
        <div><input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" /><div class="small">天（>0 視為 +1月）</div></div>
      </div>

      <div class="row">
        <div>
          <label>到請領年齡是否持續投保？</label>
          <select id="keepInsuredToClaim">
            <option value="yes" selected>是（年資會累積到請領點）</option>
            <option value="no">否（年資以目前為準）</option>
          </select>
          <div class="small">年資以「請領點」認定，會影響是否滿15年與金額。</div>
        </div>
        <div>
          <label>平均月投保薪資（最高60個月平均）</label>
          <input id="avgSalary60" type="number" min="0" step="100" placeholder="例：45800" />
          <div class="small">年金、老年一次金都用這個（60月最高平均）。</div>
        </div>
      </div>

      <!-- ✅ 你指定：勾了就是98前；沒勾就是98後 -->
      <div class="chkline">
        <input id="pre98" type="checkbox" />
        <div class="chktext">
          <div class="t">98/01/01 前已經有勞保年資（勾選代表「有」）</div>
          <div class="d">不勾＝視為 98/01/01 後才首次投保。系統會依制度自動算出可用的給付。</div>
        </div>
      </div>

      <!-- 只有勾98前才需要 36月平均（一次請領用） -->
      <div id="avg36Block" class="row hide">
        <div>
          <label>（僅98前一次請領用）平均月投保薪資（最近36個月平均）</label>
          <input id="avgSalary36" type="number" min="0" step="100" placeholder="例：45800" />
          <div class="small">若你只想看年金/老年一次金，可不填（則一次請領不計）。</div>
        </div>
        <div>
          <label>（僅98前一次請領用）是否未滿60歲就請領？</label>
          <select id="claimBefore60">
            <option value="no" selected>否（60歲或之後）</option>
            <option value="yes">是（未滿60歲）</option>
          </select>
          <div class="small">影響一次請領上限：未滿60歲以45月為主。</div>
        </div>
      </div>

      <details>
        <summary>進階（可選）：特殊工作55歲 / 併計國民年金 / 一次請領條件（不填也能算）</summary>
        <div class="inner">
          <div class="row">
            <div>
              <label>特殊性質工作且勞保年資滿15年？（55歲可領年金）</label>
              <select id="specialWork15">
                <option value="no" selected>否</option>
                <option value="yes">是</option>
              </select>
            </div>
            <div>
              <label>勞保未滿15年：是否併計國民年金滿15年（65歲可選領勞保年金）？</label>
              <select id="combineNP">
                <option value="no" selected>否</option>
                <option value="yes">是</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>國民年金年資（併計用）</label>
              <div class="row">
                <div><input id="npYears" type="number" min="0" step="1" value="0" /><div class="small">年</div></div>
                <div><input id="npMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">月</div></div>
              </div>
            </div>
            <div>
              <label>（一次請領）同一投保單位年資（不確定可填0）</label>
              <div class="row">
                <div><input id="sameUnitYears" type="number" min="0" step="1" value="0" /><div class="small">年</div></div>
                <div><input id="sameUnitMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">月</div></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>（一次請領）特殊工作年資（滿5年且55歲退職者條件之一）</label>
              <div class="row">
                <div><input id="specialWorkYears5" type="number" min="0" step="1" value="0" /><div class="small">年</div></div>
                <div><input id="specialWorkMonths5" type="number" min="0" max="11" step="1" value="0" /><div class="small">月</div></div>
              </div>
            </div>
            <div>
              <label>女性被保險人（一次請領條件之一含女55歲）</label>
              <select id="isFemale">
                <option value="no" selected>否</option>
                <option value="yes">是</option>
              </select>
            </div>
          </div>

          <div class="small">
            進階條件若都不填，本工具對「一次請領」會採保守判斷（避免誤判）。
          </div>
        </div>
      </details>

      <div class="btnrow">
        <button onclick="calcAllBenefits()">計算（依98前/後制度分流）</button>
        <button class="ghost" onclick="loadExample()">帶入範例</button>
      </div>

      <div id="warnBox" class="warn"></div>
      <div id="okBox" class="ok"></div>

      <div id="output" class="result"></div>

      <div class="small">
        ※ 教育用途：實際核付以勞保局為準。本工具以常見公開規則建模：年金兩式擇優＋提早/展延按月計（±20%封頂），並依98前/後分流判斷可用給付。
      </div>
    </div>
  </div>

<script>
/* ===================== 制度核心（分流） =====================
A) 年金（老年年金給付）：兩式擇優
   (1) 平均月投保薪資 × 年資 × 0.775% + 3000
   (2) 平均月投保薪資 × 年資 × 1.55%
   提早/展延：每年±4%，按月比例，封頂±20%（±60月）

B) 98後（未勾 pre98）：年資>=15 → 年金；年資<15 → 老年一次金
   老年一次金：平均月投保薪資(60月最高平均) × 給付月數
   給付月數：每滿1年=1月；未滿1年按月比例

C) 98前（勾 pre98）：仍可能存在「一次請領老年給付」的選項（需符合條件）
   一次請領（簡化計算模型）：
   平均月投保薪資(最近36月平均) × 給付月數
   給付月數：每滿1年1月；超過15年部分每滿1年2月；上限45月
             若60歲後年資最多5年，合併上限50月（本頁用輸入的年資粗估，不另拆實際60後明細）
============================================================ */

const RULES = {
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  }
};

function $(id){ return document.getElementById(id); }
function fmt(n){ return Number(n).toLocaleString("en-US"); }
function money(v){
  const n = Number(String(v||"").replace(/[,，\s]/g,""));
  return Number.isFinite(n) ? n : NaN;
}
function clampInt(v){
  if(!Number.isFinite(v)) return NaN;
  return Math.max(0, Math.floor(v));
}
function showWarn(msg){
  const w=$("warnBox");
  if(!msg){ w.style.display="none"; w.textContent=""; return; }
  w.style.display="block"; w.textContent=msg;
}
function showOk(msg){
  const o=$("okBox");
  if(!msg){ o.style.display="none"; o.textContent=""; return; }
  o.style.display="block"; o.textContent=msg;
}
function hideOutput(){
  $("output").style.display="none";
  $("output").innerHTML="";
}

function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }

function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}

function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}

function monthsBetween(today, future){
  let m = (future.getFullYear()-today.getFullYear())*12 + (future.getMonth()-today.getMonth());
  if (future.getDate() < today.getDate()) m -= 1;
  return Math.max(0, m);
}

// 提早/展延：按月4%/年 + 封頂±60月(±20%)
function adjustFactorByMonth(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths;
  const cappedMonths = Math.max(-60, Math.min(60, diffMonths));
  const factor = 1 + cappedMonths * (0.04/12);
  return { factor, diffMonths, cappedMonths };
}

// 年金：兩式擇優
function calcPension(avgSalary60, insMonths, factor){
  const insYears = insMonths / 12;
  const base1 = avgSalary60 * insYears * 0.00775 + 3000;
  const base2 = avgSalary60 * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2) ? "式1（0.775%×年資 + 3000）" : "式2（1.55%×年資）";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly };
}

// 老年一次金（98後）：60月平均 × 年資（1倍，月比例）
function calcOldAgeLump60(avgSalary60, insMonths){
  const benefitMonths = insMonths / 12; // 月比例
  const amount = Math.round(avgSalary60 * benefitMonths);
  return { benefitMonths, amount };
}

// 一次請領（98前）：36月平均 × (1倍+2倍，上限45；滿60後可到50：這裡用簡化上限處理)
function calcOneTimeLump36(avgSalary36, insMonths, claimBefore60){
  const years = insMonths / 12;
  const y1 = Math.min(15, years);
  const y2 = Math.max(0, years - 15);
  const benefitPreCap = y1*1 + y2*2;

  const cap = claimBefore60 ? 45 : 50; // 簡化：>=60歲上限可到50（實務還牽涉60後年資拆分）
  const benefitMonths = Math.min(benefitPreCap, cap);
  const amount = Math.round(avgSalary36 * benefitMonths);
  return { benefitMonths, amount, cap };
}

// 年金資格（一般/特殊/併計）
function determinePensionEligibility({
  claimAgeMonths,
  legalAgeMonthsNormal,
  specialWork15,
  insMonthsAtClaim,
  combineNP,
  npMonths
}){
  const legalAgeMonths = specialWork15 ? ageToMonths(55,0) : legalAgeMonthsNormal;

  const eligibleGeneral = (claimAgeMonths >= legalAgeMonthsNormal) && (insMonthsAtClaim >= 15*12);
  const eligibleSpecial = (specialWork15) && (claimAgeMonths >= ageToMonths(55,0)) && (insMonthsAtClaim >= 15*12);

  const eligibleCombineNP =
    (combineNP) &&
    (insMonthsAtClaim < 15*12) &&
    ((insMonthsAtClaim + npMonths) >= 15*12) &&
    (claimAgeMonths >= ageToMonths(65,0));

  const eligible = eligibleGeneral || eligibleSpecial || eligibleCombineNP;

  return { legalAgeMonths, eligible, eligibleGeneral, eligibleSpecial, eligibleCombineNP };
}

// 一次請領資格（保守版：只有98前才可能；條件用進階輸入判斷，若都沒填則保守視為不確定→不算）
function determineOneTimeEligibilityConservative({
  pre98,
  claimAgeMonths,
  insMonthsAtClaim,
  isFemale,
  sameUnitMonths,
  specialWorkMonths5
}){
  if(!pre98) return { eligible:false, reason:"98後不適用" };

  // 若使用者完全沒填進階條件，就保守不算（避免誤判）
  const anyAdvanced =
    (isFemale === true) ||
    (sameUnitMonths > 0) ||
    (specialWorkMonths5 > 0);

  if(!anyAdvanced){
    return { eligible:false, reason:"未提供一次請領條件（保守不判定）" };
  }

  // 簡化五擇一（同你先前旗艦版的條件骨架）
  const cond1 = (insMonthsAtClaim >= 12) && (claimAgeMonths >= ageToMonths(60,0) || (isFemale && claimAgeMonths >= ageToMonths(55,0)));
  const cond2 = (insMonthsAtClaim >= 15*12) && (claimAgeMonths >= ageToMonths(55,0));
  const cond3 = (sameUnitMonths >= 25*12);
  const cond4 = (insMonthsAtClaim >= 25*12) && (claimAgeMonths >= ageToMonths(50,0));
  const cond5 = (specialWorkMonths5 >= 5*12) && (claimAgeMonths >= ageToMonths(55,0));

  const eligible = cond1 || cond2 || cond3 || cond4 || cond5;
  return { eligible, reason: eligible ? "符合一次請領條件（進階）" : "進階條件不符合" };
}

function badge(b, okTxt="符合", noTxt="不符合"){
  return b ? `<span class="badge ok">${okTxt}</span>` : `<span class="badge no">${noTxt}</span>`;
}

function calcAllBenefits(){
  showWarn(""); showOk(""); hideOutput();

  const today = new Date();

  const birthStr = ($("birthDate").value || "").trim();
  if(!birthStr){ alert("請填出生日期"); return; }
  const birthDate = new Date(birthStr + "T00:00:00");
  if(isNaN(birthDate.getTime())){ alert("出生日期格式不正確"); return; }

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || claimM>11){ alert("請領年齡輸入錯誤"); return; }
  const claimAgeMonths = ageToMonths(claimY, claimM);

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){ alert("投保年資需大於0"); return; }

  const avgSalary60 = money($("avgSalary60").value);
  if(!Number.isFinite(avgSalary60) || avgSalary60<=0){ alert("請填平均月投保薪資（60月最高平均）"); return; }

  const pre98 = $("pre98").checked; // ✅ 你要的：勾了就是98前，沒勾就是98後

  const keepInsuredToClaim = ($("keepInsuredToClaim").value === "yes");
  const claimDate = calcDateAtAge(birthDate, claimAgeMonths);
  const monthsToClaimFromNow = monthsBetween(today, claimDate);
  const insAtClaimMonths = keepInsuredToClaim ? (insNowMonths + monthsToClaimFromNow) : insNowMonths;

  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalAgeMonthsNormal = ageToMonths(legal.years, legal.months);

  // 進階：年金資格路徑
  const specialWork15 = ($("specialWork15").value === "yes");
  const combineNP = ($("combineNP").value === "yes");
  const npMonths = insToMonths($("npYears").value, $("npMonths").value, 0) || 0;

  const eligP = determinePensionEligibility({
    claimAgeMonths,
    legalAgeMonthsNormal,
    specialWork15,
    insMonthsAtClaim: insAtClaimMonths,
    combineNP,
    npMonths
  });

  // 年金加減給
  const adj = adjustFactorByMonth(eligP.legalAgeMonths, claimAgeMonths);
  const diffText = (adj.diffMonths === 0)
    ? "依法定年齡請領（不加減給）"
    : (adj.diffMonths > 0)
      ? `展延 ${Math.abs(adj.diffMonths)} 個月（按月計；係數×${adj.factor.toFixed(3)}；封頂±20%）`
      : `提早 ${Math.abs(adj.diffMonths)} 個月（按月計；係數×${adj.factor.toFixed(3)}；封頂±20%）`;

  // 依98前/後分流，決定「制度結果」要算哪些
  const insYearsAtClaim = insAtClaimMonths/12;

  // 年金：若符合資格則算
  const pension = eligP.eligible ? calcPension(avgSalary60, insAtClaimMonths, adj.factor) : null;

  // 98後：未滿15年 → 老年一次金（這裡也提供顯示；98前則視為可能還有一次請領，兩者都列出供比較）
  const oldAgeLump = (insAtClaimMonths < 15*12) ? calcOldAgeLump60(avgSalary60, insAtClaimMonths) : null;

  // 98前：可能一次請領（需要36月平均 + 進階條件才「判定」）
  let oneTime = null;
  let oneTimeElig = { eligible:false, reason:"" };

  if(pre98){
    const avgSalary36 = money($("avgSalary36").value);
    const claimBefore60 = ($("claimBefore60").value === "yes");

    const isFemale = ($("isFemale").value === "yes");
    const sameUnitMonths = insToMonths($("sameUnitYears").value, $("sameUnitMonths").value, 0) || 0;
    const specialWorkMonths5 = insToMonths($("specialWorkYears5").value, $("specialWorkMonths5").value, 0) || 0;

    oneTimeElig = determineOneTimeEligibilityConservative({
      pre98,
      claimAgeMonths,
      insMonthsAtClaim: insAtClaimMonths,
      isFemale,
      sameUnitMonths,
      specialWorkMonths5
    });

    if(Number.isFinite(avgSalary36) && avgSalary36>0 && oneTimeElig.eligible){
      oneTime = calcOneTimeLump36(avgSalary36, insAtClaimMonths, claimBefore60);
    }
  }

  const out = $("output");
  out.style.display = "block";

  const sysBadge = pre98
    ? `<span class="badge ok">制度判定：98前已投保（你勾選）</span>`
    : `<span class="badge ok">制度判定：98後首次投保（你未勾選）</span>`;

  // 結果區：把「依制度可用的」都清楚列出
  out.innerHTML = `
    <div class="kpi">
      <div class="kpi-box">
        <div class="kpi-title">制度分流</div>
        <div class="kpi-value">${sysBadge}</div>
        <div class="kpi-sub">
          出生年次（民國）：${rocBirthYear}｜一般法定請領：${legal.years} 歲<br/>
          本次採用法定請領：${(eligP.legalAgeMonths/12).toFixed(0)} 歲 ${specialWork15 ? "（特殊工作55歲）" : ""}<br/>
          請領年齡：${claimY} 歲 ${claimM} 月｜請領日（估）：${claimDate.getFullYear()}-${String(claimDate.getMonth()+1).padStart(2,"0")}-${String(claimDate.getDate()).padStart(2,"0")}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">年資與資格（請領點）</div>
        <div class="kpi-value">請領時年資（估）：${insYearsAtClaim.toFixed(2)} 年</div>
        <div class="kpi-sub">
          年金資格：${badge(eligP.eligible)}<br/>
          一般路徑：${badge(eligP.eligibleGeneral)}　特殊工作：${badge(eligP.eligibleSpecial)}　併計國民年金：${badge(eligP.eligibleCombineNP)}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">老年年金（月領）</div>
        <div class="kpi-value">${pension ? `約 NT$ ${fmt(pension.finalMonthly)} / 月` : "—（未符合年金資格）"}</div>
        <div class="kpi-sub">
          ${pension ? `採用：${pension.chosen}<br/>${diffText}` : "需達法定請領年齡且勞保年資滿15年（或符合特殊/併計路徑）。"}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">一次給付（依制度顯示）</div>
        <div class="kpi-sub">
          ${(!pre98) ? `
            <div style="margin-bottom:6px"><b>98後</b>（你未勾）：未滿15年 → 老年一次金</div>
          ` : `
            <div style="margin-bottom:6px"><b>98前</b>（你勾選）：可能有一次請領（需條件），同時也列出老年一次金供參考</div>
          `}
          老年一次金：<b>${oldAgeLump ? `NT$ ${fmt(oldAgeLump.amount)}` : "—（年資已滿15年通常走年金）"}</b>
          ${oldAgeLump ? `<br/><span class="small">給付月數：${oldAgeLump.benefitMonths.toFixed(3)}（年資月比例）</span>` : ``}
          ${pre98 ? `
            <hr style="border:0;border-top:1px dashed #dbe2f0;margin:10px 0">
            一次請領老年給付（98前可能）：<b>${oneTime ? `NT$ ${fmt(oneTime.amount)}` : "—（未判定符合或未填36月平均）"}</b><br/>
            <span class="small">判定：${oneTimeElig.eligible ? "符合（進階條件）" : "未判定符合（保守）"}｜${oneTimeElig.reason}</span>
          ` : ``}
        </div>
      </div>
    </div>

    <details style="margin-top:12px">
      <summary>展開：計算細節（年金/一次金/一次請領）</summary>
      <div class="inner">
        <table class="table">
          <tr><td>平均月投保薪資（60月最高平均）</td><td>NT$ ${fmt(Math.round(avgSalary60))}</td></tr>
          <tr><td>請領時年資（估）</td><td>${insYearsAtClaim.toFixed(2)} 年</td></tr>
          ${pension ? `
            <tr><td>年金式1（未加減給）</td><td>NT$ ${fmt(Math.round(pension.base1))}</td></tr>
            <tr><td>年金式2（未加減給）</td><td>NT$ ${fmt(Math.round(pension.base2))}</td></tr>
            <tr><td>擇優基礎（未加減給）</td><td>NT$ ${fmt(Math.round(pension.chosenBase))}</td></tr>
            <tr><td>提早/展延月數（未封頂）</td><td>${adj.diffMonths} 月</td></tr>
            <tr><td>封頂後月數（±60月）</td><td>${adj.cappedMonths} 月</td></tr>
            <tr><td>加減給係數（按月4%/年）</td><td>× ${adj.factor.toFixed(4)}</td></tr>
          ` : ``}
          ${oldAgeLump ? `
            <tr><td>老年一次金：給付月數</td><td>${oldAgeLump.benefitMonths.toFixed(3)}</td></tr>
          ` : ``}
          ${pre98 ? `
            <tr><td>98前勾選</td><td>是</td></tr>
            <tr><td>一次請領判定</td><td>${oneTimeElig.eligible ? "符合" : "未判定符合（保守）"}｜${oneTimeElig.reason}</td></tr>
            ${oneTime ? `
              <tr><td>一次請領：給付月數（上限${oneTime.cap}）</td><td>${oneTime.benefitMonths.toFixed(2)}</td></tr>
            ` : ``}
          ` : `
            <tr><td>98前勾選</td><td>否（視為98後）</td></tr>
          `}
        </table>
        <div class="small muted">
          提醒：一次請領老年給付是否可選與核付結果，仍以實際個案與勞保局認定為準；本工具採「保守判定」避免誤判。
        </div>
      </div>
    </details>
  `;

  if(Math.abs(adj.diffMonths) > 60){
    showWarn("請領年齡與法定年齡相差超過5年；年金加減給已依規則封頂（±20%）。");
  }else{
    showOk("已依你勾選的98前/後分流，完成制度計算：年金/一次金/（可能）一次請領。");
  }
}

function loadExample(){
  $("birthDate").value = "1980-01-01";
  $("claimYears").value = 65;
  $("claimMonths").value = 0;
  $("insYearsNow").value = 12;
  $("insMonthsNow").value = 0;
  $("insDaysNow").value = 5;
  $("keepInsuredToClaim").value = "yes";
  $("avgSalary60").value = 45800;

  $("pre98").checked = true; // 範例：98前
  $("avgSalary36").value = 45800;
  $("claimBefore60").value = "no";

  $("specialWork15").value = "no";
  $("combineNP").value = "no";
  $("npYears").value = 0; $("npMonths").value = 0;

  $("sameUnitYears").value = 0; $("sameUnitMonths").value = 0;
  $("specialWorkYears5").value = 0; $("specialWorkMonths5").value = 0;
  $("isFemale").value = "no";

  toggleAvg36();
  showOk("已帶入範例：勾98前，並填36月平均（一次請領才會計）。");
  showWarn("");
  hideOutput();
}

function toggleAvg36(){
  const block = $("avg36Block");
  if($("pre98").checked) block.classList.remove("hide");
  else block.classList.add("hide");
}

(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  [
    "birthDate","claimYears","claimMonths",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsuredToClaim",
    "avgSalary60",
    "pre98","avgSalary36","claimBefore60",
    "specialWork15","combineNP","npYears","npMonths",
    "sameUnitYears","sameUnitMonths","specialWorkYears5","specialWorkMonths5","isFemale"
  ].forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener("input", hideOutput);
    el.addEventListener("change", hideOutput);
  });

  $("pre98").addEventListener("change", () => { toggleAvg36(); hideOutput(); });

  toggleAvg36();
})();
</script>
</body>
</html>
