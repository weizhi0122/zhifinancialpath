<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é€€ä¼‘ç¼ºå£å·¥å…·ï¼ˆåˆ¶åº¦æ ¡æ­£ï¼‹è³‡ç”¢æ¨¡æ“¬ï½œç²¾ç°¡ç‰ˆï¼‰ï½œæ™º Financial Path</title>
<meta name="description" content="å‹ä¿åˆ¶åº¦æ ¡æ­£ï¼ˆè«‹é ˜é»èªå®šï¼‰ï¼‹é€€ä¼‘ç¼ºå£è³‡ç”¢æ¨¡æ“¬ï¼‹å¹´é‡‘vsä¸€æ¬¡é‡‘æ¯”è¼ƒï¼‹å®‰å…¨é‚Šéš›å£“åŠ›æ¸¬è©¦ï¼ˆç²¾ç°¡å¥½å¡«ç‰ˆï¼‰ã€‚" />

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300;
    --goodbg:#ecfdf3; --good:#027a48;
    --shadow:0 6px 16px rgba(0,0,0,.06);
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text);line-height:1.6}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:10px 18px;position:sticky;top:0;z-index:10}
  .topbar-inner{max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left-nav{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .container{max-width:1100px;margin:auto;padding:18px}
  h1{margin:4px 0 10px;color:var(--primary);font-size:24px}
  .sub{color:var(--muted);font-size:13.5px;margin:6px 0 14px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:1020px){ .grid{grid-template-columns:1.15fr 0.85fr} }
  .card{background:var(--card);padding:16px;border-radius:14px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0f172a}
  .hr{border:0;border-top:1px solid var(--line);margin:14px 0}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a}
  input,select,textarea,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  textarea{min-height:92px;resize:vertical;line-height:1.35}
  input:focus,select:focus,textarea:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1;min-width:160px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:900}
  button.secondary{background:#334155}
  button.ghost{background:#fff;color:var(--primary);border:1px solid #cfe0ff}
  button:hover{opacity:.92}
  .warn,.ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.45}
  .warn{background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5}
  .ok{background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc}
  .small{font-size:12.8px;color:var(--muted);line-height:1.55;margin-top:10px}
  .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:var(--primary);border:1px solid #dbe7ff}
  .result{display:none}
  .kpi{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  @media (min-width:980px){ .kpi{grid-template-columns:1fr 1fr} }
  .kpi-box{border:1px solid #dbe7ff;background:var(--soft);border-radius:12px;padding:12px}
  .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi-value{font-size:18px;font-weight:900;color:var(--primary)}
  .kpi-sub{font-size:12.8px;color:var(--muted);margin-top:6px;line-height:1.55}
  details{margin-top:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  summary{cursor:pointer;padding:12px 12px;font-weight:900;color:#0f172a}
  details .inner{padding:0 12px 12px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table td:last-child{text-align:right}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#334155}
  .badge.ok{border-color:#b7f0cc;background:#ecfdf3;color:#027a48}
  .badge.no{border-color:#ffd6d6;background:#fff4f4;color:#b42318}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¼ºå£å·¥å…· <span class="chip">åˆ¶åº¦æ ¡æ­£ï¼ˆè«‹é ˜é»ï¼‰ï¼‹è³‡ç”¢æ¨¡æ“¬ï¼ˆç²¾ç°¡å¥½å¡«ï¼‰</span></h1>
    <div class="sub">
      é€™ç‰ˆåˆ»æ„ã€Œä¸è¤‡é›œã€ï¼šé è¨­åªç®— <b>å¹´é‡‘ vs è€å¹´ä¸€æ¬¡é‡‘</b>ï¼›ã€Œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ã€æ”¾åœ¨é€²éšæŠ˜ç–Šå€ï¼Œæƒ³ç®—å†é–‹ã€‚
    </div>

    <div class="grid">
      <!-- LEFT INPUT -->
      <div class="card">
        <h2>Step 1ï½œä¸‰å€‹é—œéµæ¬„ä½ï¼ˆå°±èƒ½ç®—ï¼‰</h2>

        <div class="row">
          <div>
            <label>å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆè¥¿å…ƒï¼‰</label>
            <input id="birthDate" type="date" />
          </div>
          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <div class="row">
              <div><input id="retireYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="retireMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
          <div>
            <label>é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆå¹´é‡‘/ä¸€æ¬¡é‡‘çš„èµ·ç®—é»ï¼‰</label>
            <div class="row">
              <div><input id="claimYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="claimMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
            <div class="small">é‡é»ï¼šåˆ¶åº¦/é‡‘é¡éƒ½ä»¥ã€Œè«‹é ˜å¹´é½¡ã€èªå®šï¼ˆä¸æ˜¯é€€ä¼‘å¹´é½¡ï¼‰ã€‚</div>
          </div>
        </div>

        <label>ç›®å‰å‹ä¿å¹´è³‡ï¼ˆæœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
        <div class="row">
          <div><input id="insYearsNow" type="number" min="0" step="1" value="30" /><div class="small">å¹´</div></div>
          <div><input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
          <div><input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" /><div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div></div>
        </div>

        <div class="row">
          <div>
            <label>åˆ°è«‹é ˜å‰æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
            <select id="keepInsured">
              <option value="yes" selected>æ˜¯ï¼šä¸€ç›´æŠ•ä¿åˆ°è«‹é ˜</option>
              <option value="no">å¦ï¼šç”¨ç›®å‰å¹´è³‡ï¼ˆä¸å†å¢åŠ ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é è¨ˆå£½å‘½ï¼ˆç”¨ä¾†çœ‹æ’ä¸æ’å¾—ä½ï¼‰</label>
            <input id="lifeExpectancy" type="number" min="1" step="1" value="90" />
          </div>
        </div>

        <hr class="hr" />

        <h2>Step 2ï½œå¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆç°¡åŒ–ï¼‰</h2>
        <div class="small">
          ç²¾ç°¡ç‰ˆé è¨­ä½ åªå¡«ä¸€å€‹æ•¸å­—ï¼ˆå¤§å¤šæ•¸äººç”¨å¾—åˆ°ï¼‰ã€‚<br/>
          è‹¥ä½ æƒ³æ›´æº–ï¼šå¯åœ¨ä¸‹æ–¹è²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼Œç³»çµ±æœƒè‡ªå‹•ç®—ã€Œæœ€é«˜60æœˆå¹³å‡ã€èˆ‡ã€Œæœ€å¾Œ36æœˆå¹³å‡ã€ã€‚
        </div>

        <div class="row">
          <div>
            <label>å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆä¸è²¼æ˜ç´°æ™‚ç”¨ï¼›å»ºè­°å¡«ä½ å¸¸è¦‹çš„é‚£å€‹ç´šè·ï¼‰</label>
            <input id="avgSalarySimple" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
          <div>
            <label>é¦–æ¬¡æŠ•ä¿æ—¥æœŸï¼ˆç”¨ä¾†åˆ¤æ–·æ˜¯å¦ 98/01/01 å‰å·²æœ‰å¹´è³‡ï¼‰</label>
            <input id="firstInsuredDate" type="date" />
            <div class="small">ä¸ç¢ºå®šå¯ç•™ç©ºâ†’ç³»çµ±æœƒä¿å®ˆè¦–ç‚ºã€Œ98å¾Œã€é¿å…èª¤åˆ¤ä¸€æ¬¡è«‹é ˜ã€‚</div>
          </div>
        </div>

        <details>
          <summary>é€²éšï¼ˆå¯ä¸å¡«ï¼‰ï½œè²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼šè‡ªå‹•ç®— 60æœˆæœ€é«˜å¹³å‡ï¼‹36æœˆæœ€å¾Œå¹³å‡</summary>
          <div class="inner">
            <div class="small">
              æ ¼å¼ï¼š<span class="mono">YYYY-MM é‡‘é¡</span>ï¼ˆæ¨è–¦ï¼‰æˆ–åªè²¼é‡‘é¡ï¼ˆéœ€ä¾æ™‚é–“é †åºï¼‰ã€‚<br/>
              å¹´é‡‘/ä¸€æ¬¡é‡‘å–<strong>æœ€é«˜60ç­†</strong>ï¼›ä¸€æ¬¡è«‹é ˜å–<strong>æœ€å¾Œ36ç­†</strong>ã€‚
            </div>
            <label>æŠ•ä¿è–ªè³‡æ˜ç´°</label>
            <textarea id="salaryLines" placeholder="ä¾‹ï¼š
2024-01 45800
2024-02 45800
..."></textarea>
          </div>
        </details>

        <hr class="hr" />

        <h2>Step 3ï½œé€€ä¼‘ç¼ºå£æ¨¡æ“¬ï¼ˆç²¾ç°¡ç‰ˆï¼šå°‘å¡«ä¹Ÿèƒ½è·‘ï¼‰</h2>

        <div class="row">
          <div>
            <label>ç›®å‰å¯æŠ•è³‡è³‡ç”¢ï¼ˆæœ¬é‡‘ï¼‰</label>
            <input id="assetNow" type="number" min="0" step="10000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆæŠ•å…¥ï¼ˆå­˜/æŠ•è³‡ï¼‰</label>
            <input id="contribMonthly" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–å ±é…¬ç‡ï¼ˆ%ï¼‰</label>
            <input id="returnPre" type="number" step="0.1" value="3.0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–å ±é…¬ç‡ï¼ˆ%ï¼‰</label>
            <input id="returnPost" type="number" step="0.1" value="2.0" />
          </div>
          <div>
            <label>é æœŸé€šè†¨ï¼ˆå¹´%ï¼‰</label>
            <input id="inflation" type="number" step="0.1" value="2.0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç”Ÿæ´»è²»ï¼ˆä»¥ä»Šå¤©åƒ¹å€¼ï¼‰</label>
            <input id="needMonthlyToday" type="number" min="0" step="1000" value="80000" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå…¶ä»–æ¯æœˆæ”¶å…¥ï¼ˆä¸å«å‹ä¿ï¼›ä¾‹ï¼šå…¼è·/å¹´é‡‘/è£œåŠ©ï¼‰</label>
            <input id="otherIncomeMonthly" type="number" min="0" step="1000" value="0" />
          </div>
          <div>
            <label>æˆ¿ç§Ÿæ”¶å…¥ï¼ˆæ¯æœˆå›ºå®šï¼›é¸å¡«ï¼‰</label>
            <input id="rentMonthly" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <details>
          <summary>é€²éšï¼ˆå¯ä¸å¡«ï¼‰ï½œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜è©¦ç®—ï¼ˆ98å‰æ‰å¯èƒ½ï¼‰</summary>
          <div class="inner">
            <div class="small">
              é€™æ˜¯ã€Œä½ æœ‰ 98/01/01 å‰å‹ä¿å¹´è³‡ã€æ‰å¯èƒ½é¸çš„é¸é …ï¼›è€Œä¸”æ ¸ä»˜å¾Œé€šå¸¸ä¸å¾—è®Šæ›´ã€‚<br/>
              ä¸æƒ³å¡«å°±ä¸è¦ç®—ï¼Œé è¨­ä»¥ã€Œå¹´é‡‘ vs è€å¹´ä¸€æ¬¡é‡‘ã€å°±å¤ åšæ±ºç­–ã€‚
            </div>
            <label>ä½ æƒ³è¦è©¦ç®—ä¸€æ¬¡è«‹é ˜å—ï¼Ÿ</label>
            <select id="wantOneTime">
              <option value="no" selected>å¦ï¼ˆä¸é¡¯ç¤ºä¸€æ¬¡è«‹é ˜ï¼‰</option>
              <option value="yes">æ˜¯ï¼ˆæˆ‘æœ‰98å‰å¹´è³‡ï¼Œæƒ³è©¦ç®—çœ‹çœ‹ï¼‰</option>
            </select>

            <div class="row">
              <div>
                <label>ï¼ˆä¸€æ¬¡è«‹é ˜ç”¨ï¼‰60æ­²å¾ŒåŠ ä¿å¹´è³‡ï¼ˆä¸ç¢ºå®šå°±å¡«0ï¼‰</label>
                <div class="row">
                  <div><input id="insAfter60Years" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="insAfter60Months" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
                <div class="small">è‹¥ä½ ä¸æƒ³ç ”ç©¶ï¼Œå¡«0å³å¯ï¼ˆç³»çµ±ä»èƒ½ç®—å¤§æ¦‚ï¼‰ã€‚</div>
              </div>
              <div>
                <label>ï¼ˆä¸€æ¬¡è«‹é ˜ç”¨ï¼‰æœªæ»¿60æ­²å°±è«‹é ˜ï¼Ÿ</label>
                <select id="claimBefore60">
                  <option value="no" selected>å¦ï¼ˆ60æ­²æˆ–ä¹‹å¾Œï¼‰</option>
                  <option value="yes">æ˜¯ï¼ˆæœªæ»¿60æ­²ï¼‰</option>
                </select>
              </div>
            </div>

            <label>ï¼ˆä¸€æ¬¡è«‹é ˜è³‡æ ¼ï¼‰ä½ æ˜¯å¦ã€Œç¢ºèªè‡ªå·±ç¬¦åˆä¸€æ¬¡è«‹é ˜æ¢ä»¶ã€ï¼Ÿ</label>
            <select id="oneTimeEligibleConfirm">
              <option value="no" selected>ä¸ç¢ºå®šï¼ˆåªé¡¯ç¤ºä¿å®ˆæç¤ºï¼Œä¸ç›´æ¥åˆ¤å®šç¬¦åˆï¼‰</option>
              <option value="yes">æˆ‘ç¢ºå®šç¬¦åˆï¼ˆæˆ‘å·²æŸ¥éå‹ä¿å±€æ¢ä»¶ï¼‰</option>
            </select>
            <div class="small">ç‚ºäº†é¿å…èª¤åˆ¤ï¼Œè‹¥ä½ é¸ã€Œä¸ç¢ºå®šã€ï¼Œç³»çµ±ä¸æœƒæŠŠä¸€æ¬¡è«‹é ˜ç•¶æˆå¯ç”¨æ–¹æ¡ˆï¼Œåªæœƒé¡¯ç¤ºè©¦ç®—åƒè€ƒã€‚</div>
          </div>
        </details>

        <div class="btnrow">
          <button onclick="calcAll()">è¨ˆç®—ï¼ˆåˆ¶åº¦ï¼‹æ¨¡æ“¬ï¼‹å®‰å…¨é‚Šéš›ï¼‰</button>
          <button class="secondary" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
          <button class="ghost" onclick="resetMsgs()">æ¸…é™¤æç¤º</button>
        </div>

        <div id="warnBox" class="warn"></div>
        <div id="okBox" class="ok"></div>

        <p class="small">
          â€» æ•™è‚²ç”¨é€”ï¼šå¯¦éš›æ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ï¼›æ­¤å·¥å…·é‡é»æ˜¯ã€ŒæŠŠæ™‚é»æ”¹æ­£ï¼ˆä»¥è«‹é ˜é»ï¼‰ï¼‹æƒ…å¢ƒæ¨¡æ“¬ã€ã€‚
        </p>
      </div>

      <!-- RIGHT OUTPUT -->
      <div class="card">
        <h2>çµæœ</h2>
        <div id="output" class="result"></div>
      </div>
    </div>
  </div>

<script>
/* ===================== æ ¸å¿ƒåˆ¶åº¦ï¼šç²¾ç°¡ä¸”ä¿å®ˆ =====================
- æ™‚é»æ ¡æ­£ï¼šæ‰€æœ‰ã€Œè³‡æ ¼/å¹´è³‡/ä¸€æ¬¡é‡‘å…¥å¸³/å¹´é‡‘é–‹å§‹ã€éƒ½ä»¥ã€Œè«‹é ˜å¹´é½¡ã€ç‚ºæº–
- é è¨­æ–¹æ¡ˆï¼šå¹´é‡‘ vs è€å¹´ä¸€æ¬¡é‡‘ï¼ˆæœ€å¸¸ç”¨ã€æœ€ä¸æœƒèª¤å°ï¼‰
- ä¸€æ¬¡è«‹é ˜ï¼šæ”¾é€²éšï¼Œä¸”é è¨­ä¸æŠŠå®ƒç•¶â€œå¯ç”¨æ–¹æ¡ˆâ€é™¤éä½¿ç”¨è€…è‡ªè¡Œç¢ºèª
=============================================================== */

/* ---------- å¸¸æ•¸ ---------- */
const DATE_98 = new Date("2009-01-01T00:00:00"); // 98/01/01
const RULES = {
  // ä¾å‡ºç”Ÿå¹´æ¬¡(æ°‘åœ‹)æ³•å®šè«‹é ˜å¹´é½¡ï¼š46å«ä»¥å‰60ã€47=61ã€48=62ã€49=63ã€50=64ã€51å«ä»¥å¾Œ65
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  },
  maxAdjYears: 5,
  adjPerYear: 0.04
};

function $(id){ return document.getElementById(id); }
function fmt(n){ try { return Number(n).toLocaleString("en-US"); } catch { return String(n); } }
function money(v){ const n = Number(String(v||"").replace(/[,ï¼Œ\s]/g,"")); return Number.isFinite(n) ? n : NaN; }
function clampInt(v){ if(!Number.isFinite(v)) return NaN; return Math.max(0, Math.floor(v)); }
function showWarn(msg){ const w=$("warnBox"); if(!msg){w.style.display="none";w.textContent="";return;} w.style.display="block"; w.textContent=msg; }
function showOk(msg){ const o=$("okBox"); if(!msg){o.style.display="none";o.textContent="";return;} o.style.display="block"; o.textContent=msg; }
function hideOutput(){ $("output").style.display="none"; $("output").innerHTML=""; }
function resetMsgs(){ showWarn(""); showOk(""); }
function round2(x){ return Math.round(x * 100) / 100; }

/* ---------- å¹´é½¡/æ—¥æœŸ/å¹´è³‡ ---------- */
function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }

function calcAgeMonths(birthDate, today){
  let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
  if (today.getDate() < birthDate.getDate()) months -= 1;
  return Math.max(0, months);
}
function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}
function monthsBetween(fromDate, toDate){
  let m = (toDate.getFullYear()-fromDate.getFullYear())*12 + (toDate.getMonth()-fromDate.getMonth());
  if (toDate.getDate() < fromDate.getDate()) m -= 1;
  return Math.max(0, m);
}
function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}

/* ---------- 98å‰å¾Œåˆ¤æ–·ï¼ˆä¿å®ˆï¼‰ ---------- */
function isPre98(){
  const dStr = ($("firstInsuredDate").value || "").trim();
  if(dStr){
    const d = new Date(dStr + "T00:00:00");
    if(!isNaN(d.getTime())) return d < DATE_98;
  }
  // æ²’å¡«æ—¥æœŸ â†’ ä¿å®ˆè¦–ç‚º 98å¾Œï¼Œé¿å…èª¤åˆ¤ä¸€æ¬¡è«‹é ˜
  return false;
}

/* ---------- è–ªè³‡æ˜ç´°ï¼ˆå¯é¸ï¼‰ ---------- */
function parseSalaryLines(text){
  const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const dated = [];
  const seq = [];
  for(const line of lines){
    const m = line.match(/^(\d{4})[\/\-](\d{1,2})[^\d]+([\d,ï¼Œ]+(\.\d+)?)$/);
    if(m){
      const yyyy=Number(m[1]), mm=Number(m[2]);
      const sal=money(m[3]);
      if(!Number.isFinite(yyyy)||!Number.isFinite(mm)||mm<1||mm>12||!Number.isFinite(sal)||sal<=0) continue;
      dated.push({ key: yyyy*12+mm, salary: sal });
      continue;
    }
    const sal = money(line);
    if(Number.isFinite(sal) && sal>0) seq.push(sal);
  }
  if(dated.length){
    const map=new Map();
    for(const it of dated) map.set(it.key, it.salary);
    const arr=[...map.entries()].sort((a,b)=>a[0]-b[0]).map(([k,s])=>s);
    return { mode:"dated", salaries: arr, count: arr.length };
  }
  return { mode:"sequence", salaries: seq, count: seq.length };
}
function avgTop60(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  if(n<60){
    const sum=salaries.reduce((a,b)=>a+b,0);
    return { avg: sum/n, rule:"æœªæ»¿60å€‹æœˆï¼šç”¨å¯¦éš›å¹³å‡" };
  }
  const top = salaries.slice().sort((a,b)=>b-a).slice(0,60);
  const sum=top.reduce((a,b)=>a+b,0);
  return { avg: sum/60, rule:"æœ€é«˜60å€‹æœˆå¹³å‡" };
}
function avgLast36(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  const used = (n<=36) ? salaries.slice() : salaries.slice(n-36);
  const sum=used.reduce((a,b)=>a+b,0);
  return { avg: sum/used.length, rule:(n<36) ? "æœªæ»¿36å€‹æœˆï¼šç”¨å¯¦éš›å¹³å‡" : "æœ€å¾Œ36å€‹æœˆå¹³å‡" };
}

/* ---------- ææ—©/å±•å»¶ä¿‚æ•¸ ---------- */
function adjustFactor(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths;
  const rawYears = diffMonths / 12;
  const cappedYears = Math.max(-RULES.maxAdjYears, Math.min(RULES.maxAdjYears, rawYears));
  const factor = 1 + cappedYears * RULES.adjPerYear;
  return { factor, diffMonths, rawYears, cappedYears };
}

/* ===================== åˆ¶åº¦è¨ˆç®—ï¼ˆç²¾ç°¡ï¼‰ ===================== */

/* å¹´é‡‘ï¼šå…©å¼æ“‡å„ª */
function calcPension(avgSalary60, insMonths, factor){
  const insYears = insMonths / 12; // ç”¨æœˆæ¯”ä¾‹
  const base1 = avgSalary60 * insYears * 0.00775 + 3000;
  const base2 = avgSalary60 * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2) ? "å¼1ï¼ˆ0.775%Ã—å¹´è³‡ + 3000ï¼‰" : "å¼2ï¼ˆ1.55%Ã—å¹´è³‡ï¼‰";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly };
}

/* è€å¹´ä¸€æ¬¡é‡‘ï¼šå¹´è³‡<15å¹´æ‰æ˜¯ä¸»æƒ…å¢ƒ */
function calcOldAgeLump60(avgSalary60, insMonthsTotal, after60MonthsInput){
  const total = Math.max(0, insMonthsTotal);
  const after60 = Math.min(Math.max(0, after60MonthsInput || 0), 60, total);
  const pre60 = Math.max(0, total - after60);
  const benefitMonths = round2((pre60 + after60) / 12);
  const amount = Math.round(avgSalary60 * benefitMonths);
  return { benefitMonths, amount, capAfter60Months: 60 };
}

/* ä¸€æ¬¡è«‹é ˜ï¼ˆé€²éšï¼‰ */
function calcOneTimeOldAgeLump36(avgSalary36, insMonthsTotal, after60MonthsInput, claimBefore60){
  const total = Math.max(0, insMonthsTotal);
  const after60Raw = claimBefore60 ? 0 : Math.max(0, after60MonthsInput || 0);
  const after60 = Math.min(after60Raw, 60, total);
  const pre60 = Math.max(0, total - after60);

  const pre60Years = pre60 / 12;
  const y1 = Math.min(15, pre60Years);
  const y2 = Math.max(0, pre60Years - 15);

  const benefitPre60 = Math.min((y1 * 1) + (y2 * 2), 45);
  const benefitAfter60 = after60 / 12;
  const cap = claimBefore60 ? 45 : 50;

  const benefitMonths = round2(Math.min(benefitPre60 + benefitAfter60, cap));
  const amount = Math.round(avgSalary36 * benefitMonths);

  return { benefitMonths, amount, cap };
}

/* è³‡æ ¼ï¼ˆç²¾ç°¡ï¼šåªåšæœ€å¸¸ç”¨çš„ï¼‰ */
function determineEligibilitySimple({ claimAgeMonths, legalAgeMonths, insMonthsAtClaim }){
  const eligiblePension = (claimAgeMonths >= legalAgeMonths) && (insMonthsAtClaim >= 15*12);
  const eligibleOldAgeLump = (claimAgeMonths >= legalAgeMonths) && (insMonthsAtClaim < 15*12);
  return { eligiblePension, eligibleOldAgeLump };
}

/* ===================== è²¡å‹™æ¨¡æ“¬ï¼ˆé€€ä¼‘â†’è«‹é ˜â†’è«‹é ˜å¾Œï¼‰ ===================== */
function annualToMonthlyRate(r){ return (1 + r) ** (1/12) - 1; }

function simulatePlan(params){
  const {
    monthsToRetire, monthsRetiredTotal,
    monthsRetireToClaim,
    principal0,
    contribMonthly,
    returnPre, returnPost,
    inflation,
    rentMonthly, otherIncomeMonthlyAtRetire,
    laborMonthlyAtClaim,
    needMonthlyToday,
    lumpSumAtClaim,
    stress // boolean: å£“åŠ›æ¸¬è©¦
  } = params;

  // å£“åŠ›æ¸¬è©¦ï¼šå›å ± -2%ã€é€šè†¨ +1%
  const rPre = stress ? (returnPre - 0.02) : returnPre;
  const rPost = stress ? (returnPost - 0.02) : returnPost;
  const inf = stress ? (inflation + 0.01) : inflation;

  let principal = Math.max(0, principal0);

  const gPreM = annualToMonthlyRate(rPre);
  const gPostM = annualToMonthlyRate(rPost);
  const infM = annualToMonthlyRate(inf);

  // Phase 1ï¼šé€€ä¼‘å‰
  for(let t=0; t<monthsToRetire; t++){
    principal = principal * (1 + gPreM) + contribMonthly;
  }

  const principalAtRetire = principal;

  // é€€ä¼‘æ™‚ç”Ÿæ´»è²»ï¼ˆåç›®ï¼‰
  let needM = needMonthlyToday * ((1 + infM) ** monthsToRetire);

  let brokeMonth = null;

  // Phase 2ï¼šé€€ä¼‘â†’è«‹é ˜ï¼ˆç„¡å‹ä¿ã€ç„¡ä¸€æ¬¡é‡‘ï¼‰
  const gapMonths = Math.max(0, monthsRetireToClaim || 0);
  for(let k=0; k<Math.min(gapMonths, monthsRetiredTotal); k++){
    if(k>0) needM *= (1 + infM);
    principal = principal * (1 + gPostM);

    const income = otherIncomeMonthlyAtRetire + rentMonthly; // é€€ä¼‘åˆ°è«‹é ˜ï¼šå‹ä¿=0
    const gap = needM - income;
    principal -= Math.max(0, gap);

    if(principal < 0){
      brokeMonth = k + 1;
      return { ok:false, principalAtRetire, principalEnd: principal, brokeMonth };
    }
  }

  // è«‹é ˜é»ï¼šä¸€æ¬¡é‡‘æ³¨å…¥ï¼ˆè‹¥æœ‰ï¼‰
  if(Number.isFinite(lumpSumAtClaim) && lumpSumAtClaim > 0){
    principal += lumpSumAtClaim;
  }

  // Phase 3ï¼šè«‹é ˜å¾Œ
  const monthsAfterClaim = Math.max(0, monthsRetiredTotal - gapMonths);
  for(let k=0; k<monthsAfterClaim; k++){
    needM *= (1 + infM);
    principal = principal * (1 + gPostM);

    const income = (laborMonthlyAtClaim || 0) + otherIncomeMonthlyAtRetire + rentMonthly;
    const gap = needM - income;
    principal -= Math.max(0, gap);

    if(principal < 0){
      brokeMonth = gapMonths + k + 1;
      break;
    }
  }

  return { ok: brokeMonth === null, principalAtRetire, principalEnd: principal, brokeMonth };
}

/* é€€ä¼‘å‰æ¯æœˆéœ€å¤šå­˜å¤šå°‘ï¼ˆç”¨äºŒåˆ†æœå°‹ï¼‰ */
function solveExtraContribution(baseParams){
  const base = simulatePlan(baseParams);
  if(base.ok) return { extra: 0, base, final: base };

  let lo = 0, hi = 300000;
  for(let i=0;i<32;i++){
    const mid = (lo+hi)/2;
    const test = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + mid });
    if(test.ok) hi = mid; else lo = mid;
  }
  const extra = Math.ceil(hi);
  const final = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + extra });
  return { extra, base, final };
}

/* ===================== ä¸»æµç¨‹ ===================== */
function calcAll(){
  resetMsgs(); hideOutput();
  const today = new Date();

  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  const birthDate = new Date($("birthDate").value + "T00:00:00");
  if(isNaN(birthDate.getTime())){ alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´æœˆæ—¥"); return; }

  const retireY = clampInt(Number($("retireYears").value));
  const retireM = clampInt(Number($("retireMonths").value));
  const claimY  = clampInt(Number($("claimYears").value));
  const claimM  = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(retireY) || retireM>11 || !Number.isFinite(claimY) || claimM>11){
    alert("é€€ä¼‘/è«‹é ˜å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return;
  }

  const lifeExp = Number($("lifeExpectancy").value);
  if(!Number.isFinite(lifeExp) || lifeExp <= 0){ alert("é è¨ˆå£½å‘½è¼¸å…¥éŒ¯èª¤"); return; }

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){ alert("æŠ•ä¿å¹´è³‡éœ€å¤§æ–¼0"); return; }

  const keepInsured = $("keepInsured").value === "yes";

  const retireAgeMonths = ageToMonths(retireY, retireM);
  const claimAgeMonths  = ageToMonths(claimY, claimM);

  const retireDate = calcDateAtAge(birthDate, retireAgeMonths);
  const claimDate  = calcDateAtAge(birthDate, claimAgeMonths);

  const monthsToRetire = monthsBetween(today, retireDate);
  const monthsToClaim  = monthsBetween(today, claimDate);
  const monthsRetireToClaim = monthsBetween(retireDate, claimDate);

  if(claimAgeMonths < retireAgeMonths){
    showWarn("ä½ è¨­å®šã€Œè«‹é ˜å¹´é½¡ã€å°æ–¼ã€Œé€€ä¼‘å¹´é½¡ã€ã€‚è‹¥ä½ æ˜¯æå‰è«‹é ˜å¾Œæ‰é€€ä¼‘ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦ç¬¦åˆä½ çš„æƒ…å¢ƒã€‚");
  }

  // â˜…åˆ¶åº¦å¹´è³‡ï¼šä»¥ã€Œè«‹é ˜æ™‚ã€å¹´è³‡ä¼°ç®—ï¼ˆé—œéµä¿®æ­£ï¼‰
  const insAtClaimMonths = keepInsured ? (insNowMonths + monthsToClaim) : insNowMonths;

  // æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¸€èˆ¬ï¼‰
  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalAgeMonths = ageToMonths(legal.years, legal.months);

  // ææ—©/å±•å»¶ï¼ˆå¹´é‡‘æ‰ç”¨ï¼‰
  const adj = adjustFactor(legalAgeMonths, claimAgeMonths);

  // è–ªè³‡ï¼šæ˜ç´°å„ªå…ˆï¼Œå¦å‰‡ç”¨ç°¡åŒ–å–®ä¸€è¼¸å…¥
  const detail = parseSalaryLines($("salaryLines")?.value || "");
  let avg60 = NaN, avg36 = NaN, salaryNote = "";
  if(detail.count){
    const p60 = avgTop60(detail.salaries);
    const l36 = avgLast36(detail.salaries);
    avg60 = p60.avg;
    avg36 = l36.avg;
    salaryNote = `å·²ç”¨æ˜ç´°ï¼š${p60.rule} / ${l36.rule}ï¼ˆå…±${detail.count}ç­†ï¼‰`;
  }else{
    const simple = money($("avgSalarySimple").value);
    if(!Number.isFinite(simple) || simple<=0){
      alert("è«‹å¡«ã€Œå¹³å‡æœˆæŠ•ä¿è–ªè³‡ã€æˆ–è²¼æŠ•ä¿è–ªè³‡æ˜ç´°ã€‚"); return;
    }
    avg60 = simple;
    avg36 = simple; // ç²¾ç°¡ç‰ˆï¼šä¸€æ¬¡è«‹é ˜è‹¥è©¦ç®—ï¼Œå…ˆç”¨åŒä¸€å€¼ï¼ˆæœƒæç¤ºï¼‰
    salaryNote = "æœªè²¼æ˜ç´°ï¼šä»¥ä½ å¡«çš„å–®ä¸€å¹³å‡è–ªè³‡ä½œç‚º60æœˆ/36æœˆä¼°ç®—ï¼ˆç²¾ç°¡ï¼‰";
  }

  // è³‡æ ¼ï¼ˆç²¾ç°¡ï¼‰
  const elig = determineEligibilitySimple({
    claimAgeMonths,
    legalAgeMonths,
    insMonthsAtClaim: insAtClaimMonths
  });

  // å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘
  const pension = elig.eligiblePension ? calcPension(avg60, insAtClaimMonths, adj.factor) : null;

  // 60æ­²å¾Œå¹´è³‡ï¼ˆç²¾ç°¡ï¼šç”±ä½¿ç”¨è€…å¯é¸å¡«ï¼›ä¸å¡«å°±ç”¨0ï¼‰
  const after60MonthsInput = insToMonths($("insAfter60Years")?.value || 0, $("insAfter60Months")?.value || 0, 0) || 0;

  const oldAgeLump = elig.eligibleOldAgeLump ? calcOldAgeLump60(avg60, insAtClaimMonths, after60MonthsInput) : null;

  // ä¸€æ¬¡è«‹é ˜ï¼ˆé€²éšï¼šä¸ä½œä¸»æƒ…å¢ƒï¼‰
  const pre98 = isPre98();
  const wantOneTime = ($("wantOneTime")?.value === "yes");
  const oneTimeEligibleConfirm = ($("oneTimeEligibleConfirm")?.value === "yes");
  const claimBefore60 = ($("claimBefore60")?.value === "yes");

  const oneTime = (wantOneTime && pre98)
    ? calcOneTimeOldAgeLump36(avg36, insAtClaimMonths, after60MonthsInput, claimBefore60)
    : null;

  // ===== è²¡å‹™åƒæ•¸ï¼ˆç²¾ç°¡ï¼‰=====
  const principal0 = Math.max(0, money($("assetNow").value) || 0);
  const contribMonthly = Math.max(0, money($("contribMonthly").value) || 0);

  const returnPre  = (Number($("returnPre").value || 0) / 100);
  const returnPost = (Number($("returnPost").value || 0) / 100);
  const inflation  = Math.max(0, Number($("inflation").value || 0) / 100);

  const rentMonthly = Math.max(0, money($("rentMonthly").value) || 0);
  const otherIncomeMonthly = Math.max(0, money($("otherIncomeMonthly").value) || 0);
  const needMonthlyToday = Math.max(0, money($("needMonthlyToday").value) || 0);

  const retireAge = retireY + retireM/12;
  const monthsRetiredTotal = Math.max(0, Math.floor((lifeExp - retireAge) * 12));

  // å…¶ä»–æ”¶å…¥æ¨åˆ°é€€ä¼‘ï¼ˆåç›®ï¼‰
  const infM = annualToMonthlyRate(inflation);
  const otherIncomeMonthlyAtRetire = otherIncomeMonthly * ((1 + infM) ** monthsToRetire);

  // ===== ä¸‰æƒ…å¢ƒï¼ˆåŒæŠ•è³‡å‡è¨­ï¼‰=====
  const laborMonthlyPension = pension ? pension.finalMonthly : 0;

  const baseA = {
    monthsToRetire,
    monthsRetiredTotal,
    monthsRetireToClaim,
    principal0,
    contribMonthly,
    returnPre, returnPost,
    inflation,
    rentMonthly,
    otherIncomeMonthlyAtRetire,
    laborMonthlyAtClaim: laborMonthlyPension, // â˜…è«‹é ˜å¾Œæ‰é–‹å§‹
    needMonthlyToday,
    lumpSumAtClaim: 0,
    stress: false
  };

  const baseB = {
    ...baseA,
    laborMonthlyAtClaim: 0,
    lumpSumAtClaim: oldAgeLump ? oldAgeLump.amount : 0
  };

  // ä¸€æ¬¡è«‹é ˜æƒ…å¢ƒåªåšåƒè€ƒï¼šé™¤éä½ è‡ªè¡Œç¢ºèªç¬¦åˆ
  const baseC = {
    ...baseA,
    laborMonthlyAtClaim: 0,
    lumpSumAtClaim: oneTime ? oneTime.amount : 0
  };

  const simA = simulatePlan(baseA);
  const simB = simulatePlan(baseB);
  const simC = oneTime ? simulatePlan(baseC) : null;

  // ä¸»æƒ…å¢ƒé¸æ“‡ï¼šå…ˆå¹´é‡‘ï¼Œå¦å‰‡è€å¹´ä¸€æ¬¡é‡‘ï¼Œå¦å‰‡ä¸å«å‹ä¿
  let mainTitle = "ä»¥ã€Œå¹´é‡‘ã€ä½œç‚ºä¸»æƒ…å¢ƒ";
  let mainParams = baseA;
  let mainSim = simA;

  if(!elig.eligiblePension){
    if(oldAgeLump){
      mainTitle = "ä»¥ã€Œè€å¹´ä¸€æ¬¡é‡‘ã€ä½œç‚ºä¸»æƒ…å¢ƒ";
      mainParams = baseB;
      mainSim = simB;
    }else{
      mainTitle = "ä»¥ã€Œä¸å«å‹ä¿ã€ä½œç‚ºä¸»æƒ…å¢ƒ";
      mainParams = { ...baseA, laborMonthlyAtClaim: 0, lumpSumAtClaim: 0 };
      mainSim = simulatePlan(mainParams);
    }
  }

  // å£“åŠ›æ¸¬è©¦ï¼ˆä¸»æƒ…å¢ƒï¼‰
  const simStress = simulatePlan({ ...mainParams, stress: true });

  // åæ¨ï¼šé€€ä¼‘å‰æ¯æœˆéœ€å¤šå­˜å¤šå°‘ï¼ˆä¸»æƒ…å¢ƒï¼‰
  const solveSave = solveExtraContribution(mainParams);

  // é¡¯ç¤ºæ–‡å­—ï¼šææ—©/å±•å»¶
  const diffText = (adj.diffMonths === 0) ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0) ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼Œå°é ‚Â±20%ï¼‰`
    : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼Œå°é ‚Â±20%ï¼‰`;

  // ç”Ÿå­˜æ–‡å­—
  function survive(sim){
    if(sim.ok) return { badge:"ok", text:`æ’åˆ° ${lifeExp} æ­²ï¼ˆæ¨¡æ“¬æœŸæœ«ä»æœ‰è³‡ç”¢ï¼‰` };
    const yearsAfter = sim.brokeMonth/12;
    const ageAtBroke = retireAge + yearsAfter;
    return { badge:"no", text:`ç´„æ’åˆ° ${ageAtBroke.toFixed(1)} æ­²ï¼ˆé€€ä¼‘å¾Œç´„ ${yearsAfter.toFixed(1)} å¹´ï¼‰` };
  }
  const sBase = survive(mainSim);
  const sStress = survive(simStress);

  // æ—¥æœŸå­—ä¸²
  const retireDateStr = `${retireDate.getFullYear()}-${String(retireDate.getMonth()+1).padStart(2,"0")}-${String(retireDate.getDate()).padStart(2,"0")}`;
  const claimDateStr  = `${claimDate.getFullYear()}-${String(claimDate.getMonth()+1).padStart(2,"0")}-${String(claimDate.getDate()).padStart(2,"0")}`;

  // 98å‰å¾Œå¾½ç« 
  const pre98Txt = pre98 ? `<span class="badge ok">98/01/01 å‰å·²æœ‰å¹´è³‡ï¼ˆå¯èƒ½æœ‰ä¸€æ¬¡è«‹é ˜ï¼‰</span>`
                         : `<span class="badge no">æœªç¢ºèª98å‰å¹´è³‡ï¼ˆä¿å®ˆè¦–ç‚º98å¾Œï¼‰</span>`;

  const badge = (b, okTxt="ç¬¦åˆ", noTxt="ä¸ç¬¦åˆ") => b ? `<span class="badge ok">${okTxt}</span>` : `<span class="badge no">${noTxt}</span>`;

  // çµæœè¼¸å‡º
  const out = $("output");
  out.style.display="block";

  const extraSaveText = (solveSave.extra<=0)
    ? "åœ¨æ­¤å‡è¨­ä¸‹ï¼šä¸éœ€è¦é¡å¤–å¢åŠ é€€ä¼‘å‰æŠ•å…¥ã€‚"
    : `è‹¥è¦æ’åˆ° ${lifeExp} æ­²ï¼šé€€ä¼‘å‰æ¯æœˆéœ€ã€Œå†å¤šå­˜ã€ç´„ NT$ ${fmt(solveSave.extra)}ã€‚`;

  // ä¸€æ¬¡è«‹é ˜é¡¯ç¤ºç­–ç•¥ï¼ˆé¿å…èª¤å°ï¼‰
  let oneTimeBlock = "";
  if(oneTime){
    const note = (!oneTimeEligibleConfirm)
      ? `<div class="small muted">â€» ä½ é¸æ“‡ã€Œä¸ç¢ºå®šæ˜¯å¦ç¬¦åˆä¸€æ¬¡è«‹é ˜è³‡æ ¼ã€ï¼šæ­¤é‡‘é¡åƒ…ä½œåƒè€ƒï¼Œä¸æœƒè¢«ç³»çµ±ç•¶æˆå¯ç”¨æ–¹æ¡ˆã€‚</div>`
      : `<div class="small muted">â€» ä½ å·²è‡ªè¡Œç¢ºèªç¬¦åˆä¸€æ¬¡è«‹é ˜è³‡æ ¼ï¼šå¯å°‡æ­¤æ–¹æ¡ˆç´å…¥ä½ è‡ªå·±çš„æ¯”è¼ƒã€‚</div>`;

    oneTimeBlock = `
      <div style="margin-top:10px">
        ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆåƒè€ƒï¼‰ï¼š<b>NT$ ${fmt(oneTime.amount)}</b>
        ${note}
      </div>
    `;
  }

  out.innerHTML = `
    <div class="kpi">
      <div class="kpi-box">
        <div class="kpi-title">ä¸»æƒ…å¢ƒï¼ˆ${mainTitle}ï¼‰</div>
        <div class="kpi-value">é€€ä¼‘æ™‚è³‡ç”¢ï¼šNT$ ${fmt(Math.round(mainSim.principalAtRetire))}</div>
        <div class="kpi-sub">
          é€€ä¼‘æ—¥æœŸï¼ˆä¼°ï¼‰ï¼š${retireDateStr}<br/>
          è«‹é ˜æ—¥æœŸï¼ˆä¼°ï¼‰ï¼š${claimDateStr}ï¼ˆé€€ä¼‘â†’è«‹é ˜ï¼š${monthsRetireToClaim} å€‹æœˆï¼‰<br/>
          åŸºæº–ï¼š<span class="badge ${sBase.badge}">${sBase.text}</span><br/>
          å£“åŠ›ï¼ˆå›å ±-2%ã€é€šè†¨+1%ï¼‰ï¼š<span class="badge ${sStress.badge}">${sStress.text}</span>
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">å·®é¡åæ¨ï¼ˆå¥½ç”¨ï¼‰</div>
        <div class="kpi-value">${extraSaveText}</div>
        <div class="kpi-sub">åæ¨æ˜¯ä»¥ã€Œä¸»æƒ…å¢ƒã€å‡è¨­è¨ˆç®—ï¼ˆåŒä¸€å¥—é€šè†¨/å ±é…¬/æ”¯å‡ºï¼‰ã€‚</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">åˆ¶åº¦è³‡æ ¼ï¼ˆä»¥è«‹é ˜é»åˆ¤å®šï¼‰</div>
        <div class="kpi-sub">
          æ³•å®šè«‹é ˜å¹´é½¡ï¼š${legal.years} æ­²ï¼ˆROC ${rocBirthYear}ï¼‰<br/>
          ä½ è¨­å®šçš„è«‹é ˜å¹´é½¡ï¼š${claimY} æ­² ${claimM} æœˆ<br/>
          è«‹é ˜æ™‚å¹´è³‡ï¼ˆä¼°ï¼‰ï¼š${(insAtClaimMonths/12).toFixed(2)} å¹´<br/>
          å¹´é‡‘ï¼š${badge(elig.eligiblePension)}ã€€
          è€å¹´ä¸€æ¬¡é‡‘ï¼š${badge(elig.eligibleOldAgeLump)}<br/>
          ${pre98Txt}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">åˆ¶åº¦é‡‘é¡ï¼ˆåŒä¸€è«‹é ˜é»ï¼‰</div>
        <div class="kpi-sub">
          å¹´é‡‘ï¼ˆæœˆï¼‰ï¼š<b>${pension ? "NT$ "+fmt(laborMonthlyPension) : "â€”"}</b>
          ${pension ? `ï¼ˆ${pension.chosen}ï¼›${diffText}ï¼‰` : "ï¼ˆä¸ç¬¦æˆ–æœªåˆ°æ³•å®šå¹´é½¡/å¹´è³‡ï¼‰"}<br/>
          è€å¹´ä¸€æ¬¡é‡‘ï¼š<b>${oldAgeLump ? "NT$ "+fmt(oldAgeLump.amount) : "â€”"}</b>
          ${oldAgeLump ? `ï¼ˆçµ¦ä»˜æœˆæ•¸ ${oldAgeLump.benefitMonths.toFixed(2)}ï¼‰` : "" }
          ${oneTimeBlock}
        </div>
      </div>
    </div>

    <details style="margin-top:12px">
      <summary>å±•é–‹ï¼šä½ é€™æ¬¡è¨ˆç®—ç”¨åˆ°çš„é—œéµå‡è¨­</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">è–ªè³‡ä¾†æº</td><td>${salaryNote}</td></tr>
          <tr><td class="muted">60æœˆå¹³å‡ï¼ˆå¹´é‡‘/ä¸€æ¬¡é‡‘ç”¨ï¼‰</td><td>NT$ ${fmt(Math.round(avg60))}</td></tr>
          <tr><td class="muted">36æœˆå¹³å‡ï¼ˆä¸€æ¬¡è«‹é ˜ç”¨ï¼›ç²¾ç°¡ç‰ˆå¯èƒ½ç­‰æ–¼ä¸Šæ–¹ï¼‰</td><td>NT$ ${fmt(Math.round(avg36))}</td></tr>
          <tr><td class="muted">é€€ä¼‘å‰å ±é…¬ç‡ / é€€ä¼‘å¾Œå ±é…¬ç‡</td><td>${(returnPre*100).toFixed(1)}% / ${(returnPost*100).toFixed(1)}%</td></tr>
          <tr><td class="muted">é€šè†¨</td><td>${(inflation*100).toFixed(1)}%</td></tr>
          <tr><td class="muted">é€€ä¼‘å¾Œç”Ÿæ´»è²»ï¼ˆä»Šå¤©åƒ¹å€¼ï¼‰</td><td>NT$ ${fmt(Math.round(needMonthlyToday))}</td></tr>
          <tr><td class="muted">é€€ä¼‘å¾Œå…¶ä»–æ”¶å…¥ / æˆ¿ç§Ÿ</td><td>NT$ ${fmt(Math.round(otherIncomeMonthly))} / NT$ ${fmt(Math.round(rentMonthly))}</td></tr>
        </table>
        <div class="small muted">
          æé†’ï¼šè‹¥ä½ è¨­å®šã€Œå±•å»¶è«‹é ˜ã€ï¼Œé€€ä¼‘åˆ°è«‹é ˜æœŸé–“ä¸æœƒæœ‰å¹´é‡‘æ”¶å…¥ä¹Ÿæ²’æœ‰ä¸€æ¬¡é‡‘å…¥å¸³ï¼›æœ¬å·¥å…·å·²ç”¨åˆ†æ®µæ¨¡æ“¬é¿å…åæ¨‚è§€ã€‚
        </div>
      </div>
    </details>
  `;

  // æç¤º
  if(Math.abs(adj.diffMonths) > 60){
    showWarn("ä½ è¨­å®šçš„è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é5å¹´ï¼›å¹´é‡‘åŠ æ¸›çµ¦å·²å°é ‚ï¼ˆÂ±20%ï¼‰ã€‚");
  }else{
    showOk("å®Œæˆï¼šåˆ¶åº¦ä»¥è«‹é ˜é»æ ¡æ­£ï¼‹å¹´é‡‘/ä¸€æ¬¡é‡‘æ¯”è¼ƒï¼‹é€€ä¼‘ç¼ºå£æ¨¡æ“¬ï¼‹å£“åŠ›æ¸¬è©¦ï¼‹å·®é¡åæ¨ã€‚");
  }

  if(!$("firstInsuredDate").value){
    showWarn("æé†’ï¼šä½ æœªå¡«ã€Œé¦–æ¬¡æŠ•ä¿æ—¥æœŸã€ã€‚æˆ‘å·²ä¿å®ˆè¦–ç‚ºã€Œ98/01/01 å¾Œé¦–æ¬¡æŠ•ä¿ã€é¿å…èª¤åˆ¤ä¸€æ¬¡è«‹é ˜ï¼›è‹¥ä½ ç¢ºå®š98å¹´å‰å·²æœ‰å¹´è³‡ï¼Œå»ºè­°è£œä¸Šæ—¥æœŸã€‚");
  }

  if(wantOneTime && !pre98){
    showWarn("ä½ å‹¾é¸äº†è©¦ç®—ä¸€æ¬¡è«‹é ˜ï¼Œä½†ä½ æœªå¡«æˆ–æœªèƒ½è­‰æ˜98å‰å·²æœ‰å¹´è³‡ï¼ˆç³»çµ±ä¿å®ˆè¦–ç‚º98å¾Œï¼‰ã€‚ä¸€æ¬¡è«‹é ˜ä»æœƒä»¥åƒè€ƒæ–¹å¼é¡¯ç¤ºï¼Œè«‹è‡ªè¡ŒæŸ¥æ ¸è³‡æ ¼ã€‚");
  }

  if(wantOneTime && detail.count === 0){
    showWarn("æé†’ï¼šä½ åœ¨è©¦ç®—ä¸€æ¬¡è«‹é ˜ï¼Œä½†æœªè²¼æ˜ç´°ã€‚ä¸€æ¬¡è«‹é ˜ç†è«–ä¸Šæ‡‰æ¡ã€Œæœ€å¾Œ36æœˆå¹³å‡ã€ã€‚ç²¾ç°¡ç‰ˆæœƒå…ˆç”¨ä½ å¡«çš„å–®ä¸€å¹³å‡è–ªè³‡ä½œè¿‘ä¼¼ï¼Œå»ºè­°è²¼æ˜ç´°æ›´æº–ã€‚");
  }
}

function loadExample(){
  $("birthDate").value = "1980-01-01";
  $("retireYears").value = 65; $("retireMonths").value = 0;
  $("claimYears").value = 65; $("claimMonths").value = 0;
  $("lifeExpectancy").value = 90;

  $("insYearsNow").value = 28; $("insMonthsNow").value = 0; $("insDaysNow").value = 5;
  $("keepInsured").value = "yes";

  $("avgSalarySimple").value = 45800;
  $("firstInsuredDate").value = "2010-01-01";
  $("salaryLines").value = "";

  $("assetNow").value = 8000000;
  $("contribMonthly").value = 30000;

  $("returnPre").value = 3.0;
  $("returnPost").value = 2.0;
  $("inflation").value = 2.0;

  $("needMonthlyToday").value = 80000;
  $("otherIncomeMonthly").value = 0;
  $("rentMonthly").value = 15000;

  // é€²éšä¸€æ¬¡è«‹é ˜ï¼šé è¨­ä¸ç®—
  $("wantOneTime").value = "no";
  $("oneTimeEligibleConfirm").value = "no";
  $("insAfter60Years").value = 0;
  $("insAfter60Months").value = 0;
  $("claimBefore60").value = "no";

  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼šè³‡ç”¢800è¬ã€æ¯æœˆæŠ•å…¥3è¬ã€å ±é…¬(å‰3%å¾Œ2%)ã€é€šè†¨2%ã€æˆ¿ç§Ÿ1.5è¬ã€ç”Ÿæ´»è²»8è¬ã€‚");
  showWarn("");
  hideOutput();
}

(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  [
    "birthDate","retireYears","retireMonths","claimYears","claimMonths","lifeExpectancy",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsured",
    "avgSalarySimple","firstInsuredDate","salaryLines",
    "assetNow","contribMonthly","returnPre","returnPost","inflation",
    "needMonthlyToday","otherIncomeMonthly","rentMonthly",
    "wantOneTime","insAfter60Years","insAfter60Months","claimBefore60","oneTimeEligibleConfirm"
  ].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", hideOutput);
    el.addEventListener("change", hideOutput);
  });
})();
</script>
</body>
</html>
