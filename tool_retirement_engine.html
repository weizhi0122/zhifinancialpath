<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é€€ä¼‘ç¼ºå£å°ˆæ¥­å·¥å…·ï¼ˆåˆ¶åº¦ç²¾æº–ï¼‹è³‡ç”¢æ¨¡æ“¬ï¼‹åˆ¶åº¦æ¯”è¼ƒï¼‹å®‰å…¨é‚Šéš›ï¼‰ï½œæ™º Financial Path</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="å‹ä¿ï¼šè€å¹´å¹´é‡‘ / è€å¹´ä¸€æ¬¡é‡‘ / ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆ98å¹´å‰å¾Œè³‡æ ¼è‡ªå‹•åˆ¤æ–·ï¼‰ï¼‹é€€ä¼‘ç¼ºå£è³‡ç”¢æ¨¡æ“¬ï¼ˆè‚¡æ¯/å‚µæ¯/å¢å€¼/æˆ¿ç§Ÿ/é€šè†¨/æŠ•å…¥ï¼‰ï¼‹å·®é¡åæ¨ï¼‹åˆ¶åº¦æ¯”è¼ƒï¼ˆæ‰“å¹³å¹´é½¡ï¼‰ï¼‹å®‰å…¨é‚Šéš›å£“åŠ›æ¸¬è©¦ã€‚" />

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#667085;
    --line:#e6e8ee; --primary:#0b3d91; --soft:#eef4ff;
    --warnbg:#fff4e5; --warn:#8a5300;
    --goodbg:#ecfdf3; --good:#027a48;
    --shadow:0 6px 16px rgba(0,0,0,.05);
  }
  body{font-family:Arial,"Noto Sans TC",sans-serif;margin:0;background:var(--bg);color:var(--text);line-height:1.55}
  a{color:var(--primary);text-decoration:none}
  a:hover{text-decoration:underline}
  .topbar{background:#fff;border-bottom:1px solid var(--line);padding:10px 18px;position:sticky;top:0;z-index:10}
  .topbar-inner{max-width:1180px;margin:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .left-nav{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .brand{font-size:13px;color:var(--muted)}
  .container{max-width:1180px;margin:auto;padding:22px 18px}
  h1{margin:0 0 10px;color:var(--primary);font-size:26px}
  .sub{color:var(--muted);font-size:13.5px;margin-top:6px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:1020px){ .grid{grid-template-columns:1.1fr 0.9fr} }

  .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0f172a}
  .hr{border:0;border-top:1px solid var(--line);margin:14px 0}
  label{display:block;margin-top:10px;font-size:14px;color:#0f172a}
  input,select,textarea,button{
    width:100%;padding:10px 10px;margin-top:6px;border:1px solid #d7dbe6;border-radius:10px;
    box-sizing:border-box;background:#fff;font-size:14px;
  }
  textarea{min-height:110px;resize:vertical;line-height:1.35}
  input:focus,select:focus,textarea:focus{outline:2px solid #cfe0ff;border-color:#cfe0ff}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1;min-width:160px}

  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--primary);color:#fff;border:0;cursor:pointer;font-weight:900}
  button.secondary{background:#334155}
  button.ghost{background:#fff;color:var(--primary);border:1px solid #cfe0ff}
  button:hover{opacity:.92}

  .warn,.ok{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;line-height:1.45}
  .warn{background:var(--warnbg);color:var(--warn);border:1px solid #ffe2b5}
  .ok{background:var(--goodbg);color:var(--good);border:1px solid #b7f0cc}

  .small{font-size:12.5px;color:var(--muted);line-height:1.55;margin-top:10px}
  .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5ff;color:var(--primary);border:1px solid #dbe7ff}
  .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid var(--line);color:#0f172a}

  .result{display:none}
  .kpi{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  @media (min-width:980px){ .kpi{grid-template-columns:1fr 1fr} }

  .kpi-box{border:1px solid #dbe7ff;background:var(--soft);border-radius:12px;padding:12px}
  .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi-value{font-size:18px;font-weight:900;color:var(--primary)}
  .kpi-sub{font-size:12.5px;color:var(--muted);margin-top:6px;line-height:1.5}

  details{margin-top:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  summary{cursor:pointer;padding:12px 12px;font-weight:900;color:#0f172a}
  details .inner{padding:0 12px 12px}

  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table td{padding:7px 0;border-bottom:1px dashed #dbe2f0;font-size:13.5px;vertical-align:top}
  .table td:last-child{text-align:right}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .seg label{margin:0;font-size:13px;color:#0f172a}
  .seg .opt{
    display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:12px;
    padding:10px 12px;cursor:pointer;flex:1;min-width:220px
  }
  .seg input{width:auto;margin:0}
  .seg .txt{display:flex;flex-direction:column;gap:2px}
  .seg .t{font-weight:900}
  .seg .d{font-size:12px;color:var(--muted);line-height:1.35}

  .badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#334155}
  .badge.ok{border-color:#b7f0cc;background:#ecfdf3;color:#027a48}
  .badge.no{border-color:#ffd6d6;background:#fff4f4;color:#b42318}
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="left-nav">
        <a href="./tools.html">â† å›å·¥å…·</a>
        <a href="./index.html">ğŸ  å›ä¸»é </a>
      </div>
      <div class="brand">æ™º Financial Path</div>
    </div>
  </div>

  <div class="container">
    <h1>é€€ä¼‘ç¼ºå£å°ˆæ¥­å·¥å…· <span class="chip">åˆ¶åº¦ç²¾æº–ï¼‹è²¡å‹™æ¨¡æ“¬ï¼‹åˆ¶åº¦æ¯”è¼ƒï¼‹å®‰å…¨é‚Šéš›</span></h1>
    <div class="sub">
      Level 1ï¼šåˆ¶åº¦æ¯”è¼ƒå¼•æ“ï¼ˆå¹´é‡‘ vs ä¸€æ¬¡è«‹é ˜/è€å¹´ä¸€æ¬¡é‡‘ã€æ‰“å¹³å¹´é½¡ï¼‰ï½œ
      Level 2ï¼šå®‰å…¨é‚Šéš›æ¨¡å‹ï¼ˆå¸‚å ´å›å ±-2%ã€é€šè†¨+1%ã€æ’å¤šä¹…/æ’åˆ°å¹¾æ­²ï¼‰
    </div>

    <div class="grid">
      <!-- LEFT INPUT -->
      <div class="card">
        <h2>Step 1ï½œåŸºæœ¬è³‡æ–™</h2>

        <div class="row">
          <div>
            <label>å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆè¥¿å…ƒï¼‰</label>
            <input id="birthDate" type="date" />
          </div>
          <div>
            <label>é è¨ˆé€€ä¼‘å¹´é½¡</label>
            <div class="row">
              <div><input id="retireYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="retireMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
          <div>
            <label>é è¨ˆå£½å‘½</label>
            <input id="lifeExpectancy" type="number" min="0" step="1" value="90" />
            <div class="small">ç”¨ä¾†åˆ¤æ–·æ˜¯å¦æ’å¾—åˆ°ï¼ˆæ’åˆ°å¹¾æ­²ï¼‰</div>
          </div>
        </div>

        <label>ç›®å‰æŠ•ä¿å¹´è³‡ï¼ˆæœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼‰</label>
        <div class="row">
          <div><input id="insYearsNow" type="number" min="0" step="1" value="30" /><div class="small">å¹´</div></div>
          <div><input id="insMonthsNow" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
          <div><input id="insDaysNow" type="number" min="0" max="30" step="1" value="0" /><div class="small">å¤©ï¼ˆ>0 è¦–ç‚º +1æœˆï¼‰</div></div>
        </div>

        <div class="row">
          <div>
            <label>åˆ°é€€ä¼‘æ˜¯å¦æŒçºŒæŠ•ä¿ï¼Ÿ</label>
            <select id="keepInsured">
              <option value="yes" selected>æ˜¯ï¼šä¸€ç›´æŠ•ä¿åˆ°é€€ä¼‘</option>
              <option value="no">å¦ï¼šç”¨ç›®å‰å¹´è³‡ï¼ˆä¸å†å¢åŠ ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é è¨ˆè«‹é ˜å¹´é½¡ï¼ˆææ—©/å±•å»¶ç”¨ï¼›ä¸€æ¬¡çµ¦ä»˜ä¹Ÿä»¥æ­¤ç•¶ä½œè«‹é ˜é»ï¼‰</label>
            <div class="row">
              <div><input id="claimYears" type="number" min="0" step="1" value="65" /><div class="small">æ­²</div></div>
              <div><input id="claimMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
            </div>
          </div>
        </div>

        <hr class="hr" />

        <h2>Step 2ï½œåˆ¶åº¦é—œéµï¼š98/01/01 å‰å¾Œï¼ˆè‡ªå‹•åˆ¤æ–·ï¼‰</h2>
        <div class="small">
          98/01/01 ä¿®æ³•å¾Œï¼šé€šå¸¸å¹´è³‡â‰¥15å¹´ â†’ ä»¥å¹´é‡‘ç‚ºä¸»ï¼›å¹´è³‡&lt;15å¹´ â†’ è€å¹´ä¸€æ¬¡é‡‘ã€‚<br/>
          è‹¥ 98/01/01 å‰å°±å·²æœ‰å‹ä¿å¹´è³‡è€…ï¼šæ‰å¯èƒ½ç¬¦åˆã€Œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ã€é¸é …ï¼ˆä¾æ¢ä»¶ï¼‰ä¸”æ ¸ä»˜å¾Œä¸å¾—è®Šæ›´ã€‚
        </div>

        <div class="row">
          <div>
            <label>ä½ ç¬¬ä¸€æ¬¡é–‹å§‹æœ‰å‹ä¿å¹´è³‡çš„æ—¥æœŸï¼ˆç”¨ä¾†è‡ªå‹•åˆ¤æ–·æ˜¯å¦ã€Œ98/01/01 å‰ã€ï¼‰</label>
            <input id="firstInsuredDate" type="date" />
            <div class="small">è‹¥ä¸ç¢ºå®šï¼Œå¯ç•™ç©ºæ”¹ç”¨å³å´æ‰‹å‹•ã€‚</div>
          </div>
          <div>
            <label>æ‰‹å‹•æŒ‡å®šï¼ˆåªåœ¨ä½ æ²’å¡«æ—¥æœŸæ™‚æ‰æœƒç”¨ï¼‰</label>
            <select id="pre98Manual">
              <option value="auto" selected>è‡ªå‹•ï¼ˆå„ªå…ˆçœ‹å·¦å´æ—¥æœŸï¼‰</option>
              <option value="yes">æ˜¯ï¼š98/01/01 å‰å·²æœ‰å¹´è³‡</option>
              <option value="no">å¦ï¼š98/01/01 å¾Œæ‰é¦–æ¬¡æŠ•ä¿</option>
            </select>
          </div>
        </div>

        <details>
          <summary>é€²éšï¼šç‰¹æ®Šå·¥ä½œ/åœ‹æ°‘å¹´é‡‘ä½µè¨ˆï¼ˆéœ€è¦æ‰é–‹ï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>æ˜¯å¦å±¬ã€Œå±éšªã€å …å¼·é«”åŠ›ç­‰ç‰¹æ®Šæ€§è³ªå·¥ä½œã€ä¸”å¹´è³‡æ»¿15å¹´ï¼Ÿ</label>
                <select id="specialWork15">
                  <option value="no" selected>å¦</option>
                  <option value="yes">æ˜¯ï¼ˆå¯ 55 æ­²è«‹é ˜å¹´é‡‘ï¼‰</option>
                </select>
              </div>
              <div>
                <label>è‹¥å‹ä¿å¹´è³‡æœªæ»¿15å¹´ï¼šæ˜¯å¦è¦ä½µè¨ˆåœ‹æ°‘å¹´é‡‘å¹´è³‡æ»¿15å¹´ï¼ˆ65æ­²å¯é¸é ˜å‹ä¿å¹´é‡‘ï¼‰ï¼Ÿ</label>
                <select id="combineNP">
                  <option value="no" selected>å¦</option>
                  <option value="yes">æ˜¯</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>åœ‹æ°‘å¹´é‡‘å¹´è³‡ï¼ˆç”¨æ–¼ä½µè¨ˆï¼‰</label>
                <div class="row">
                  <div><input id="npYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="npMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>
              <div>
                <label>ï¼ˆåƒ…ä¸€æ¬¡è«‹é ˜ç”¨ï¼‰åŒä¸€æŠ•ä¿å–®ä½å¹´è³‡ï¼ˆä¸ç¢ºå®šå°±å¡«0ï¼‰</label>
                <div class="row">
                  <div><input id="sameUnitYears" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="sameUnitMonths" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>
            </div>
            <div class="row">
              <div>
                <label>ï¼ˆåƒ…ä¸€æ¬¡è«‹é ˜ç”¨ï¼‰ç‰¹æ®Šå·¥ä½œå¹´è³‡ï¼ˆæ»¿5å¹´ä¸”55æ­²é€€è·è€…æ¢ä»¶ä¹‹ä¸€ï¼‰</label>
                <div class="row">
                  <div><input id="specialWorkYears5" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="specialWorkMonths5" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>
              <div>
                <label>å¥³æ€§è¢«ä¿éšªäººï¼ˆä¸€æ¬¡è«‹é ˜æ¢ä»¶ä¹‹ä¸€å«ã€Œå¥³55æ­²ã€ï¼‰</label>
                <select id="isFemale">
                  <option value="no" selected>å¦</option>
                  <option value="yes">æ˜¯</option>
                </select>
              </div>
            </div>
          </div>
        </details>

        <hr class="hr" />

        <h2>Step 3ï½œå‹ä¿è¨ˆç®—ï¼ˆå¹³å‡è–ªè³‡å–æ³•ç²¾æº–ï¼‰</h2>
        <div class="small">
          å¹´é‡‘ï¼šåŠ ä¿æœŸé–“ã€Œæœ€é«˜60å€‹æœˆå¹³å‡ã€ã€‚ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼šé€€ä¿ç•¶æœˆèµ·ã€Œæœ€è¿‘36å€‹æœˆå¹³å‡ã€ã€‚
        </div>

        <div class="row">
          <div>
            <label>å¹´é‡‘å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€é«˜60æœˆå¹³å‡ï¼‰</label>
            <input id="avgSalaryPension" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
          <div>
            <label>ä¸€æ¬¡è«‹é ˜å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€è¿‘36æœˆå¹³å‡ï¼‰</label>
            <input id="avgSalaryLump36" type="number" min="0" step="100" placeholder="ä¾‹ï¼š45800" />
          </div>
        </div>

        <details>
          <summary>é€²éšï¼šè²¼æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆè‡ªå‹•ç®— 60æœˆæœ€é«˜å¹³å‡ï¼‹36æœˆæœ€è¿‘å¹³å‡ï¼‰</summary>
          <div class="inner">
            <div class="small">
              æ ¼å¼ï¼š<span class="mono">YYYY-MM é‡‘é¡</span> æˆ–åªè²¼é‡‘é¡ï¼ˆä¾æ™‚é–“é †åºï¼‰ã€‚<br/>
              å¹´é‡‘æœƒå–<strong>æœ€é«˜60ç­†</strong>ï¼›ä¸€æ¬¡è«‹é ˜æœƒå–<strong>æœ€å¾Œ36ç­†</strong>ã€‚
            </div>
            <label>æŠ•ä¿è–ªè³‡æ˜ç´°ï¼ˆå¯ç•™ç©ºï¼›æœ‰è²¼å°±å„ªå…ˆä½¿ç”¨ï¼‰</label>
            <textarea id="salaryLines" placeholder="ä¾‹ï¼š
2024-01 45800
2024-02 45800
..."></textarea>
          </div>
        </details>

        <details>
          <summary>é€²éšï¼šä¸€æ¬¡è«‹é ˜çš„ 60æ­²å¾Œå¹´è³‡ï¼ˆæœ€å¤š5å¹´ï¼›åˆä½µä¸Šé™50æœˆï¼‰</summary>
          <div class="inner">
            <div class="row">
              <div>
                <label>60æ­²å¾ŒåŠ ä¿å¹´è³‡ï¼ˆæœ€å¤š5å¹´ï¼›ä¸ç¢ºå®šå°±å¡«0ï¼‰</label>
                <div class="row">
                  <div><input id="insAfter60Years" type="number" min="0" step="1" value="0" /><div class="small">å¹´</div></div>
                  <div><input id="insAfter60Months" type="number" min="0" max="11" step="1" value="0" /><div class="small">æœˆ</div></div>
                </div>
              </div>
              <div>
                <label>æ˜¯å¦åœ¨æœªæ»¿60æ­²å°±è«‹é ˜ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼Ÿ</label>
                <select id="claimBefore60">
                  <option value="no" selected>å¦ï¼ˆ60æ­²æˆ–ä¹‹å¾Œï¼‰</option>
                  <option value="yes">æ˜¯ï¼ˆæœªæ»¿60æ­²ï¼‰</option>
                </select>
                <div class="small">æœªæ»¿60æ­²ä¸€æ¬¡è«‹é ˜ä¸Šé™ä»¥45æœˆç‚ºä¸»ã€‚</div>
              </div>
            </div>
          </div>
        </details>

        <hr class="hr" />

        <h2>Step 4ï½œè³‡ç”¢æ¨¡æ“¬ï¼ˆç¼ºå£å¼•æ“ï¼šè‚¡æ¯/å‚µæ¯/å¢å€¼ï¼‹æˆ¿ç§Ÿï¼‹é€šè†¨ï¼‹æŠ•å…¥ï¼‰</h2>

        <div class="row">
          <div>
            <label>ç¾åœ¨æŠ•è³‡ç¸½é¡ï¼ˆè³‡ç”¢æ± æœ¬é‡‘ï¼‰</label>
            <input id="assetNow" type="number" min="0" step="10000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰æ¯æœˆæŠ•å…¥ï¼ˆå­˜/æŠ•è³‡ï¼‰</label>
            <input id="contribMonthly" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–è‚¡æ¯ %ï¼ˆç¾é‡‘æµï¼‰</label>
            <input id="divPre" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–å‚µæ¯ %ï¼ˆç¾é‡‘æµï¼‰</label>
            <input id="bondPre" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å‰å¹´åŒ–å¢å€¼ %ï¼ˆè³‡ç”¢æˆé•·ï¼‰</label>
            <input id="growthPre" type="number" step="0.1" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å‰ï¼šè‚¡æ¯/å‚µæ¯æ˜¯å¦å†æŠ•å…¥ï¼Ÿ</label>
            <select id="reinvestPre">
              <option value="yes" selected>æ˜¯ï¼šè‚¡æ¯/å‚µæ¯å†æŠ•å…¥è³‡ç”¢æ± </option>
              <option value="no">å¦ï¼šè‚¡æ¯/å‚µæ¯ä¸æŠ•å…¥ï¼ˆç´¯ç©æˆç¾é‡‘/æº–å‚™é‡‘ï¼‰</option>
            </select>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œï¼šè‚¡æ¯/å‚µæ¯ç”¨é€”</label>
            <select id="reinvestPost">
              <option value="spend" selected>æ‹¿ä¾†ç”Ÿæ´»è²»ï¼ˆæŠµç¼ºå£ï¼‰</option>
              <option value="reinvest">å†æŠ•å…¥ï¼ˆä¸æŠµç”Ÿæ´»è²»ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–è‚¡æ¯ %</label>
            <input id="divPost" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–å‚µæ¯ %</label>
            <input id="bondPost" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå¹´åŒ–å¢å€¼ %</label>
            <input id="growthPost" type="number" step="0.1" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>æˆ¿ç§Ÿæ”¶å…¥ï¼ˆé¸å¡«ï¼Œå›ºå®šæœˆé¡ï¼‰</label>
            <input id="rentMonthly" type="number" min="0" step="1000" value="0" />
            <div class="small">æˆ¿ç§Ÿæ˜¯å›ºå®šé‡‘é¡ï¼ˆä¸æ˜¯%ï¼‰ã€‚</div>
          </div>
          <div>
            <label>é€€ä¼‘å¾Œæ˜¯å¦ä»æ¯æœˆæŠ•å…¥ï¼Ÿ</label>
            <select id="postContribMode">
              <option value="no" selected>å¦ï¼šé€€ä¼‘å¾Œä¸å†æŠ•å…¥</option>
              <option value="yes">æ˜¯ï¼šé€€ä¼‘å¾Œä»æ¯æœˆæŠ•å…¥ï¼ˆä¸‹æ–¹å¡«é‡‘é¡ï¼‰</option>
            </select>
            <div class="small">å¯æ¨¡æ“¬åŠé€€ä¼‘/æŒçºŒå·¥ä½œã€‚</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆæŠ•å…¥ï¼ˆè‹¥æœ‰ï¼‰</label>
            <input id="postContribMonthly" type="number" min="0" step="1000" value="0" />
          </div>
          <div>
            <label>é€€ä¼‘å¾Œå…¶ä»–æ¯æœˆæ”¶å…¥ï¼ˆä¸å«å‹ä¿/è‚¡æ¯å‚µæ¯/æˆ¿ç§Ÿï¼‰</label>
            <input id="otherIncomeMonthly" type="number" min="0" step="1000" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é€€ä¼‘å¾Œæ¯æœˆç”Ÿæ´»è²»ï¼ˆä»¥ä»Šå¤©åƒ¹å€¼ï¼‰</label>
            <input id="needMonthlyToday" type="number" min="0" step="1000" value="80000" />
          </div>
          <div>
            <label>é æœŸé€šè†¨ï¼ˆå¹´%ï¼‰</label>
            <input id="inflation" type="number" min="0" step="0.1" value="2.0" />
          </div>
        </div>

        <hr class="hr" />

        <h2>Step 5ï½œLevel 1ï¼šåˆ¶åº¦æ¯”è¼ƒå¼•æ“ï¼ˆçµæœç”¨åŒä¸€çµ„å‡è¨­æ¯”è¼ƒï¼‰</h2>
        <div class="small">
          ä½ æœƒçœ‹åˆ°ï¼š<b>å¹´é‡‘</b>ã€<b>è€å¹´ä¸€æ¬¡é‡‘</b>ã€<b>ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜</b>ï¼ˆè‹¥ç¬¦åˆï¼‰ä¸‰è€…é‡‘é¡ï¼Œä»¥åŠã€Œå¹´é‡‘æ‰“å¹³å¹´é½¡ã€ã€‚
        </div>

        <h2 style="margin-top:14px">Step 6ï½œLevel 2ï¼šå®‰å…¨é‚Šéš›æ¨¡å‹ï¼ˆå£“åŠ›æ¸¬è©¦ï¼‰</h2>
        <div class="small">
          å£“åŠ›æ¸¬è©¦æœƒåœ¨ã€ŒåŒä¸€æƒ…å¢ƒã€ä¸‹å†è·‘ä¸€æ¬¡ï¼š<b>å¸‚å ´å›å ± -2%</b>ã€<b>é€šè†¨ +1%</b>ï¼Œçœ‹ä½ <b>æ’å¤šä¹…/æ’åˆ°å¹¾æ­²</b>ã€‚
        </div>

        <div class="btnrow">
          <button onclick="calcAll()">è¨ˆç®—ï¼ˆåˆ¶åº¦ï¼‹æ¨¡æ“¬ï¼‹å·®é¡ï¼‹æ¯”è¼ƒï¼‹å®‰å…¨é‚Šéš›ï¼‰</button>
          <button class="secondary" onclick="loadExample()">å¸¶å…¥ç¯„ä¾‹</button>
          <button class="ghost" onclick="resetMsgs()">æ¸…é™¤æç¤º</button>
        </div>

        <div id="warnBox" class="warn"></div>
        <div id="okBox" class="ok"></div>

        <p class="small">
          â€» æ•™è‚²ç”¨é€”ï¼šå¯¦éš›æ ¸ä»˜ä»¥å‹ä¿å±€ç‚ºæº–ï¼›æ­¤å·¥å…·æä¾›ã€Œåˆ¶åº¦è¦å‰‡å°é½Š + è²¡å‹™æƒ…å¢ƒæ¨¡æ“¬ã€å”åŠ©ä½ åšæ±ºç­–ã€‚
        </p>
      </div>

      <!-- RIGHT OUTPUT -->
      <div class="card">
        <h2>çµæœï¼ˆæ¸…æ™°ï¼‹è©³ç´°ï¼‰</h2>
        <div id="output" class="result"></div>
      </div>
    </div>
  </div>

<script>
/* ===================== è¦å‰‡ï¼ˆå°é½Šå‹ä¿å±€å…¬é–‹èªªæ˜ï¼‰ =====================

1) è€å¹´å¹´é‡‘çµ¦ä»˜ï¼šå…©å¼æ“‡å„ª
   (1) å¹³å‡æœˆæŠ•ä¿è–ªè³‡ Ã— å¹´è³‡ Ã— 0.775% + 3000
   (2) å¹³å‡æœˆæŠ•ä¿è–ªè³‡ Ã— å¹´è³‡ Ã— 1.55%
   ææ—©/å±•å»¶ï¼šæ¯å¹´ Â±4%ï¼Œæœ€å¤š Â±20%ï¼Œæœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹
   å¹³å‡è–ªè³‡ï¼šåŠ ä¿æœŸé–“æœ€é«˜60å€‹æœˆå¹³å‡ï¼ˆæœªæ»¿60æœˆç”¨å¯¦éš›å¹³å‡ï¼‰
   å¹´è³‡ï¼šæœªæ»¿30æ—¥ä»¥1å€‹æœˆè¨ˆï¼›æœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹

2) è€å¹´ä¸€æ¬¡é‡‘çµ¦ä»˜ï¼ˆ98å¾Œåˆ¶åº¦ä¸»é«”ï¼‰ï¼šå¹´æ»¿æ³•å®šè«‹é ˜å¹´é½¡ï¼Œä¸”å‹ä¿å¹´è³‡æœªæ»¿15å¹´
   é‡‘é¡ï¼å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆæœ€é«˜60æœˆå¹³å‡ï¼‰Ã—çµ¦ä»˜æœˆæ•¸
   çµ¦ä»˜æœˆæ•¸ï¼šæ¯æ»¿1å¹´ç™¼1å€‹æœˆï¼›æœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹ï¼›60æ­²å¾Œæœ€å¤š5å¹´

3) ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆåƒ… 98/01/01 ä¿®æ³•å‰å·²æœ‰å¹´è³‡è€…å¯èƒ½é¸ï¼‰ï¼š
   é‡‘é¡ï¼å¹³å‡æœˆæŠ•ä¿è–ªè³‡ï¼ˆé€€ä¿ç•¶æœˆèµ·æœ€è¿‘36æœˆå¹³å‡ï¼‰Ã—çµ¦ä»˜æœˆæ•¸
   çµ¦ä»˜æœˆæ•¸ï¼šæ¯æ»¿1å¹´1å€‹æœˆï¼›è¶…é15å¹´éƒ¨åˆ†æ¯æ»¿1å¹´2å€‹æœˆï¼›æœ€é«˜45æœˆï¼›
             é€¾60æ­²å¾Œå¹´è³‡æœ€å¤š5å¹´ï¼›åˆä½µæœ€é«˜50æœˆ
   ä¸¦é ˆç¬¦åˆå…¶ä¸€æ¢ä»¶ï¼ˆç°¡åŒ–æˆå¯è¼¸å…¥/å‹¾é¸çš„åˆ¤æ–·ï¼‰ä¸”é›¢è·é€€ä¿å¾Œè«‹é ˜

â€» æœ¬é æœƒã€Œå…ˆåˆ¤æ–· 98å‰å¾Œã€å†æ±ºå®šå“ªäº›åˆ¶åº¦é¸é …å¯ç”¨ï¼Œ
   ä¸¦åœ¨çµæœåŠ ä¸Šã€Œæ¯”è¼ƒæ¨¡å¼ã€èˆ‡ã€Œæ‰“å¹³å¹´é½¡ã€ã€‚

==================================== */

/* ---------- å¸¸æ•¸ ---------- */
const DATE_98 = new Date("2009-01-01T00:00:00"); // 98/01/01
const RULES = {
  // ä¾å‡ºç”Ÿå¹´æ¬¡(æ°‘åœ‹)æ³•å®šè«‹é ˜å¹´é½¡ï¼š46å«ä»¥å‰60ã€47=61ã€48=62ã€49=63ã€50=64ã€51å«ä»¥å¾Œ65
  legalAgeByBirthRoc: (roc) => {
    if (roc <= 46) return { years: 60, months: 0 };
    if (roc === 47) return { years: 61, months: 0 };
    if (roc === 48) return { years: 62, months: 0 };
    if (roc === 49) return { years: 63, months: 0 };
    if (roc === 50) return { years: 64, months: 0 };
    return { years: 65, months: 0 };
  },
  maxAdjYears: 5,
  adjPerYear: 0.04
};

function $(id){ return document.getElementById(id); }
function fmt(n){ try { return Number(n).toLocaleString("en-US"); } catch { return String(n); } }
function money(v){ const n = Number(String(v||"").replace(/[,ï¼Œ\s]/g,"")); return Number.isFinite(n) ? n : NaN; }
function clampInt(v){ if(!Number.isFinite(v)) return NaN; return Math.max(0, Math.floor(v)); }
function showWarn(msg){ const w=$("warnBox"); if(!msg){w.style.display="none";w.textContent="";return;} w.style.display="block"; w.textContent=msg; }
function showOk(msg){ const o=$("okBox"); if(!msg){o.style.display="none";o.textContent="";return;} o.style.display="block"; o.textContent=msg; }
function hideOutput(){ $("output").style.display="none"; $("output").innerHTML=""; }
function resetMsgs(){ showWarn(""); showOk(""); }

/* ---------- å¹´é½¡/æ—¥æœŸ/å¹´è³‡å·¥å…· ---------- */
function ageToMonths(y,m){ return clampInt(y)*12 + clampInt(m); }
function birthDateToRocYear(d){ return d.getFullYear() - 1911; }

function calcAgeMonths(birthDate, today){
  let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
  if (today.getDate() < birthDate.getDate()) months -= 1;
  return Math.max(0, months);
}
function calcDateAtAge(birthDate, targetAgeMonths){
  const d = new Date(birthDate.getTime());
  d.setMonth(d.getMonth() + targetAgeMonths);
  return d;
}
function monthsBetween(today, future){
  let m = (future.getFullYear()-today.getFullYear())*12 + (future.getMonth()-today.getMonth());
  if (future.getDate() < today.getDate()) m -= 1;
  return Math.max(0, m);
}
function insToMonths(years, months, days){
  const y=clampInt(Number(years)), m=clampInt(Number(months)), d=clampInt(Number(days));
  if([y,m,d].some(v => !Number.isFinite(v))) return NaN;
  if(m>11 || d>30) return NaN;
  const extraMonth = (d > 0) ? 1 : 0;
  return y*12 + m + extraMonth;
}
function adjustFactor(legalMonths, claimMonths){
  const diffMonths = claimMonths - legalMonths; // >0å±•å»¶ <0ææ—©
  const rawYears = diffMonths / 12;
  const cappedYears = Math.max(-RULES.maxAdjYears, Math.min(RULES.maxAdjYears, rawYears));
  const factor = 1 + cappedYears * RULES.adjPerYear;
  return { factor, diffMonths, rawYears, cappedYears };
}

/* ---------- è–ªè³‡æ˜ç´° ---------- */
function parseSalaryLines(text){
  const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const dated = [];
  const seq = [];
  for(const line of lines){
    const m = line.match(/^(\d{4})[\/\-](\d{1,2})[^\d]+([\d,ï¼Œ]+(\.\d+)?)$/);
    if(m){
      const yyyy=Number(m[1]), mm=Number(m[2]);
      const sal=money(m[3]);
      if(!Number.isFinite(yyyy)||!Number.isFinite(mm)||mm<1||mm>12||!Number.isFinite(sal)||sal<=0) continue;
      dated.push({ key: yyyy*12+mm, salary: sal });
      continue;
    }
    const sal = money(line);
    if(Number.isFinite(sal) && sal>0) seq.push(sal);
  }
  if(dated.length){
    const map=new Map();
    for(const it of dated) map.set(it.key, it.salary); // åŒæœˆå–æœ€å¾Œä¸€ç­†
    const arr=[...map.entries()].sort((a,b)=>a[0]-b[0]).map(([k,s])=>s);
    return { mode:"dated", salaries: arr, count: arr.length };
  }
  return { mode:"sequence", salaries: seq, count: seq.length };
}
function avgTop60(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  if(n<60){
    const sum=salaries.reduce((a,b)=>a+b,0);
    return { avg: sum/n, rule:"æœªæ»¿60å€‹æœˆï¼šç”¨å¯¦éš›æœŸé–“å¹³å‡ï¼ˆå¹´é‡‘/ä¸€æ¬¡é‡‘60æœˆåˆ¶ï¼‰" };
  }
  const top = salaries.slice().sort((a,b)=>b-a).slice(0,60);
  const sum=top.reduce((a,b)=>a+b,0);
  return { avg: sum/60, rule:"æœ€é«˜60å€‹æœˆå¹³å‡" };
}
function avgLast36(salaries){
  if(!salaries || salaries.length===0) return { avg:NaN, rule:"" };
  const n=salaries.length;
  const used = (n<=36) ? salaries.slice() : salaries.slice(n-36);
  const sum=used.reduce((a,b)=>a+b,0);
  return { avg: sum/used.length, rule:(n<36) ? "æœªæ»¿36å€‹æœˆï¼šç”¨å¯¦éš›æœŸé–“å¹³å‡ï¼ˆä¸€æ¬¡è«‹é ˜36æœˆåˆ¶ï¼‰" : "æœ€è¿‘36å€‹æœˆå¹³å‡" };
}

/* ---------- åˆ¶åº¦è¨ˆç®—ï¼šå¹´é‡‘ ---------- */
function calcPension(avgSalary60, insMonths, factor){
  const insYears = insMonths / 12; // å¹´è³‡ä¸è¶³1å¹´æŒ‰æ¯”ä¾‹ï¼ˆä»¥æœˆï¼‰
  const base1 = avgSalary60 * insYears * 0.00775 + 3000;
  const base2 = avgSalary60 * insYears * 0.0155;
  const chosenBase = Math.max(base1, base2);
  const chosen = (base1 >= base2) ? "å¼1ï¼ˆ0.775%Ã—å¹´è³‡ + 3000ï¼‰" : "å¼2ï¼ˆ1.55%Ã—å¹´è³‡ï¼‰";
  const finalMonthly = Math.round(chosenBase * factor);
  return { base1, base2, chosenBase, chosen, finalMonthly };
}

/* ---------- åˆ¶åº¦è¨ˆç®—ï¼šè€å¹´ä¸€æ¬¡é‡‘ï¼ˆ60æœˆå¹³å‡ Ã— å¹´è³‡(1å€ï¼Œæœˆæ¯”ä¾‹)ï¼›60å¾Œæœ€å¤š5å¹´ï¼‰ ---------- */
function calcOldAgeLump60(avgSalary60, insMonthsTotal, after60MonthsInput){
  // 60å¾Œæœ€å¤š5å¹´ï¼ˆ60æœˆï¼‰
  const after60 = Math.min(Math.max(0, after60MonthsInput), 60);
  const pre60 = Math.max(0, insMonthsTotal - after60);

  // çµ¦ä»˜æœˆæ•¸ï¼šæ¯æ»¿1å¹´=1æœˆï¼›æœªæ»¿1å¹´æŒ‰æœˆæ¯”ä¾‹ï¼ˆinsMonths/12ï¼‰
  const benefitMonths = (pre60/12) + (after60/12);
  const amount = Math.round(avgSalary60 * benefitMonths);
  return { benefitMonths, amount, capAfter60Months: 60 };
}

/* ---------- åˆ¶åº¦è¨ˆç®—ï¼šä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆ36æœˆå¹³å‡ Ã— (1å€+2å€ï¼Œä¸Šé™45/50)ï¼‰ ---------- */
function calcOneTimeOldAgeLump36(avgSalary36, insMonthsTotal, after60MonthsInput, claimBefore60){
  const after60MonthsCapped = Math.min(Math.max(0, after60MonthsInput), 60); // æœ€å¤š5å¹´
  const after60Months = claimBefore60 ? 0 : after60MonthsCapped;

  let pre60Months = Math.max(0, insMonthsTotal - after60Months);
  const pre60Years = pre60Months / 12;

  const y1 = Math.min(15, pre60Years);
  const y2 = Math.max(0, pre60Years - 15);

  const benefitPre60 = Math.min(y1*1 + y2*2, 45);

  const benefitAfter60 = after60Months / 12; // 0~5
  const cap = claimBefore60 ? 45 : 50;
  const benefitMonths = Math.min(benefitPre60 + benefitAfter60, cap);

  const amount = Math.round(avgSalary36 * benefitMonths);
  return { benefitMonths, amount, cap };
}

/* ---------- 98å‰å¾Œåˆ¤æ–·ï¼ˆè‡ªå‹•ï¼‰ ---------- */
function isPre98(){
  const dStr = ($("firstInsuredDate").value || "").trim();
  if(dStr){
    const d = new Date(dStr + "T00:00:00");
    if(!isNaN(d.getTime())) return d < DATE_98;
  }
  const manual = $("pre98Manual").value;
  if(manual === "yes") return true;
  if(manual === "no") return false;
  // auto but no date -> unknownï¼Œä¿å®ˆå…ˆç•¶ä½œ falseï¼ˆé¿å…éŒ¯çµ¦ä¸€æ¬¡è«‹é ˜è³‡æ ¼ï¼‰
  return false;
}

/* ---------- å¹´é‡‘/ä¸€æ¬¡é‡‘/ä¸€æ¬¡è«‹é ˜è³‡æ ¼åˆ¤æ–·ï¼ˆä¾ä½ æä¾›çš„è¦å‰‡åšã€Œå¯è¼¸å…¥åƒæ•¸åŒ–ã€ï¼‰ ---------- */
function determineEligibility(opts){
  const {
    pre98,
    claimAgeMonths,
    legalAgeMonthsNormal,
    specialWork15, // 55æ­²å¹´é‡‘
    insMonthsAtClaim,
    combineNP,
    npMonths,
    isFemale,
    sameUnitMonths,
    specialWorkMonths5
  } = opts;

  const claimAgeYears = claimAgeMonths / 12;

  // å¹´é‡‘/è€å¹´ä¸€æ¬¡é‡‘æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¸€èˆ¬ä¾å‡ºç”Ÿå¹´æ¬¡ï¼›è‹¥ç‰¹æ®Šå·¥ä½œ15å¹´ â†’ 55æ­²ï¼‰
  const legalAgeMonths = (specialWork15) ? ageToMonths(55,0) : legalAgeMonthsNormal;

  // 1) è€å¹´å¹´é‡‘çµ¦ä»˜è³‡æ ¼ï¼ˆç°¡åŒ–æˆä¸‰è·¯ï¼‰
  const eligiblePension_1 = (claimAgeMonths >= legalAgeMonths) && (insMonthsAtClaim >= 15*12);
  const eligiblePension_2 = (specialWork15 && claimAgeMonths >= ageToMonths(55,0) && insMonthsAtClaim >= 15*12);
  const eligiblePension_3 = (combineNP && insMonthsAtClaim < 15*12 && (insMonthsAtClaim + npMonths) >= 15*12 && claimAgeMonths >= ageToMonths(65,0));
  const eligiblePension = eligiblePension_1 || eligiblePension_2 || eligiblePension_3;

  // 2) è€å¹´ä¸€æ¬¡é‡‘ï¼ˆ98å¾Œå¸¸è¦‹è·¯å¾‘ï¼‰ï¼šå¹´æ»¿æ³•å®šè«‹é ˜å¹´é½¡ä¸”å¹´è³‡æœªæ»¿15å¹´
  const eligibleOldAgeLump = (claimAgeMonths >= legalAgeMonths) && (insMonthsAtClaim < 15*12);

  // 3) ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆåƒ… pre98 æ‰å¯èƒ½ï¼‰ï¼šéœ€ç¬¦åˆå…¶ä¸€æ¢ä»¶ï¼ˆç”¨è¼¸å…¥åƒæ•¸åˆ¤æ–·ï¼‰
  //    ä½ æä¾›çš„æ¢ä»¶ï¼ˆé€™è£¡åšæˆå¯è¨ˆç®—ï¼‰
  const cond1 = (insMonthsAtClaim >= 12) && (claimAgeMonths >= ageToMonths(60,0) || (isFemale && claimAgeMonths >= ageToMonths(55,0)));
  const cond2 = (insMonthsAtClaim >= 15*12) && (claimAgeMonths >= ageToMonths(55,0));
  const cond3 = (sameUnitMonths >= 25*12); // åŒä¸€æŠ•ä¿å–®ä½å¹´è³‡åˆè¨ˆæ»¿25å¹´é€€è·
  const cond4 = (insMonthsAtClaim >= 25*12) && (claimAgeMonths >= ageToMonths(50,0));
  const cond5 = (specialWorkMonths5 >= 5*12) && (claimAgeMonths >= ageToMonths(55,0));

  const eligibleOneTime = pre98 && (cond1 || cond2 || cond3 || cond4 || cond5);

  return {
    legalAgeMonths,
    eligiblePension,
    eligibleOldAgeLump,
    eligibleOneTime,
    oneTimeConditions: { cond1, cond2, cond3, cond4, cond5 }
  };
}

/* ===================== è²¡å‹™æ¨¡æ“¬ï¼ˆç¼ºå£å¼•æ“ï¼‰ ===================== */
/*
è³‡ç”¢æ±  principalï¼šå¯æŠ•è³‡éƒ¨åˆ†
æº–å‚™é‡‘ reserveCashï¼šä¸å†æŠ•å…¥çš„è‚¡æ¯/å‚µæ¯ï¼Œç•™åšç¾é‡‘ï¼ˆåˆ©ç‡=0ï¼Œä¿å®ˆï¼‰
é€€ä¼‘å‰ï¼š
  principal æ¯æœˆå¢å€¼ + æ¯æœˆæŠ•å…¥ + ï¼ˆè‹¥å†æŠ•å…¥ï¼šè‚¡æ¯/å‚µæ¯ä¹ŸåŠ å›principalï¼›è‹¥ä¸æŠ•å…¥ï¼šç´¯ç©åˆ°reserveCashï¼‰
é€€ä¼‘å¾Œï¼š
  ç¾é‡‘æµ = å‹ä¿ï¼ˆæœˆé ˜ï¼‰ + å…¶ä»–æ”¶å…¥ + æˆ¿ç§Ÿ + ï¼ˆè‹¥é¸ã€Œæ‹¿ä¾†ç”Ÿæ´»ã€ï¼šè‚¡æ¯/å‚µæ¯ï¼‰
  æ”¯å‡ºï¼ˆé€šè†¨ï¼‰æ‰£é™¤ç¾é‡‘æµå¾Œä¸è¶³ â†’ å…ˆç”¨reserveCashï¼Œå†æé ˜principal
  è‹¥é¸ã€Œè‚¡æ¯/å‚µæ¯å†æŠ•å…¥ã€ï¼šè‚¡æ¯/å‚µæ¯ä¸ä½œæ”¶å…¥ï¼Œç›´æ¥åŠ å›principal
ä¸€æ¬¡çµ¦ä»˜æƒ…å¢ƒï¼š
  åœ¨è«‹é ˜æ™‚é»ï¼ˆé€€ä¼‘/è«‹é ˜æœˆï¼‰ï¼ŒæŠŠä¸€æ¬¡é‡‘åŠ åˆ° principalï¼ˆè¦–ç‚ºå¯æŠ•è³‡ï¼‰
*/
function annualToMonthlyRate(r){ return (1 + r) ** (1/12) - 1; }

function simulatePlan(params){
  const {
    monthsToRetire, monthsRetired,
    principal0, reserve0,
    contribMonthly, reinvestPre,
    divPre, bondPre, growthPre,
    reinvestPostMode,
    divPost, bondPost, growthPost,
    rentMonthly, otherIncomeMonthlyAtRetire,
    laborMonthlyAtRetire,
    needMonthlyToday, inflation,
    postContribMode, postContribMonthly,
    lumpSumAtRetire // ä¸€æ¬¡çµ¦ä»˜åœ¨é€€ä¼‘/è«‹é ˜é»æ³¨å…¥ principal
  } = params;

  let principal = principal0;
  let reserve = reserve0;

  const gPreM = annualToMonthlyRate(growthPre);
  const dPreM = (divPre/12);
  const bPreM = (bondPre/12);

  // é€€ä¼‘å‰é€æœˆ
  for(let t=0; t<monthsToRetire; t++){
    principal = principal * (1 + gPreM);

    const divInc = principal * dPreM;
    const bondInc = principal * bPreM;

    if(reinvestPre){
      principal += (divInc + bondInc);
    }else{
      reserve += (divInc + bondInc);
    }

    principal += contribMonthly;
  }

  // é€€ä¼‘/è«‹é ˜é»ï¼šä¸€æ¬¡é‡‘æ³¨å…¥
  if(Number.isFinite(lumpSumAtRetire) && lumpSumAtRetire > 0){
    principal += lumpSumAtRetire;
  }

  const principalAtRetire = principal;
  const reserveAtRetire = reserve;
  const totalAtRetire = principalAtRetire + reserveAtRetire;

  const infM = annualToMonthlyRate(inflation);
  let needM = needMonthlyToday * ((1 + infM) ** monthsToRetire);
  let otherIncomeM = otherIncomeMonthlyAtRetire;

  const gPostM = annualToMonthlyRate(growthPost);
  const dPostM = (divPost/12);
  const bPostM = (bondPost/12);

  let brokeMonth = null;
  let minTotal = totalAtRetire;

  for(let k=0; k<monthsRetired; k++){
    if(k>0) needM *= (1 + infM);

    principal = principal * (1 + gPostM);

    const divInc = principal * dPostM;
    const bondInc = principal * bPostM;

    let incomeFromYields = 0;
    if(reinvestPostMode === "reinvest"){
      principal += (divInc + bondInc);
    }else{
      incomeFromYields = divInc + bondInc;
    }

    const postContrib = (postContribMode === "yes") ? postContribMonthly : 0;
    principal += postContrib;

    const income = laborMonthlyAtRetire + otherIncomeM + rentMonthly + incomeFromYields;

    let gap = needM - income;

    if(gap <= 0){
      reserve += (-gap);
    }else{
      const useReserve = Math.min(reserve, gap);
      reserve -= useReserve;
      gap -= useReserve;

      if(gap > 0){
        principal -= gap;
      }
    }

    const total = principal + reserve;
    if(total < minTotal) minTotal = total;

    if(principal < 0){
      brokeMonth = k + 1;
      break;
    }
  }

  return {
    ok: brokeMonth === null,
    principalAtRetire, reserveAtRetire, totalAtRetire,
    principalEnd: principal, reserveEnd: reserve, totalEnd: principal + reserve,
    brokeMonth,
    minTotal
  };
}

/* åæ¨å·®é¡ï¼šé€€ä¼‘å‰æ¯æœˆéœ€å¤šå­˜å¤šå°‘ï¼ˆç”¨äºŒåˆ†æœå°‹ï¼‰ */
function solveExtraContribution(baseParams){
  const base = simulatePlan(baseParams);
  if(base.ok) return { extra: 0, base, final: base };

  let lo = 0, hi = 300000; // ä¸Šé™å¯è‡ªè¡Œèª¿å¤§
  for(let i=0;i<32;i++){
    const mid = (lo+hi)/2;
    const test = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + mid });
    if(test.ok) hi = mid; else lo = mid;
  }
  const extra = Math.ceil(hi);
  const final = simulatePlan({ ...baseParams, contribMonthly: baseParams.contribMonthly + extra });
  return { extra, base, final };
}

/* åæ¨å·®é¡ï¼šé€€ä¼‘å¾Œæ¯æœˆç”Ÿæ´»è²»éœ€å°‘å¤šå°‘ï¼ˆç”¨äºŒåˆ†æœå°‹ï¼‰ */
function solveExpenseCut(baseParams){
  const base = simulatePlan(baseParams);
  if(base.ok) return { cut: 0, base, final: base };

  let lo = 0, hi = Math.max(0, baseParams.needMonthlyToday);
  for(let i=0;i<32;i++){
    const mid = (lo+hi)/2;
    const test = simulatePlan({ ...baseParams, needMonthlyToday: Math.max(0, baseParams.needMonthlyToday - mid) });
    if(test.ok) hi = mid; else lo = mid;
  }
  const cut = Math.ceil(hi);
  const final = simulatePlan({ ...baseParams, needMonthlyToday: Math.max(0, baseParams.needMonthlyToday - cut) });
  return { cut, base, final };
}

/* ---------- Level 1ï¼šæ‰“å¹³å¹´é½¡ï¼ˆç°¡åŒ–ï¼šåç›®ã€å›ºå®šæœˆé ˜ï¼Œä¸å«æŠ•è³‡æ”¶ç›Šï¼‰ ---------- */
function breakevenAgeYears(claimAgeMonths, monthlyPension, lumpSum){
  if(!(monthlyPension>0) || !(lumpSum>0)) return null;
  const months = Math.ceil(lumpSum / monthlyPension);
  const beMonths = claimAgeMonths + months;
  return { months, beAgeYears: (beMonths/12) };
}

/* ---------- Level 2ï¼šå®‰å…¨é‚Šéš›ï¼ˆå¸‚å ´å›å ±-2%ã€é€šè†¨+1%ï¼‰ ---------- */
function buildStressParams(baseParams){
  return {
    ...baseParams,
    growthPre: baseParams.growthPre - 0.02,
    growthPost: baseParams.growthPost - 0.02,
    inflation: baseParams.inflation + 0.01
  };
}
function surviveText(sim, retireY, retireM, lifeExp){
  const retireAge = retireY + retireM/12;
  if(sim.ok){
    return { badge:"ok", text:`æ’åˆ° ${lifeExp} æ­²ï¼ˆæ¨¡æ“¬çµæŸä»æœªæ­¸é›¶ï¼‰` };
  }
  const yearsAfter = sim.brokeMonth/12;
  const ageAtBroke = retireAge + yearsAfter;
  return { badge:"no", text:`ç´„æ’åˆ° ${ageAtBroke.toFixed(1)} æ­²ï¼ˆé€€ä¼‘å¾Œç´„ ${yearsAfter.toFixed(1)} å¹´ï¼‰` };
}

/* ===================== ä¸»æµç¨‹ ===================== */
function calcAll(){
  resetMsgs(); hideOutput();

  const today = new Date();
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  const birthDate = new Date($("birthDate").value + "T00:00:00");
  if(isNaN(birthDate.getTime())){ alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´æœˆæ—¥"); return; }

  const retireY = clampInt(Number($("retireYears").value));
  const retireM = clampInt(Number($("retireMonths").value));
  if(!Number.isFinite(retireY) || retireM>11){ alert("é€€ä¼‘å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }

  const claimY = clampInt(Number($("claimYears").value));
  const claimM = clampInt(Number($("claimMonths").value));
  if(!Number.isFinite(claimY) || claimM>11){ alert("è«‹é ˜å¹´é½¡è¼¸å…¥éŒ¯èª¤"); return; }

  const lifeExp = Number($("lifeExpectancy").value);
  if(!Number.isFinite(lifeExp) || lifeExp <= 0){ alert("é è¨ˆå£½å‘½è¼¸å…¥éŒ¯èª¤"); return; }

  const insNowMonths = insToMonths($("insYearsNow").value, $("insMonthsNow").value, $("insDaysNow").value);
  if(!Number.isFinite(insNowMonths) || insNowMonths<=0){ alert("æŠ•ä¿å¹´è³‡éœ€å¤§æ–¼0"); return; }

  const keepInsured = $("keepInsured").value === "yes";

  const ageNowMonths = calcAgeMonths(birthDate, today);

  const retireAgeMonths = ageToMonths(retireY, retireM);
  const retireDate = calcDateAtAge(birthDate, retireAgeMonths);
  const monthsToRetire = monthsBetween(today, retireDate);

  // é€€ä¼‘æ™‚å¹´è³‡ï¼ˆæ­¤è™•ç”¨é€€ä¼‘é»ï¼›è«‹é ˜é»è‹¥ä¸åŒï¼Œä»æ¡åŒä¸€å¥—å¹´è³‡ä¼°ç®—ï¼Œå¯¦å‹™å¯å†æ“´å……ï¼‰
  const insAtRetireMonths = keepInsured ? (insNowMonths + monthsToRetire) : insNowMonths;

  // è–ªè³‡ï¼šå„ªå…ˆæ˜ç´°
  const detail = parseSalaryLines($("salaryLines")?.value || "");
  let avgPension60 = money($("avgSalaryPension").value);
  let avgLump36 = money($("avgSalaryLump36").value);
  let salaryNote = "";

  if(detail.count){
    const p60 = avgTop60(detail.salaries);
    const l36 = avgLast36(detail.salaries);
    avgPension60 = p60.avg;
    avgLump36 = l36.avg;
    salaryNote = `å·²ä½¿ç”¨æ˜ç´°ï¼š${p60.rule} / ${l36.rule}ï¼ˆå…±${detail.count}ç­†ï¼‰`;
  }else{
    if(!Number.isFinite(avgPension60) || avgPension60<=0 || !Number.isFinite(avgLump36) || avgLump36<=0){
      alert("æœªè²¼æ˜ç´°æ™‚ï¼Œè«‹å¡«ï¼šå¹´é‡‘å¹³å‡è–ªè³‡ï¼ˆ60æœˆï¼‰èˆ‡ä¸€æ¬¡è«‹é ˜å¹³å‡è–ªè³‡ï¼ˆ36æœˆï¼‰");
      return;
    }
    salaryNote = "æœªè²¼æ˜ç´°ï¼šä½¿ç”¨ä½ è¼¸å…¥çš„å…©å€‹å¹³å‡è–ªè³‡";
  }

  // 98å‰å¾Œ
  const pre98 = isPre98();

  // æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¸€èˆ¬ï¼‰
  const rocBirthYear = birthDateToRocYear(birthDate);
  const legal = RULES.legalAgeByBirthRoc(rocBirthYear);
  const legalMonthsNormal = ageToMonths(legal.years, legal.months);
  const claimMonthsTotal = ageToMonths(claimY, claimM);

  // é€²éšæ¢ä»¶
  const specialWork15 = ($("specialWork15").value === "yes");
  const combineNP = ($("combineNP").value === "yes");
  const npMonths = insToMonths($("npYears").value, $("npMonths").value, 0) || 0;

  const isFemale = ($("isFemale").value === "yes");
  const sameUnitMonths = insToMonths($("sameUnitYears").value, $("sameUnitMonths").value, 0) || 0;
  const specialWorkMonths5 = insToMonths($("specialWorkYears5").value, $("specialWorkMonths5").value, 0) || 0;

  // è³‡æ ¼åˆ¤æ–·
  const elig = determineEligibility({
    pre98,
    claimAgeMonths: claimMonthsTotal,
    legalAgeMonthsNormal,
    specialWork15,
    insMonthsAtClaim: insAtRetireMonths,
    combineNP,
    npMonths,
    isFemale,
    sameUnitMonths,
    specialWorkMonths5
  });

  // ææ—©/å±•å»¶ä¿‚æ•¸ï¼ˆå¹´é‡‘æ‰ç”¨ï¼‰
  const adj = adjustFactor(elig.legalAgeMonths, claimMonthsTotal);

  // å¹´é‡‘é‡‘é¡
  const pension = elig.eligiblePension ? calcPension(avgPension60, insAtRetireMonths, adj.factor) : null;
  const laborMonthlyPension = pension ? pension.finalMonthly : 0;

  // è€å¹´ä¸€æ¬¡é‡‘ï¼ˆ98å¾Œå¸¸è¦‹ï¼›ä¹Ÿå¯è¦–ç‚ºâ€œå¹´è³‡æœªæ»¿15å¹´â€çš„ä¸€æ¬¡çµ¦ä»˜ï¼‰
  const after60MonthsInput = insToMonths($("insAfter60Years").value, $("insAfter60Months").value, 0) || 0;
  const oldAgeLump = elig.eligibleOldAgeLump ? calcOldAgeLump60(avgPension60, insAtRetireMonths, after60MonthsInput) : null;

  // ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼ˆåƒ… pre98 ä¸”ç¬¦åˆæ¢ä»¶ï¼‰
  const claimBefore60 = ($("claimBefore60").value === "yes");
  const oneTime = elig.eligibleOneTime ? calcOneTimeOldAgeLump36(avgLump36, insAtRetireMonths, after60MonthsInput, claimBefore60) : null;

  // è²¡å‹™åƒæ•¸
  const principal0 = Math.max(0, money($("assetNow").value) || 0);
  const contribMonthly = Math.max(0, money($("contribMonthly").value) || 0);

  const divPre = Math.max(0, Number($("divPre").value) || 0) / 100;
  const bondPre = Math.max(0, Number($("bondPre").value) || 0) / 100;
  const growthPre = Number($("growthPre").value || 0) / 100;

  const divPost = Math.max(0, Number($("divPost").value) || 0) / 100;
  const bondPost = Math.max(0, Number($("bondPost").value) || 0) / 100;
  const growthPost = Number($("growthPost").value || 0) / 100;

  const reinvestPre = ($("reinvestPre").value === "yes");
  const reinvestPostMode = $("reinvestPost").value; // spend / reinvest

  const rentMonthly = Math.max(0, money($("rentMonthly").value) || 0);
  const otherIncomeMonthly = Math.max(0, money($("otherIncomeMonthly").value) || 0);

  const needMonthlyToday = Math.max(0, money($("needMonthlyToday").value) || 0);
  const inflation = Math.max(0, Number($("inflation").value) || 0) / 100;

  const postContribMode = $("postContribMode").value; // yes/no
  const postContribMonthly = Math.max(0, money($("postContribMonthly").value) || 0);

  // é€€ä¼‘å¾ŒæœŸé–“ï¼ˆæœˆï¼‰
  const retireAge = retireY + retireM/12;
  const monthsRetired = Math.max(0, Math.floor((lifeExp - retireAge) * 12));

  // å…¶ä»–æ”¶å…¥æ¨åˆ°é€€ä¼‘ï¼ˆåç›®ï¼‰ï¼šç”¨é€šè†¨æœˆåŒ–æ¨
  const infM = annualToMonthlyRate(inflation);
  const otherIncomeMonthlyAtRetire = otherIncomeMonthly * ((1 + infM) ** monthsToRetire);

  // ç‚ºäº†ã€Œåˆ¶åº¦æ¯”è¼ƒã€ï¼šåŒä¸€å¥—æŠ•è³‡å‡è¨­ä¸‹ï¼Œè·‘ä¸‰å€‹æƒ…å¢ƒï¼ˆå¹´é‡‘ / è€å¹´ä¸€æ¬¡é‡‘ / ä¸€æ¬¡è«‹é ˜ï¼‰
  // A) å¹´é‡‘æƒ…å¢ƒï¼šæœˆé ˜ = laborMonthlyPensionï¼›ä¸€æ¬¡é‡‘æ³¨å…¥=0
  const baseA = {
    monthsToRetire, monthsRetired,
    principal0, reserve0: 0,
    contribMonthly, reinvestPre,
    divPre, bondPre, growthPre,
    reinvestPostMode,
    divPost, bondPost, growthPost,
    rentMonthly, otherIncomeMonthlyAtRetire,
    laborMonthlyAtRetire: laborMonthlyPension,
    needMonthlyToday, inflation,
    postContribMode, postContribMonthly,
    lumpSumAtRetire: 0
  };

  // B) è€å¹´ä¸€æ¬¡é‡‘æƒ…å¢ƒï¼šæœˆé ˜=0ï¼›ä¸€æ¬¡é‡‘æ³¨å…¥=oldAgeLump.amount
  const baseB = {
    ...baseA,
    laborMonthlyAtRetire: 0,
    lumpSumAtRetire: oldAgeLump ? oldAgeLump.amount : 0
  };

  // C) ä¸€æ¬¡è«‹é ˜æƒ…å¢ƒï¼šæœˆé ˜=0ï¼›ä¸€æ¬¡é‡‘æ³¨å…¥=oneTime.amount
  const baseC = {
    ...baseA,
    laborMonthlyAtRetire: 0,
    lumpSumAtRetire: oneTime ? oneTime.amount : 0
  };

  const simA = simulatePlan(baseA);
  const simB = simulatePlan(baseB);
  const simC = simulatePlan(baseC);

  // å·®é¡åæ¨ï¼ˆä»¥â€œå¹´é‡‘æƒ…å¢ƒâ€åšä¸»æƒ…å¢ƒï¼›è‹¥ä¸ç¬¦å¹´é‡‘ï¼Œå°±ç”¨â€œå¯ç”¨çš„ä¸€æ¬¡é‡‘æƒ…å¢ƒâ€ï¼‰
  let mainMode = "pension";
  let mainParams = baseA;
  let mainSim = simA;

  if(!elig.eligiblePension){
    if(oldAgeLump){
      mainMode = "oldlump";
      mainParams = baseB;
      mainSim = simB;
    }else if(oneTime){
      mainMode = "onetime";
      mainParams = baseC;
      mainSim = simC;
    }else{
      // éƒ½ä¸ç¬¦ï¼šä»å¯è·‘ç´”æŠ•è³‡/ç¾é‡‘æµï¼ˆå‹ä¿=0ï¼‰
      mainMode = "none";
      mainParams = { ...baseA, laborMonthlyAtRetire: 0 };
      mainSim = simulatePlan(mainParams);
    }
  }

  const solveSave = solveExtraContribution(mainParams);
  const solveCut  = solveExpenseCut(mainParams);

  // é€€ä¼‘ç•¶ä¸‹ç¼ºå£ï¼ˆä»¥ä¸»æƒ…å¢ƒçš„â€œæœˆé ˜/ä¸€æ¬¡é‡‘æ³¨å…¥â€è¨ˆç®—é€€ä¼‘ç•¶ä¸‹ç¾é‡‘æµï¼‰
  const retireDateStr = `${retireDate.getFullYear()}-${String(retireDate.getMonth()+1).padStart(2,"0")}-${String(retireDate.getDate()).padStart(2,"0")}`;
  const infToRetire = (1 + infM) ** monthsToRetire;
  const needAtRetire = needMonthlyToday * infToRetire;

  const principalAtRetireMain = mainSim.principalAtRetire;
  const divInc0 = principalAtRetireMain * (divPost/12);
  const bondInc0 = principalAtRetireMain * (bondPost/12);
  const incomeFromYields0 = (reinvestPostMode === "spend") ? (divInc0 + bondInc0) : 0;

  const laborMain = mainParams.laborMonthlyAtRetire || 0;
  const incomeAtRetire =
    laborMain +
    otherIncomeMonthlyAtRetire +
    rentMonthly +
    incomeFromYields0;

  const gapAtRetire = Math.max(0, needAtRetire - incomeAtRetire);

  // Level 1ï¼šæ‰“å¹³å¹´é½¡ï¼ˆå¹´é‡‘ vs ä¸€æ¬¡é‡‘ï¼‰
  const beOld = (oldAgeLump && laborMonthlyPension>0) ? breakevenAgeYears(claimMonthsTotal, laborMonthlyPension, oldAgeLump.amount) : null;
  const beOne = (oneTime && laborMonthlyPension>0) ? breakevenAgeYears(claimMonthsTotal, laborMonthlyPension, oneTime.amount) : null;

  // Level 2ï¼šå®‰å…¨é‚Šéš›ï¼ˆä¸»æƒ…å¢ƒ + å£“åŠ›æ¸¬è©¦ï¼‰
  const stressParams = buildStressParams(mainParams);
  const simStress = simulatePlan(stressParams);

  const sBase = surviveText(mainSim, retireY, retireM, lifeExp);
  const sStress = surviveText(simStress, retireY, retireM, lifeExp);

  // æ–‡æ¡ˆï¼šææ—©/å±•å»¶
  const diffText = (adj.diffMonths === 0) ? "ä¾æ³•å®šå¹´é½¡è«‹é ˜ï¼ˆä¸åŠ æ¸›çµ¦ï¼‰"
    : (adj.diffMonths > 0) ? `å±•å»¶ ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼Œå°é ‚Â±20%ï¼‰`
    : `ææ—© ${Math.abs(adj.diffMonths)} å€‹æœˆï¼ˆä¿‚æ•¸Ã—${adj.factor.toFixed(3)}ï¼Œå°é ‚Â±20%ï¼‰`;

  // é¡¯ç¤ºè³‡æ ¼æ‘˜è¦
  const pre98Txt = pre98 ? `<span class="badge ok">98/01/01 å‰å·²æœ‰å¹´è³‡</span>` : `<span class="badge no">98/01/01 å¾Œæ‰é¦–æ¬¡æŠ•ä¿ï¼ˆä¸€æ¬¡è«‹é ˜é€šå¸¸ä¸å¯ç”¨ï¼‰</span>`;
  const badge = (b, okTxt="ç¬¦åˆ", noTxt="ä¸ç¬¦åˆ") => b ? `<span class="badge ok">${okTxt}</span>` : `<span class="badge no">${noTxt}</span>`;

  // ä¸»çµè«–æ¨™é¡Œ
  const mainTitle = (mainMode==="pension") ? "ä»¥ã€Œå¹´é‡‘ã€ä½œç‚ºä¸»æƒ…å¢ƒ"
    : (mainMode==="oldlump") ? "ä»¥ã€Œè€å¹´ä¸€æ¬¡é‡‘ã€ä½œç‚ºä¸»æƒ…å¢ƒ"
    : (mainMode==="onetime") ? "ä»¥ã€Œä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ã€ä½œç‚ºä¸»æƒ…å¢ƒ"
    : "ä»¥ã€Œä¸å«å‹ä¿ã€ä½œç‚ºä¸»æƒ…å¢ƒ";

  const extraSaveText = (solveSave.extra<=0)
    ? "ä¸éœ€è¦é¡å¤–å¢åŠ é€€ä¼‘å‰æŠ•å…¥ã€‚"
    : `è‹¥è¦æ’åˆ° ${lifeExp} æ­²ï¼Œåœ¨åŒæ¨£å‡è¨­ä¸‹ï¼šé€€ä¼‘å‰æ¯æœˆéœ€ã€Œå†å¤šå­˜ã€ç´„ NT$ ${fmt(solveSave.extra)}ã€‚`;

  const cutText = (solveCut.cut<=0)
    ? "ç”Ÿæ´»è²»ä¸éœ€è¦èª¿é™ã€‚"
    : `æˆ–ï¼šæŠŠã€Œä»Šå¤©åƒ¹å€¼çš„ç”Ÿæ´»è²»ã€æ¯æœˆèª¿é™ç´„ NT$ ${fmt(solveCut.cut)}ï¼ˆå…¶ä»–å‡è¨­ä¸è®Šï¼‰ã€‚`;

  // Output
  const out = $("output");
  out.style.display="block";

  out.innerHTML = `
    <div class="kpi">
      <div class="kpi-box">
        <div class="kpi-title">ä¸»æƒ…å¢ƒï¼ˆ${mainTitle}ï¼‰</div>
        <div class="kpi-value">é€€ä¼‘æ™‚ç¸½è³‡ç”¢ï¼šNT$ ${fmt(Math.round(mainSim.totalAtRetire))}</div>
        <div class="kpi-sub">
          é€€ä¼‘æ—¥æœŸï¼ˆä¼°ï¼‰ï¼š${retireDateStr}<br/>
          Level 2 åŸºæº–ï¼š<span class="badge ${sBase.badge}">${sBase.text}</span><br/>
          Level 2 å£“åŠ›ï¼ˆå›å ±-2%ã€é€šè†¨+1%ï¼‰ï¼š<span class="badge ${sStress.badge}">${sStress.text}</span>
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">å·®é¡é …ï¼ˆæœ€é‡è¦ï¼‰</div>
        <div class="kpi-value">é€€ä¼‘ç•¶ä¸‹æ¯æœˆç¼ºå£ï¼šNT$ ${fmt(Math.round(gapAtRetire))}</div>
        <div class="kpi-sub">
          ${extraSaveText}<br/>${cutText}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">åˆ¶åº¦è³‡æ ¼è‡ªå‹•åˆ¤æ–·</div>
        <div class="kpi-sub">
          ${pre98Txt}<br/>
          å¹´é‡‘ï¼š${badge(elig.eligiblePension)}ã€€
          è€å¹´ä¸€æ¬¡é‡‘ï¼š${badge(elig.eligibleOldAgeLump)}ã€€
          ä¸€æ¬¡è«‹é ˜ï¼š${badge(elig.eligibleOneTime)}<br/>
          æ³•å®šè«‹é ˜å¹´é½¡ï¼š${(elig.legalAgeMonths/12).toFixed(0)} æ­²
          ${specialWork15 ? "ï¼ˆç‰¹æ®Šå·¥ä½œ15å¹´ï¼š55æ­²ï¼‰" : ""}
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">Level 1ï¼šåˆ¶åº¦æ¯”è¼ƒï¼ˆå¹´é‡‘ vs ä¸€æ¬¡çµ¦ä»˜ï¼‰</div>
        <div class="kpi-sub">
          å¹´é‡‘ï¼ˆæœˆï¼‰ï¼š<b>NT$ ${fmt(laborMonthlyPension)}</b> ${pension ? `ï¼ˆ${pension.chosen}ï¼›${diffText}ï¼‰` : "ï¼ˆä¸ç¬¦/æœªè¨ˆï¼‰"}<br/>
          è€å¹´ä¸€æ¬¡é‡‘ï¼š<b>${oldAgeLump ? "NT$ "+fmt(oldAgeLump.amount) : "â€”"}</b><br/>
          ä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜ï¼š<b>${oneTime ? "NT$ "+fmt(oneTime.amount) : "â€”"}</b><br/>
          <div style="margin-top:8px">
            å¹´é‡‘æ‰“å¹³ï¼ˆvs è€å¹´ä¸€æ¬¡é‡‘ï¼‰ï¼š<b>${beOld ? `${beOld.months} å€‹æœˆ â†’ ç´„ ${beOld.beAgeYears.toFixed(1)} æ­²` : "â€”"}</b><br/>
            å¹´é‡‘æ‰“å¹³ï¼ˆvs ä¸€æ¬¡è«‹é ˜ï¼‰ï¼š<b>${beOne ? `${beOne.months} å€‹æœˆ â†’ ç´„ ${beOne.beAgeYears.toFixed(1)} æ­²` : "â€”"}</b>
          </div>
        </div>
      </div>
    </div>

    <details style="margin-top:12px">
      <summary>å±•é–‹ï¼šé€€ä¼‘ç•¶ä¸‹ç¾é‡‘æµæ‹†è§£ï¼ˆæ¸…æ™°ç‰ˆï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">é€€ä¼‘ç•¶ä¸‹ç”Ÿæ´»è²»ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(needAtRetire))}</td></tr>
          <tr><td class="muted">å‹ä¿æœˆé ˜ï¼ˆä¸»æƒ…å¢ƒï¼‰</td><td>NT$ ${fmt(Math.round(laborMain))}</td></tr>
          <tr><td class="muted">å…¶ä»–æ”¶å…¥ï¼ˆåç›®ï¼‰</td><td>NT$ ${fmt(Math.round(otherIncomeMonthlyAtRetire))}</td></tr>
          <tr><td class="muted">æˆ¿ç§Ÿï¼ˆæœˆé¡ï¼‰</td><td>NT$ ${fmt(Math.round(rentMonthly))}</td></tr>
          <tr><td class="muted">è‚¡æ¯+å‚µæ¯ï¼ˆæœˆï¼‰</td><td>NT$ ${fmt(Math.round(incomeFromYields0))} ${reinvestPostMode==="reinvest" ? "ï¼ˆä½ é¸æ“‡å†æŠ•å…¥â†’æ­¤é …ä¸ä½œç”Ÿæ´»è²»æ”¶å…¥ï¼‰" : ""}</td></tr>
          <tr><td style="font-weight:900">åˆè¨ˆæ”¶å…¥</td><td style="font-weight:900">NT$ ${fmt(Math.round(incomeAtRetire))}</td></tr>
          <tr><td style="font-weight:900">ç¼ºå£ï¼ˆéœ€æé ˜/å‹•ç”¨è³‡ç”¢ï¼‰</td><td style="font-weight:900">NT$ ${fmt(Math.round(gapAtRetire))}</td></tr>
        </table>
      </div>
    </details>

    <details>
      <summary>å±•é–‹ï¼šåˆ¶åº¦è¨ˆç®—ç´°ç¯€ï¼ˆçµ¦æƒ³ç¢ºèªè¦å‰‡çš„äººï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">è–ªè³‡ä¾†æº</td><td>${salaryNote}</td></tr>
          <tr><td class="muted">å¹´é‡‘å¹³å‡è–ªè³‡ï¼ˆ60æœˆæœ€é«˜å¹³å‡ï¼‰</td><td>NT$ ${fmt(Math.round(avgPension60))}</td></tr>
          <tr><td class="muted">ä¸€æ¬¡è«‹é ˜å¹³å‡è–ªè³‡ï¼ˆ36æœˆæœ€è¿‘å¹³å‡ï¼‰</td><td>NT$ ${fmt(Math.round(avgLump36))}</td></tr>
          <tr><td class="muted">é€€ä¼‘æ™‚å¹´è³‡ï¼ˆä¼°ï¼‰</td><td>${(insAtRetireMonths/12).toFixed(2)} å¹´</td></tr>
          <tr><td class="muted">æ³•å®šè«‹é ˜å¹´é½¡ï¼ˆä¾å‡ºç”Ÿå¹´æ¬¡ ROC ${rocBirthYear}ï¼‰</td><td>${legal.years} æ­²</td></tr>
          <tr><td class="muted">ææ—©/å±•å»¶ï¼ˆå¹´é‡‘ï¼‰</td><td>${diffText}</td></tr>
          ${pension ? `
            <tr><td class="muted">å¹´é‡‘å¼1ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base1))}</td></tr>
            <tr><td class="muted">å¹´é‡‘å¼2ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.base2))}</td></tr>
            <tr><td class="muted">æ“‡å„ªåŸºç¤ï¼ˆæœªåŠ æ¸›çµ¦ï¼‰</td><td>NT$ ${fmt(Math.round(pension.chosenBase))}</td></tr>
            <tr><td class="muted">åŠ æ¸›çµ¦ä¿‚æ•¸</td><td>Ã— ${adj.factor.toFixed(4)}</td></tr>
          ` : ``}
          ${oldAgeLump ? `
            <tr><td class="muted">è€å¹´ä¸€æ¬¡é‡‘ï¼šçµ¦ä»˜æœˆæ•¸</td><td>${oldAgeLump.benefitMonths.toFixed(3)}ï¼ˆ60å¾Œå¹´è³‡æœ€å¤š5å¹´ï¼‰</td></tr>
          ` : ``}
          ${oneTime ? `
            <tr><td class="muted">ä¸€æ¬¡è«‹é ˜ï¼šçµ¦ä»˜æœˆæ•¸</td><td>${oneTime.benefitMonths.toFixed(2)}ï¼ˆä¸Šé™${oneTime.cap}ï¼‰</td></tr>
            <tr><td class="muted">ä¸€æ¬¡è«‹é ˜è³‡æ ¼ï¼ˆäº”æ“‡ä¸€ï¼‰</td><td>
              ${elig.oneTimeConditions.cond1 ? "âœ“" : "âœ—"} æ¢ä»¶1ã€€
              ${elig.oneTimeConditions.cond2 ? "âœ“" : "âœ—"} æ¢ä»¶2ã€€
              ${elig.oneTimeConditions.cond3 ? "âœ“" : "âœ—"} æ¢ä»¶3ã€€
              ${elig.oneTimeConditions.cond4 ? "âœ“" : "âœ—"} æ¢ä»¶4ã€€
              ${elig.oneTimeConditions.cond5 ? "âœ“" : "âœ—"} æ¢ä»¶5
            </td></tr>
          ` : ``}
        </table>
        <div class="small muted">
          æé†’ï¼šä¸€æ¬¡è«‹é ˜è€å¹´çµ¦ä»˜åƒ…åœ¨ 98/01/01 ä¿®æ³•å‰å·²æœ‰å¹´è³‡è€…ï¼Œä¸”ç¬¦åˆæ¢ä»¶è€…å¯é¸ï¼›æ ¸ä»˜å¾Œä¸å¾—è®Šæ›´ã€‚
        </div>
      </div>
    </details>

    <details>
      <summary>å±•é–‹ï¼šä¸‰ç¨®åˆ¶åº¦æƒ…å¢ƒçš„è³‡ç”¢æ¨¡æ“¬å°ç…§ï¼ˆåŒä¸€çµ„æŠ•è³‡å‡è¨­ï¼‰</summary>
      <div class="inner">
        <table class="table">
          <tr><td class="muted">æƒ…å¢ƒAï¼šå¹´é‡‘ï¼ˆæœˆé ˜ï¼‰</td><td>
            é€€ä¼‘æ™‚ç¸½è³‡ç”¢ NT$ ${fmt(Math.round(simA.totalAtRetire))}ï½œ
            ${surviveText(simA, retireY, retireM, lifeExp).text}
          </td></tr>
          <tr><td class="muted">æƒ…å¢ƒBï¼šè€å¹´ä¸€æ¬¡é‡‘ï¼ˆæ³¨å…¥æœ¬é‡‘ï¼‰</td><td>
            é€€ä¼‘æ™‚ç¸½è³‡ç”¢ NT$ ${fmt(Math.round(simB.totalAtRetire))}ï½œ
            ${surviveText(simB, retireY, retireM, lifeExp).text}
          </td></tr>
          <tr><td class="muted">æƒ…å¢ƒCï¼šä¸€æ¬¡è«‹é ˜ï¼ˆæ³¨å…¥æœ¬é‡‘ï¼‰</td><td>
            é€€ä¼‘æ™‚ç¸½è³‡ç”¢ NT$ ${fmt(Math.round(simC.totalAtRetire))}ï½œ
            ${surviveText(simC, retireY, retireM, lifeExp).text}
          </td></tr>
        </table>
        <div class="small muted">
          èªªæ˜ï¼šä¸€æ¬¡çµ¦ä»˜æƒ…å¢ƒæœƒæŠŠä¸€æ¬¡é‡‘è¦–ç‚ºã€Œè«‹é ˜ç•¶ä¸‹å¯æŠ•è³‡è³‡ç”¢ã€åŠ å…¥æœ¬é‡‘ï¼›å¹´é‡‘æƒ…å¢ƒå‰‡ç”¨æœˆé ˜ä½œç‚ºé€€ä¼‘å¾Œç¾é‡‘æµæ”¶å…¥ã€‚
        </div>
      </div>
    </details>
  `;

  // æç¤ºï¼šè«‹é ˜å¹´é½¡å·®è· >5å¹´
  if(Math.abs(adj.diffMonths) > 60){
    showWarn("ä½ è¼¸å…¥çš„è«‹é ˜å¹´é½¡èˆ‡æ³•å®šå¹´é½¡ç›¸å·®è¶…é5å¹´ï¼›å¹´é‡‘åŠ æ¸›çµ¦å·²ä¾è¦å‰‡å°é ‚ï¼ˆÂ±20%ï¼‰ã€‚");
  }else{
    showOk("å·²å®Œæˆï¼šåˆ¶åº¦ç²¾æº–ï¼ˆ98å‰å¾Œè‡ªå‹•åˆ¤æ–·ï¼‰ï¼‹ç¼ºå£æ¨¡æ“¬ï¼‹å·®é¡åæ¨ï¼‹åˆ¶åº¦æ¯”è¼ƒï¼ˆæ‰“å¹³å¹´é½¡ï¼‰ï¼‹å®‰å…¨é‚Šéš›å£“åŠ›æ¸¬è©¦ã€‚");
  }

  // å¦‚æœä½¿ç”¨è€…æ²’å¡« firstInsuredDate ä¸” manual=autoï¼Œæé†’å¯èƒ½éœ€è¦ç¢ºèª
  if(!$("firstInsuredDate").value && $("pre98Manual").value==="auto"){
    showWarn("æé†’ï¼šä½ æœªå¡«ã€Œé¦–æ¬¡æŠ•ä¿æ—¥æœŸã€ï¼Œä¸”æ‰‹å‹•æŒ‡å®šç‚º autoã€‚æˆ‘å·²ä¿å®ˆè¦–ç‚ºã€Œ98/01/01 å¾Œé¦–æ¬¡æŠ•ä¿ã€ä¾†é¿å…èª¤åˆ¤ä¸€æ¬¡è«‹é ˜è³‡æ ¼ã€‚è‹¥ä½ ç¢ºå®š98å¹´å‰å·²æœ‰å¹´è³‡ï¼Œè«‹å¡«æ—¥æœŸæˆ–æ”¹ç‚ºæ‰‹å‹•=æ˜¯ã€‚");
  }
}

function loadExample(){
  $("birthDate").value = "1980-01-01";
  $("retireYears").value = 65; $("retireMonths").value = 0;
  $("claimYears").value = 65; $("claimMonths").value = 0;
  $("lifeExpectancy").value = 90;

  $("insYearsNow").value = 28; $("insMonthsNow").value = 0; $("insDaysNow").value = 5;
  $("keepInsured").value = "yes";

  // ä¾‹ï¼šç”¨æ—¥æœŸè‡ªå‹•åˆ¤æ–·ï¼ˆè‹¥ä½ è¦æ¸¬ä¸€æ¬¡è«‹é ˜ï¼ŒæŠŠæ—¥æœŸè¨­æˆ 2008-12-01ï¼‰
  $("firstInsuredDate").value = "2010-01-01";
  $("pre98Manual").value = "auto";

  $("specialWork15").value = "no";
  $("combineNP").value = "no";
  $("npYears").value = 0; $("npMonths").value = 0;

  $("sameUnitYears").value = 0; $("sameUnitMonths").value = 0;
  $("specialWorkYears5").value = 0; $("specialWorkMonths5").value = 0;
  $("isFemale").value = "no";

  $("avgSalaryPension").value = 45800;
  $("avgSalaryLump36").value = 45800;
  $("salaryLines").value = "";

  $("insAfter60Years").value = 0;
  $("insAfter60Months").value = 0;
  $("claimBefore60").value = "no";

  $("assetNow").value = 8000000;
  $("contribMonthly").value = 30000;

  $("divPre").value = 3.0;
  $("bondPre").value = 1.0;
  $("growthPre").value = 3.0;
  $("reinvestPre").value = "yes";

  $("divPost").value = 3.0;
  $("bondPost").value = 1.0;
  $("growthPost").value = 2.0;
  $("reinvestPost").value = "spend";

  $("rentMonthly").value = 15000;
  $("otherIncomeMonthly").value = 0;

  $("needMonthlyToday").value = 80000;
  $("inflation").value = 2.0;

  $("postContribMode").value = "no";
  $("postContribMonthly").value = 0;

  showOk("å·²å¸¶å…¥ç¯„ä¾‹ï¼šè³‡ç”¢800è¬ã€æ¯æœˆæŠ•å…¥3è¬ã€è‚¡æ¯3%å‚µæ¯1%å¢å€¼(å‰3%å¾Œ2%)ã€æˆ¿ç§Ÿ1.5è¬ã€ç”Ÿæ´»è²»8è¬ã€‚");
  showWarn("");
  hideOutput();
}

(function init(){
  if(!$("birthDate").value) $("birthDate").value = "1980-01-01";
  [
    "birthDate","retireYears","retireMonths","lifeExpectancy",
    "insYearsNow","insMonthsNow","insDaysNow","keepInsured",
    "claimYears","claimMonths",
    "firstInsuredDate","pre98Manual",
    "specialWork15","combineNP","npYears","npMonths",
    "sameUnitYears","sameUnitMonths","specialWorkYears5","specialWorkMonths5","isFemale",
    "avgSalaryPension","avgSalaryLump36","salaryLines",
    "insAfter60Years","insAfter60Months","claimBefore60",
    "assetNow","contribMonthly",
    "divPre","bondPre","growthPre","reinvestPre",
    "divPost","bondPost","growthPost","reinvestPost",
    "rentMonthly","otherIncomeMonthly",
    "needMonthlyToday","inflation",
    "postContribMode","postContribMonthly"
  ].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", hideOutput);
    el.addEventListener("change", hideOutput);
  });
})();
</script>
</body>
</html>
